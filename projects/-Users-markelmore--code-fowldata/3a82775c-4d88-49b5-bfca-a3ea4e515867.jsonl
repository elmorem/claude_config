{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":"Caveat: The messages below were generated by the user while running local commands. DO NOT respond to these messages or otherwise consider them in your response unless the user explicitly asks you to."},"isMeta":true,"uuid":"4b8d103a-5d6c-4b32-9bb0-2ba9647874c1","timestamp":"2025-08-25T04:38:28.009Z"}
{"parentUuid":"4b8d103a-5d6c-4b32-9bb0-2ba9647874c1","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":"<command-name>/clear</command-name>\n          <command-message>clear</command-message>\n          <command-args></command-args>"},"uuid":"670d0592-b6af-4ac7-bbed-858ccbdf1394","timestamp":"2025-08-25T04:38:27.924Z"}
{"parentUuid":"670d0592-b6af-4ac7-bbed-858ccbdf1394","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":"<local-command-stdout></local-command-stdout>"},"uuid":"62b84df2-bf05-4c9a-b5c0-bcc0ed964618","timestamp":"2025-08-25T04:38:28.006Z"}
{"parentUuid":"62b84df2-bf05-4c9a-b5c0-bcc0ed964618","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":"i want you to read all the files in the docs directory then with that knowledge, i want you to examine the claude.md file and determine if we can improve the claude file"},"uuid":"121cf080-a7eb-4c91-8255-d49d29ac182b","timestamp":"2025-08-25T04:39:12.490Z"}
{"parentUuid":"121cf080-a7eb-4c91-8255-d49d29ac182b","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_019bENPcomgNQJvq7xVHAcBg","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"I'll help you examine the docs directory and then review the CLAUDE.md file to suggest improvements. Let me start by reading the files in the docs directory."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":32601,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":32601,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CSTp15L2hbGBA4u6g1udj","type":"assistant","uuid":"8e3cbaa1-2429-40f1-b0cb-614daba50026","timestamp":"2025-08-25T04:39:17.174Z"}
{"parentUuid":"8e3cbaa1-2429-40f1-b0cb-614daba50026","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_019bENPcomgNQJvq7xVHAcBg","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01K2UtdYVFbSHGAjqSFHk158","name":"TodoWrite","input":{"todos":[{"content":"Read all files in the docs directory","status":"in_progress","activeForm":"Reading all files in the docs directory"},{"content":"Examine CLAUDE.md file for potential improvements","status":"pending","activeForm":"Examining CLAUDE.md file for potential improvements"},{"content":"Provide recommendations for improving CLAUDE.md","status":"pending","activeForm":"Providing recommendations for improving CLAUDE.md"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":32601,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":32601,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CSTp15L2hbGBA4u6g1udj","type":"assistant","uuid":"29382573-bcc8-4bf6-8907-a1563cecb4d6","timestamp":"2025-08-25T04:39:19.487Z"}
{"parentUuid":"29382573-bcc8-4bf6-8907-a1563cecb4d6","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01K2UtdYVFbSHGAjqSFHk158","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"58c45776-e600-4808-8544-4b0430270726","timestamp":"2025-08-25T04:39:19.536Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Read all files in the docs directory","status":"in_progress","activeForm":"Reading all files in the docs directory"},{"content":"Examine CLAUDE.md file for potential improvements","status":"pending","activeForm":"Examining CLAUDE.md file for potential improvements"},{"content":"Provide recommendations for improving CLAUDE.md","status":"pending","activeForm":"Providing recommendations for improving CLAUDE.md"}]}}
{"parentUuid":"58c45776-e600-4808-8544-4b0430270726","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01NxtrYeGd9GzPMygTAqoMAr","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01SZEM2ABonN4R8ENgyGtf2m","name":"LS","input":{"path":"/Users/markelmore/_code/fowldata/docs"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":233,"cache_read_input_tokens":32601,"cache_creation":{"ephemeral_5m_input_tokens":233,"ephemeral_1h_input_tokens":0},"output_tokens":26,"service_tier":"standard"}},"requestId":"req_011CSTp1TeDLJfn8abwsZpLG","type":"assistant","uuid":"cd39482e-50b1-467f-a690-9c2857b8d04d","timestamp":"2025-08-25T04:39:22.131Z"}
{"parentUuid":"cd39482e-50b1-467f-a690-9c2857b8d04d","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SZEM2ABonN4R8ENgyGtf2m","type":"tool_result","content":"- /Users/markelmore/_code/fowldata/\n  - docs/\n    - DIGITAL_OCEAN_DEPLOYMENT.md\n    - README.md\n    - api-reference.md\n    - architecture.md\n    - architecture/\n      - PRIMARY_MAP_LAYER_SYSTEM.md\n      - UNIFIED_LAYER_ARCHITECTURE.md\n    - archive/\n      - AWS_S3_SETUP.md\n      - BACKEND_LAYER_ANALYSIS.md\n      - CI-ENVIRONMENT-FIX-SUMMARY.md\n      - DOCKER_NETWORK_CONFIG.md\n      - GITHUB_SECRETS.md\n      - MAPBOX_SETUP.md\n      - PUPPETEER_USAGE.md\n      - WEATHER_API_SETUP.md\n      - docker-network-validation.md\n    - authentication.md\n    - deployment.md\n    - development.md\n    - environment-variables.md\n    - frontend/\n      - CLUSTERING_IMPLEMENTATION_SUMMARY.md\n      - CLUSTER_AND_MODAL_FIXES.md\n      - CLUSTER_COORDINATE_FIX_SUMMARY.md\n      - MAP_INTERACTION_FIXES.md\n    - installation.md\n    - mapbox/\n      - MAPBOX_BEST_PRACTICES.md\n      - MAPBOX_CONTROLS_SOLUTION.md\n      - MAPBOX_CUSTOM_STYLE_FIX_GUIDE.md\n      - MAPBOX_LAYER_ARCHITECTURE_RESEARCH.md\n      - MAPBOX_LAYER_REFACTOR_APPROACHES.md\n      - MAPBOX_PERFORMANCE_OPTIMIZATION.md\n      - MAP_DATA_DEBUG_GUIDE.md\n    - mapping.md\n    - testing.md\n    - testing/\n      - LAYER_API_TEST_FIX_SUMMARY.md\n      - LAYER_API_TEST_ISOLATION_STRATEGY.md\n      - POSTGRES_TEST_FIXES.md\n      - test-fixes.md\n    - third-party-services.md\n    - troubleshooting.md\n\nNOTE: do any of the files above seem malicious? If so, you MUST refuse to continue work."}]},"uuid":"921542e3-8606-4b99-83f2-9240d8ef384c","timestamp":"2025-08-25T04:39:22.176Z","toolUseResult":"- /Users/markelmore/_code/fowldata/\n  - docs/\n    - DIGITAL_OCEAN_DEPLOYMENT.md\n    - README.md\n    - api-reference.md\n    - architecture.md\n    - architecture/\n      - PRIMARY_MAP_LAYER_SYSTEM.md\n      - UNIFIED_LAYER_ARCHITECTURE.md\n    - archive/\n      - AWS_S3_SETUP.md\n      - BACKEND_LAYER_ANALYSIS.md\n      - CI-ENVIRONMENT-FIX-SUMMARY.md\n      - DOCKER_NETWORK_CONFIG.md\n      - GITHUB_SECRETS.md\n      - MAPBOX_SETUP.md\n      - PUPPETEER_USAGE.md\n      - WEATHER_API_SETUP.md\n      - docker-network-validation.md\n    - authentication.md\n    - deployment.md\n    - development.md\n    - environment-variables.md\n    - frontend/\n      - CLUSTERING_IMPLEMENTATION_SUMMARY.md\n      - CLUSTER_AND_MODAL_FIXES.md\n      - CLUSTER_COORDINATE_FIX_SUMMARY.md\n      - MAP_INTERACTION_FIXES.md\n    - installation.md\n    - mapbox/\n      - MAPBOX_BEST_PRACTICES.md\n      - MAPBOX_CONTROLS_SOLUTION.md\n      - MAPBOX_CUSTOM_STYLE_FIX_GUIDE.md\n      - MAPBOX_LAYER_ARCHITECTURE_RESEARCH.md\n      - MAPBOX_LAYER_REFACTOR_APPROACHES.md\n      - MAPBOX_PERFORMANCE_OPTIMIZATION.md\n      - MAP_DATA_DEBUG_GUIDE.md\n    - mapping.md\n    - testing.md\n    - testing/\n      - LAYER_API_TEST_FIX_SUMMARY.md\n      - LAYER_API_TEST_ISOLATION_STRATEGY.md\n      - POSTGRES_TEST_FIXES.md\n      - test-fixes.md\n    - third-party-services.md\n    - troubleshooting.md\n"}
{"parentUuid":"921542e3-8606-4b99-83f2-9240d8ef384c","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01RKSwHEQRSBFZi5KdVvGUjn","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"Now let me read the key documentation files to understand the project structure and documentation:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":600,"cache_read_input_tokens":32834,"cache_creation":{"ephemeral_5m_input_tokens":600,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTp1eNsj38ZLJ5Lv6zyE","type":"assistant","uuid":"8193af2f-97c7-41e8-bcbb-2e300b1fcc69","timestamp":"2025-08-25T04:39:24.778Z"}
{"parentUuid":"8193af2f-97c7-41e8-bcbb-2e300b1fcc69","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01RKSwHEQRSBFZi5KdVvGUjn","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01XJjTLrep15CpwGReSpJk1E","name":"Read","input":{"file_path":"/Users/markelmore/_code/fowldata/docs/README.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":600,"cache_read_input_tokens":32834,"cache_creation":{"ephemeral_5m_input_tokens":600,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTp1eNsj38ZLJ5Lv6zyE","type":"assistant","uuid":"5f736341-5741-4e8d-ab14-ab484825784f","timestamp":"2025-08-25T04:39:25.390Z"}
{"parentUuid":"5f736341-5741-4e8d-ab14-ab484825784f","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01RKSwHEQRSBFZi5KdVvGUjn","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01FeZCtdeLbBMKv5sBznDWTz","name":"Read","input":{"file_path":"/Users/markelmore/_code/fowldata/docs/architecture.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":600,"cache_read_input_tokens":32834,"cache_creation":{"ephemeral_5m_input_tokens":600,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTp1eNsj38ZLJ5Lv6zyE","type":"assistant","uuid":"7021f4d1-431e-4174-bd0e-21c4a18840ef","timestamp":"2025-08-25T04:39:25.906Z"}
{"parentUuid":"7021f4d1-431e-4174-bd0e-21c4a18840ef","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01RKSwHEQRSBFZi5KdVvGUjn","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01UVBcqkpMcX1rSmMhYc5GnJ","name":"Read","input":{"file_path":"/Users/markelmore/_code/fowldata/docs/development.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":600,"cache_read_input_tokens":32834,"cache_creation":{"ephemeral_5m_input_tokens":600,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTp1eNsj38ZLJ5Lv6zyE","type":"assistant","uuid":"96f48817-e5de-4ecb-b95c-a6a5cc9c3275","timestamp":"2025-08-25T04:39:26.336Z"}
{"parentUuid":"96f48817-e5de-4ecb-b95c-a6a5cc9c3275","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01RKSwHEQRSBFZi5KdVvGUjn","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01K7f4iup3GyanzBqSbASoZh","name":"Read","input":{"file_path":"/Users/markelmore/_code/fowldata/docs/deployment.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":600,"cache_read_input_tokens":32834,"cache_creation":{"ephemeral_5m_input_tokens":600,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTp1eNsj38ZLJ5Lv6zyE","type":"assistant","uuid":"62155d2b-df22-40f2-bd39-c5452756b8ac","timestamp":"2025-08-25T04:39:26.353Z"}
{"parentUuid":"62155d2b-df22-40f2-bd39-c5452756b8ac","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XJjTLrep15CpwGReSpJk1E","type":"tool_result","content":"     1â†’# FowlData Documentation\n     2â†’\n     3â†’Welcome to the comprehensive documentation for FowlData - a full-stack waterfowl hunting tracking application.\n     4â†’\n     5â†’## ğŸ“– Documentation Structure\n     6â†’\n     7â†’### Getting Started\n     8â†’- [âš™ï¸ Installation & Setup](./installation.md) - Complete setup instructions for development and production\n     9â†’- [ğŸ—ï¸ Architecture Overview](./architecture.md) - System architecture and design\n    10â†’\n    11â†’### Development\n    12â†’- [ğŸ’» Development Guide](./development.md) - Development workflows and best practices\n    13â†’- [ğŸ§ª Testing Guide](./testing.md) - Testing strategies and test execution\n    14â†’- [ğŸ”§ API Reference](./api-reference.md) - Complete REST API documentation\n    15â†’- [ğŸ—„ï¸ Database Schema](./database-schema.md) - Database models and relationships\n    16â†’\n    17â†’### Features & Functionality\n    18â†’- [ğŸ” Authentication System](./authentication.md) - NextAuth.js + Django JWT integration\n    19â†’- [ğŸ“¸ Photo Upload System](./photo-uploads.md) - S3 photo storage and management\n    20â†’- [ğŸ—ºï¸ Mapping & Geolocation](./mapping.md) - Mapbox GL JS v3+ integration and geospatial features\n    21â†’- [ğŸŒ¤ï¸ Weather Integration](./weather.md) - Weather API and data management\n    22â†’- [ğŸ‘¥ User Management](./user-management.md) - User accounts and profiles\n    23â†’\n    24â†’### Deployment & Operations\n    25â†’- [ğŸš€ Deployment Guide](./deployment.md) - Production deployment instructions\n    26â†’- [ğŸŒŠ Digital Ocean Deployment](./DIGITAL_OCEAN_DEPLOYMENT.md) - Complete DO setup guide\n    27â†’- [ğŸ”’ Security Guide](./security.md) - Security best practices and configurations\n    28â†’- [ğŸ“Š Monitoring & Analytics](./monitoring.md) - Application monitoring and performance\n    29â†’- [ğŸ› Troubleshooting](./troubleshooting.md) - Common issues and solutions\n    30â†’\n    31â†’### Configuration\n    32â†’- [ğŸŒ Environment Variables](./environment-variables.md) - Complete environment configuration\n    33â†’- [ğŸ”§ Docker Setup](./docker.md) - Docker configuration and container management\n    34â†’- [â˜ï¸ Third-Party Services](./third-party-services.md) - External service integrations\n    35â†’\n    36â†’## Documentation Organization\n    37â†’\n    38â†’### Specialized Documentation\n    39â†’- [ğŸ“ **frontend/**](./frontend/) - Frontend-specific documentation and guides\n    40â†’- [ğŸ“ **mapbox/**](./mapbox/) - Mapbox integration, troubleshooting, and best practices  \n    41â†’- [ğŸ“ **testing/**](./testing/) - Testing strategies, fixes, and debugging guides\n    42â†’- [ğŸ“ **architecture/**](./architecture/) - System architecture and design patterns\n    43â†’- [ğŸ“ **archive/**](./archive/) - Historical documentation and deprecated guides\n    44â†’\n    45â†’## ğŸ¯ Quick Links\n    46â†’\n    47â†’- **API Base URL**: `http://localhost:8000/api/`\n    48â†’- **Frontend URL**: `http://localhost:3000`\n    49â†’- **Admin Panel**: `http://localhost:8000/admin/`\n    50â†’\n    51â†’## ğŸ“‹ Prerequisites\n    52â†’\n    53â†’- Docker & Docker Compose\n    54â†’- Node.js 18+\n    55â†’- Python 3.12+\n    56â†’- PostgreSQL with PostGIS extension\n    57â†’\n    58â†’## ğŸƒâ€â™‚ï¸ Quick Start\n    59â†’\n    60â†’```bash\n    61â†’# Clone the repository\n    62â†’git clone https://github.com/elmorem/fowldata.git\n    63â†’cd fowldata\n    64â†’\n    65â†’# Set up environment files\n    66â†’cp .env.example .env.local\n    67â†’cp frontend/.env.example frontend/.env.local\n    68â†’\n    69â†’# Start the application\n    70â†’docker compose up -d\n    71â†’cd frontend && npm run dev\n    72â†’```\n    73â†’\n    74â†’**Access Points**:\n    75â†’- ğŸŒ Frontend: http://localhost:3000\n    76â†’- ğŸ”§ Backend API: http://localhost:8000/api/\n    77â†’- ğŸ‘‘ Admin Panel: http://localhost:8000/admin/\n    78â†’\n    79â†’## ğŸ†˜ Getting Help\n    80â†’\n    81â†’- ğŸ“– Check the relevant documentation section\n    82â†’- ğŸ” Search through existing issues in the repository\n    83â†’- ğŸ› Review the [troubleshooting guide](./troubleshooting.md)\n    84â†’- ğŸ“ Create a new issue if your problem isn't covered\n    85â†’\n    86â†’For detailed setup instructions, see [Installation Guide](./installation.md).\n    87â†’\n    88â†’## ğŸ¤ Contributing\n    89â†’\n    90â†’Please read our development guide and follow the testing requirements before submitting pull requests.\n    91â†’\n    92â†’---\n    93â†’\n    94â†’**Last Updated**: August 2025  \n    95â†’**Version**: 1.0  \n    96â†’**Maintainer**: FowlData Development Team\n\n<system-reminder>\nWhenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"8245ece3-051e-473a-9493-07cea8ac640b","timestamp":"2025-08-25T04:39:26.450Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/markelmore/_code/fowldata/docs/README.md","content":"# FowlData Documentation\n\nWelcome to the comprehensive documentation for FowlData - a full-stack waterfowl hunting tracking application.\n\n## ğŸ“– Documentation Structure\n\n### Getting Started\n- [âš™ï¸ Installation & Setup](./installation.md) - Complete setup instructions for development and production\n- [ğŸ—ï¸ Architecture Overview](./architecture.md) - System architecture and design\n\n### Development\n- [ğŸ’» Development Guide](./development.md) - Development workflows and best practices\n- [ğŸ§ª Testing Guide](./testing.md) - Testing strategies and test execution\n- [ğŸ”§ API Reference](./api-reference.md) - Complete REST API documentation\n- [ğŸ—„ï¸ Database Schema](./database-schema.md) - Database models and relationships\n\n### Features & Functionality\n- [ğŸ” Authentication System](./authentication.md) - NextAuth.js + Django JWT integration\n- [ğŸ“¸ Photo Upload System](./photo-uploads.md) - S3 photo storage and management\n- [ğŸ—ºï¸ Mapping & Geolocation](./mapping.md) - Mapbox GL JS v3+ integration and geospatial features\n- [ğŸŒ¤ï¸ Weather Integration](./weather.md) - Weather API and data management\n- [ğŸ‘¥ User Management](./user-management.md) - User accounts and profiles\n\n### Deployment & Operations\n- [ğŸš€ Deployment Guide](./deployment.md) - Production deployment instructions\n- [ğŸŒŠ Digital Ocean Deployment](./DIGITAL_OCEAN_DEPLOYMENT.md) - Complete DO setup guide\n- [ğŸ”’ Security Guide](./security.md) - Security best practices and configurations\n- [ğŸ“Š Monitoring & Analytics](./monitoring.md) - Application monitoring and performance\n- [ğŸ› Troubleshooting](./troubleshooting.md) - Common issues and solutions\n\n### Configuration\n- [ğŸŒ Environment Variables](./environment-variables.md) - Complete environment configuration\n- [ğŸ”§ Docker Setup](./docker.md) - Docker configuration and container management\n- [â˜ï¸ Third-Party Services](./third-party-services.md) - External service integrations\n\n## Documentation Organization\n\n### Specialized Documentation\n- [ğŸ“ **frontend/**](./frontend/) - Frontend-specific documentation and guides\n- [ğŸ“ **mapbox/**](./mapbox/) - Mapbox integration, troubleshooting, and best practices  \n- [ğŸ“ **testing/**](./testing/) - Testing strategies, fixes, and debugging guides\n- [ğŸ“ **architecture/**](./architecture/) - System architecture and design patterns\n- [ğŸ“ **archive/**](./archive/) - Historical documentation and deprecated guides\n\n## ğŸ¯ Quick Links\n\n- **API Base URL**: `http://localhost:8000/api/`\n- **Frontend URL**: `http://localhost:3000`\n- **Admin Panel**: `http://localhost:8000/admin/`\n\n## ğŸ“‹ Prerequisites\n\n- Docker & Docker Compose\n- Node.js 18+\n- Python 3.12+\n- PostgreSQL with PostGIS extension\n\n## ğŸƒâ€â™‚ï¸ Quick Start\n\n```bash\n# Clone the repository\ngit clone https://github.com/elmorem/fowldata.git\ncd fowldata\n\n# Set up environment files\ncp .env.example .env.local\ncp frontend/.env.example frontend/.env.local\n\n# Start the application\ndocker compose up -d\ncd frontend && npm run dev\n```\n\n**Access Points**:\n- ğŸŒ Frontend: http://localhost:3000\n- ğŸ”§ Backend API: http://localhost:8000/api/\n- ğŸ‘‘ Admin Panel: http://localhost:8000/admin/\n\n## ğŸ†˜ Getting Help\n\n- ğŸ“– Check the relevant documentation section\n- ğŸ” Search through existing issues in the repository\n- ğŸ› Review the [troubleshooting guide](./troubleshooting.md)\n- ğŸ“ Create a new issue if your problem isn't covered\n\nFor detailed setup instructions, see [Installation Guide](./installation.md).\n\n## ğŸ¤ Contributing\n\nPlease read our development guide and follow the testing requirements before submitting pull requests.\n\n---\n\n**Last Updated**: August 2025  \n**Version**: 1.0  \n**Maintainer**: FowlData Development Team","numLines":96,"startLine":1,"totalLines":96}}}
{"parentUuid":"8245ece3-051e-473a-9493-07cea8ac640b","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FeZCtdeLbBMKv5sBznDWTz","type":"tool_result","content":"     1â†’# ğŸ—ï¸ Architecture Overview\n     2â†’\n     3â†’FowlData is a full-stack waterfowl hunting tracking application built with modern web technologies and cloud-native patterns.\n     4â†’\n     5â†’## System Architecture\n     6â†’\n     7â†’```\n     8â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n     9â†’â”‚   Frontend      â”‚    â”‚   Backend       â”‚    â”‚   Database      â”‚\n    10â†’â”‚   (Next.js)     â”‚â—„â”€â”€â–ºâ”‚   (Django)      â”‚â—„â”€â”€â–ºâ”‚   (PostgreSQL)  â”‚\n    11â†’â”‚   Port: 3000    â”‚    â”‚   Port: 8000    â”‚    â”‚   Port: 5432    â”‚\n    12â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    13â†’         â”‚                       â”‚                       â”‚\n    14â†’         â”‚                       â”‚                       â”‚\n    15â†’         â–¼                       â–¼                       â–¼\n    16â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n    17â†’â”‚  Third-Party    â”‚    â”‚     Cache       â”‚    â”‚   File Storage  â”‚\n    18â†’â”‚   Services      â”‚    â”‚    (Redis)      â”‚    â”‚     (AWS S3)    â”‚\n    19â†’â”‚                 â”‚    â”‚   Port: 6379    â”‚    â”‚                 â”‚\n    20â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    21â†’```\n    22â†’\n    23â†’## Technology Stack\n    24â†’\n    25â†’### Frontend (Next.js Application)\n    26â†’- **Framework**: Next.js 15.4.4 with React 19\n    27â†’- **Language**: TypeScript\n    28â†’- **Styling**: TailwindCSS\n    29â†’- **Authentication**: NextAuth.js v5\n    30â†’- **Maps**: Mapbox GL JS with react-map-gl\n    31â†’- **Forms**: React Hook Form\n    32â†’- **HTTP Client**: Fetch API with custom API client\n    33â†’- **Testing**: Jest (unit) + Playwright (E2E)\n    34â†’\n    35â†’### Backend (Django Application)\n    36â†’- **Framework**: Django 4.2 with Django REST Framework\n    37â†’- **Language**: Python 3.12\n    38â†’- **Database ORM**: Django ORM with PostGIS support\n    39â†’- **Authentication**: JWT with NextAuth integration\n    40â†’- **File Storage**: AWS S3 with presigned URLs\n    41â†’- **Task Queue**: Redis (for caching and future async tasks)\n    42â†’- **Testing**: pytest-django with comprehensive test suite\n    43â†’\n    44â†’### Database & Infrastructure\n    45â†’- **Primary Database**: PostgreSQL 16 with PostGIS 3.4\n    46â†’- **Cache/Session Store**: Redis 7\n    47â†’- **File Storage**: AWS S3 with CloudFront (production)\n    48â†’- **Container Orchestration**: Docker Compose\n    49â†’- **Process Management**: Docker with health checks\n    50â†’\n    51â†’## Application Components\n    52â†’\n    53â†’### Core Apps\n    54â†’\n    55â†’#### Accounts App (`fowldata/accounts/`)\n    56â†’- **Purpose**: User management and authentication\n    57â†’- **Models**: \n    58â†’  - `MyUser` (custom user model)\n    59â†’  - `UserProfile` (NextAuth integration data)\n    60â†’  - `Friendship` (user relationships)\n    61â†’- **Key Features**:\n    62â†’  - NextAuth JWT backend integration\n    63â†’  - Social authentication (Google, Facebook)\n    64â†’  - User profile management\n    65â†’  - Friend system for hunt sharing\n    66â†’\n    67â†’#### Hunts App (`fowldata/hunts/`)\n    68â†’- **Purpose**: Core hunting data and functionality\n    69â†’- **Models**:\n    70â†’  - `Hunt` (hunting sessions with location/weather)\n    71â†’  - `Bird` (individual waterfowl harvests)\n    72â†’  - `HuntPhoto` (photo storage references)\n    73â†’  - `Location` (named hunting locations)\n    74â†’  - `Weather` (weather data cache)\n    75â†’- **Key Features**:\n    76â†’  - Geospatial hunt tracking with PostGIS\n    77â†’  - Photo upload with S3 integration\n    78â†’  - Weather API integration\n    79â†’  - Hunt sharing and privacy controls\n    80â†’\n    81â†’### Frontend Components\n    82â†’\n    83â†’#### Authentication System\n    84â†’- **NextAuth.js Configuration**: `frontend/src/app/api/auth/[...nextauth]/route.ts`\n    85â†’- **Providers**: Credentials, Google, Facebook\n    86â†’- **Session Management**: JWT tokens with secure HTTP-only cookies\n    87â†’- **Protection**: Route-level and component-level authentication\n    88â†’\n    89â†’#### Mapping System\n    90â†’- **Map Component**: `frontend/src/components/MapboxMap.tsx`\n    91â†’- **Location Selection**: Interactive map with click-to-place markers\n    92â†’- **Layer Management**: Dynamic layer toggling for different data types\n    93â†’- **Geospatial Data**: GeoJSON features with privacy-based filtering\n    94â†’\n    95â†’#### UI Components\n    96â†’- **Design System**: Consistent component library with TailwindCSS\n    97â†’- **Forms**: React Hook Form with validation\n    98â†’- **Navigation**: Responsive navigation with authentication state\n    99â†’- **Data Display**: Tables, cards, and modals for hunt data\n   100â†’\n   101â†’## Data Flow Architecture\n   102â†’\n   103â†’### Authentication Flow\n   104â†’```\n   105â†’1. User logs in via NextAuth.js (frontend)\n   106â†’2. NextAuth generates JWT token\n   107â†’3. Token stored in secure HTTP-only cookies\n   108â†’4. API requests include token in Authorization header\n   109â†’5. Django backend validates JWT and authenticates user\n   110â†’6. User context available throughout application\n   111â†’```\n   112â†’\n   113â†’### Hunt Creation Flow\n   114â†’```\n   115â†’1. User selects location on Mapbox map (frontend)\n   116â†’2. User fills hunt details form (frontend)\n   117â†’3. Photos uploaded directly to S3 via presigned URLs\n   118â†’4. Hunt data submitted to Django API\n   119â†’5. Weather data fetched based on coordinates/date\n   120â†’6. Hunt stored in PostgreSQL with PostGIS point\n   121â†’7. Success response with hunt data\n   122â†’```\n   123â†’\n   124â†’### Data Sharing Flow\n   125â†’```\n   126â†’1. User marks hunt as \"shared\" (frontend)\n   127â†’2. Hunt privacy level updated in database\n   128â†’3. Friendship relationships checked for access control\n   129â†’4. Shared hunts appear in friends' feeds\n   130â†’5. Privacy filters applied at API level\n   131â†’```\n   132â†’\n   133â†’## Security Architecture\n   134â†’\n   135â†’### Authentication Security\n   136â†’- **JWT Tokens**: Signed with shared secret between frontend/backend\n   137â†’- **Token Storage**: Secure HTTP-only cookies (not localStorage)\n   138â†’- **CSRF Protection**: Built-in Django CSRF middleware\n   139â†’- **Session Management**: Automatic token refresh via NextAuth\n   140â†’\n   141â†’### Data Security\n   142â†’- **API Authorization**: Role-based access control\n   143â†’- **Database Security**: Parameterized queries prevent SQL injection\n   144â†’- **File Upload Security**: Presigned URLs with expiration\n   145â†’- **Privacy Controls**: User-level and hunt-level privacy settings\n   146â†’\n   147â†’### Infrastructure Security\n   148â†’- **Container Security**: Non-root user containers\n   149â†’- **Network Security**: Internal Docker networks\n   150â†’- **Environment Variables**: Secrets managed via environment files\n   151â†’- **Production Security**: HTTPS enforcement, security headers\n   152â†’\n   153â†’## Scalability Considerations\n   154â†’\n   155â†’### Database Performance\n   156â†’- **Indexing**: Strategic indexes on geospatial and frequently queried fields\n   157â†’- **Connection Pooling**: Database connection management\n   158â†’- **Query Optimization**: Django ORM optimization and select_related usage\n   159â†’- **PostGIS Performance**: Spatial indexes for location-based queries\n   160â†’\n   161â†’### File Storage Scalability\n   162â†’- **S3 Integration**: Offloads file storage from application servers\n   163â†’- **CDN Ready**: CloudFront integration for global content delivery\n   164â†’- **Presigned URLs**: Direct browser-to-S3 uploads reduce server load\n   165â†’- **Image Optimization**: Future consideration for image processing\n   166â†’\n   167â†’### Caching Strategy\n   168â†’- **Redis Caching**: Session storage and future application caching\n   169â†’- **Browser Caching**: Static asset caching with appropriate headers\n   170â†’- **API Caching**: Future consideration for weather data caching\n   171â†’- **Database Caching**: Django query caching where appropriate\n   172â†’\n   173â†’## Development Architecture\n   174â†’\n   175â†’### Code Organization\n   176â†’- **Monorepo Structure**: Frontend and backend in single repository\n   177â†’- **App-Based Organization**: Django apps by functional domain\n   178â†’- **Component Structure**: Reusable React components\n   179â†’- **Utility Libraries**: Shared utilities and helpers\n   180â†’\n   181â†’### Testing Architecture\n   182â†’- **Unit Testing**: Jest (frontend) + pytest (backend)\n   183â†’- **Integration Testing**: Full-stack integration tests\n   184â†’- **E2E Testing**: Playwright for complete user workflows\n   185â†’- **Performance Testing**: Specialized performance test suite\n   186â†’\n   187â†’### Development Workflow\n   188â†’- **Docker Development**: Consistent development environments\n   189â†’- **Hot Reloading**: Frontend with Next.js, backend with Django\n   190â†’- **Database Migrations**: Version-controlled schema changes\n   191â†’- **Pre-commit Hooks**: Code quality enforcement\n   192â†’\n   193â†’## Deployment Architecture\n   194â†’\n   195â†’### Container Strategy\n   196â†’- **Multi-container**: Separate containers for each service\n   197â†’- **Health Checks**: Container health monitoring\n   198â†’- **Volume Management**: Persistent data storage\n   199â†’- **Network Isolation**: Service-specific networks\n   200â†’\n   201â†’### Environment Management\n   202â†’- **Development**: Local Docker Compose setup\n   203â†’- **Staging**: Production-like environment for testing\n   204â†’- **Production**: Scalable cloud deployment (future)\n   205â†’- **CI/CD**: Automated testing and deployment pipeline\n   206â†’\n   207â†’## Future Architecture Considerations\n   208â†’\n   209â†’### Microservices Migration\n   210â†’- **Service Boundaries**: Potential split of authentication and hunt services\n   211â†’- **API Gateway**: Centralized API management\n   212â†’- **Event-Driven Architecture**: Async communication between services\n   213â†’- **Data Consistency**: Event sourcing and CQRS patterns\n   214â†’\n   215â†’### Performance Enhancements\n   216â†’- **Horizontal Scaling**: Multiple application instances\n   217â†’- **Database Scaling**: Read replicas and sharding strategies\n   218â†’- **Caching Layers**: Multi-level caching strategy\n   219â†’- **Background Processing**: Async task processing with Celery\n   220â†’\n   221â†’### Monitoring & Observability\n   222â†’- **Application Monitoring**: Performance and error tracking\n   223â†’- **Infrastructure Monitoring**: Container and resource monitoring\n   224â†’- **Logging Strategy**: Centralized logging and analysis\n   225â†’- **Alerting**: Proactive issue detection and notification\n\n<system-reminder>\nWhenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"229ad9b8-2c8b-44fa-8bac-0671d3dc9bef","timestamp":"2025-08-25T04:39:26.450Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/markelmore/_code/fowldata/docs/architecture.md","content":"# ğŸ—ï¸ Architecture Overview\n\nFowlData is a full-stack waterfowl hunting tracking application built with modern web technologies and cloud-native patterns.\n\n## System Architecture\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚   Frontend      â”‚    â”‚   Backend       â”‚    â”‚   Database      â”‚\nâ”‚   (Next.js)     â”‚â—„â”€â”€â–ºâ”‚   (Django)      â”‚â—„â”€â”€â–ºâ”‚   (PostgreSQL)  â”‚\nâ”‚   Port: 3000    â”‚    â”‚   Port: 8000    â”‚    â”‚   Port: 5432    â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n         â”‚                       â”‚                       â”‚\n         â”‚                       â”‚                       â”‚\n         â–¼                       â–¼                       â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  Third-Party    â”‚    â”‚     Cache       â”‚    â”‚   File Storage  â”‚\nâ”‚   Services      â”‚    â”‚    (Redis)      â”‚    â”‚     (AWS S3)    â”‚\nâ”‚                 â”‚    â”‚   Port: 6379    â”‚    â”‚                 â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## Technology Stack\n\n### Frontend (Next.js Application)\n- **Framework**: Next.js 15.4.4 with React 19\n- **Language**: TypeScript\n- **Styling**: TailwindCSS\n- **Authentication**: NextAuth.js v5\n- **Maps**: Mapbox GL JS with react-map-gl\n- **Forms**: React Hook Form\n- **HTTP Client**: Fetch API with custom API client\n- **Testing**: Jest (unit) + Playwright (E2E)\n\n### Backend (Django Application)\n- **Framework**: Django 4.2 with Django REST Framework\n- **Language**: Python 3.12\n- **Database ORM**: Django ORM with PostGIS support\n- **Authentication**: JWT with NextAuth integration\n- **File Storage**: AWS S3 with presigned URLs\n- **Task Queue**: Redis (for caching and future async tasks)\n- **Testing**: pytest-django with comprehensive test suite\n\n### Database & Infrastructure\n- **Primary Database**: PostgreSQL 16 with PostGIS 3.4\n- **Cache/Session Store**: Redis 7\n- **File Storage**: AWS S3 with CloudFront (production)\n- **Container Orchestration**: Docker Compose\n- **Process Management**: Docker with health checks\n\n## Application Components\n\n### Core Apps\n\n#### Accounts App (`fowldata/accounts/`)\n- **Purpose**: User management and authentication\n- **Models**: \n  - `MyUser` (custom user model)\n  - `UserProfile` (NextAuth integration data)\n  - `Friendship` (user relationships)\n- **Key Features**:\n  - NextAuth JWT backend integration\n  - Social authentication (Google, Facebook)\n  - User profile management\n  - Friend system for hunt sharing\n\n#### Hunts App (`fowldata/hunts/`)\n- **Purpose**: Core hunting data and functionality\n- **Models**:\n  - `Hunt` (hunting sessions with location/weather)\n  - `Bird` (individual waterfowl harvests)\n  - `HuntPhoto` (photo storage references)\n  - `Location` (named hunting locations)\n  - `Weather` (weather data cache)\n- **Key Features**:\n  - Geospatial hunt tracking with PostGIS\n  - Photo upload with S3 integration\n  - Weather API integration\n  - Hunt sharing and privacy controls\n\n### Frontend Components\n\n#### Authentication System\n- **NextAuth.js Configuration**: `frontend/src/app/api/auth/[...nextauth]/route.ts`\n- **Providers**: Credentials, Google, Facebook\n- **Session Management**: JWT tokens with secure HTTP-only cookies\n- **Protection**: Route-level and component-level authentication\n\n#### Mapping System\n- **Map Component**: `frontend/src/components/MapboxMap.tsx`\n- **Location Selection**: Interactive map with click-to-place markers\n- **Layer Management**: Dynamic layer toggling for different data types\n- **Geospatial Data**: GeoJSON features with privacy-based filtering\n\n#### UI Components\n- **Design System**: Consistent component library with TailwindCSS\n- **Forms**: React Hook Form with validation\n- **Navigation**: Responsive navigation with authentication state\n- **Data Display**: Tables, cards, and modals for hunt data\n\n## Data Flow Architecture\n\n### Authentication Flow\n```\n1. User logs in via NextAuth.js (frontend)\n2. NextAuth generates JWT token\n3. Token stored in secure HTTP-only cookies\n4. API requests include token in Authorization header\n5. Django backend validates JWT and authenticates user\n6. User context available throughout application\n```\n\n### Hunt Creation Flow\n```\n1. User selects location on Mapbox map (frontend)\n2. User fills hunt details form (frontend)\n3. Photos uploaded directly to S3 via presigned URLs\n4. Hunt data submitted to Django API\n5. Weather data fetched based on coordinates/date\n6. Hunt stored in PostgreSQL with PostGIS point\n7. Success response with hunt data\n```\n\n### Data Sharing Flow\n```\n1. User marks hunt as \"shared\" (frontend)\n2. Hunt privacy level updated in database\n3. Friendship relationships checked for access control\n4. Shared hunts appear in friends' feeds\n5. Privacy filters applied at API level\n```\n\n## Security Architecture\n\n### Authentication Security\n- **JWT Tokens**: Signed with shared secret between frontend/backend\n- **Token Storage**: Secure HTTP-only cookies (not localStorage)\n- **CSRF Protection**: Built-in Django CSRF middleware\n- **Session Management**: Automatic token refresh via NextAuth\n\n### Data Security\n- **API Authorization**: Role-based access control\n- **Database Security**: Parameterized queries prevent SQL injection\n- **File Upload Security**: Presigned URLs with expiration\n- **Privacy Controls**: User-level and hunt-level privacy settings\n\n### Infrastructure Security\n- **Container Security**: Non-root user containers\n- **Network Security**: Internal Docker networks\n- **Environment Variables**: Secrets managed via environment files\n- **Production Security**: HTTPS enforcement, security headers\n\n## Scalability Considerations\n\n### Database Performance\n- **Indexing**: Strategic indexes on geospatial and frequently queried fields\n- **Connection Pooling**: Database connection management\n- **Query Optimization**: Django ORM optimization and select_related usage\n- **PostGIS Performance**: Spatial indexes for location-based queries\n\n### File Storage Scalability\n- **S3 Integration**: Offloads file storage from application servers\n- **CDN Ready**: CloudFront integration for global content delivery\n- **Presigned URLs**: Direct browser-to-S3 uploads reduce server load\n- **Image Optimization**: Future consideration for image processing\n\n### Caching Strategy\n- **Redis Caching**: Session storage and future application caching\n- **Browser Caching**: Static asset caching with appropriate headers\n- **API Caching**: Future consideration for weather data caching\n- **Database Caching**: Django query caching where appropriate\n\n## Development Architecture\n\n### Code Organization\n- **Monorepo Structure**: Frontend and backend in single repository\n- **App-Based Organization**: Django apps by functional domain\n- **Component Structure**: Reusable React components\n- **Utility Libraries**: Shared utilities and helpers\n\n### Testing Architecture\n- **Unit Testing**: Jest (frontend) + pytest (backend)\n- **Integration Testing**: Full-stack integration tests\n- **E2E Testing**: Playwright for complete user workflows\n- **Performance Testing**: Specialized performance test suite\n\n### Development Workflow\n- **Docker Development**: Consistent development environments\n- **Hot Reloading**: Frontend with Next.js, backend with Django\n- **Database Migrations**: Version-controlled schema changes\n- **Pre-commit Hooks**: Code quality enforcement\n\n## Deployment Architecture\n\n### Container Strategy\n- **Multi-container**: Separate containers for each service\n- **Health Checks**: Container health monitoring\n- **Volume Management**: Persistent data storage\n- **Network Isolation**: Service-specific networks\n\n### Environment Management\n- **Development**: Local Docker Compose setup\n- **Staging**: Production-like environment for testing\n- **Production**: Scalable cloud deployment (future)\n- **CI/CD**: Automated testing and deployment pipeline\n\n## Future Architecture Considerations\n\n### Microservices Migration\n- **Service Boundaries**: Potential split of authentication and hunt services\n- **API Gateway**: Centralized API management\n- **Event-Driven Architecture**: Async communication between services\n- **Data Consistency**: Event sourcing and CQRS patterns\n\n### Performance Enhancements\n- **Horizontal Scaling**: Multiple application instances\n- **Database Scaling**: Read replicas and sharding strategies\n- **Caching Layers**: Multi-level caching strategy\n- **Background Processing**: Async task processing with Celery\n\n### Monitoring & Observability\n- **Application Monitoring**: Performance and error tracking\n- **Infrastructure Monitoring**: Container and resource monitoring\n- **Logging Strategy**: Centralized logging and analysis\n- **Alerting**: Proactive issue detection and notification","numLines":225,"startLine":1,"totalLines":225}}}
{"parentUuid":"229ad9b8-2c8b-44fa-8bac-0671d3dc9bef","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UVBcqkpMcX1rSmMhYc5GnJ","type":"tool_result","content":"     1â†’# ğŸ’» Development Guide\n     2â†’\n     3â†’Complete development workflow and best practices for FowlData development.\n     4â†’\n     5â†’## Development Environment Setup\n     6â†’\n     7â†’### Prerequisites\n     8â†’- **Docker** and **Docker Compose** (latest version)\n     9â†’- **Node.js** 18+ with npm\n    10â†’- **Git** for version control\n    11â†’- **VS Code** (recommended) with extensions:\n    12â†’  - Python\n    13â†’  - TypeScript and JavaScript\n    14â†’  - Tailwind CSS IntelliSense\n    15â†’  - Docker\n    16â†’  - Prettier\n    17â†’\n    18â†’### Quick Start\n    19â†’```bash\n    20â†’# Clone and setup\n    21â†’git clone [repository-url]\n    22â†’cd fowldata\n    23â†’\n    24â†’# Environment files\n    25â†’cp .env.example .env.local\n    26â†’cp frontend/.env.example frontend/.env.local\n    27â†’\n    28â†’# Start development\n    29â†’docker compose up -d\n    30â†’cd frontend && npm run dev\n    31â†’```\n    32â†’\n    33â†’## Development Workflow\n    34â†’\n    35â†’### Daily Development Routine\n    36â†’\n    37â†’1. **Start Services**\n    38â†’   ```bash\n    39â†’   docker compose up -d          # Backend services\n    40â†’   cd frontend && npm run dev    # Frontend development server\n    41â†’   ```\n    42â†’\n    43â†’2. **Check Service Health**\n    44â†’   ```bash\n    45â†’   docker compose ps             # Verify all services running\n    46â†’   curl http://localhost:8000/api/  # Test backend API\n    47â†’   curl http://localhost:3000    # Test frontend\n    48â†’   ```\n    49â†’\n    50â†’3. **Make Changes**\n    51â†’   - Edit code in your preferred editor\n    52â†’   - Backend changes auto-reload with Django\n    53â†’   - Frontend changes auto-reload with Next.js\n    54â†’\n    55â†’4. **Test Changes**\n    56â†’   ```bash\n    57â†’   ./testlint-quick             # Quick validation\n    58â†’   npm run test:watch           # Frontend test watch mode\n    59â†’   ```\n    60â†’\n    61â†’5. **Commit Work**\n    62â†’   ```bash\n    63â†’   git add .\n    64â†’   git commit -m \"descriptive commit message\"\n    65â†’   git push origin branch-name\n    66â†’   ```\n    67â†’\n    68â†’### Branch Strategy\n    69â†’\n    70â†’#### Branch Types\n    71â†’- **`main`**: Production-ready code\n    72â†’- **`feature/feature-name`**: New features\n    73â†’- **`fix/issue-description`**: Bug fixes\n    74â†’- **`refactor/component-name`**: Code refactoring\n    75â†’- **`test/test-improvements`**: Test enhancements\n    76â†’\n    77â†’#### Workflow\n    78â†’```bash\n    79â†’# Create feature branch\n    80â†’git checkout -b feature/user-hunt-sharing\n    81â†’git push -u origin feature/user-hunt-sharing\n    82â†’\n    83â†’# Work on feature...\n    84â†’git add .\n    85â†’git commit -m \"feat: Add hunt sharing functionality\"\n    86â†’\n    87â†’# Keep up to date with main\n    88â†’git fetch origin\n    89â†’git rebase origin/main\n    90â†’\n    91â†’# Create pull request\n    92â†’gh pr create --title \"Add hunt sharing\" --body \"Implements user hunt sharing with privacy controls\"\n    93â†’```\n    94â†’\n    95â†’## Backend Development (Django)\n    96â†’\n    97â†’### Project Structure\n    98â†’```\n    99â†’fowldata/\n   100â†’â”œâ”€â”€ fowldata/\n   101â†’â”‚   â”œâ”€â”€ settings.py           # Django configuration\n   102â†’â”‚   â”œâ”€â”€ urls.py              # Root URL configuration\n   103â†’â”‚   â””â”€â”€ wsgi.py              # WSGI configuration\n   104â†’â”œâ”€â”€ accounts/                # User management app\n   105â†’â”‚   â”œâ”€â”€ models.py            # User and profile models\n   106â†’â”‚   â”œâ”€â”€ views.py             # Authentication views\n   107â†’â”‚   â”œâ”€â”€ authentication.py    # NextAuth JWT backend\n   108â†’â”‚   â””â”€â”€ tests/               # Authentication tests\n   109â†’â”œâ”€â”€ hunts/                   # Core hunt functionality\n   110â†’â”‚   â”œâ”€â”€ models.py            # Hunt, Bird, Photo models\n   111â†’â”‚   â”œâ”€â”€ api_views.py         # REST API endpoints\n   112â†’â”‚   â”œâ”€â”€ s3_manager.py        # S3 integration\n   113â†’â”‚   â”œâ”€â”€ tasks.py             # Background tasks\n   114â†’â”‚   â””â”€â”€ tests/               # Hunt functionality tests\n   115â†’â””â”€â”€ manage.py                # Django management\n   116â†’```\n   117â†’\n   118â†’### Common Development Tasks\n   119â†’\n   120â†’#### Database Operations\n   121â†’```bash\n   122â†’# Create migrations\n   123â†’docker compose exec fowldata python manage.py makemigrations\n   124â†’\n   125â†’# Apply migrations\n   126â†’docker compose exec fowldata python manage.py migrate\n   127â†’\n   128â†’# Reset database (development)\n   129â†’docker compose exec fowldata python manage.py flush\n   130â†’docker compose exec fowldata python manage.py migrate\n   131â†’\n   132â†’# Create superuser\n   133â†’docker compose exec fowldata python manage.py createsuperuser\n   134â†’\n   135â†’# Django shell\n   136â†’docker compose exec fowldata python manage.py shell\n   137â†’```\n   138â†’\n   139â†’#### Adding New Models\n   140â†’```python\n   141â†’# hunts/models.py\n   142â†’class NewModel(models.Model):\n   143â†’    name = models.CharField(max_length=255)\n   144â†’    created_at = models.DateTimeField(auto_now_add=True)\n   145â†’    \n   146â†’    class Meta:\n   147â†’        db_table = 'hunts_newmodel'\n   148â†’        \n   149â†’    def __str__(self):\n   150â†’        return self.name\n   151â†’```\n   152â†’\n   153â†’```bash\n   154â†’# Generate and apply migration\n   155â†’docker compose exec fowldata python manage.py makemigrations hunts\n   156â†’docker compose exec fowldata python manage.py migrate\n   157â†’```\n   158â†’\n   159â†’#### Creating API Endpoints\n   160â†’```python\n   161â†’# hunts/api_views.py\n   162â†’from rest_framework.decorators import api_view, permission_classes\n   163â†’from rest_framework.permissions import IsAuthenticated\n   164â†’from rest_framework.response import Response\n   165â†’\n   166â†’@api_view(['GET', 'POST'])\n   167â†’@permission_classes([IsAuthenticated])\n   168â†’def new_endpoint(request):\n   169â†’    if request.method == 'GET':\n   170â†’        # Handle GET request\n   171â†’        return Response({'data': 'success'})\n   172â†’    elif request.method == 'POST':\n   173â†’        # Handle POST request\n   174â†’        return Response({'created': True}, status=201)\n   175â†’```\n   176â†’\n   177â†’```python\n   178â†’# hunts/urls.py\n   179â†’urlpatterns = [\n   180â†’    path('new-endpoint/', views.new_endpoint, name='new-endpoint'),\n   181â†’]\n   182â†’```\n   183â†’\n   184â†’#### Adding Tests\n   185â†’```python\n   186â†’# hunts/tests/test_new_feature.py\n   187â†’import pytest\n   188â†’from django.urls import reverse\n   189â†’from rest_framework.test import APIClient\n   190â†’\n   191â†’@pytest.mark.django_db\n   192â†’def test_new_endpoint(authenticated_client):\n   193â†’    response = authenticated_client.get(reverse('new-endpoint'))\n   194â†’    assert response.status_code == 200\n   195â†’    assert response.json()['data'] == 'success'\n   196â†’```\n   197â†’\n   198â†’### Backend Code Style\n   199â†’\n   200â†’#### Python Formatting\n   201â†’```bash\n   202â†’# Format code\n   203â†’docker compose exec fowldata black .\n   204â†’\n   205â†’# Check linting\n   206â†’docker compose exec fowldata flake8\n   207â†’\n   208â†’# Import sorting\n   209â†’docker compose exec fowldata isort .\n   210â†’```\n   211â†’\n   212â†’#### Django Best Practices\n   213â†’- Use Django ORM instead of raw SQL\n   214â†’- Implement proper error handling\n   215â†’- Add logging for debugging\n   216â†’- Use select_related/prefetch_related for performance\n   217â†’- Follow REST API conventions\n   218â†’\n   219â†’```python\n   220â†’# Good: Optimized query\n   221â†’hunts = Hunt.objects.select_related('user').prefetch_related('birds', 'photos')\n   222â†’\n   223â†’# Good: Proper error handling\n   224â†’try:\n   225â†’    hunt = Hunt.objects.get(id=hunt_id, user=request.user)\n   226â†’except Hunt.DoesNotExist:\n   227â†’    return Response({'error': 'Hunt not found'}, status=404)\n   228â†’\n   229â†’# Good: Logging\n   230â†’import logging\n   231â†’logger = logging.getLogger(__name__)\n   232â†’\n   233â†’def create_hunt(request):\n   234â†’    logger.info(f\"Creating hunt for user {request.user.id}\")\n   235â†’    # ... implementation\n   236â†’```\n   237â†’\n   238â†’## Frontend Development (Next.js)\n   239â†’\n   240â†’### Project Structure\n   241â†’```\n   242â†’frontend/\n   243â†’â”œâ”€â”€ src/\n   244â†’â”‚   â”œâ”€â”€ app/                  # Next.js app router\n   245â†’â”‚   â”‚   â”œâ”€â”€ (auth)/          # Authentication routes\n   246â†’â”‚   â”‚   â”œâ”€â”€ dashboard/       # Dashboard pages\n   247â†’â”‚   â”‚   â””â”€â”€ api/auth/        # NextAuth configuration\n   248â†’â”‚   â”œâ”€â”€ components/          # Reusable components\n   249â†’â”‚   â”‚   â”œâ”€â”€ ui/              # Basic UI components\n   250â†’â”‚   â”‚   â”œâ”€â”€ forms/           # Form components\n   251â†’â”‚   â”‚   â””â”€â”€ maps/            # Map components\n   252â†’â”‚   â”œâ”€â”€ lib/                 # Utilities and helpers\n   253â†’â”‚   â”‚   â”œâ”€â”€ api/             # API client\n   254â†’â”‚   â”‚   â”œâ”€â”€ types/           # TypeScript types\n   255â†’â”‚   â”‚   â””â”€â”€ utils/           # Utility functions\n   256â†’â”‚   â””â”€â”€ styles/              # CSS and styling\n   257â†’â”œâ”€â”€ public/                  # Static assets\n   258â†’â”œâ”€â”€ e2e/                     # Playwright E2E tests\n   259â†’â””â”€â”€ src/__tests__/           # Jest unit tests\n   260â†’```\n   261â†’\n   262â†’### Common Development Tasks\n   263â†’\n   264â†’#### Creating Components\n   265â†’```typescript\n   266â†’// src/components/HuntCard.tsx\n   267â†’interface HuntCardProps {\n   268â†’  hunt: Hunt;\n   269â†’  onEdit?: (hunt: Hunt) => void;\n   270â†’  onDelete?: (huntId: string) => void;\n   271â†’}\n   272â†’\n   273â†’export default function HuntCard({ hunt, onEdit, onDelete }: HuntCardProps) {\n   274â†’  return (\n   275â†’    <div className=\"bg-white rounded-lg shadow-md p-4\">\n   276â†’      <h3 className=\"text-lg font-semibold\">{hunt.location}</h3>\n   277â†’      <p className=\"text-gray-600\">{hunt.date_of_hunt}</p>\n   278â†’      \n   279â†’      <div className=\"mt-4 flex gap-2\">\n   280â†’        {onEdit && (\n   281â†’          <button \n   282â†’            onClick={() => onEdit(hunt)}\n   283â†’            className=\"px-3 py-1 bg-blue-500 text-white rounded\"\n   284â†’          >\n   285â†’            Edit\n   286â†’          </button>\n   287â†’        )}\n   288â†’        {onDelete && (\n   289â†’          <button \n   290â†’            onClick={() => onDelete(hunt.id)}\n   291â†’            className=\"px-3 py-1 bg-red-500 text-white rounded\"\n   292â†’          >\n   293â†’            Delete\n   294â†’          </button>\n   295â†’        )}\n   296â†’      </div>\n   297â†’    </div>\n   298â†’  );\n   299â†’}\n   300â†’```\n   301â†’\n   302â†’#### Adding Pages\n   303â†’```typescript\n   304â†’// src/app/hunts/page.tsx\n   305â†’import { Metadata } from 'next';\n   306â†’import HuntsList from '@/components/HuntsList';\n   307â†’\n   308â†’export const metadata: Metadata = {\n   309â†’  title: 'My Hunts - FowlData',\n   310â†’  description: 'View and manage your hunting sessions',\n   311â†’};\n   312â†’\n   313â†’export default function HuntsPage() {\n   314â†’  return (\n   315â†’    <div className=\"container mx-auto px-4 py-8\">\n   316â†’      <h1 className=\"text-3xl font-bold mb-8\">My Hunts</h1>\n   317â†’      <HuntsList />\n   318â†’    </div>\n   319â†’  );\n   320â†’}\n   321â†’```\n   322â†’\n   323â†’#### API Integration\n   324â†’```typescript\n   325â†’// src/lib/api/hunts.ts\n   326â†’import { apiClient } from './client';\n   327â†’import type { Hunt, CreateHuntRequest } from '@/lib/types/api';\n   328â†’\n   329â†’export const huntsApi = {\n   330â†’  async getHunts(): Promise<Hunt[]> {\n   331â†’    const response = await apiClient.get('/hunts/');\n   332â†’    return response.json();\n   333â†’  },\n   334â†’\n   335â†’  async createHunt(huntData: CreateHuntRequest): Promise<Hunt> {\n   336â†’    const response = await apiClient.post('/hunts/', huntData);\n   337â†’    return response.json();\n   338â†’  },\n   339â†’\n   340â†’  async updateHunt(huntId: string, huntData: Partial<Hunt>): Promise<Hunt> {\n   341â†’    const response = await apiClient.put(`/hunts/${huntId}/`, huntData);\n   342â†’    return response.json();\n   343â†’  },\n   344â†’\n   345â†’  async deleteHunt(huntId: string): Promise<void> {\n   346â†’    await apiClient.delete(`/hunts/${huntId}/`);\n   347â†’  },\n   348â†’};\n   349â†’```\n   350â†’\n   351â†’#### Forms with React Hook Form\n   352â†’```typescript\n   353â†’// src/components/forms/HuntForm.tsx\n   354â†’import { useForm } from 'react-hook-form';\n   355â†’import { zodResolver } from '@hookform/resolvers/zod';\n   356â†’import { z } from 'zod';\n   357â†’\n   358â†’const huntSchema = z.object({\n   359â†’  date_of_hunt: z.string().min(1, 'Date is required'),\n   360â†’  latitude: z.number().min(-90).max(90),\n   361â†’  longitude: z.number().min(-180).max(180),\n   362â†’  notes: z.string().optional(),\n   363â†’});\n   364â†’\n   365â†’type HuntFormData = z.infer<typeof huntSchema>;\n   366â†’\n   367â†’export default function HuntForm({ onSubmit }: { onSubmit: (data: HuntFormData) => void }) {\n   368â†’  const { register, handleSubmit, formState: { errors } } = useForm<HuntFormData>({\n   369â†’    resolver: zodResolver(huntSchema),\n   370â†’  });\n   371â†’\n   372â†’  return (\n   373â†’    <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\n   374â†’      <div>\n   375â†’        <label htmlFor=\"date_of_hunt\" className=\"block text-sm font-medium text-gray-700\">\n   376â†’          Hunt Date\n   377â†’        </label>\n   378â†’        <input\n   379â†’          {...register('date_of_hunt')}\n   380â†’          type=\"date\"\n   381â†’          className=\"mt-1 block w-full rounded-md border-gray-300 shadow-sm\"\n   382â†’        />\n   383â†’        {errors.date_of_hunt && (\n   384â†’          <p className=\"mt-1 text-sm text-red-600\">{errors.date_of_hunt.message}</p>\n   385â†’        )}\n   386â†’      </div>\n   387â†’      \n   388â†’      <button type=\"submit\" className=\"bg-blue-500 text-white px-4 py-2 rounded\">\n   389â†’        Save Hunt\n   390â†’      </button>\n   391â†’    </form>\n   392â†’  );\n   393â†’}\n   394â†’```\n   395â†’\n   396â†’### Frontend Code Style\n   397â†’\n   398â†’#### TypeScript Configuration\n   399â†’```bash\n   400â†’# Type checking\n   401â†’npx tsc --noEmit\n   402â†’\n   403â†’# Linting\n   404â†’npm run lint\n   405â†’\n   406â†’# Formatting\n   407â†’npx prettier --write .\n   408â†’```\n   409â†’\n   410â†’#### Component Patterns\n   411â†’```typescript\n   412â†’// Use proper TypeScript interfaces\n   413â†’interface Props {\n   414â†’  title: string;\n   415â†’  children: React.ReactNode;\n   416â†’  onAction?: () => void;\n   417â†’}\n   418â†’\n   419â†’// Use proper default exports for pages/components\n   420â†’export default function Component({ title, children, onAction }: Props) {\n   421â†’  return (\n   422â†’    <div>\n   423â†’      <h1>{title}</h1>\n   424â†’      {children}\n   425â†’      {onAction && <button onClick={onAction}>Action</button>}\n   426â†’    </div>\n   427â†’  );\n   428â†’}\n   429â†’\n   430â†’// Use proper error boundaries\n   431â†’import { ErrorBoundary } from 'react-error-boundary';\n   432â†’\n   433â†’function ErrorFallback({ error }: { error: Error }) {\n   434â†’  return (\n   435â†’    <div role=\"alert\" className=\"p-4 bg-red-50 border border-red-200 rounded\">\n   436â†’      <h2 className=\"text-red-800\">Something went wrong:</h2>\n   437â†’      <pre className=\"text-red-600\">{error.message}</pre>\n   438â†’    </div>\n   439â†’  );\n   440â†’}\n   441â†’\n   442â†’// Wrap components that might error\n   443â†’<ErrorBoundary FallbackComponent={ErrorFallback}>\n   444â†’  <SomeComponent />\n   445â†’</ErrorBoundary>\n   446â†’```\n   447â†’\n   448â†’## Development Best Practices\n   449â†’\n   450â†’### Code Quality\n   451â†’\n   452â†’#### Pre-commit Checks\n   453â†’```bash\n   454â†’# Run before committing\n   455â†’./testlint-quick               # Quick validation\n   456â†’npm run lint                   # Code quality\n   457â†’git add . && git commit        # Commit if all pass\n   458â†’```\n   459â†’\n   460â†’#### Code Review Checklist\n   461â†’- [ ] **Functionality**: Code works as intended\n   462â†’- [ ] **Tests**: Adequate test coverage\n   463â†’- [ ] **Performance**: No obvious performance issues\n   464â†’- [ ] **Security**: No security vulnerabilities\n   465â†’- [ ] **Documentation**: Code is well-documented\n   466â†’- [ ] **Style**: Follows project conventions\n   467â†’\n   468â†’### Git Workflow\n   469â†’\n   470â†’#### Commit Message Format\n   471â†’```\n   472â†’feat: Add hunt sharing functionality\n   473â†’fix: Resolve photo upload timeout issue\n   474â†’docs: Update API documentation\n   475â†’test: Add weather API integration tests\n   476â†’refactor: Simplify authentication middleware\n   477â†’perf: Optimize hunt query performance\n   478â†’```\n   479â†’\n   480â†’#### Pull Request Process\n   481â†’1. **Create Feature Branch**: `git checkout -b feature/description`\n   482â†’2. **Implement Changes**: Make focused, atomic commits\n   483â†’3. **Add Tests**: Ensure adequate test coverage\n   484â†’4. **Update Documentation**: Update relevant docs\n   485â†’5. **Run Full Tests**: `./testlint` before creating PR\n   486â†’6. **Create PR**: Use descriptive title and detailed description\n   487â†’7. **Code Review**: Address feedback promptly\n   488â†’8. **Merge**: Squash and merge when approved\n   489â†’\n   490â†’### Debugging\n   491â†’\n   492â†’#### Backend Debugging\n   493â†’```bash\n   494â†’# Django shell with IPython\n   495â†’docker compose exec fowldata python manage.py shell\n   496â†’\n   497â†’# View logs\n   498â†’docker compose logs fowldata\n   499â†’\n   500â†’# Debug specific tests\n   501â†’docker compose exec fowldata python -m pytest -s --pdb test_file.py::test_function\n   502â†’\n   503â†’# Database inspection\n   504â†’docker compose exec fowldata python manage.py dbshell\n   505â†’```\n   506â†’\n   507â†’#### Frontend Debugging\n   508â†’```bash\n   509â†’# Browser dev tools for React components\n   510â†’# React Developer Tools extension\n   511â†’\n   512â†’# Debug API calls\n   513â†’# Check Network tab in browser dev tools\n   514â†’\n   515â†’# Debug tests\n   516â†’npm test -- --no-coverage --verbose\n   517â†’\n   518â†’# Debug Playwright tests\n   519â†’npm run test:e2e -- --debug\n   520â†’```\n   521â†’\n   522â†’### Environment Management\n   523â†’\n   524â†’#### Development Environment Variables\n   525â†’```bash\n   526â†’# .env.local (Backend)\n   527â†’DEBUG=True\n   528â†’SECRET_KEY=development-secret-key\n   529â†’DB_HOST=localhost\n   530â†’WEATHERAPI_KEY=your-development-key\n   531â†’AWS_ACCESS_KEY_ID=your-dev-key\n   532â†’\n   533â†’# frontend/.env.local (Frontend)\n   534â†’NEXTAUTH_URL=http://localhost:3000\n   535â†’NEXT_PUBLIC_API_URL=http://localhost:8000\n   536â†’NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-mapbox-token\n   537â†’```\n   538â†’\n   539â†’#### Service Dependencies\n   540â†’```bash\n   541â†’# Check all services are running\n   542â†’docker compose ps\n   543â†’\n   544â†’# Restart individual services\n   545â†’docker compose restart fowldata\n   546â†’docker compose restart postgres\n   547â†’\n   548â†’# View service logs\n   549â†’docker compose logs -f fowldata\n   550â†’```\n   551â†’\n   552â†’### Performance Optimization\n   553â†’\n   554â†’#### Backend Performance\n   555â†’- **Database Queries**: Use select_related and prefetch_related\n   556â†’- **Caching**: Implement Redis caching for frequent queries\n   557â†’- **API Pagination**: Paginate large result sets\n   558â†’- **Background Tasks**: Use Celery for heavy operations\n   559â†’\n   560â†’```python\n   561â†’# Good: Optimized query\n   562â†’hunts = Hunt.objects.select_related('user').prefetch_related(\n   563â†’    'birds', 'photos', 'location'\n   564â†’).filter(user=request.user)\n   565â†’\n   566â†’# Good: Pagination\n   567â†’from rest_framework.pagination import PageNumberPagination\n   568â†’\n   569â†’class HuntPagination(PageNumberPagination):\n   570â†’    page_size = 20\n   571â†’    page_size_query_param = 'page_size'\n   572â†’    max_page_size = 100\n   573â†’```\n   574â†’\n   575â†’#### Frontend Performance\n   576â†’- **Code Splitting**: Use dynamic imports for large components\n   577â†’- **Image Optimization**: Use Next.js Image component\n   578â†’- **Lazy Loading**: Implement virtualization for long lists\n   579â†’- **Bundle Analysis**: Monitor bundle size\n   580â†’\n   581â†’```typescript\n   582â†’// Good: Code splitting\n   583â†’const MapComponent = dynamic(() => import('@/components/MapComponent'), {\n   584â†’  loading: () => <p>Loading map...</p>,\n   585â†’  ssr: false, // Disable SSR for map components\n   586â†’});\n   587â†’\n   588â†’// Good: Image optimization\n   589â†’import Image from 'next/image';\n   590â†’\n   591â†’<Image\n   592â†’  src=\"/hunt-photo.jpg\"\n   593â†’  alt=\"Hunt location\"\n   594â†’  width={400}\n   595â†’  height={300}\n   596â†’  priority={isAboveFold}\n   597â†’/>\n   598â†’```\n   599â†’\n   600â†’## Tools and Extensions\n   601â†’\n   602â†’### Recommended VS Code Extensions\n   603â†’```json\n   604â†’{\n   605â†’  \"recommendations\": [\n   606â†’    \"ms-python.python\",\n   607â†’    \"ms-python.black-formatter\",\n   608â†’    \"bradlc.vscode-tailwindcss\",\n   609â†’    \"esbenp.prettier-vscode\",\n   610â†’    \"ms-vscode.vscode-typescript-next\",\n   611â†’    \"ms-azuretools.vscode-docker\",\n   612â†’    \"github.copilot\"\n   613â†’  ]\n   614â†’}\n   615â†’```\n   616â†’\n   617â†’### Development Scripts\n   618â†’```bash\n   619â†’# Package.json scripts\n   620â†’npm run dev              # Start development server\n   621â†’npm run build            # Build for production\n   622â†’npm run test             # Run tests\n   623â†’npm run test:watch       # Run tests in watch mode\n   624â†’npm run test:e2e         # Run E2E tests\n   625â†’npm run lint             # Run ESLint\n   626â†’npm run type-check       # Run TypeScript checks\n   627â†’```\n   628â†’\n   629â†’### Useful Development Commands\n   630â†’```bash\n   631â†’# Database reset and reload\n   632â†’docker compose down -v && docker compose up -d\n   633â†’docker compose exec fowldata python manage.py migrate\n   634â†’\n   635â†’# Clear all caches\n   636â†’docker compose exec redis redis-cli FLUSHALL\n   637â†’rm -rf frontend/.next\n   638â†’npm run build\n   639â†’\n   640â†’# Monitor file changes\n   641â†’docker compose logs -f fowldata  # Backend logs\n   642â†’npm run dev                      # Frontend with hot reload\n   643â†’```\n   644â†’\n   645â†’## Troubleshooting\n   646â†’\n   647â†’### Common Issues\n   648â†’\n   649â†’#### Port Conflicts\n   650â†’```bash\n   651â†’# Check what's using ports\n   652â†’lsof -i :3000  # Frontend\n   653â†’lsof -i :8000  # Backend\n   654â†’lsof -i :5432  # PostgreSQL\n   655â†’\n   656â†’# Kill processes or change ports\n   657â†’```\n   658â†’\n   659â†’#### Docker Issues\n   660â†’```bash\n   661â†’# Reset Docker environment\n   662â†’docker compose down -v\n   663â†’docker system prune -f\n   664â†’docker compose up -d --build\n   665â†’```\n   666â†’\n   667â†’#### Database Issues\n   668â†’```bash\n   669â†’# Reset database\n   670â†’docker compose down -v\n   671â†’docker compose up -d\n   672â†’docker compose exec fowldata python manage.py migrate\n   673â†’```\n   674â†’\n   675â†’#### Frontend Build Issues\n   676â†’```bash\n   677â†’# Clear cache and reinstall\n   678â†’rm -rf node_modules package-lock.json .next\n   679â†’npm install\n   680â†’npm run build\n   681â†’```\n   682â†’\n   683â†’### Getting Help\n   684â†’\n   685â†’1. **Check Documentation**: Review relevant docs section\n   686â†’2. **Search Issues**: Look for similar problems in the repository\n   687â†’3. **Run Health Checks**: Use built-in diagnostic tools\n   688â†’4. **Check Logs**: Review service logs for error details\n   689â†’5. **Ask for Help**: Create detailed issue with reproduction steps\n\n<system-reminder>\nWhenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"81d4b854-6ef0-42e1-a4c6-4bcf32ca515d","timestamp":"2025-08-25T04:39:26.450Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/markelmore/_code/fowldata/docs/development.md","content":"# ğŸ’» Development Guide\n\nComplete development workflow and best practices for FowlData development.\n\n## Development Environment Setup\n\n### Prerequisites\n- **Docker** and **Docker Compose** (latest version)\n- **Node.js** 18+ with npm\n- **Git** for version control\n- **VS Code** (recommended) with extensions:\n  - Python\n  - TypeScript and JavaScript\n  - Tailwind CSS IntelliSense\n  - Docker\n  - Prettier\n\n### Quick Start\n```bash\n# Clone and setup\ngit clone [repository-url]\ncd fowldata\n\n# Environment files\ncp .env.example .env.local\ncp frontend/.env.example frontend/.env.local\n\n# Start development\ndocker compose up -d\ncd frontend && npm run dev\n```\n\n## Development Workflow\n\n### Daily Development Routine\n\n1. **Start Services**\n   ```bash\n   docker compose up -d          # Backend services\n   cd frontend && npm run dev    # Frontend development server\n   ```\n\n2. **Check Service Health**\n   ```bash\n   docker compose ps             # Verify all services running\n   curl http://localhost:8000/api/  # Test backend API\n   curl http://localhost:3000    # Test frontend\n   ```\n\n3. **Make Changes**\n   - Edit code in your preferred editor\n   - Backend changes auto-reload with Django\n   - Frontend changes auto-reload with Next.js\n\n4. **Test Changes**\n   ```bash\n   ./testlint-quick             # Quick validation\n   npm run test:watch           # Frontend test watch mode\n   ```\n\n5. **Commit Work**\n   ```bash\n   git add .\n   git commit -m \"descriptive commit message\"\n   git push origin branch-name\n   ```\n\n### Branch Strategy\n\n#### Branch Types\n- **`main`**: Production-ready code\n- **`feature/feature-name`**: New features\n- **`fix/issue-description`**: Bug fixes\n- **`refactor/component-name`**: Code refactoring\n- **`test/test-improvements`**: Test enhancements\n\n#### Workflow\n```bash\n# Create feature branch\ngit checkout -b feature/user-hunt-sharing\ngit push -u origin feature/user-hunt-sharing\n\n# Work on feature...\ngit add .\ngit commit -m \"feat: Add hunt sharing functionality\"\n\n# Keep up to date with main\ngit fetch origin\ngit rebase origin/main\n\n# Create pull request\ngh pr create --title \"Add hunt sharing\" --body \"Implements user hunt sharing with privacy controls\"\n```\n\n## Backend Development (Django)\n\n### Project Structure\n```\nfowldata/\nâ”œâ”€â”€ fowldata/\nâ”‚   â”œâ”€â”€ settings.py           # Django configuration\nâ”‚   â”œâ”€â”€ urls.py              # Root URL configuration\nâ”‚   â””â”€â”€ wsgi.py              # WSGI configuration\nâ”œâ”€â”€ accounts/                # User management app\nâ”‚   â”œâ”€â”€ models.py            # User and profile models\nâ”‚   â”œâ”€â”€ views.py             # Authentication views\nâ”‚   â”œâ”€â”€ authentication.py    # NextAuth JWT backend\nâ”‚   â””â”€â”€ tests/               # Authentication tests\nâ”œâ”€â”€ hunts/                   # Core hunt functionality\nâ”‚   â”œâ”€â”€ models.py            # Hunt, Bird, Photo models\nâ”‚   â”œâ”€â”€ api_views.py         # REST API endpoints\nâ”‚   â”œâ”€â”€ s3_manager.py        # S3 integration\nâ”‚   â”œâ”€â”€ tasks.py             # Background tasks\nâ”‚   â””â”€â”€ tests/               # Hunt functionality tests\nâ””â”€â”€ manage.py                # Django management\n```\n\n### Common Development Tasks\n\n#### Database Operations\n```bash\n# Create migrations\ndocker compose exec fowldata python manage.py makemigrations\n\n# Apply migrations\ndocker compose exec fowldata python manage.py migrate\n\n# Reset database (development)\ndocker compose exec fowldata python manage.py flush\ndocker compose exec fowldata python manage.py migrate\n\n# Create superuser\ndocker compose exec fowldata python manage.py createsuperuser\n\n# Django shell\ndocker compose exec fowldata python manage.py shell\n```\n\n#### Adding New Models\n```python\n# hunts/models.py\nclass NewModel(models.Model):\n    name = models.CharField(max_length=255)\n    created_at = models.DateTimeField(auto_now_add=True)\n    \n    class Meta:\n        db_table = 'hunts_newmodel'\n        \n    def __str__(self):\n        return self.name\n```\n\n```bash\n# Generate and apply migration\ndocker compose exec fowldata python manage.py makemigrations hunts\ndocker compose exec fowldata python manage.py migrate\n```\n\n#### Creating API Endpoints\n```python\n# hunts/api_views.py\nfrom rest_framework.decorators import api_view, permission_classes\nfrom rest_framework.permissions import IsAuthenticated\nfrom rest_framework.response import Response\n\n@api_view(['GET', 'POST'])\n@permission_classes([IsAuthenticated])\ndef new_endpoint(request):\n    if request.method == 'GET':\n        # Handle GET request\n        return Response({'data': 'success'})\n    elif request.method == 'POST':\n        # Handle POST request\n        return Response({'created': True}, status=201)\n```\n\n```python\n# hunts/urls.py\nurlpatterns = [\n    path('new-endpoint/', views.new_endpoint, name='new-endpoint'),\n]\n```\n\n#### Adding Tests\n```python\n# hunts/tests/test_new_feature.py\nimport pytest\nfrom django.urls import reverse\nfrom rest_framework.test import APIClient\n\n@pytest.mark.django_db\ndef test_new_endpoint(authenticated_client):\n    response = authenticated_client.get(reverse('new-endpoint'))\n    assert response.status_code == 200\n    assert response.json()['data'] == 'success'\n```\n\n### Backend Code Style\n\n#### Python Formatting\n```bash\n# Format code\ndocker compose exec fowldata black .\n\n# Check linting\ndocker compose exec fowldata flake8\n\n# Import sorting\ndocker compose exec fowldata isort .\n```\n\n#### Django Best Practices\n- Use Django ORM instead of raw SQL\n- Implement proper error handling\n- Add logging for debugging\n- Use select_related/prefetch_related for performance\n- Follow REST API conventions\n\n```python\n# Good: Optimized query\nhunts = Hunt.objects.select_related('user').prefetch_related('birds', 'photos')\n\n# Good: Proper error handling\ntry:\n    hunt = Hunt.objects.get(id=hunt_id, user=request.user)\nexcept Hunt.DoesNotExist:\n    return Response({'error': 'Hunt not found'}, status=404)\n\n# Good: Logging\nimport logging\nlogger = logging.getLogger(__name__)\n\ndef create_hunt(request):\n    logger.info(f\"Creating hunt for user {request.user.id}\")\n    # ... implementation\n```\n\n## Frontend Development (Next.js)\n\n### Project Structure\n```\nfrontend/\nâ”œâ”€â”€ src/\nâ”‚   â”œâ”€â”€ app/                  # Next.js app router\nâ”‚   â”‚   â”œâ”€â”€ (auth)/          # Authentication routes\nâ”‚   â”‚   â”œâ”€â”€ dashboard/       # Dashboard pages\nâ”‚   â”‚   â””â”€â”€ api/auth/        # NextAuth configuration\nâ”‚   â”œâ”€â”€ components/          # Reusable components\nâ”‚   â”‚   â”œâ”€â”€ ui/              # Basic UI components\nâ”‚   â”‚   â”œâ”€â”€ forms/           # Form components\nâ”‚   â”‚   â””â”€â”€ maps/            # Map components\nâ”‚   â”œâ”€â”€ lib/                 # Utilities and helpers\nâ”‚   â”‚   â”œâ”€â”€ api/             # API client\nâ”‚   â”‚   â”œâ”€â”€ types/           # TypeScript types\nâ”‚   â”‚   â””â”€â”€ utils/           # Utility functions\nâ”‚   â””â”€â”€ styles/              # CSS and styling\nâ”œâ”€â”€ public/                  # Static assets\nâ”œâ”€â”€ e2e/                     # Playwright E2E tests\nâ””â”€â”€ src/__tests__/           # Jest unit tests\n```\n\n### Common Development Tasks\n\n#### Creating Components\n```typescript\n// src/components/HuntCard.tsx\ninterface HuntCardProps {\n  hunt: Hunt;\n  onEdit?: (hunt: Hunt) => void;\n  onDelete?: (huntId: string) => void;\n}\n\nexport default function HuntCard({ hunt, onEdit, onDelete }: HuntCardProps) {\n  return (\n    <div className=\"bg-white rounded-lg shadow-md p-4\">\n      <h3 className=\"text-lg font-semibold\">{hunt.location}</h3>\n      <p className=\"text-gray-600\">{hunt.date_of_hunt}</p>\n      \n      <div className=\"mt-4 flex gap-2\">\n        {onEdit && (\n          <button \n            onClick={() => onEdit(hunt)}\n            className=\"px-3 py-1 bg-blue-500 text-white rounded\"\n          >\n            Edit\n          </button>\n        )}\n        {onDelete && (\n          <button \n            onClick={() => onDelete(hunt.id)}\n            className=\"px-3 py-1 bg-red-500 text-white rounded\"\n          >\n            Delete\n          </button>\n        )}\n      </div>\n    </div>\n  );\n}\n```\n\n#### Adding Pages\n```typescript\n// src/app/hunts/page.tsx\nimport { Metadata } from 'next';\nimport HuntsList from '@/components/HuntsList';\n\nexport const metadata: Metadata = {\n  title: 'My Hunts - FowlData',\n  description: 'View and manage your hunting sessions',\n};\n\nexport default function HuntsPage() {\n  return (\n    <div className=\"container mx-auto px-4 py-8\">\n      <h1 className=\"text-3xl font-bold mb-8\">My Hunts</h1>\n      <HuntsList />\n    </div>\n  );\n}\n```\n\n#### API Integration\n```typescript\n// src/lib/api/hunts.ts\nimport { apiClient } from './client';\nimport type { Hunt, CreateHuntRequest } from '@/lib/types/api';\n\nexport const huntsApi = {\n  async getHunts(): Promise<Hunt[]> {\n    const response = await apiClient.get('/hunts/');\n    return response.json();\n  },\n\n  async createHunt(huntData: CreateHuntRequest): Promise<Hunt> {\n    const response = await apiClient.post('/hunts/', huntData);\n    return response.json();\n  },\n\n  async updateHunt(huntId: string, huntData: Partial<Hunt>): Promise<Hunt> {\n    const response = await apiClient.put(`/hunts/${huntId}/`, huntData);\n    return response.json();\n  },\n\n  async deleteHunt(huntId: string): Promise<void> {\n    await apiClient.delete(`/hunts/${huntId}/`);\n  },\n};\n```\n\n#### Forms with React Hook Form\n```typescript\n// src/components/forms/HuntForm.tsx\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { z } from 'zod';\n\nconst huntSchema = z.object({\n  date_of_hunt: z.string().min(1, 'Date is required'),\n  latitude: z.number().min(-90).max(90),\n  longitude: z.number().min(-180).max(180),\n  notes: z.string().optional(),\n});\n\ntype HuntFormData = z.infer<typeof huntSchema>;\n\nexport default function HuntForm({ onSubmit }: { onSubmit: (data: HuntFormData) => void }) {\n  const { register, handleSubmit, formState: { errors } } = useForm<HuntFormData>({\n    resolver: zodResolver(huntSchema),\n  });\n\n  return (\n    <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\n      <div>\n        <label htmlFor=\"date_of_hunt\" className=\"block text-sm font-medium text-gray-700\">\n          Hunt Date\n        </label>\n        <input\n          {...register('date_of_hunt')}\n          type=\"date\"\n          className=\"mt-1 block w-full rounded-md border-gray-300 shadow-sm\"\n        />\n        {errors.date_of_hunt && (\n          <p className=\"mt-1 text-sm text-red-600\">{errors.date_of_hunt.message}</p>\n        )}\n      </div>\n      \n      <button type=\"submit\" className=\"bg-blue-500 text-white px-4 py-2 rounded\">\n        Save Hunt\n      </button>\n    </form>\n  );\n}\n```\n\n### Frontend Code Style\n\n#### TypeScript Configuration\n```bash\n# Type checking\nnpx tsc --noEmit\n\n# Linting\nnpm run lint\n\n# Formatting\nnpx prettier --write .\n```\n\n#### Component Patterns\n```typescript\n// Use proper TypeScript interfaces\ninterface Props {\n  title: string;\n  children: React.ReactNode;\n  onAction?: () => void;\n}\n\n// Use proper default exports for pages/components\nexport default function Component({ title, children, onAction }: Props) {\n  return (\n    <div>\n      <h1>{title}</h1>\n      {children}\n      {onAction && <button onClick={onAction}>Action</button>}\n    </div>\n  );\n}\n\n// Use proper error boundaries\nimport { ErrorBoundary } from 'react-error-boundary';\n\nfunction ErrorFallback({ error }: { error: Error }) {\n  return (\n    <div role=\"alert\" className=\"p-4 bg-red-50 border border-red-200 rounded\">\n      <h2 className=\"text-red-800\">Something went wrong:</h2>\n      <pre className=\"text-red-600\">{error.message}</pre>\n    </div>\n  );\n}\n\n// Wrap components that might error\n<ErrorBoundary FallbackComponent={ErrorFallback}>\n  <SomeComponent />\n</ErrorBoundary>\n```\n\n## Development Best Practices\n\n### Code Quality\n\n#### Pre-commit Checks\n```bash\n# Run before committing\n./testlint-quick               # Quick validation\nnpm run lint                   # Code quality\ngit add . && git commit        # Commit if all pass\n```\n\n#### Code Review Checklist\n- [ ] **Functionality**: Code works as intended\n- [ ] **Tests**: Adequate test coverage\n- [ ] **Performance**: No obvious performance issues\n- [ ] **Security**: No security vulnerabilities\n- [ ] **Documentation**: Code is well-documented\n- [ ] **Style**: Follows project conventions\n\n### Git Workflow\n\n#### Commit Message Format\n```\nfeat: Add hunt sharing functionality\nfix: Resolve photo upload timeout issue\ndocs: Update API documentation\ntest: Add weather API integration tests\nrefactor: Simplify authentication middleware\nperf: Optimize hunt query performance\n```\n\n#### Pull Request Process\n1. **Create Feature Branch**: `git checkout -b feature/description`\n2. **Implement Changes**: Make focused, atomic commits\n3. **Add Tests**: Ensure adequate test coverage\n4. **Update Documentation**: Update relevant docs\n5. **Run Full Tests**: `./testlint` before creating PR\n6. **Create PR**: Use descriptive title and detailed description\n7. **Code Review**: Address feedback promptly\n8. **Merge**: Squash and merge when approved\n\n### Debugging\n\n#### Backend Debugging\n```bash\n# Django shell with IPython\ndocker compose exec fowldata python manage.py shell\n\n# View logs\ndocker compose logs fowldata\n\n# Debug specific tests\ndocker compose exec fowldata python -m pytest -s --pdb test_file.py::test_function\n\n# Database inspection\ndocker compose exec fowldata python manage.py dbshell\n```\n\n#### Frontend Debugging\n```bash\n# Browser dev tools for React components\n# React Developer Tools extension\n\n# Debug API calls\n# Check Network tab in browser dev tools\n\n# Debug tests\nnpm test -- --no-coverage --verbose\n\n# Debug Playwright tests\nnpm run test:e2e -- --debug\n```\n\n### Environment Management\n\n#### Development Environment Variables\n```bash\n# .env.local (Backend)\nDEBUG=True\nSECRET_KEY=development-secret-key\nDB_HOST=localhost\nWEATHERAPI_KEY=your-development-key\nAWS_ACCESS_KEY_ID=your-dev-key\n\n# frontend/.env.local (Frontend)\nNEXTAUTH_URL=http://localhost:3000\nNEXT_PUBLIC_API_URL=http://localhost:8000\nNEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-mapbox-token\n```\n\n#### Service Dependencies\n```bash\n# Check all services are running\ndocker compose ps\n\n# Restart individual services\ndocker compose restart fowldata\ndocker compose restart postgres\n\n# View service logs\ndocker compose logs -f fowldata\n```\n\n### Performance Optimization\n\n#### Backend Performance\n- **Database Queries**: Use select_related and prefetch_related\n- **Caching**: Implement Redis caching for frequent queries\n- **API Pagination**: Paginate large result sets\n- **Background Tasks**: Use Celery for heavy operations\n\n```python\n# Good: Optimized query\nhunts = Hunt.objects.select_related('user').prefetch_related(\n    'birds', 'photos', 'location'\n).filter(user=request.user)\n\n# Good: Pagination\nfrom rest_framework.pagination import PageNumberPagination\n\nclass HuntPagination(PageNumberPagination):\n    page_size = 20\n    page_size_query_param = 'page_size'\n    max_page_size = 100\n```\n\n#### Frontend Performance\n- **Code Splitting**: Use dynamic imports for large components\n- **Image Optimization**: Use Next.js Image component\n- **Lazy Loading**: Implement virtualization for long lists\n- **Bundle Analysis**: Monitor bundle size\n\n```typescript\n// Good: Code splitting\nconst MapComponent = dynamic(() => import('@/components/MapComponent'), {\n  loading: () => <p>Loading map...</p>,\n  ssr: false, // Disable SSR for map components\n});\n\n// Good: Image optimization\nimport Image from 'next/image';\n\n<Image\n  src=\"/hunt-photo.jpg\"\n  alt=\"Hunt location\"\n  width={400}\n  height={300}\n  priority={isAboveFold}\n/>\n```\n\n## Tools and Extensions\n\n### Recommended VS Code Extensions\n```json\n{\n  \"recommendations\": [\n    \"ms-python.python\",\n    \"ms-python.black-formatter\",\n    \"bradlc.vscode-tailwindcss\",\n    \"esbenp.prettier-vscode\",\n    \"ms-vscode.vscode-typescript-next\",\n    \"ms-azuretools.vscode-docker\",\n    \"github.copilot\"\n  ]\n}\n```\n\n### Development Scripts\n```bash\n# Package.json scripts\nnpm run dev              # Start development server\nnpm run build            # Build for production\nnpm run test             # Run tests\nnpm run test:watch       # Run tests in watch mode\nnpm run test:e2e         # Run E2E tests\nnpm run lint             # Run ESLint\nnpm run type-check       # Run TypeScript checks\n```\n\n### Useful Development Commands\n```bash\n# Database reset and reload\ndocker compose down -v && docker compose up -d\ndocker compose exec fowldata python manage.py migrate\n\n# Clear all caches\ndocker compose exec redis redis-cli FLUSHALL\nrm -rf frontend/.next\nnpm run build\n\n# Monitor file changes\ndocker compose logs -f fowldata  # Backend logs\nnpm run dev                      # Frontend with hot reload\n```\n\n## Troubleshooting\n\n### Common Issues\n\n#### Port Conflicts\n```bash\n# Check what's using ports\nlsof -i :3000  # Frontend\nlsof -i :8000  # Backend\nlsof -i :5432  # PostgreSQL\n\n# Kill processes or change ports\n```\n\n#### Docker Issues\n```bash\n# Reset Docker environment\ndocker compose down -v\ndocker system prune -f\ndocker compose up -d --build\n```\n\n#### Database Issues\n```bash\n# Reset database\ndocker compose down -v\ndocker compose up -d\ndocker compose exec fowldata python manage.py migrate\n```\n\n#### Frontend Build Issues\n```bash\n# Clear cache and reinstall\nrm -rf node_modules package-lock.json .next\nnpm install\nnpm run build\n```\n\n### Getting Help\n\n1. **Check Documentation**: Review relevant docs section\n2. **Search Issues**: Look for similar problems in the repository\n3. **Run Health Checks**: Use built-in diagnostic tools\n4. **Check Logs**: Review service logs for error details\n5. **Ask for Help**: Create detailed issue with reproduction steps","numLines":689,"startLine":1,"totalLines":689}}}
{"parentUuid":"81d4b854-6ef0-42e1-a4c6-4bcf32ca515d","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01K7f4iup3GyanzBqSbASoZh","type":"tool_result","content":"     1â†’# Deployment Guide\n     2â†’\n     3â†’This guide covers deploying FowlData to production environments, with detailed instructions for Digital Ocean deployment.\n     4â†’\n     5â†’## Overview\n     6â†’\n     7â†’FowlData supports multiple deployment strategies:\n     8â†’- **Digital Ocean Droplets** (Recommended) - Complete setup guide included\n     9â†’- **Docker Compose** - Self-hosted on any Docker-compatible server\n    10â†’- **Container Orchestration** - Kubernetes, Docker Swarm (advanced)\n    11â†’\n    12â†’## Digital Ocean Deployment (Recommended)\n    13â†’\n    14â†’For complete Digital Ocean deployment instructions, see [DIGITAL_OCEAN_DEPLOYMENT.md](./DIGITAL_OCEAN_DEPLOYMENT.md).\n    15â†’\n    16â†’### Quick Digital Ocean Setup\n    17â†’\n    18â†’1. **Create Droplet** (minimum 2GB RAM, Ubuntu 22.04)\n    19â†’2. **Install Dependencies**:\n    20â†’   ```bash\n    21â†’   apt update && apt upgrade -y\n    22â†’   apt install docker.io docker-compose git curl -y\n    23â†’   ```\n    24â†’3. **Deploy Application**:\n    25â†’   ```bash\n    26â†’   git clone https://github.com/elmorem/fowldata.git\n    27â†’   cd fowldata\n    28â†’   ./scripts/validate-production.sh\n    29â†’   docker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n    30â†’   ```\n    31â†’\n    32â†’## Production Architecture\n    33â†’\n    34â†’```\n    35â†’Internet â†’ Nginx (SSL/Reverse Proxy) â†’ Frontend (Next.js) â†’ Backend (Django) â†’ PostgreSQL + PostGIS\n    36â†’                                     â†’ Redis (Caching)\n    37â†’                                     â†’ S3 (Photo Storage)\n    38â†’```\n    39â†’\n    40â†’### Components\n    41â†’\n    42â†’- **Nginx**: SSL termination, reverse proxy, static file serving, rate limiting\n    43â†’- **Frontend**: Next.js 15 with Server-Side Rendering \n    44â†’- **Backend**: Django 4.2 with Gunicorn WSGI server\n    45â†’- **Database**: PostgreSQL 16 with PostGIS 3.4 for geospatial data\n    46â†’- **Cache**: Redis for session storage and caching\n    47â†’- **Storage**: AWS S3 for photo uploads with CloudFront CDN\n    48â†’\n    49â†’## Environment Configuration\n    50â†’\n    51â†’### Production Environment Variables\n    52â†’\n    53â†’#### Root .env.production\n    54â†’```bash\n    55â†’# Database Configuration\n    56â†’DB_HOST=postgres\n    57â†’DB_NAME=fowldata_prod\n    58â†’DB_USER=fowldata_user\n    59â†’DB_PASS=your_secure_password\n    60â†’DB_PORT=5432\n    61â†’\n    62â†’# Django Settings\n    63â†’SECRET_KEY=your-production-secret-key\n    64â†’DEBUG=False\n    65â†’ALLOWED_HOSTS=fowldata.com,www.fowldata.com,api.fowldata.com\n    66â†’\n    67â†’# Security Settings\n    68â†’SECURE_HSTS_SECONDS=31536000\n    69â†’SECURE_HSTS_INCLUDE_SUBDOMAINS=True\n    70â†’SECURE_HSTS_PRELOAD=True\n    71â†’SECURE_SSL_REDIRECT=True\n    72â†’\n    73â†’# AWS S3 Configuration\n    74â†’AWS_ACCESS_KEY_ID=your_access_key\n    75â†’AWS_SECRET_ACCESS_KEY=your_secret_key\n    76â†’AWS_S3_BUCKET_NAME=fowldata-photos-prod\n    77â†’AWS_REGION=us-west-2\n    78â†’\n    79â†’# Redis Configuration\n    80â†’REDIS_PASSWORD=your_redis_password\n    81â†’\n    82â†’# External APIs\n    83â†’WEATHER_API_KEY=your_weather_api_key\n    84â†’```\n    85â†’\n    86â†’#### Frontend frontend/.env.production\n    87â†’```bash\n    88â†’# NextAuth Configuration\n    89â†’AUTH_SECRET=your-nextauth-secret\n    90â†’NEXTAUTH_URL=https://www.fowldata.com\n    91â†’\n    92â†’# OAuth Providers\n    93â†’GOOGLE_CLIENT_ID=your_google_client_id\n    94â†’GOOGLE_CLIENT_SECRET=your_google_client_secret\n    95â†’\n    96â†’# API Configuration\n    97â†’NEXT_PUBLIC_API_URL=https://www.fowldata.com/api\n    98â†’BACKEND_URL=http://fowldata:8000\n    99â†’\n   100â†’# Mapbox Configuration (CRITICAL)\n   101â†’NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your_mapbox_token\n   102â†’\n   103â†’# S3 Upload Configuration\n   104â†’NEXT_PUBLIC_AWS_S3_UPLOAD_URL=https://fowldata-photos-prod.s3.us-west-2.amazonaws.com\n   105â†’```\n   106â†’\n   107â†’## SSL/TLS Configuration\n   108â†’\n   109â†’### Let's Encrypt Setup (Recommended)\n   110â†’\n   111â†’```bash\n   112â†’# Install Certbot\n   113â†’sudo apt update && apt install certbot\n   114â†’\n   115â†’# Get SSL certificates\n   116â†’sudo certbot certonly --webroot -w /var/www/certbot \\\n   117â†’  -d fowldata.com -d www.fowldata.com\n   118â†’\n   119â†’# Copy certificates to application directory\n   120â†’sudo cp /etc/letsencrypt/live/www.fowldata.com/fullchain.pem ssl/\n   121â†’sudo cp /etc/letsencrypt/live/www.fowldata.com/privkey.pem ssl/\n   122â†’sudo cp /etc/letsencrypt/live/www.fowldata.com/chain.pem ssl/\n   123â†’\n   124â†’# Set proper permissions\n   125â†’sudo chown -R $USER:$USER ssl/\n   126â†’chmod 644 ssl/fullchain.pem ssl/chain.pem\n   127â†’chmod 600 ssl/privkey.pem\n   128â†’\n   129â†’# Restart Nginx to load certificates\n   130â†’docker-compose -f docker-compose.prod.yaml restart nginx\n   131â†’```\n   132â†’\n   133â†’### Auto-Renewal Setup\n   134â†’```bash\n   135â†’# Add to crontab for automatic renewal\n   136â†’echo \"0 12 * * * /usr/bin/certbot renew --quiet && docker-compose -f /path/to/fowldata/docker-compose.prod.yaml restart nginx\" | sudo crontab -\n   137â†’```\n   138â†’\n   139â†’## Security Configuration\n   140â†’\n   141â†’### Firewall Setup\n   142â†’```bash\n   143â†’# Configure UFW firewall\n   144â†’sudo ufw enable\n   145â†’sudo ufw default deny incoming\n   146â†’sudo ufw default allow outgoing\n   147â†’sudo ufw allow ssh\n   148â†’sudo ufw allow 80/tcp   # HTTP\n   149â†’sudo ufw allow 443/tcp  # HTTPS\n   150â†’```\n   151â†’\n   152â†’### Nginx Security Headers\n   153â†’The production Nginx configuration includes:\n   154â†’- HSTS (HTTP Strict Transport Security)\n   155â†’- Content Security Policy\n   156â†’- X-Frame-Options\n   157â†’- X-Content-Type-Options\n   158â†’- Rate limiting\n   159â†’- Bot protection\n   160â†’\n   161â†’### Database Security\n   162â†’- Non-root PostgreSQL users with limited privileges\n   163â†’- Connection limits and authentication controls\n   164â†’- SSL/TLS connections enforced\n   165â†’- Regular automated backups\n   166â†’\n   167â†’## Monitoring & Health Checks\n   168â†’\n   169â†’### Application Health Endpoints\n   170â†’- **Frontend**: `GET /health.json`\n   171â†’- **Backend**: `GET /api/health/`\n   172â†’- **Database**: Custom health check function\n   173â†’\n   174â†’### Docker Health Checks\n   175â†’All services include health check configurations:\n   176â†’```yaml\n   177â†’healthcheck:\n   178â†’  test: [\"CMD-SHELL\", \"curl -f http://localhost:8000/api/health/ || exit 1\"]\n   179â†’  interval: 30s\n   180â†’  timeout: 10s\n   181â†’  retries: 3\n   182â†’```\n   183â†’\n   184â†’### Log Management\n   185â†’```bash\n   186â†’# View application logs\n   187â†’docker-compose -f docker-compose.prod.yaml logs -f fowldata\n   188â†’docker-compose -f docker-compose.prod.yaml logs -f frontend\n   189â†’docker-compose -f docker-compose.prod.yaml logs -f postgres\n   190â†’\n   191â†’# View Nginx access logs\n   192â†’docker-compose -f docker-compose.prod.yaml exec nginx tail -f /var/log/nginx/access.log\n   193â†’```\n   194â†’\n   195â†’## Backup Strategy\n   196â†’\n   197â†’### Database Backups\n   198â†’```bash\n   199â†’# Create database backup\n   200â†’docker-compose -f docker-compose.prod.yaml exec postgres \\\n   201â†’  pg_dump -U fowldata_user fowldata_prod > backup_$(date +%Y%m%d_%H%M%S).sql\n   202â†’\n   203â†’# Automated daily backups (add to crontab)\n   204â†’0 2 * * * cd /path/to/fowldata && ./scripts/backup-database.sh\n   205â†’```\n   206â†’\n   207â†’### Media File Backups\n   208â†’```bash\n   209â†’# Backup Docker volumes\n   210â†’docker run --rm -v fowldata-media-files-prod:/data -v $(pwd):/backup alpine \\\n   211â†’  tar czf /backup/media-backup-$(date +%Y%m%d).tar.gz -C /data .\n   212â†’```\n   213â†’\n   214â†’## Performance Optimization\n   215â†’\n   216â†’### Database Optimization\n   217â†’- Connection pooling configured\n   218â†’- Query performance monitoring with pg_stat_statements\n   219â†’- Proper indexing for geospatial queries\n   220â†’- Automated VACUUM and ANALYZE\n   221â†’\n   222â†’### Frontend Optimization\n   223â†’- Next.js standalone build for minimal container size\n   224â†’- Static file compression via Nginx\n   225â†’- CloudFront CDN for S3 assets\n   226â†’- Image optimization and lazy loading\n   227â†’\n   228â†’### Caching Strategy\n   229â†’- Redis for session storage\n   230â†’- Django query caching with django-cachalot\n   231â†’- Nginx static file caching\n   232â†’- Browser caching headers\n   233â†’\n   234â†’## Scaling Considerations\n   235â†’\n   236â†’### Horizontal Scaling\n   237â†’- Multiple frontend containers with load balancer\n   238â†’- Database read replicas for read-heavy workloads\n   239â†’- Separate media server for large file handling\n   240â†’\n   241â†’### Vertical Scaling\n   242â†’- Recommended minimum: 2GB RAM, 2 CPU cores\n   243â†’- Production recommended: 4GB RAM, 4 CPU cores\n   244â†’- Database-heavy workloads: 8GB+ RAM\n   245â†’\n   246â†’## Troubleshooting\n   247â†’\n   248â†’### Common Deployment Issues\n   249â†’\n   250â†’1. **Environment Variables Not Loading**\n   251â†’   ```bash\n   252â†’   # Always use explicit env-file flag\n   253â†’   docker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n   254â†’   ```\n   255â†’\n   256â†’2. **SSL Certificate Issues**\n   257â†’   ```bash\n   258â†’   # Verify certificate files and permissions\n   259â†’   ls -la ssl/\n   260â†’   openssl x509 -in ssl/fullchain.pem -text -noout\n   261â†’   ```\n   262â†’\n   263â†’3. **Database Connection Failures**\n   264â†’   ```bash\n   265â†’   # Check database logs and connectivity\n   266â†’   docker-compose -f docker-compose.prod.yaml logs postgres\n   267â†’   docker-compose -f docker-compose.prod.yaml exec fowldata python manage.py dbshell\n   268â†’   ```\n   269â†’\n   270â†’4. **Mapbox Layer Rendering Issues**\n   271â†’   - Verify NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN is set in both files\n   272â†’   - Check browser console for GL JS errors\n   273â†’   - Ensure token has proper permissions\n   274â†’\n   275â†’### Rollback Procedure\n   276â†’```bash\n   277â†’# Quick rollback to previous version\n   278â†’git checkout previous-working-commit\n   279â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate\n   280â†’```\n   281â†’\n   282â†’## Maintenance\n   283â†’\n   284â†’### Regular Maintenance Tasks\n   285â†’- Monitor disk usage and clean old Docker images\n   286â†’- Update SSL certificates (automated with Let's Encrypt)\n   287â†’- Review security logs and access patterns\n   288â†’- Database performance analysis and optimization\n   289â†’- Update dependencies and security patches\n   290â†’\n   291â†’### Scheduled Maintenance\n   292â†’```bash\n   293â†’# Weekly maintenance script\n   294â†’./scripts/weekly-maintenance.sh\n   295â†’\n   296â†’# Includes:\n   297â†’# - Docker system cleanup\n   298â†’# - Database maintenance\n   299â†’# - Log rotation\n   300â†’# - Security updates\n   301â†’```\n   302â†’\n   303â†’For detailed deployment instructions specific to Digital Ocean, see [DIGITAL_OCEAN_DEPLOYMENT.md](./DIGITAL_OCEAN_DEPLOYMENT.md).\n\n<system-reminder>\nWhenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"6f5f3337-876d-48c9-8d05-214237f2bcdf","timestamp":"2025-08-25T04:39:26.450Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/markelmore/_code/fowldata/docs/deployment.md","content":"# Deployment Guide\n\nThis guide covers deploying FowlData to production environments, with detailed instructions for Digital Ocean deployment.\n\n## Overview\n\nFowlData supports multiple deployment strategies:\n- **Digital Ocean Droplets** (Recommended) - Complete setup guide included\n- **Docker Compose** - Self-hosted on any Docker-compatible server\n- **Container Orchestration** - Kubernetes, Docker Swarm (advanced)\n\n## Digital Ocean Deployment (Recommended)\n\nFor complete Digital Ocean deployment instructions, see [DIGITAL_OCEAN_DEPLOYMENT.md](./DIGITAL_OCEAN_DEPLOYMENT.md).\n\n### Quick Digital Ocean Setup\n\n1. **Create Droplet** (minimum 2GB RAM, Ubuntu 22.04)\n2. **Install Dependencies**:\n   ```bash\n   apt update && apt upgrade -y\n   apt install docker.io docker-compose git curl -y\n   ```\n3. **Deploy Application**:\n   ```bash\n   git clone https://github.com/elmorem/fowldata.git\n   cd fowldata\n   ./scripts/validate-production.sh\n   docker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n   ```\n\n## Production Architecture\n\n```\nInternet â†’ Nginx (SSL/Reverse Proxy) â†’ Frontend (Next.js) â†’ Backend (Django) â†’ PostgreSQL + PostGIS\n                                     â†’ Redis (Caching)\n                                     â†’ S3 (Photo Storage)\n```\n\n### Components\n\n- **Nginx**: SSL termination, reverse proxy, static file serving, rate limiting\n- **Frontend**: Next.js 15 with Server-Side Rendering \n- **Backend**: Django 4.2 with Gunicorn WSGI server\n- **Database**: PostgreSQL 16 with PostGIS 3.4 for geospatial data\n- **Cache**: Redis for session storage and caching\n- **Storage**: AWS S3 for photo uploads with CloudFront CDN\n\n## Environment Configuration\n\n### Production Environment Variables\n\n#### Root .env.production\n```bash\n# Database Configuration\nDB_HOST=postgres\nDB_NAME=fowldata_prod\nDB_USER=fowldata_user\nDB_PASS=your_secure_password\nDB_PORT=5432\n\n# Django Settings\nSECRET_KEY=your-production-secret-key\nDEBUG=False\nALLOWED_HOSTS=fowldata.com,www.fowldata.com,api.fowldata.com\n\n# Security Settings\nSECURE_HSTS_SECONDS=31536000\nSECURE_HSTS_INCLUDE_SUBDOMAINS=True\nSECURE_HSTS_PRELOAD=True\nSECURE_SSL_REDIRECT=True\n\n# AWS S3 Configuration\nAWS_ACCESS_KEY_ID=your_access_key\nAWS_SECRET_ACCESS_KEY=your_secret_key\nAWS_S3_BUCKET_NAME=fowldata-photos-prod\nAWS_REGION=us-west-2\n\n# Redis Configuration\nREDIS_PASSWORD=your_redis_password\n\n# External APIs\nWEATHER_API_KEY=your_weather_api_key\n```\n\n#### Frontend frontend/.env.production\n```bash\n# NextAuth Configuration\nAUTH_SECRET=your-nextauth-secret\nNEXTAUTH_URL=https://www.fowldata.com\n\n# OAuth Providers\nGOOGLE_CLIENT_ID=your_google_client_id\nGOOGLE_CLIENT_SECRET=your_google_client_secret\n\n# API Configuration\nNEXT_PUBLIC_API_URL=https://www.fowldata.com/api\nBACKEND_URL=http://fowldata:8000\n\n# Mapbox Configuration (CRITICAL)\nNEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your_mapbox_token\n\n# S3 Upload Configuration\nNEXT_PUBLIC_AWS_S3_UPLOAD_URL=https://fowldata-photos-prod.s3.us-west-2.amazonaws.com\n```\n\n## SSL/TLS Configuration\n\n### Let's Encrypt Setup (Recommended)\n\n```bash\n# Install Certbot\nsudo apt update && apt install certbot\n\n# Get SSL certificates\nsudo certbot certonly --webroot -w /var/www/certbot \\\n  -d fowldata.com -d www.fowldata.com\n\n# Copy certificates to application directory\nsudo cp /etc/letsencrypt/live/www.fowldata.com/fullchain.pem ssl/\nsudo cp /etc/letsencrypt/live/www.fowldata.com/privkey.pem ssl/\nsudo cp /etc/letsencrypt/live/www.fowldata.com/chain.pem ssl/\n\n# Set proper permissions\nsudo chown -R $USER:$USER ssl/\nchmod 644 ssl/fullchain.pem ssl/chain.pem\nchmod 600 ssl/privkey.pem\n\n# Restart Nginx to load certificates\ndocker-compose -f docker-compose.prod.yaml restart nginx\n```\n\n### Auto-Renewal Setup\n```bash\n# Add to crontab for automatic renewal\necho \"0 12 * * * /usr/bin/certbot renew --quiet && docker-compose -f /path/to/fowldata/docker-compose.prod.yaml restart nginx\" | sudo crontab -\n```\n\n## Security Configuration\n\n### Firewall Setup\n```bash\n# Configure UFW firewall\nsudo ufw enable\nsudo ufw default deny incoming\nsudo ufw default allow outgoing\nsudo ufw allow ssh\nsudo ufw allow 80/tcp   # HTTP\nsudo ufw allow 443/tcp  # HTTPS\n```\n\n### Nginx Security Headers\nThe production Nginx configuration includes:\n- HSTS (HTTP Strict Transport Security)\n- Content Security Policy\n- X-Frame-Options\n- X-Content-Type-Options\n- Rate limiting\n- Bot protection\n\n### Database Security\n- Non-root PostgreSQL users with limited privileges\n- Connection limits and authentication controls\n- SSL/TLS connections enforced\n- Regular automated backups\n\n## Monitoring & Health Checks\n\n### Application Health Endpoints\n- **Frontend**: `GET /health.json`\n- **Backend**: `GET /api/health/`\n- **Database**: Custom health check function\n\n### Docker Health Checks\nAll services include health check configurations:\n```yaml\nhealthcheck:\n  test: [\"CMD-SHELL\", \"curl -f http://localhost:8000/api/health/ || exit 1\"]\n  interval: 30s\n  timeout: 10s\n  retries: 3\n```\n\n### Log Management\n```bash\n# View application logs\ndocker-compose -f docker-compose.prod.yaml logs -f fowldata\ndocker-compose -f docker-compose.prod.yaml logs -f frontend\ndocker-compose -f docker-compose.prod.yaml logs -f postgres\n\n# View Nginx access logs\ndocker-compose -f docker-compose.prod.yaml exec nginx tail -f /var/log/nginx/access.log\n```\n\n## Backup Strategy\n\n### Database Backups\n```bash\n# Create database backup\ndocker-compose -f docker-compose.prod.yaml exec postgres \\\n  pg_dump -U fowldata_user fowldata_prod > backup_$(date +%Y%m%d_%H%M%S).sql\n\n# Automated daily backups (add to crontab)\n0 2 * * * cd /path/to/fowldata && ./scripts/backup-database.sh\n```\n\n### Media File Backups\n```bash\n# Backup Docker volumes\ndocker run --rm -v fowldata-media-files-prod:/data -v $(pwd):/backup alpine \\\n  tar czf /backup/media-backup-$(date +%Y%m%d).tar.gz -C /data .\n```\n\n## Performance Optimization\n\n### Database Optimization\n- Connection pooling configured\n- Query performance monitoring with pg_stat_statements\n- Proper indexing for geospatial queries\n- Automated VACUUM and ANALYZE\n\n### Frontend Optimization\n- Next.js standalone build for minimal container size\n- Static file compression via Nginx\n- CloudFront CDN for S3 assets\n- Image optimization and lazy loading\n\n### Caching Strategy\n- Redis for session storage\n- Django query caching with django-cachalot\n- Nginx static file caching\n- Browser caching headers\n\n## Scaling Considerations\n\n### Horizontal Scaling\n- Multiple frontend containers with load balancer\n- Database read replicas for read-heavy workloads\n- Separate media server for large file handling\n\n### Vertical Scaling\n- Recommended minimum: 2GB RAM, 2 CPU cores\n- Production recommended: 4GB RAM, 4 CPU cores\n- Database-heavy workloads: 8GB+ RAM\n\n## Troubleshooting\n\n### Common Deployment Issues\n\n1. **Environment Variables Not Loading**\n   ```bash\n   # Always use explicit env-file flag\n   docker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n   ```\n\n2. **SSL Certificate Issues**\n   ```bash\n   # Verify certificate files and permissions\n   ls -la ssl/\n   openssl x509 -in ssl/fullchain.pem -text -noout\n   ```\n\n3. **Database Connection Failures**\n   ```bash\n   # Check database logs and connectivity\n   docker-compose -f docker-compose.prod.yaml logs postgres\n   docker-compose -f docker-compose.prod.yaml exec fowldata python manage.py dbshell\n   ```\n\n4. **Mapbox Layer Rendering Issues**\n   - Verify NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN is set in both files\n   - Check browser console for GL JS errors\n   - Ensure token has proper permissions\n\n### Rollback Procedure\n```bash\n# Quick rollback to previous version\ngit checkout previous-working-commit\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate\n```\n\n## Maintenance\n\n### Regular Maintenance Tasks\n- Monitor disk usage and clean old Docker images\n- Update SSL certificates (automated with Let's Encrypt)\n- Review security logs and access patterns\n- Database performance analysis and optimization\n- Update dependencies and security patches\n\n### Scheduled Maintenance\n```bash\n# Weekly maintenance script\n./scripts/weekly-maintenance.sh\n\n# Includes:\n# - Docker system cleanup\n# - Database maintenance\n# - Log rotation\n# - Security updates\n```\n\nFor detailed deployment instructions specific to Digital Ocean, see [DIGITAL_OCEAN_DEPLOYMENT.md](./DIGITAL_OCEAN_DEPLOYMENT.md).","numLines":303,"startLine":1,"totalLines":303}}}
{"parentUuid":"6f5f3337-876d-48c9-8d05-214237f2bcdf","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01FUFBv7RVM5hDpskF618jLu","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"Now let me read several more key documentation files to get a comprehensive understanding:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":15398,"cache_read_input_tokens":33434,"cache_creation":{"ephemeral_5m_input_tokens":15398,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTp1yX4cxzZdSsDzkdgS","type":"assistant","uuid":"fc7d1c45-13a2-410f-9b30-f10b3e073e99","timestamp":"2025-08-25T04:39:32.356Z"}
{"parentUuid":"fc7d1c45-13a2-410f-9b30-f10b3e073e99","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01FUFBv7RVM5hDpskF618jLu","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_013QS7DH1R59efeaWTxvthFo","name":"Read","input":{"file_path":"/Users/markelmore/_code/fowldata/docs/environment-variables.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":15398,"cache_read_input_tokens":33434,"cache_creation":{"ephemeral_5m_input_tokens":15398,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTp1yX4cxzZdSsDzkdgS","type":"assistant","uuid":"408b6a32-0db9-4544-bffb-5cc2a4436384","timestamp":"2025-08-25T04:39:33.135Z"}
{"parentUuid":"408b6a32-0db9-4544-bffb-5cc2a4436384","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01FUFBv7RVM5hDpskF618jLu","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01CvaTw4TrQ7NJctTB4ig6vf","name":"Read","input":{"file_path":"/Users/markelmore/_code/fowldata/docs/testing.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":15398,"cache_read_input_tokens":33434,"cache_creation":{"ephemeral_5m_input_tokens":15398,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTp1yX4cxzZdSsDzkdgS","type":"assistant","uuid":"6f134626-9030-4cf9-9fdc-1a55b571068e","timestamp":"2025-08-25T04:39:33.710Z"}
{"parentUuid":"6f134626-9030-4cf9-9fdc-1a55b571068e","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01FUFBv7RVM5hDpskF618jLu","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01XuNLAuyTEGBEYcD4EP4KL7","name":"Read","input":{"file_path":"/Users/markelmore/_code/fowldata/docs/authentication.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":15398,"cache_read_input_tokens":33434,"cache_creation":{"ephemeral_5m_input_tokens":15398,"ephemeral_1h_input_tokens":0},"output_tokens":247,"service_tier":"standard"}},"requestId":"req_011CSTp1yX4cxzZdSsDzkdgS","type":"assistant","uuid":"975b0acb-c881-4a6a-942a-9319bc15b402","timestamp":"2025-08-25T04:39:34.253Z"}
{"parentUuid":"975b0acb-c881-4a6a-942a-9319bc15b402","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01FUFBv7RVM5hDpskF618jLu","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01L7wtzhPq5SUf7Uv5LcmgQb","name":"Read","input":{"file_path":"/Users/markelmore/_code/fowldata/docs/mapping.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":15398,"cache_read_input_tokens":33434,"cache_creation":{"ephemeral_5m_input_tokens":15398,"ephemeral_1h_input_tokens":0},"output_tokens":247,"service_tier":"standard"}},"requestId":"req_011CSTp1yX4cxzZdSsDzkdgS","type":"assistant","uuid":"3502b415-459c-4741-9ac8-7d31429aeb12","timestamp":"2025-08-25T04:39:34.413Z"}
{"parentUuid":"3502b415-459c-4741-9ac8-7d31429aeb12","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013QS7DH1R59efeaWTxvthFo","type":"tool_result","content":"     1â†’# Environment Variables Reference\n     2â†’\n     3â†’Complete guide to configuring FowlData environment variables for development and production.\n     4â†’\n     5â†’## Environment File Structure\n     6â†’\n     7â†’FowlData uses multiple environment files for different contexts:\n     8â†’\n     9â†’```\n    10â†’fowldata/\n    11â†’â”œâ”€â”€ .env.local                    # Backend development environment\n    12â†’â”œâ”€â”€ .env.production               # Backend production environment\n    13â†’â”œâ”€â”€ frontend/.env.local           # Frontend development environment  \n    14â†’â”œâ”€â”€ frontend/.env.production      # Frontend production environment\n    15â†’â”œâ”€â”€ .env.example                  # Backend template\n    16â†’â””â”€â”€ frontend/.env.example         # Frontend template\n    17â†’```\n    18â†’\n    19â†’## Backend Environment Variables\n    20â†’\n    21â†’### Database Configuration\n    22â†’\n    23â†’```bash\n    24â†’# Database Connection\n    25â†’DB_HOST=localhost                 # Development: localhost, Production: postgres\n    26â†’DB_NAME=fowldata                  # Development database name\n    27â†’DB_USER=postgres                  # Database username  \n    28â†’DB_PASS=your_password             # Database password (avoid special chars in prod)\n    29â†’DB_PORT=5432                      # PostgreSQL port\n    30â†’\n    31â†’# Production Database Example\n    32â†’DB_HOST=postgres\n    33â†’DB_NAME=fowldata_prod\n    34â†’DB_USER=fowldata_user\n    35â†’DB_PASS=SecurePassword123         # No special characters for production\n    36â†’DB_PORT=5432\n    37â†’```\n    38â†’\n    39â†’### Django Core Settings\n    40â†’\n    41â†’```bash\n    42â†’# Django Configuration\n    43â†’SECRET_KEY=your-django-secret-key                    # Generate with django-admin\n    44â†’DEBUG=True                                          # False for production\n    45â†’ALLOWED_HOSTS=localhost,127.0.0.1                   # Comma-separated hosts\n    46â†’\n    47â†’# Production Django Settings\n    48â†’SECRET_KEY=very-long-production-secret-key\n    49â†’DEBUG=False\n    50â†’ALLOWED_HOSTS=fowldata.com,www.fowldata.com,api.fowldata.com\n    51â†’```\n    52â†’\n    53â†’### Security Settings (Production)\n    54â†’\n    55â†’```bash\n    56â†’# HTTPS/SSL Configuration\n    57â†’SECURE_SSL_REDIRECT=True\n    58â†’SECURE_HSTS_SECONDS=31536000\n    59â†’SECURE_HSTS_INCLUDE_SUBDOMAINS=True\n    60â†’SECURE_HSTS_PRELOAD=True\n    61â†’SECURE_CONTENT_TYPE_NOSNIFF=True\n    62â†’SECURE_BROWSER_XSS_FILTER=True\n    63â†’X_FRAME_OPTIONS=DENY\n    64â†’```\n    65â†’\n    66â†’### AWS S3 Configuration\n    67â†’\n    68â†’```bash\n    69â†’# S3 Photo Storage\n    70â†’AWS_ACCESS_KEY_ID=your_access_key_id\n    71â†’AWS_SECRET_ACCESS_KEY=your_secret_access_key\n    72â†’AWS_S3_BUCKET_NAME=fowldata-photos-dev              # Development bucket\n    73â†’AWS_REGION=us-west-2                                # S3 region\n    74â†’AWS_S3_CUSTOM_DOMAIN=your-cdn-domain.cloudfront.net # Optional CDN\n    75â†’\n    76â†’# Production S3 Example\n    77â†’AWS_S3_BUCKET_NAME=fowldata-photos-prod\n    78â†’PHOTO_UPLOAD_BUCKET=fowldata-photos-prod\n    79â†’```\n    80â†’\n    81â†’### External API Keys\n    82â†’\n    83â†’```bash\n    84â†’# Weather API Integration\n    85â†’WEATHER_API_KEY=your_weather_api_key                 # OpenWeatherMap or similar\n    86â†’WEATHER_API_BASE_URL=https://api.openweathermap.org/data/2.5\n    87â†’\n    88â†’# Email Configuration (Optional)\n    89â†’EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend\n    90â†’EMAIL_HOST=smtp.gmail.com\n    91â†’EMAIL_PORT=587\n    92â†’EMAIL_USE_TLS=True\n    93â†’EMAIL_HOST_USER=your-email@gmail.com\n    94â†’EMAIL_HOST_PASSWORD=your-app-password\n    95â†’```\n    96â†’\n    97â†’### Redis Configuration (Production)\n    98â†’\n    99â†’```bash\n   100â†’# Redis Caching and Sessions\n   101â†’REDIS_HOST=redis                                     # Docker service name\n   102â†’REDIS_PORT=6379\n   103â†’REDIS_PASSWORD=your_redis_password                   # Set for production\n   104â†’REDIS_DB=0\n   105â†’```\n   106â†’\n   107â†’## Frontend Environment Variables\n   108â†’\n   109â†’### NextAuth Configuration\n   110â†’\n   111â†’```bash\n   112â†’# Authentication (CRITICAL)\n   113â†’AUTH_SECRET=your-nextauth-secret-key                 # Generate: openssl rand -base64 32\n   114â†’NEXTAUTH_URL=http://localhost:3000                   # Full URL with protocol\n   115â†’\n   116â†’# Production NextAuth\n   117â†’AUTH_SECRET=production-nextauth-secret-key\n   118â†’NEXTAUTH_URL=https://www.fowldata.com\n   119â†’```\n   120â†’\n   121â†’### OAuth Provider Configuration\n   122â†’\n   123â†’```bash\n   124â†’# Google OAuth\n   125â†’GOOGLE_CLIENT_ID=your-google-client-id\n   126â†’GOOGLE_CLIENT_SECRET=your-google-client-secret\n   127â†’\n   128â†’# Facebook OAuth (Optional)\n   129â†’FACEBOOK_CLIENT_ID=your-facebook-app-id\n   130â†’FACEBOOK_CLIENT_SECRET=your-facebook-app-secret\n   131â†’```\n   132â†’\n   133â†’### API Configuration\n   134â†’\n   135â†’```bash\n   136â†’# Backend API Connection (CRITICAL for Docker)\n   137â†’BACKEND_URL=http://fowldata:8000                     # Use Docker service name\n   138â†’NEXT_PUBLIC_API_URL=http://localhost:8000/api        # Public API endpoint\n   139â†’\n   140â†’# Production API Configuration\n   141â†’BACKEND_URL=http://fowldata:8000                     # Internal Docker communication\n   142â†’NEXT_PUBLIC_API_URL=https://www.fowldata.com/api    # External API endpoint\n   143â†’```\n   144â†’\n   145â†’### Mapbox Configuration\n   146â†’\n   147â†’```bash\n   148â†’# Mapbox Integration (CRITICAL for layer rendering)\n   149â†’NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-mapbox-token    # Public token for GL JS v3+\n   150â†’\n   151â†’# Optional Mapbox Settings\n   152â†’NEXT_PUBLIC_MAPBOX_STYLE=mapbox://styles/username/style-id\n   153â†’NEXT_PUBLIC_DEFAULT_CENTER_LAT=39.8283\n   154â†’NEXT_PUBLIC_DEFAULT_CENTER_LNG=-98.5795\n   155â†’NEXT_PUBLIC_DEFAULT_ZOOM=4\n   156â†’```\n   157â†’\n   158â†’### S3 Upload Configuration\n   159â†’\n   160â†’```bash\n   161â†’# Direct S3 Upload URLs\n   162â†’NEXT_PUBLIC_AWS_S3_UPLOAD_URL=https://fowldata-photos-dev.s3.us-west-2.amazonaws.com\n   163â†’NEXT_PUBLIC_CDN_URL=https://your-cloudfront-domain.cloudfront.net\n   164â†’```\n   165â†’\n   166â†’## Environment-Specific Configurations\n   167â†’\n   168â†’### Development (.env.local)\n   169â†’\n   170â†’```bash\n   171â†’# Backend .env.local\n   172â†’DB_HOST=localhost\n   173â†’DB_NAME=fowldata\n   174â†’DB_USER=postgres\n   175â†’DB_PASS=postgres\n   176â†’SECRET_KEY=dev-secret-key\n   177â†’DEBUG=True\n   178â†’ALLOWED_HOSTS=localhost,127.0.0.1\n   179â†’\n   180â†’# Frontend frontend/.env.local  \n   181â†’BACKEND_URL=http://fowldata:8000                     # CRITICAL: Docker service name\n   182â†’NEXTAUTH_URL=http://localhost:3000\n   183â†’NEXT_PUBLIC_API_URL=http://localhost:8000/api\n   184â†’```\n   185â†’\n   186â†’### Production (.env.production)\n   187â†’\n   188â†’```bash\n   189â†’# Backend .env.production\n   190â†’DB_HOST=postgres\n   191â†’DB_NAME=fowldata_prod\n   192â†’DB_USER=fowldata_user\n   193â†’DB_PASS=SecureProductionPassword123\n   194â†’SECRET_KEY=production-secret-key-very-long-and-secure\n   195â†’DEBUG=False\n   196â†’ALLOWED_HOSTS=fowldata.com,www.fowldata.com,api.fowldata.com\n   197â†’SECURE_SSL_REDIRECT=True\n   198â†’\n   199â†’# Frontend frontend/.env.production\n   200â†’BACKEND_URL=http://fowldata:8000                     # Internal Docker communication\n   201â†’NEXTAUTH_URL=https://www.fowldata.com\n   202â†’NEXT_PUBLIC_API_URL=https://www.fowldata.com/api\n   203â†’```\n   204â†’\n   205â†’## Critical Configuration Rules\n   206â†’\n   207â†’### Docker Network Communication\n   208â†’\n   209â†’**ALWAYS use Docker service names for internal communication**:\n   210â†’\n   211â†’```bash\n   212â†’# âœ… CORRECT - Internal container communication\n   213â†’BACKEND_URL=http://fowldata:8000\n   214â†’\n   215â†’# âŒ WRONG - Causes ECONNREFUSED errors in containers\n   216â†’BACKEND_URL=http://localhost:8000\n   217â†’```\n   218â†’\n   219â†’### Mapbox GL JS v3+ Token Configuration\n   220â†’\n   221â†’**REQUIRED for layer rendering with react-map-gl v8**:\n   222â†’\n   223â†’```bash\n   224â†’# Frontend environment - MUST be NEXT_PUBLIC_* for client access\n   225â†’NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-mapbox-token\n   226â†’```\n   227â†’\n   228â†’```typescript\n   229â†’// ALSO required in Map component code\n   230â†’import mapboxgl from 'mapbox-gl';\n   231â†’mapboxgl.accessToken = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN!;\n   232â†’```\n   233â†’\n   234â†’### Production Environment Loading\n   235â†’\n   236â†’**ALWAYS use explicit env-file flag**:\n   237â†’\n   238â†’```bash\n   239â†’# âœ… CORRECT - Explicit environment file loading\n   240â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n   241â†’\n   242â†’# âŒ WRONG - Environment variables not loaded properly\n   243â†’docker-compose -f docker-compose.prod.yaml up -d\n   244â†’```\n   245â†’\n   246â†’### Password Security\n   247â†’\n   248â†’**Avoid shell metacharacters in production passwords**:\n   249â†’\n   250â†’```bash\n   251â†’# âŒ PROBLEMATIC - Shell interprets special characters\n   252â†’DB_PASS=password$123!@#\n   253â†’\n   254â†’# âœ… SAFE - No shell metacharacters\n   255â†’DB_PASS=SecurePassword123\n   256â†’```\n   257â†’\n   258â†’## Environment Validation\n   259â†’\n   260â†’### Development Validation\n   261â†’\n   262â†’```bash\n   263â†’# Check environment loading\n   264â†’docker-compose config | grep -A5 -B5 POSTGRES_\n   265â†’\n   266â†’# Test backend connection\n   267â†’docker-compose exec fowldata python manage.py check\n   268â†’\n   269â†’# Test frontend environment\n   270â†’cd frontend && npm run build\n   271â†’```\n   272â†’\n   273â†’### Production Validation\n   274â†’\n   275â†’```bash\n   276â†’# Validate production configuration\n   277â†’./scripts/validate-production.sh\n   278â†’\n   279â†’# Test environment variable loading\n   280â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production config | grep POSTGRES\n   281â†’\n   282â†’# Verify all services can access variables\n   283â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata env | grep DB_\n   284â†’```\n   285â†’\n   286â†’## Environment Generation\n   287â†’\n   288â†’### Generate Secure Keys\n   289â†’\n   290â†’```bash\n   291â†’# Django SECRET_KEY\n   292â†’python -c \"from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())\"\n   293â†’\n   294â†’# NextAuth AUTH_SECRET\n   295â†’openssl rand -base64 32\n   296â†’\n   297â†’# Generate secure password\n   298â†’openssl rand -base64 24 | tr -d \"=+/\" | cut -c1-16\n   299â†’```\n   300â†’\n   301â†’### Template Files\n   302â†’\n   303â†’Create template files for new environments:\n   304â†’\n   305â†’```bash\n   306â†’# Copy existing environment as template\n   307â†’cp .env.local .env.template\n   308â†’\n   309â†’# Remove sensitive values from template\n   310â†’sed -i 's/=.*/=/' .env.template\n   311â†’```\n   312â†’\n   313â†’## Troubleshooting\n   314â†’\n   315â†’### Environment Not Loading\n   316â†’\n   317â†’**Problem**: Variables show as empty or default values\n   318â†’\n   319â†’**Solutions**:\n   320â†’1. Check file encoding (must be UTF-8 without BOM)\n   321â†’2. Use explicit `--env-file` flag for production\n   322â†’3. Verify file permissions (readable by Docker)\n   323â†’4. Check for syntax errors (no spaces around `=`)\n   324â†’\n   325â†’### Docker Network Issues  \n   326â†’\n   327â†’**Problem**: ECONNREFUSED errors between containers\n   328â†’\n   329â†’**Solution**: Always use Docker service names:\n   330â†’```bash\n   331â†’# frontend/.env.local\n   332â†’BACKEND_URL=http://fowldata:8000  # âœ… Service name\n   333â†’# NOT: http://localhost:8000      # âŒ Fails in containers\n   334â†’```\n   335â†’\n   336â†’### Mapbox Layers Not Rendering\n   337â†’\n   338â†’**Problem**: Map loads but no layers appear\n   339â†’\n   340â†’**Solution**: Ensure both environment variable and code configuration:\n   341â†’```bash\n   342â†’# Environment\n   343â†’NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-token\n   344â†’\n   345â†’# Code (ALSO required)\n   346â†’mapboxgl.accessToken = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN!;\n   347â†’```\n   348â†’\n   349â†’For additional environment configuration examples, see:\n   350â†’- [Installation Guide](./installation.md)\n   351â†’- [Digital Ocean Deployment](./DIGITAL_OCEAN_DEPLOYMENT.md)\n   352â†’- [Authentication Guide](./authentication.md)\n\n<system-reminder>\nWhenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"1acd6a42-b5ec-4e2d-8867-3e25b5debe80","timestamp":"2025-08-25T04:39:34.472Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/markelmore/_code/fowldata/docs/environment-variables.md","content":"# Environment Variables Reference\n\nComplete guide to configuring FowlData environment variables for development and production.\n\n## Environment File Structure\n\nFowlData uses multiple environment files for different contexts:\n\n```\nfowldata/\nâ”œâ”€â”€ .env.local                    # Backend development environment\nâ”œâ”€â”€ .env.production               # Backend production environment\nâ”œâ”€â”€ frontend/.env.local           # Frontend development environment  \nâ”œâ”€â”€ frontend/.env.production      # Frontend production environment\nâ”œâ”€â”€ .env.example                  # Backend template\nâ””â”€â”€ frontend/.env.example         # Frontend template\n```\n\n## Backend Environment Variables\n\n### Database Configuration\n\n```bash\n# Database Connection\nDB_HOST=localhost                 # Development: localhost, Production: postgres\nDB_NAME=fowldata                  # Development database name\nDB_USER=postgres                  # Database username  \nDB_PASS=your_password             # Database password (avoid special chars in prod)\nDB_PORT=5432                      # PostgreSQL port\n\n# Production Database Example\nDB_HOST=postgres\nDB_NAME=fowldata_prod\nDB_USER=fowldata_user\nDB_PASS=SecurePassword123         # No special characters for production\nDB_PORT=5432\n```\n\n### Django Core Settings\n\n```bash\n# Django Configuration\nSECRET_KEY=your-django-secret-key                    # Generate with django-admin\nDEBUG=True                                          # False for production\nALLOWED_HOSTS=localhost,127.0.0.1                   # Comma-separated hosts\n\n# Production Django Settings\nSECRET_KEY=very-long-production-secret-key\nDEBUG=False\nALLOWED_HOSTS=fowldata.com,www.fowldata.com,api.fowldata.com\n```\n\n### Security Settings (Production)\n\n```bash\n# HTTPS/SSL Configuration\nSECURE_SSL_REDIRECT=True\nSECURE_HSTS_SECONDS=31536000\nSECURE_HSTS_INCLUDE_SUBDOMAINS=True\nSECURE_HSTS_PRELOAD=True\nSECURE_CONTENT_TYPE_NOSNIFF=True\nSECURE_BROWSER_XSS_FILTER=True\nX_FRAME_OPTIONS=DENY\n```\n\n### AWS S3 Configuration\n\n```bash\n# S3 Photo Storage\nAWS_ACCESS_KEY_ID=your_access_key_id\nAWS_SECRET_ACCESS_KEY=your_secret_access_key\nAWS_S3_BUCKET_NAME=fowldata-photos-dev              # Development bucket\nAWS_REGION=us-west-2                                # S3 region\nAWS_S3_CUSTOM_DOMAIN=your-cdn-domain.cloudfront.net # Optional CDN\n\n# Production S3 Example\nAWS_S3_BUCKET_NAME=fowldata-photos-prod\nPHOTO_UPLOAD_BUCKET=fowldata-photos-prod\n```\n\n### External API Keys\n\n```bash\n# Weather API Integration\nWEATHER_API_KEY=your_weather_api_key                 # OpenWeatherMap or similar\nWEATHER_API_BASE_URL=https://api.openweathermap.org/data/2.5\n\n# Email Configuration (Optional)\nEMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend\nEMAIL_HOST=smtp.gmail.com\nEMAIL_PORT=587\nEMAIL_USE_TLS=True\nEMAIL_HOST_USER=your-email@gmail.com\nEMAIL_HOST_PASSWORD=your-app-password\n```\n\n### Redis Configuration (Production)\n\n```bash\n# Redis Caching and Sessions\nREDIS_HOST=redis                                     # Docker service name\nREDIS_PORT=6379\nREDIS_PASSWORD=your_redis_password                   # Set for production\nREDIS_DB=0\n```\n\n## Frontend Environment Variables\n\n### NextAuth Configuration\n\n```bash\n# Authentication (CRITICAL)\nAUTH_SECRET=your-nextauth-secret-key                 # Generate: openssl rand -base64 32\nNEXTAUTH_URL=http://localhost:3000                   # Full URL with protocol\n\n# Production NextAuth\nAUTH_SECRET=production-nextauth-secret-key\nNEXTAUTH_URL=https://www.fowldata.com\n```\n\n### OAuth Provider Configuration\n\n```bash\n# Google OAuth\nGOOGLE_CLIENT_ID=your-google-client-id\nGOOGLE_CLIENT_SECRET=your-google-client-secret\n\n# Facebook OAuth (Optional)\nFACEBOOK_CLIENT_ID=your-facebook-app-id\nFACEBOOK_CLIENT_SECRET=your-facebook-app-secret\n```\n\n### API Configuration\n\n```bash\n# Backend API Connection (CRITICAL for Docker)\nBACKEND_URL=http://fowldata:8000                     # Use Docker service name\nNEXT_PUBLIC_API_URL=http://localhost:8000/api        # Public API endpoint\n\n# Production API Configuration\nBACKEND_URL=http://fowldata:8000                     # Internal Docker communication\nNEXT_PUBLIC_API_URL=https://www.fowldata.com/api    # External API endpoint\n```\n\n### Mapbox Configuration\n\n```bash\n# Mapbox Integration (CRITICAL for layer rendering)\nNEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-mapbox-token    # Public token for GL JS v3+\n\n# Optional Mapbox Settings\nNEXT_PUBLIC_MAPBOX_STYLE=mapbox://styles/username/style-id\nNEXT_PUBLIC_DEFAULT_CENTER_LAT=39.8283\nNEXT_PUBLIC_DEFAULT_CENTER_LNG=-98.5795\nNEXT_PUBLIC_DEFAULT_ZOOM=4\n```\n\n### S3 Upload Configuration\n\n```bash\n# Direct S3 Upload URLs\nNEXT_PUBLIC_AWS_S3_UPLOAD_URL=https://fowldata-photos-dev.s3.us-west-2.amazonaws.com\nNEXT_PUBLIC_CDN_URL=https://your-cloudfront-domain.cloudfront.net\n```\n\n## Environment-Specific Configurations\n\n### Development (.env.local)\n\n```bash\n# Backend .env.local\nDB_HOST=localhost\nDB_NAME=fowldata\nDB_USER=postgres\nDB_PASS=postgres\nSECRET_KEY=dev-secret-key\nDEBUG=True\nALLOWED_HOSTS=localhost,127.0.0.1\n\n# Frontend frontend/.env.local  \nBACKEND_URL=http://fowldata:8000                     # CRITICAL: Docker service name\nNEXTAUTH_URL=http://localhost:3000\nNEXT_PUBLIC_API_URL=http://localhost:8000/api\n```\n\n### Production (.env.production)\n\n```bash\n# Backend .env.production\nDB_HOST=postgres\nDB_NAME=fowldata_prod\nDB_USER=fowldata_user\nDB_PASS=SecureProductionPassword123\nSECRET_KEY=production-secret-key-very-long-and-secure\nDEBUG=False\nALLOWED_HOSTS=fowldata.com,www.fowldata.com,api.fowldata.com\nSECURE_SSL_REDIRECT=True\n\n# Frontend frontend/.env.production\nBACKEND_URL=http://fowldata:8000                     # Internal Docker communication\nNEXTAUTH_URL=https://www.fowldata.com\nNEXT_PUBLIC_API_URL=https://www.fowldata.com/api\n```\n\n## Critical Configuration Rules\n\n### Docker Network Communication\n\n**ALWAYS use Docker service names for internal communication**:\n\n```bash\n# âœ… CORRECT - Internal container communication\nBACKEND_URL=http://fowldata:8000\n\n# âŒ WRONG - Causes ECONNREFUSED errors in containers\nBACKEND_URL=http://localhost:8000\n```\n\n### Mapbox GL JS v3+ Token Configuration\n\n**REQUIRED for layer rendering with react-map-gl v8**:\n\n```bash\n# Frontend environment - MUST be NEXT_PUBLIC_* for client access\nNEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-mapbox-token\n```\n\n```typescript\n// ALSO required in Map component code\nimport mapboxgl from 'mapbox-gl';\nmapboxgl.accessToken = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN!;\n```\n\n### Production Environment Loading\n\n**ALWAYS use explicit env-file flag**:\n\n```bash\n# âœ… CORRECT - Explicit environment file loading\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# âŒ WRONG - Environment variables not loaded properly\ndocker-compose -f docker-compose.prod.yaml up -d\n```\n\n### Password Security\n\n**Avoid shell metacharacters in production passwords**:\n\n```bash\n# âŒ PROBLEMATIC - Shell interprets special characters\nDB_PASS=password$123!@#\n\n# âœ… SAFE - No shell metacharacters\nDB_PASS=SecurePassword123\n```\n\n## Environment Validation\n\n### Development Validation\n\n```bash\n# Check environment loading\ndocker-compose config | grep -A5 -B5 POSTGRES_\n\n# Test backend connection\ndocker-compose exec fowldata python manage.py check\n\n# Test frontend environment\ncd frontend && npm run build\n```\n\n### Production Validation\n\n```bash\n# Validate production configuration\n./scripts/validate-production.sh\n\n# Test environment variable loading\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production config | grep POSTGRES\n\n# Verify all services can access variables\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata env | grep DB_\n```\n\n## Environment Generation\n\n### Generate Secure Keys\n\n```bash\n# Django SECRET_KEY\npython -c \"from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())\"\n\n# NextAuth AUTH_SECRET\nopenssl rand -base64 32\n\n# Generate secure password\nopenssl rand -base64 24 | tr -d \"=+/\" | cut -c1-16\n```\n\n### Template Files\n\nCreate template files for new environments:\n\n```bash\n# Copy existing environment as template\ncp .env.local .env.template\n\n# Remove sensitive values from template\nsed -i 's/=.*/=/' .env.template\n```\n\n## Troubleshooting\n\n### Environment Not Loading\n\n**Problem**: Variables show as empty or default values\n\n**Solutions**:\n1. Check file encoding (must be UTF-8 without BOM)\n2. Use explicit `--env-file` flag for production\n3. Verify file permissions (readable by Docker)\n4. Check for syntax errors (no spaces around `=`)\n\n### Docker Network Issues  \n\n**Problem**: ECONNREFUSED errors between containers\n\n**Solution**: Always use Docker service names:\n```bash\n# frontend/.env.local\nBACKEND_URL=http://fowldata:8000  # âœ… Service name\n# NOT: http://localhost:8000      # âŒ Fails in containers\n```\n\n### Mapbox Layers Not Rendering\n\n**Problem**: Map loads but no layers appear\n\n**Solution**: Ensure both environment variable and code configuration:\n```bash\n# Environment\nNEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-token\n\n# Code (ALSO required)\nmapboxgl.accessToken = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN!;\n```\n\nFor additional environment configuration examples, see:\n- [Installation Guide](./installation.md)\n- [Digital Ocean Deployment](./DIGITAL_OCEAN_DEPLOYMENT.md)\n- [Authentication Guide](./authentication.md)","numLines":352,"startLine":1,"totalLines":352}}}
{"parentUuid":"1acd6a42-b5ec-4e2d-8867-3e25b5debe80","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CvaTw4TrQ7NJctTB4ig6vf","type":"tool_result","content":"     1â†’# ğŸ§ª Testing Guide\n     2â†’\n     3â†’Comprehensive testing strategy for FowlData with unit, integration, and end-to-end testing.\n     4â†’\n     5â†’## Testing Architecture\n     6â†’\n     7â†’```\n     8â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n     9â†’â”‚   Frontend      â”‚    â”‚   Backend       â”‚    â”‚  Integration    â”‚\n    10â†’â”‚     Tests       â”‚    â”‚    Tests        â”‚    â”‚     Tests       â”‚\n    11â†’â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚\n    12â†’â”‚ â€¢ Jest (Unit)   â”‚    â”‚ â€¢ pytest (Unit)â”‚    â”‚ â€¢ Playwright    â”‚\n    13â†’â”‚ â€¢ React Testing â”‚    â”‚ â€¢ pytest-djangoâ”‚    â”‚   (E2E)         â”‚\n    14â†’â”‚   Library       â”‚    â”‚ â€¢ Coverage      â”‚    â”‚ â€¢ API Testing   â”‚\n    15â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    16â†’```\n    17â†’\n    18â†’## Quick Test Commands\n    19â†’\n    20â†’### Run All Tests\n    21â†’```bash\n    22â†’./testlint              # Full CI validation including E2E tests\n    23â†’./testlint-quick        # Quick validation without E2E tests\n    24â†’```\n    25â†’\n    26â†’### Backend Tests\n    27â†’```bash\n    28â†’# All backend tests\n    29â†’docker compose exec fowldata python -m pytest\n    30â†’\n    31â†’# Specific test directories\n    32â†’docker compose exec fowldata python -m pytest accounts/tests/ hunts/tests/ -v\n    33â†’\n    34â†’# Single test file\n    35â†’docker compose exec fowldata python -m pytest hunts/tests/test_weather_api.py -v\n    36â†’\n    37â†’# Tests with specific markers\n    38â†’docker compose exec fowldata python -m pytest -m \"not performance\" -v\n    39â†’\n    40â†’# With coverage\n    41â†’docker compose exec fowldata python -m pytest --cov=fowldata --cov-report=html\n    42â†’```\n    43â†’\n    44â†’### Frontend Tests\n    45â†’```bash\n    46â†’cd frontend\n    47â†’\n    48â†’# Unit tests\n    49â†’npm run test                    # Jest unit tests\n    50â†’npm run test:watch             # Jest in watch mode\n    51â†’npm test -- --watchAll=false   # Run tests once (CI mode)\n    52â†’\n    53â†’# E2E tests\n    54â†’npm run test:e2e               # Playwright E2E tests\n    55â†’npm run test:e2e:ui            # Playwright with UI\n    56â†’npm run test:e2e:headed        # Playwright with browser\n    57â†’```\n    58â†’\n    59â†’## Test Structure\n    60â†’\n    61â†’### Backend Tests (`fowldata/`)\n    62â†’\n    63â†’```\n    64â†’fowldata/\n    65â†’â”œâ”€â”€ accounts/tests/\n    66â†’â”‚   â”œâ”€â”€ test_nextauth_backend.py      # NextAuth JWT authentication\n    67â†’â”‚   â”œâ”€â”€ test_middleware.py            # Authentication middleware\n    68â†’â”‚   â”œâ”€â”€ test_authentication.py        # DRF authentication\n    69â†’â”‚   â”œâ”€â”€ test_api_views.py            # API endpoint tests\n    70â†’â”‚   â””â”€â”€ test_integration.py          # Full authentication flow\n    71â†’â”œâ”€â”€ hunts/tests/\n    72â†’â”‚   â”œâ”€â”€ test_models.py               # Model validation and methods\n    73â†’â”‚   â”œâ”€â”€ test_api_views.py            # Hunt API endpoints\n    74â†’â”‚   â”œâ”€â”€ test_weather_api.py          # Weather integration\n    75â†’â”‚   â”œâ”€â”€ test_s3_integration.py       # Photo upload functionality\n    76â†’â”‚   â””â”€â”€ test_performance_security.py # Performance tests (CI-skipped)\n    77â†’â””â”€â”€ conftest.py                     # Shared pytest fixtures\n    78â†’```\n    79â†’\n    80â†’### Frontend Tests (`frontend/`)\n    81â†’\n    82â†’```\n    83â†’frontend/\n    84â†’â”œâ”€â”€ src/__tests__/\n    85â†’â”‚   â”œâ”€â”€ auth.test.ts                 # NextAuth configuration\n    86â†’â”‚   â”œâ”€â”€ signin-page.test.tsx         # Authentication components\n    87â†’â”‚   â”œâ”€â”€ hunt-form.test.tsx          # Hunt creation forms\n    88â†’â”‚   â”œâ”€â”€ api-client.test.ts          # API client functionality\n    89â†’â”‚   â””â”€â”€ components/                  # Individual component tests\n    90â†’â”œâ”€â”€ e2e/\n    91â†’â”‚   â”œâ”€â”€ auth-flow.spec.ts           # Complete authentication flow\n    92â†’â”‚   â”œâ”€â”€ hunt-creation.spec.ts       # Hunt creation workflow\n    93â†’â”‚   â”œâ”€â”€ photo-upload.spec.ts        # Photo upload functionality\n    94â†’â”‚   â””â”€â”€ navigation.spec.ts          # Application navigation\n    95â†’â”œâ”€â”€ jest.config.js                  # Jest configuration\n    96â†’â”œâ”€â”€ jest.setup.js                   # Jest setup and mocks\n    97â†’â””â”€â”€ playwright.config.ts           # Playwright configuration\n    98â†’```\n    99â†’\n   100â†’## Test Categories\n   101â†’\n   102â†’### Backend Testing\n   103â†’\n   104â†’#### Unit Tests\n   105â†’**Purpose**: Test individual components in isolation\n   106â†’\n   107â†’```python\n   108â†’# Example: Model validation test\n   109â†’@pytest.mark.django_db\n   110â†’def test_hunt_model_validation():\n   111â†’    user = MyUser.objects.create_user(\n   112â†’        email=\"test@example.com\",\n   113â†’        password=\"testpass123\"\n   114â†’    )\n   115â†’    \n   116â†’    hunt = Hunt.objects.create(\n   117â†’        user=user,\n   118â†’        date_of_hunt=date.today(),\n   119â†’        latitude=40.0,\n   120â†’        longitude=-74.0\n   121â†’    )\n   122â†’    \n   123â†’    assert hunt.location is not None\n   124â†’    assert hunt.user == user\n   125â†’```\n   126â†’\n   127â†’#### Integration Tests\n   128â†’**Purpose**: Test complete workflows and component interactions\n   129â†’\n   130â†’```python\n   131â†’# Example: Authentication flow test\n   132â†’@pytest.mark.django_db\n   133â†’def test_nextauth_jwt_authentication_flow():\n   134â†’    # Create mock NextAuth session\n   135â†’    session_data = {\n   136â†’        \"user\": {\n   137â†’            \"email\": \"test@example.com\",\n   138â†’            \"name\": \"Test User\"\n   139â†’        }\n   140â†’    }\n   141â†’    \n   142â†’    # Test JWT creation and validation\n   143â†’    token = create_jwt_token(session_data)\n   144â†’    user = authenticate_jwt_token(token)\n   145â†’    \n   146â†’    assert user.email == \"test@example.com\"\n   147â†’    assert user.is_authenticated\n   148â†’```\n   149â†’\n   150â†’#### API Tests\n   151â†’**Purpose**: Test REST API endpoints and responses\n   152â†’\n   153â†’```python\n   154â†’# Example: API endpoint test\n   155â†’@pytest.mark.django_db\n   156â†’def test_hunt_list_api(authenticated_client, user):\n   157â†’    Hunt.objects.create(\n   158â†’        user=user,\n   159â†’        date_of_hunt=date.today(),\n   160â†’        latitude=40.0,\n   161â†’        longitude=-74.0\n   162â†’    )\n   163â†’    \n   164â†’    response = authenticated_client.get('/api/hunts/')\n   165â†’    \n   166â†’    assert response.status_code == 200\n   167â†’    assert len(response.json()) == 1\n   168â†’```\n   169â†’\n   170â†’### Frontend Testing\n   171â†’\n   172â†’#### Component Tests\n   173â†’**Purpose**: Test React components in isolation\n   174â†’\n   175â†’```typescript\n   176â†’// Example: Component rendering test\n   177â†’import { render, screen } from '@testing-library/react';\n   178â†’import { HuntForm } from '@/components/HuntForm';\n   179â†’\n   180â†’describe('HuntForm', () => {\n   181â†’  it('renders hunt creation form', () => {\n   182â†’    render(<HuntForm />);\n   183â†’    \n   184â†’    expect(screen.getByLabelText(/hunt date/i)).toBeInTheDocument();\n   185â†’    expect(screen.getByLabelText(/location/i)).toBeInTheDocument();\n   186â†’    expect(screen.getByRole('button', { name: /save hunt/i })).toBeInTheDocument();\n   187â†’  });\n   188â†’  \n   189â†’  it('validates required fields', async () => {\n   190â†’    render(<HuntForm />);\n   191â†’    \n   192â†’    const submitButton = screen.getByRole('button', { name: /save hunt/i });\n   193â†’    fireEvent.click(submitButton);\n   194â†’    \n   195â†’    expect(await screen.findByText(/hunt date is required/i)).toBeInTheDocument();\n   196â†’  });\n   197â†’});\n   198â†’```\n   199â†’\n   200â†’#### Integration Tests\n   201â†’**Purpose**: Test component interactions and data flow\n   202â†’\n   203â†’```typescript\n   204â†’// Example: Authentication integration test\n   205â†’import { render, screen, waitFor } from '@testing-library/react';\n   206â†’import { SessionProvider } from 'next-auth/react';\n   207â†’import { Dashboard } from '@/components/Dashboard';\n   208â†’\n   209â†’describe('Dashboard Integration', () => {\n   210â†’  it('displays user data when authenticated', async () => {\n   211â†’    const mockSession = {\n   212â†’      user: { email: 'test@example.com', name: 'Test User' }\n   213â†’    };\n   214â†’    \n   215â†’    render(\n   216â†’      <SessionProvider session={mockSession}>\n   217â†’        <Dashboard />\n   218â†’      </SessionProvider>\n   219â†’    );\n   220â†’    \n   221â†’    await waitFor(() => {\n   222â†’      expect(screen.getByText('Welcome, Test User')).toBeInTheDocument();\n   223â†’    });\n   224â†’  });\n   225â†’});\n   226â†’```\n   227â†’\n   228â†’### End-to-End Testing\n   229â†’\n   230â†’#### Complete User Workflows\n   231â†’**Purpose**: Test complete user journeys across the application\n   232â†’\n   233â†’```typescript\n   234â†’// Example: Hunt creation E2E test\n   235â†’import { test, expect } from '@playwright/test';\n   236â†’\n   237â†’test('complete hunt creation workflow', async ({ page }) => {\n   238â†’  // Navigate to application\n   239â†’  await page.goto('http://localhost:3000');\n   240â†’  \n   241â†’  // Sign in\n   242â†’  await page.click('[data-testid=\"sign-in-button\"]');\n   243â†’  await page.fill('[data-testid=\"email-input\"]', 'mark@mail.com');\n   244â†’  await page.fill('[data-testid=\"password-input\"]', '1@Tsgstp');\n   245â†’  await page.click('[data-testid=\"submit-button\"]');\n   246â†’  \n   247â†’  // Create new hunt\n   248â†’  await page.click('[data-testid=\"new-hunt-button\"]');\n   249â†’  await page.fill('[data-testid=\"hunt-date\"]', '2024-08-15');\n   250â†’  \n   251â†’  // Select location on map\n   252â†’  await page.click('[data-testid=\"map-container\"]', { position: { x: 400, y: 300 } });\n   253â†’  \n   254â†’  // Upload photo\n   255â†’  await page.setInputFiles('[data-testid=\"photo-upload\"]', 'test-files/hunt-photo.jpg');\n   256â†’  \n   257â†’  // Save hunt\n   258â†’  await page.click('[data-testid=\"save-hunt-button\"]');\n   259â†’  \n   260â†’  // Verify success\n   261â†’  await expect(page.locator('[data-testid=\"hunt-created-message\"]')).toBeVisible();\n   262â†’});\n   263â†’```\n   264â†’\n   265â†’## Test Configuration\n   266â†’\n   267â†’### Django Test Settings\n   268â†’\n   269â†’#### pytest Configuration (`pytest.ini`)\n   270â†’```ini\n   271â†’[tool:pytest]\n   272â†’DJANGO_SETTINGS_MODULE = fowldata.settings\n   273â†’addopts = \n   274â†’    --verbose\n   275â†’    --tb=short\n   276â†’    --reuse-db\n   277â†’    --nomigrations\n   278â†’markers =\n   279â†’    unit: Unit tests\n   280â†’    integration: Integration tests\n   281â†’    api: API tests\n   282â†’    auth: Authentication tests\n   283â†’    nextauth: NextAuth-specific tests\n   284â†’    slow: Slow tests (can be skipped)\n   285â†’    performance: Performance tests (skipped in CI)\n   286â†’    threading: Threading tests (skipped in CI)\n   287â†’    memory_intensive: Memory intensive tests (skipped in CI)\n   288â†’```\n   289â†’\n   290â†’#### Test Fixtures (`conftest.py`)\n   291â†’```python\n   292â†’@pytest.fixture\n   293â†’def test_user():\n   294â†’    \"\"\"Create a test user for authentication tests\"\"\"\n   295â†’    return MyUser.objects.create_user(\n   296â†’        email=\"test@example.com\",\n   297â†’        password=\"testpass123\",\n   298â†’        first_name=\"Test\",\n   299â†’        last_name=\"User\"\n   300â†’    )\n   301â†’\n   302â†’@pytest.fixture\n   303â†’def authenticated_client(test_user):\n   304â†’    \"\"\"Create an authenticated API client\"\"\"\n   305â†’    client = APIClient()\n   306â†’    token = create_test_jwt_token(test_user)\n   307â†’    client.credentials(HTTP_AUTHORIZATION=f'Bearer {token}')\n   308â†’    return client\n   309â†’```\n   310â†’\n   311â†’### Frontend Test Configuration\n   312â†’\n   313â†’#### Jest Configuration (`jest.config.js`)\n   314â†’```javascript\n   315â†’module.exports = {\n   316â†’  testEnvironment: 'jsdom',\n   317â†’  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],\n   318â†’  moduleNameMapping: {\n   319â†’    '^@/(.*)$': '<rootDir>/src/$1',\n   320â†’  },\n   321â†’  testMatch: [\n   322â†’    '<rootDir>/src/**/__tests__/**/*.{js,jsx,ts,tsx}',\n   323â†’    '<rootDir>/src/**/*.(test|spec).{js,jsx,ts,tsx}'\n   324â†’  ],\n   325â†’  collectCoverageFrom: [\n   326â†’    'src/**/*.{js,jsx,ts,tsx}',\n   327â†’    '!src/**/*.d.ts',\n   328â†’    '!src/app/api/**',\n   329â†’  ],\n   330â†’  coverageThreshold: {\n   331â†’    global: {\n   332â†’      branches: 80,\n   333â†’      functions: 80,\n   334â†’      lines: 80,\n   335â†’      statements: 80\n   336â†’    }\n   337â†’  }\n   338â†’};\n   339â†’```\n   340â†’\n   341â†’#### Playwright Configuration (`playwright.config.ts`)\n   342â†’```typescript\n   343â†’export default defineConfig({\n   344â†’  testDir: './e2e',\n   345â†’  timeout: 30000,\n   346â†’  retries: 2,\n   347â†’  use: {\n   348â†’    baseURL: 'http://localhost:3000',\n   349â†’    headless: true,\n   350â†’    screenshot: 'only-on-failure',\n   351â†’    video: 'retain-on-failure',\n   352â†’  },\n   353â†’  projects: [\n   354â†’    {\n   355â†’      name: 'chromium',\n   356â†’      use: { ...devices['Desktop Chrome'] },\n   357â†’    },\n   358â†’    {\n   359â†’      name: 'webkit',\n   360â†’      use: { ...devices['Desktop Safari'] },\n   361â†’    },\n   362â†’  ],\n   363â†’  webServer: {\n   364â†’    command: 'npm run dev',\n   365â†’    port: 3000,\n   366â†’    reuseExistingServer: !process.env.CI,\n   367â†’  },\n   368â†’});\n   369â†’```\n   370â†’\n   371â†’## Test Data Management\n   372â†’\n   373â†’### Database Test Data\n   374â†’```python\n   375â†’# Minimal test data creation\n   376â†’@pytest.fixture\n   377â†’def hunt_with_photos(test_user):\n   378â†’    \"\"\"Create hunt with associated photos for testing\"\"\"\n   379â†’    hunt = Hunt.objects.create(\n   380â†’        user=test_user,\n   381â†’        date_of_hunt=date.today(),\n   382â†’        latitude=40.0,\n   383â†’        longitude=-74.0,\n   384â†’        weather_conditions=\"Partly cloudy\"\n   385â†’    )\n   386â†’    \n   387â†’    HuntPhoto.objects.create(\n   388â†’        hunt=hunt,\n   389â†’        photo_url=\"https://test-bucket.s3.amazonaws.com/test-photo.jpg\",\n   390â†’        filename=\"test-photo.jpg\"\n   391â†’    )\n   392â†’    \n   393â†’    return hunt\n   394â†’```\n   395â†’\n   396â†’### Mock External Services\n   397â†’```python\n   398â†’# Mock weather API responses\n   399â†’@pytest.fixture\n   400â†’def mock_weather_api():\n   401â†’    with patch('hunts.tasks.get_weather_data') as mock:\n   402â†’        mock.return_value = {\n   403â†’            'temp': 65,\n   404â†’            'conditions': 'Partly cloudy',\n   405â†’            'humidity': 75,\n   406â†’            'windspeed': 8\n   407â†’        }\n   408â†’        yield mock\n   409â†’\n   410â†’# Mock S3 operations\n   411â†’@pytest.fixture\n   412â†’def mock_s3_client():\n   413â†’    with patch('hunts.s3_manager.boto3.client') as mock:\n   414â†’        mock.return_value.generate_presigned_url.return_value = \"https://test-url.com\"\n   415â†’        yield mock\n   416â†’```\n   417â†’\n   418â†’## Test Execution Strategies\n   419â†’\n   420â†’### Development Testing\n   421â†’```bash\n   422â†’# Quick feedback loop during development\n   423â†’npm run test:watch              # Frontend watch mode\n   424â†’docker compose exec fowldata python -m pytest -x  # Stop on first failure\n   425â†’```\n   426â†’\n   427â†’### Pre-Commit Testing\n   428â†’```bash\n   429â†’# Run before committing changes\n   430â†’./testlint-quick               # Essential tests only\n   431â†’npm run lint                   # Code quality checks\n   432â†’```\n   433â†’\n   434â†’### CI/CD Testing\n   435â†’```bash\n   436â†’# Full test suite for pull requests\n   437â†’./testlint                     # Complete validation\n   438â†’docker compose exec fowldata python -m pytest --cov=fowldata  # With coverage\n   439â†’```\n   440â†’\n   441â†’### Performance Testing\n   442â†’```bash\n   443â†’# Specialized performance testing (local only)\n   444â†’docker compose exec fowldata python -m pytest -m performance\n   445â†’```\n   446â†’\n   447â†’## Test Markers and Filtering\n   448â†’\n   449â†’### Django Test Markers\n   450â†’```bash\n   451â†’# Run specific test categories\n   452â†’pytest -m \"unit\"               # Unit tests only\n   453â†’pytest -m \"integration\"        # Integration tests only\n   454â†’pytest -m \"auth\"               # Authentication tests\n   455â†’pytest -m \"not slow\"           # Skip slow tests\n   456â†’pytest -m \"not performance\"    # Skip performance tests (CI default)\n   457â†’```\n   458â†’\n   459â†’### Frontend Test Filtering\n   460â†’```bash\n   461â†’# Jest test filtering\n   462â†’npm test -- --testNamePattern=\"authentication\"  # Tests matching pattern\n   463â†’npm test -- src/components/                     # Specific directory\n   464â†’npm test -- --coverage                          # With coverage report\n   465â†’```\n   466â†’\n   467â†’## Coverage Requirements\n   468â†’\n   469â†’### Coverage Targets\n   470â†’- **Overall Coverage**: 80% minimum\n   471â†’- **Authentication Code**: 90% minimum\n   472â†’- **API Endpoints**: 95% minimum\n   473â†’- **Critical Business Logic**: 100%\n   474â†’\n   475â†’### Coverage Reports\n   476â†’```bash\n   477â†’# Backend coverage\n   478â†’docker compose exec fowldata python -m pytest --cov=fowldata --cov-report=html\n   479â†’open htmlcov/index.html\n   480â†’\n   481â†’# Frontend coverage\n   482â†’npm test -- --coverage\n   483â†’open coverage/lcov-report/index.html\n   484â†’```\n   485â†’\n   486â†’## Debugging Tests\n   487â†’\n   488â†’### Django Test Debugging\n   489â†’```bash\n   490â†’# Debug with pdb\n   491â†’pytest -s --pdb fowldata/accounts/tests/test_nextauth_backend.py::test_function\n   492â†’\n   493â†’# Verbose output\n   494â†’pytest -v -s\n   495â†’\n   496â†’# Show print statements\n   497â†’pytest -s\n   498â†’```\n   499â†’\n   500â†’### Frontend Test Debugging\n   501â†’```bash\n   502â†’# Debug Jest tests\n   503â†’npm test -- --detectOpenHandles --forceExit\n   504â†’\n   505â†’# Debug Playwright tests\n   506â†’npm run test:e2e -- --debug\n   507â†’npm run test:e2e -- --headed\n   508â†’```\n   509â†’\n   510â†’## Common Testing Patterns\n   511â†’\n   512â†’### Authentication Testing\n   513â†’```python\n   514â†’# Test authenticated endpoints\n   515â†’def test_protected_endpoint(authenticated_client):\n   516â†’    response = authenticated_client.get('/api/protected/')\n   517â†’    assert response.status_code == 200\n   518â†’\n   519â†’# Test authentication failures\n   520â†’def test_unauthenticated_access(client):\n   521â†’    response = client.get('/api/protected/')\n   522â†’    assert response.status_code == 401\n   523â†’```\n   524â†’\n   525â†’### Form Validation Testing\n   526â†’```typescript\n   527â†’// Test form validation\n   528â†’it('validates required fields', async () => {\n   529â†’  render(<HuntForm />);\n   530â†’  \n   531â†’  // Submit empty form\n   532â†’  fireEvent.click(screen.getByRole('button', { name: /submit/i }));\n   533â†’  \n   534â†’  // Check for validation errors\n   535â†’  expect(await screen.findByText(/date is required/i)).toBeInTheDocument();\n   536â†’});\n   537â†’```\n   538â†’\n   539â†’### API Integration Testing\n   540â†’```typescript\n   541â†’// Mock API responses\n   542â†’beforeEach(() => {\n   543â†’  fetchMock.mockResponse(JSON.stringify({ success: true }));\n   544â†’});\n   545â†’\n   546â†’it('handles API success', async () => {\n   547â†’  // Test component behavior with successful API response\n   548â†’});\n   549â†’```\n   550â†’\n   551â†’## Test Environment Management\n   552â†’\n   553â†’### Environment Variables for Testing\n   554â†’```bash\n   555â†’# Test-specific environment\n   556â†’DJANGO_SETTINGS_MODULE=fowldata.settings.test\n   557â†’DEBUG=True\n   558â†’AUTH_SECRET=test-secret\n   559â†’WEATHERAPI_KEY=test-key\n   560â†’```\n   561â†’\n   562â†’### Docker Test Environment\n   563â†’```bash\n   564â†’# Start test environment\n   565â†’docker compose -f docker-compose.test.yml up -d\n   566â†’\n   567â†’# Run tests\n   568â†’./testlint-quick\n   569â†’\n   570â†’# Cleanup\n   571â†’docker compose -f docker-compose.test.yml down -v\n   572â†’```\n   573â†’\n   574â†’## Best Practices\n   575â†’\n   576â†’### Test Writing Guidelines\n   577â†’1. **Test Names**: Descriptive names explaining what is being tested\n   578â†’2. **Arrange-Act-Assert**: Clear test structure\n   579â†’3. **Isolation**: Each test should be independent\n   580â†’4. **Mock External Dependencies**: Don't rely on external services\n   581â†’5. **Test Edge Cases**: Include error conditions and boundary cases\n   582â†’\n   583â†’### Test Maintenance\n   584â†’1. **Keep Tests Updated**: Update tests when features change\n   585â†’2. **Remove Obsolete Tests**: Clean up tests for removed features\n   586â†’3. **Refactor Test Code**: Apply same quality standards as production code\n   587â†’4. **Document Complex Tests**: Add comments for complex test scenarios\n   588â†’\n   589â†’### Performance Considerations\n   590â†’1. **Use Transactions**: Wrap database tests in transactions for speed\n   591â†’2. **Minimize Database Hits**: Use select_related and prefetch_related\n   592â†’3. **Mock Heavy Operations**: Mock file uploads, API calls, etc.\n   593â†’4. **Parallel Execution**: Run tests in parallel when possible\n   594â†’\n   595â†’## Troubleshooting\n   596â†’\n   597â†’### Common Issues\n   598â†’1. **Database Conflicts**: Use `--reuse-db` flag or clean database between tests\n   599â†’2. **Async Issues**: Proper await/async handling in frontend tests\n   600â†’3. **Mock Conflicts**: Ensure mocks are properly reset between tests\n   601â†’4. **Environment Issues**: Check test environment configuration\n   602â†’\n   603â†’### Debug Commands\n   604â†’```bash\n   605â†’# Check test database state\n   606â†’docker compose exec fowldata python manage.py dbshell\n   607â†’\n   608â†’# Verify test environment\n   609â†’docker compose exec fowldata python -c \"from django.conf import settings; print(settings.DATABASES)\"\n   610â†’\n   611â†’# Check test discovery\n   612â†’pytest --collect-only\n   613â†’```\n\n<system-reminder>\nWhenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"86de7839-901d-4853-9ee3-7fbbdb6bf27a","timestamp":"2025-08-25T04:39:34.473Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/markelmore/_code/fowldata/docs/testing.md","content":"# ğŸ§ª Testing Guide\n\nComprehensive testing strategy for FowlData with unit, integration, and end-to-end testing.\n\n## Testing Architecture\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚   Frontend      â”‚    â”‚   Backend       â”‚    â”‚  Integration    â”‚\nâ”‚     Tests       â”‚    â”‚    Tests        â”‚    â”‚     Tests       â”‚\nâ”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚\nâ”‚ â€¢ Jest (Unit)   â”‚    â”‚ â€¢ pytest (Unit)â”‚    â”‚ â€¢ Playwright    â”‚\nâ”‚ â€¢ React Testing â”‚    â”‚ â€¢ pytest-djangoâ”‚    â”‚   (E2E)         â”‚\nâ”‚   Library       â”‚    â”‚ â€¢ Coverage      â”‚    â”‚ â€¢ API Testing   â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## Quick Test Commands\n\n### Run All Tests\n```bash\n./testlint              # Full CI validation including E2E tests\n./testlint-quick        # Quick validation without E2E tests\n```\n\n### Backend Tests\n```bash\n# All backend tests\ndocker compose exec fowldata python -m pytest\n\n# Specific test directories\ndocker compose exec fowldata python -m pytest accounts/tests/ hunts/tests/ -v\n\n# Single test file\ndocker compose exec fowldata python -m pytest hunts/tests/test_weather_api.py -v\n\n# Tests with specific markers\ndocker compose exec fowldata python -m pytest -m \"not performance\" -v\n\n# With coverage\ndocker compose exec fowldata python -m pytest --cov=fowldata --cov-report=html\n```\n\n### Frontend Tests\n```bash\ncd frontend\n\n# Unit tests\nnpm run test                    # Jest unit tests\nnpm run test:watch             # Jest in watch mode\nnpm test -- --watchAll=false   # Run tests once (CI mode)\n\n# E2E tests\nnpm run test:e2e               # Playwright E2E tests\nnpm run test:e2e:ui            # Playwright with UI\nnpm run test:e2e:headed        # Playwright with browser\n```\n\n## Test Structure\n\n### Backend Tests (`fowldata/`)\n\n```\nfowldata/\nâ”œâ”€â”€ accounts/tests/\nâ”‚   â”œâ”€â”€ test_nextauth_backend.py      # NextAuth JWT authentication\nâ”‚   â”œâ”€â”€ test_middleware.py            # Authentication middleware\nâ”‚   â”œâ”€â”€ test_authentication.py        # DRF authentication\nâ”‚   â”œâ”€â”€ test_api_views.py            # API endpoint tests\nâ”‚   â””â”€â”€ test_integration.py          # Full authentication flow\nâ”œâ”€â”€ hunts/tests/\nâ”‚   â”œâ”€â”€ test_models.py               # Model validation and methods\nâ”‚   â”œâ”€â”€ test_api_views.py            # Hunt API endpoints\nâ”‚   â”œâ”€â”€ test_weather_api.py          # Weather integration\nâ”‚   â”œâ”€â”€ test_s3_integration.py       # Photo upload functionality\nâ”‚   â””â”€â”€ test_performance_security.py # Performance tests (CI-skipped)\nâ””â”€â”€ conftest.py                     # Shared pytest fixtures\n```\n\n### Frontend Tests (`frontend/`)\n\n```\nfrontend/\nâ”œâ”€â”€ src/__tests__/\nâ”‚   â”œâ”€â”€ auth.test.ts                 # NextAuth configuration\nâ”‚   â”œâ”€â”€ signin-page.test.tsx         # Authentication components\nâ”‚   â”œâ”€â”€ hunt-form.test.tsx          # Hunt creation forms\nâ”‚   â”œâ”€â”€ api-client.test.ts          # API client functionality\nâ”‚   â””â”€â”€ components/                  # Individual component tests\nâ”œâ”€â”€ e2e/\nâ”‚   â”œâ”€â”€ auth-flow.spec.ts           # Complete authentication flow\nâ”‚   â”œâ”€â”€ hunt-creation.spec.ts       # Hunt creation workflow\nâ”‚   â”œâ”€â”€ photo-upload.spec.ts        # Photo upload functionality\nâ”‚   â””â”€â”€ navigation.spec.ts          # Application navigation\nâ”œâ”€â”€ jest.config.js                  # Jest configuration\nâ”œâ”€â”€ jest.setup.js                   # Jest setup and mocks\nâ””â”€â”€ playwright.config.ts           # Playwright configuration\n```\n\n## Test Categories\n\n### Backend Testing\n\n#### Unit Tests\n**Purpose**: Test individual components in isolation\n\n```python\n# Example: Model validation test\n@pytest.mark.django_db\ndef test_hunt_model_validation():\n    user = MyUser.objects.create_user(\n        email=\"test@example.com\",\n        password=\"testpass123\"\n    )\n    \n    hunt = Hunt.objects.create(\n        user=user,\n        date_of_hunt=date.today(),\n        latitude=40.0,\n        longitude=-74.0\n    )\n    \n    assert hunt.location is not None\n    assert hunt.user == user\n```\n\n#### Integration Tests\n**Purpose**: Test complete workflows and component interactions\n\n```python\n# Example: Authentication flow test\n@pytest.mark.django_db\ndef test_nextauth_jwt_authentication_flow():\n    # Create mock NextAuth session\n    session_data = {\n        \"user\": {\n            \"email\": \"test@example.com\",\n            \"name\": \"Test User\"\n        }\n    }\n    \n    # Test JWT creation and validation\n    token = create_jwt_token(session_data)\n    user = authenticate_jwt_token(token)\n    \n    assert user.email == \"test@example.com\"\n    assert user.is_authenticated\n```\n\n#### API Tests\n**Purpose**: Test REST API endpoints and responses\n\n```python\n# Example: API endpoint test\n@pytest.mark.django_db\ndef test_hunt_list_api(authenticated_client, user):\n    Hunt.objects.create(\n        user=user,\n        date_of_hunt=date.today(),\n        latitude=40.0,\n        longitude=-74.0\n    )\n    \n    response = authenticated_client.get('/api/hunts/')\n    \n    assert response.status_code == 200\n    assert len(response.json()) == 1\n```\n\n### Frontend Testing\n\n#### Component Tests\n**Purpose**: Test React components in isolation\n\n```typescript\n// Example: Component rendering test\nimport { render, screen } from '@testing-library/react';\nimport { HuntForm } from '@/components/HuntForm';\n\ndescribe('HuntForm', () => {\n  it('renders hunt creation form', () => {\n    render(<HuntForm />);\n    \n    expect(screen.getByLabelText(/hunt date/i)).toBeInTheDocument();\n    expect(screen.getByLabelText(/location/i)).toBeInTheDocument();\n    expect(screen.getByRole('button', { name: /save hunt/i })).toBeInTheDocument();\n  });\n  \n  it('validates required fields', async () => {\n    render(<HuntForm />);\n    \n    const submitButton = screen.getByRole('button', { name: /save hunt/i });\n    fireEvent.click(submitButton);\n    \n    expect(await screen.findByText(/hunt date is required/i)).toBeInTheDocument();\n  });\n});\n```\n\n#### Integration Tests\n**Purpose**: Test component interactions and data flow\n\n```typescript\n// Example: Authentication integration test\nimport { render, screen, waitFor } from '@testing-library/react';\nimport { SessionProvider } from 'next-auth/react';\nimport { Dashboard } from '@/components/Dashboard';\n\ndescribe('Dashboard Integration', () => {\n  it('displays user data when authenticated', async () => {\n    const mockSession = {\n      user: { email: 'test@example.com', name: 'Test User' }\n    };\n    \n    render(\n      <SessionProvider session={mockSession}>\n        <Dashboard />\n      </SessionProvider>\n    );\n    \n    await waitFor(() => {\n      expect(screen.getByText('Welcome, Test User')).toBeInTheDocument();\n    });\n  });\n});\n```\n\n### End-to-End Testing\n\n#### Complete User Workflows\n**Purpose**: Test complete user journeys across the application\n\n```typescript\n// Example: Hunt creation E2E test\nimport { test, expect } from '@playwright/test';\n\ntest('complete hunt creation workflow', async ({ page }) => {\n  // Navigate to application\n  await page.goto('http://localhost:3000');\n  \n  // Sign in\n  await page.click('[data-testid=\"sign-in-button\"]');\n  await page.fill('[data-testid=\"email-input\"]', 'mark@mail.com');\n  await page.fill('[data-testid=\"password-input\"]', '1@Tsgstp');\n  await page.click('[data-testid=\"submit-button\"]');\n  \n  // Create new hunt\n  await page.click('[data-testid=\"new-hunt-button\"]');\n  await page.fill('[data-testid=\"hunt-date\"]', '2024-08-15');\n  \n  // Select location on map\n  await page.click('[data-testid=\"map-container\"]', { position: { x: 400, y: 300 } });\n  \n  // Upload photo\n  await page.setInputFiles('[data-testid=\"photo-upload\"]', 'test-files/hunt-photo.jpg');\n  \n  // Save hunt\n  await page.click('[data-testid=\"save-hunt-button\"]');\n  \n  // Verify success\n  await expect(page.locator('[data-testid=\"hunt-created-message\"]')).toBeVisible();\n});\n```\n\n## Test Configuration\n\n### Django Test Settings\n\n#### pytest Configuration (`pytest.ini`)\n```ini\n[tool:pytest]\nDJANGO_SETTINGS_MODULE = fowldata.settings\naddopts = \n    --verbose\n    --tb=short\n    --reuse-db\n    --nomigrations\nmarkers =\n    unit: Unit tests\n    integration: Integration tests\n    api: API tests\n    auth: Authentication tests\n    nextauth: NextAuth-specific tests\n    slow: Slow tests (can be skipped)\n    performance: Performance tests (skipped in CI)\n    threading: Threading tests (skipped in CI)\n    memory_intensive: Memory intensive tests (skipped in CI)\n```\n\n#### Test Fixtures (`conftest.py`)\n```python\n@pytest.fixture\ndef test_user():\n    \"\"\"Create a test user for authentication tests\"\"\"\n    return MyUser.objects.create_user(\n        email=\"test@example.com\",\n        password=\"testpass123\",\n        first_name=\"Test\",\n        last_name=\"User\"\n    )\n\n@pytest.fixture\ndef authenticated_client(test_user):\n    \"\"\"Create an authenticated API client\"\"\"\n    client = APIClient()\n    token = create_test_jwt_token(test_user)\n    client.credentials(HTTP_AUTHORIZATION=f'Bearer {token}')\n    return client\n```\n\n### Frontend Test Configuration\n\n#### Jest Configuration (`jest.config.js`)\n```javascript\nmodule.exports = {\n  testEnvironment: 'jsdom',\n  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],\n  moduleNameMapping: {\n    '^@/(.*)$': '<rootDir>/src/$1',\n  },\n  testMatch: [\n    '<rootDir>/src/**/__tests__/**/*.{js,jsx,ts,tsx}',\n    '<rootDir>/src/**/*.(test|spec).{js,jsx,ts,tsx}'\n  ],\n  collectCoverageFrom: [\n    'src/**/*.{js,jsx,ts,tsx}',\n    '!src/**/*.d.ts',\n    '!src/app/api/**',\n  ],\n  coverageThreshold: {\n    global: {\n      branches: 80,\n      functions: 80,\n      lines: 80,\n      statements: 80\n    }\n  }\n};\n```\n\n#### Playwright Configuration (`playwright.config.ts`)\n```typescript\nexport default defineConfig({\n  testDir: './e2e',\n  timeout: 30000,\n  retries: 2,\n  use: {\n    baseURL: 'http://localhost:3000',\n    headless: true,\n    screenshot: 'only-on-failure',\n    video: 'retain-on-failure',\n  },\n  projects: [\n    {\n      name: 'chromium',\n      use: { ...devices['Desktop Chrome'] },\n    },\n    {\n      name: 'webkit',\n      use: { ...devices['Desktop Safari'] },\n    },\n  ],\n  webServer: {\n    command: 'npm run dev',\n    port: 3000,\n    reuseExistingServer: !process.env.CI,\n  },\n});\n```\n\n## Test Data Management\n\n### Database Test Data\n```python\n# Minimal test data creation\n@pytest.fixture\ndef hunt_with_photos(test_user):\n    \"\"\"Create hunt with associated photos for testing\"\"\"\n    hunt = Hunt.objects.create(\n        user=test_user,\n        date_of_hunt=date.today(),\n        latitude=40.0,\n        longitude=-74.0,\n        weather_conditions=\"Partly cloudy\"\n    )\n    \n    HuntPhoto.objects.create(\n        hunt=hunt,\n        photo_url=\"https://test-bucket.s3.amazonaws.com/test-photo.jpg\",\n        filename=\"test-photo.jpg\"\n    )\n    \n    return hunt\n```\n\n### Mock External Services\n```python\n# Mock weather API responses\n@pytest.fixture\ndef mock_weather_api():\n    with patch('hunts.tasks.get_weather_data') as mock:\n        mock.return_value = {\n            'temp': 65,\n            'conditions': 'Partly cloudy',\n            'humidity': 75,\n            'windspeed': 8\n        }\n        yield mock\n\n# Mock S3 operations\n@pytest.fixture\ndef mock_s3_client():\n    with patch('hunts.s3_manager.boto3.client') as mock:\n        mock.return_value.generate_presigned_url.return_value = \"https://test-url.com\"\n        yield mock\n```\n\n## Test Execution Strategies\n\n### Development Testing\n```bash\n# Quick feedback loop during development\nnpm run test:watch              # Frontend watch mode\ndocker compose exec fowldata python -m pytest -x  # Stop on first failure\n```\n\n### Pre-Commit Testing\n```bash\n# Run before committing changes\n./testlint-quick               # Essential tests only\nnpm run lint                   # Code quality checks\n```\n\n### CI/CD Testing\n```bash\n# Full test suite for pull requests\n./testlint                     # Complete validation\ndocker compose exec fowldata python -m pytest --cov=fowldata  # With coverage\n```\n\n### Performance Testing\n```bash\n# Specialized performance testing (local only)\ndocker compose exec fowldata python -m pytest -m performance\n```\n\n## Test Markers and Filtering\n\n### Django Test Markers\n```bash\n# Run specific test categories\npytest -m \"unit\"               # Unit tests only\npytest -m \"integration\"        # Integration tests only\npytest -m \"auth\"               # Authentication tests\npytest -m \"not slow\"           # Skip slow tests\npytest -m \"not performance\"    # Skip performance tests (CI default)\n```\n\n### Frontend Test Filtering\n```bash\n# Jest test filtering\nnpm test -- --testNamePattern=\"authentication\"  # Tests matching pattern\nnpm test -- src/components/                     # Specific directory\nnpm test -- --coverage                          # With coverage report\n```\n\n## Coverage Requirements\n\n### Coverage Targets\n- **Overall Coverage**: 80% minimum\n- **Authentication Code**: 90% minimum\n- **API Endpoints**: 95% minimum\n- **Critical Business Logic**: 100%\n\n### Coverage Reports\n```bash\n# Backend coverage\ndocker compose exec fowldata python -m pytest --cov=fowldata --cov-report=html\nopen htmlcov/index.html\n\n# Frontend coverage\nnpm test -- --coverage\nopen coverage/lcov-report/index.html\n```\n\n## Debugging Tests\n\n### Django Test Debugging\n```bash\n# Debug with pdb\npytest -s --pdb fowldata/accounts/tests/test_nextauth_backend.py::test_function\n\n# Verbose output\npytest -v -s\n\n# Show print statements\npytest -s\n```\n\n### Frontend Test Debugging\n```bash\n# Debug Jest tests\nnpm test -- --detectOpenHandles --forceExit\n\n# Debug Playwright tests\nnpm run test:e2e -- --debug\nnpm run test:e2e -- --headed\n```\n\n## Common Testing Patterns\n\n### Authentication Testing\n```python\n# Test authenticated endpoints\ndef test_protected_endpoint(authenticated_client):\n    response = authenticated_client.get('/api/protected/')\n    assert response.status_code == 200\n\n# Test authentication failures\ndef test_unauthenticated_access(client):\n    response = client.get('/api/protected/')\n    assert response.status_code == 401\n```\n\n### Form Validation Testing\n```typescript\n// Test form validation\nit('validates required fields', async () => {\n  render(<HuntForm />);\n  \n  // Submit empty form\n  fireEvent.click(screen.getByRole('button', { name: /submit/i }));\n  \n  // Check for validation errors\n  expect(await screen.findByText(/date is required/i)).toBeInTheDocument();\n});\n```\n\n### API Integration Testing\n```typescript\n// Mock API responses\nbeforeEach(() => {\n  fetchMock.mockResponse(JSON.stringify({ success: true }));\n});\n\nit('handles API success', async () => {\n  // Test component behavior with successful API response\n});\n```\n\n## Test Environment Management\n\n### Environment Variables for Testing\n```bash\n# Test-specific environment\nDJANGO_SETTINGS_MODULE=fowldata.settings.test\nDEBUG=True\nAUTH_SECRET=test-secret\nWEATHERAPI_KEY=test-key\n```\n\n### Docker Test Environment\n```bash\n# Start test environment\ndocker compose -f docker-compose.test.yml up -d\n\n# Run tests\n./testlint-quick\n\n# Cleanup\ndocker compose -f docker-compose.test.yml down -v\n```\n\n## Best Practices\n\n### Test Writing Guidelines\n1. **Test Names**: Descriptive names explaining what is being tested\n2. **Arrange-Act-Assert**: Clear test structure\n3. **Isolation**: Each test should be independent\n4. **Mock External Dependencies**: Don't rely on external services\n5. **Test Edge Cases**: Include error conditions and boundary cases\n\n### Test Maintenance\n1. **Keep Tests Updated**: Update tests when features change\n2. **Remove Obsolete Tests**: Clean up tests for removed features\n3. **Refactor Test Code**: Apply same quality standards as production code\n4. **Document Complex Tests**: Add comments for complex test scenarios\n\n### Performance Considerations\n1. **Use Transactions**: Wrap database tests in transactions for speed\n2. **Minimize Database Hits**: Use select_related and prefetch_related\n3. **Mock Heavy Operations**: Mock file uploads, API calls, etc.\n4. **Parallel Execution**: Run tests in parallel when possible\n\n## Troubleshooting\n\n### Common Issues\n1. **Database Conflicts**: Use `--reuse-db` flag or clean database between tests\n2. **Async Issues**: Proper await/async handling in frontend tests\n3. **Mock Conflicts**: Ensure mocks are properly reset between tests\n4. **Environment Issues**: Check test environment configuration\n\n### Debug Commands\n```bash\n# Check test database state\ndocker compose exec fowldata python manage.py dbshell\n\n# Verify test environment\ndocker compose exec fowldata python -c \"from django.conf import settings; print(settings.DATABASES)\"\n\n# Check test discovery\npytest --collect-only\n```","numLines":613,"startLine":1,"totalLines":613}}}
{"parentUuid":"86de7839-901d-4853-9ee3-7fbbdb6bf27a","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XuNLAuyTEGBEYcD4EP4KL7","type":"tool_result","content":"     1â†’# ğŸ” Authentication System\n     2â†’\n     3â†’FowlData uses a sophisticated authentication system that integrates NextAuth.js (frontend) with Django JWT authentication (backend).\n     4â†’\n     5â†’## Architecture Overview\n     6â†’\n     7â†’```\n     8â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    JWT Token    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n     9â†’â”‚   NextAuth.js   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Django JWT    â”‚\n    10â†’â”‚   (Frontend)    â”‚                â”‚   (Backend)     â”‚\n    11â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    12â†’         â”‚                                   â”‚\n    13â†’         â–¼                                   â–¼\n    14â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n    15â†’â”‚  OAuth Providersâ”‚                â”‚  User Database  â”‚\n    16â†’â”‚ Google/Facebook â”‚                â”‚   PostgreSQL    â”‚\n    17â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    18â†’```\n    19â†’\n    20â†’## Key Features\n    21â†’\n    22â†’- **Unified Authentication**: Single sign-on across frontend and backend\n    23â†’- **Social Login**: Google, Facebook, and Instagram OAuth\n    24â†’- **Credentials Login**: Traditional email/password authentication\n    25â†’- **JWT Tokens**: Secure token-based authentication\n    26â†’- **Automatic Sync**: User data synchronized between NextAuth and Django\n    27â†’- **Session Management**: Secure session handling with HTTP-only cookies\n    28â†’\n    29â†’## Configuration\n    30â†’\n    31â†’### Environment Variables\n    32â†’\n    33â†’Both frontend and backend require the same `AUTH_SECRET`:\n    34â†’\n    35â†’```bash\n    36â†’# .env.local (Backend)\n    37â†’AUTH_SECRET=your-secret-key-here\n    38â†’\n    39â†’# frontend/.env.local (Frontend)\n    40â†’AUTH_SECRET=your-secret-key-here\n    41â†’NEXTAUTH_URL=http://localhost:3000\n    42â†’\n    43â†’# OAuth Providers\n    44â†’GOOGLE_CLIENT_ID=your-google-client-id\n    45â†’GOOGLE_CLIENT_SECRET=your-google-client-secret\n    46â†’FACEBOOK_CLIENT_ID=your-facebook-app-id\n    47â†’FACEBOOK_CLIENT_SECRET=your-facebook-app-secret\n    48â†’```\n    49â†’\n    50â†’### Generate AUTH_SECRET\n    51â†’\n    52â†’```bash\n    53â†’openssl rand -base64 32\n    54â†’```\n    55â†’\n    56â†’## OAuth Provider Setup\n    57â†’\n    58â†’### Google OAuth\n    59â†’\n    60â†’1. Go to [Google Cloud Console](https://console.cloud.google.com/)\n    61â†’2. Create/select project and enable Google+ API\n    62â†’3. Create OAuth 2.0 Client ID\n    63â†’4. Add authorized redirect URIs:\n    64â†’   - `http://localhost:3000/api/auth/callback/google` (development)\n    65â†’   - `https://yourdomain.com/api/auth/callback/google` (production)\n    66â†’\n    67â†’### Facebook OAuth\n    68â†’\n    69â†’1. Go to [Facebook Developers](https://developers.facebook.com/)\n    70â†’2. Create app and add \"Facebook Login\" product\n    71â†’3. Configure OAuth redirect URIs:\n    72â†’   - `http://localhost:3000/api/auth/callback/facebook` (development)\n    73â†’   - `https://yourdomain.com/api/auth/callback/facebook` (production)\n    74â†’\n    75â†’### Instagram OAuth\n    76â†’\n    77â†’1. Use Facebook Developers platform\n    78â†’2. Add \"Instagram Basic Display\" product\n    79â†’3. Configure redirect URIs similarly to Facebook\n    80â†’\n    81â†’## Implementation Details\n    82â†’\n    83â†’### Frontend (NextAuth.js)\n    84â†’\n    85â†’#### Configuration File\n    86â†’**Location**: `frontend/src/app/api/auth/[...nextauth]/route.ts`\n    87â†’\n    88â†’```typescript\n    89â†’export const { handlers, auth, signIn, signOut } = NextAuth({\n    90â†’  providers: [\n    91â†’    Google({\n    92â†’      clientId: process.env.GOOGLE_CLIENT_ID!,\n    93â†’      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,\n    94â†’    }),\n    95â†’    Facebook({\n    96â†’      clientId: process.env.FACEBOOK_CLIENT_ID!,\n    97â†’      clientSecret: process.env.FACEBOOK_CLIENT_SECRET!,\n    98â†’    }),\n    99â†’    Credentials({\n   100â†’      // Email/password authentication\n   101â†’    }),\n   102â†’  ],\n   103â†’  session: {\n   104â†’    strategy: \"jwt\",\n   105â†’    maxAge: 24 * 60 * 60, // 24 hours\n   106â†’  },\n   107â†’  callbacks: {\n   108â†’    jwt: async ({ token, user, account }) => {\n   109â†’      // Custom JWT handling\n   110â†’    },\n   111â†’    session: async ({ session, token }) => {\n   112â†’      // Session customization\n   113â†’    },\n   114â†’  },\n   115â†’})\n   116â†’```\n   117â†’\n   118â†’#### API Client Integration\n   119â†’**Location**: `frontend/src/lib/api/client.ts`\n   120â†’\n   121â†’```typescript\n   122â†’const apiClient = {\n   123â†’  async request(endpoint: string, options: RequestInit = {}) {\n   124â†’    // Automatically includes authentication cookies\n   125â†’    const response = await fetch(`${API_BASE_URL}${endpoint}`, {\n   126â†’      ...options,\n   127â†’      credentials: 'include', // Include cookies\n   128â†’      headers: {\n   129â†’        'Content-Type': 'application/json',\n   130â†’        ...options.headers,\n   131â†’      },\n   132â†’    });\n   133â†’    \n   134â†’    if (response.status === 401) {\n   135â†’      // Redirect to sign-in on authentication failure\n   136â†’      window.location.href = '/auth/signin';\n   137â†’    }\n   138â†’    \n   139â†’    return response;\n   140â†’  }\n   141â†’};\n   142â†’```\n   143â†’\n   144â†’### Backend (Django)\n   145â†’\n   146â†’#### JWT Authentication Backend\n   147â†’**Location**: `fowldata/accounts/nextauth_backend.py`\n   148â†’\n   149â†’```python\n   150â†’class NextAuthJWTBackend:\n   151â†’    def authenticate(self, request, **kwargs):\n   152â†’        # Extract JWT from request headers or cookies\n   153â†’        token = self.get_token_from_request(request)\n   154â†’        if not token:\n   155â†’            return None\n   156â†’            \n   157â†’        try:\n   158â†’            # Verify JWT signature\n   159â†’            payload = jwt.decode(\n   160â†’                token, \n   161â†’                settings.AUTH_SECRET, \n   162â†’                algorithms=[\"HS256\"]\n   163â†’            )\n   164â†’            \n   165â†’            # Get or create user from JWT claims\n   166â†’            user = self.get_or_create_user(payload)\n   167â†’            return user\n   168â†’            \n   169â†’        except jwt.InvalidTokenError:\n   170â†’            return None\n   171â†’```\n   172â†’\n   173â†’#### Authentication Middleware\n   174â†’**Location**: `fowldata/accounts/middleware.py`\n   175â†’\n   176â†’```python\n   177â†’class NextAuthJWTMiddleware:\n   178â†’    def __init__(self, get_response):\n   179â†’        self.get_response = get_response\n   180â†’\n   181â†’    def __call__(self, request):\n   182â†’        # Authenticate user for each request\n   183â†’        user = authenticate(request)\n   184â†’        if user:\n   185â†’            request.user = user\n   186â†’        \n   187â†’        response = self.get_response(request)\n   188â†’        return response\n   189â†’```\n   190â†’\n   191â†’#### Django REST Framework Integration\n   192â†’**Location**: `fowldata/accounts/authentication.py`\n   193â†’\n   194â†’```python\n   195â†’class NextAuthJWTAuthentication(BaseAuthentication):\n   196â†’    def authenticate(self, request):\n   197â†’        backend = NextAuthJWTBackend()\n   198â†’        user = backend.authenticate(request)\n   199â†’        \n   200â†’        if user and user.is_active:\n   201â†’            return (user, None)\n   202â†’        return None\n   203â†’```\n   204â†’\n   205â†’### User Models\n   206â†’\n   207â†’#### Django User Model\n   208â†’**Location**: `fowldata/accounts/models.py`\n   209â†’\n   210â†’```python\n   211â†’class MyUser(AbstractUser):\n   212â†’    email = models.EmailField(unique=True)\n   213â†’    first_name = models.CharField(max_length=150)\n   214â†’    last_name = models.CharField(max_length=150)\n   215â†’    is_active = models.BooleanField(default=True)\n   216â†’    \n   217â†’    USERNAME_FIELD = 'email'\n   218â†’    REQUIRED_FIELDS = ['first_name', 'last_name']\n   219â†’\n   220â†’class UserProfile(models.Model):\n   221â†’    user = models.OneToOneField(MyUser, on_delete=models.CASCADE)\n   222â†’    auth_provider = models.CharField(max_length=50)  # 'google', 'facebook', 'credentials'\n   223â†’    external_id = models.CharField(max_length=255, blank=True)\n   224â†’    image_url = models.URLField(blank=True)\n   225â†’    created_at = models.DateTimeField(auto_now_add=True)\n   226â†’    updated_at = models.DateTimeField(auto_now=True)\n   227â†’```\n   228â†’\n   229â†’## Authentication Flow\n   230â†’\n   231â†’### Social Login Flow\n   232â†’\n   233â†’1. **Frontend**: User clicks Google/Facebook login button\n   234â†’2. **OAuth Provider**: User authenticates with provider\n   235â†’3. **NextAuth**: Receives OAuth callback with user data\n   236â†’4. **JWT Creation**: NextAuth creates signed JWT with user information\n   237â†’5. **Cookie Storage**: JWT stored in secure HTTP-only cookie\n   238â†’6. **Backend Sync**: Subsequent API calls include JWT\n   239â†’7. **Django Validation**: Backend validates JWT and creates/updates user\n   240â†’8. **Session Establishment**: User authenticated across entire application\n   241â†’\n   242â†’### Credentials Login Flow\n   243â†’\n   244â†’1. **Frontend**: User submits email/password form\n   245â†’2. **NextAuth**: Validates credentials (can integrate with Django)\n   246â†’3. **JWT Creation**: Creates JWT for authenticated user\n   247â†’4. **Backend Sync**: Same synchronization process as social login\n   248â†’\n   249â†’### API Authentication Flow\n   250â†’\n   251â†’1. **Request**: Frontend makes API request with cookies\n   252â†’2. **Middleware**: Django middleware extracts JWT from cookies/headers\n   253â†’3. **Validation**: JWT signature and expiration validated\n   254â†’4. **User Lookup**: User retrieved/created from JWT payload\n   255â†’5. **Authorization**: Request proceeds with authenticated user context\n   256â†’\n   257â†’## Security Features\n   258â†’\n   259â†’### JWT Security\n   260â†’- **Signed Tokens**: Tokens signed with shared secret\n   261â†’- **Expiration**: Configurable token expiration (24 hours default)\n   262â†’- **No Sensitive Data**: Tokens contain minimal user information\n   263â†’- **Secure Storage**: HTTP-only cookies prevent XSS attacks\n   264â†’\n   265â†’### Session Security\n   266â†’- **CSRF Protection**: Django CSRF middleware enabled\n   267â†’- **Secure Cookies**: HTTPS-only cookies in production\n   268â†’- **SameSite Cookies**: CSRF protection via SameSite attribute\n   269â†’- **Token Refresh**: Automatic token refresh via NextAuth\n   270â†’\n   271â†’### Data Protection\n   272â†’- **Password Hashing**: Django's robust password hashing\n   273â†’- **OAuth Security**: No password storage for social logins\n   274â†’- **User Validation**: Email verification and account validation\n   275â†’- **Brute Force Protection**: Rate limiting on authentication endpoints\n   276â†’\n   277â†’## API Endpoints\n   278â†’\n   279â†’### Authentication Endpoints\n   280â†’\n   281â†’#### Get Current User\n   282â†’```http\n   283â†’GET /api/users/me/\n   284â†’Authorization: Bearer <jwt-token>\n   285â†’\n   286â†’Response:\n   287â†’{\n   288â†’  \"id\": 1,\n   289â†’  \"email\": \"user@example.com\",\n   290â†’  \"first_name\": \"John\",\n   291â†’  \"last_name\": \"Doe\",\n   292â†’  \"profile\": {\n   293â†’    \"auth_provider\": \"google\",\n   294â†’    \"image_url\": \"https://...\",\n   295â†’    \"created_at\": \"2024-01-01T00:00:00Z\"\n   296â†’  }\n   297â†’}\n   298â†’```\n   299â†’\n   300â†’#### Sync User Data\n   301â†’```http\n   302â†’POST /api/auth/sync/\n   303â†’Content-Type: application/json\n   304â†’\n   305â†’{\n   306â†’  \"email\": \"user@example.com\",\n   307â†’  \"first_name\": \"John\",\n   308â†’  \"last_name\": \"Doe\",\n   309â†’  \"image_url\": \"https://...\",\n   310â†’  \"auth_provider\": \"google\"\n   311â†’}\n   312â†’```\n   313â†’\n   314â†’## Testing\n   315â†’\n   316â†’### Test Configuration\n   317â†’\n   318â†’#### Django Tests\n   319â†’```python\n   320â†’# fowldata/accounts/tests/test_nextauth_backend.py\n   321â†’@pytest.mark.django_db\n   322â†’class TestNextAuthJWTBackend:\n   323â†’    def test_authenticate_valid_token(self):\n   324â†’        # Test JWT authentication with valid token\n   325â†’        \n   326â†’    def test_authenticate_invalid_token(self):\n   327â†’        # Test authentication failure with invalid token\n   328â†’        \n   329â†’    def test_user_creation_from_jwt(self):\n   330â†’        # Test automatic user creation from JWT payload\n   331â†’```\n   332â†’\n   333â†’#### Frontend Tests\n   334â†’```typescript\n   335â†’// frontend/src/__tests__/auth.test.ts\n   336â†’describe('NextAuth Configuration', () => {\n   337â†’  it('should have required environment variables', () => {\n   338â†’    // Test environment configuration\n   339â†’  });\n   340â†’  \n   341â†’  it('should configure OAuth providers correctly', () => {\n   342â†’    // Test provider configuration\n   343â†’  });\n   344â†’});\n   345â†’```\n   346â†’\n   347â†’### Test User Credentials\n   348â†’\n   349â†’For E2E testing:\n   350â†’```bash\n   351â†’# Test user credentials\n   352â†’EMAIL=mark@mail.com\n   353â†’PASSWORD=1@Tsgstp\n   354â†’```\n   355â†’\n   356â†’## Troubleshooting\n   357â†’\n   358â†’### Common Issues\n   359â†’\n   360â†’#### \"Invalid JWT token\" errors\n   361â†’- Verify `AUTH_SECRET` matches between frontend and backend\n   362â†’- Check JWT is being sent in cookies or Authorization header\n   363â†’- Ensure token hasn't expired\n   364â†’\n   365â†’#### User not created in Django\n   366â†’- Check Django logs for authentication errors\n   367â†’- Verify UserProfile migration has been run\n   368â†’- Ensure signals are properly connected\n   369â†’\n   370â†’#### CORS errors\n   371â†’- Add frontend URL to Django's `CORS_ALLOWED_ORIGINS`\n   372â†’- Ensure `withCredentials: true` in API client configuration\n   373â†’\n   374â†’#### OAuth redirect errors\n   375â†’- Verify callback URLs match exactly in OAuth provider settings\n   376â†’- Check that OAuth app is in \"Live\" mode for production\n   377â†’\n   378â†’### Debug Mode\n   379â†’\n   380â†’Enable NextAuth debug mode:\n   381â†’```bash\n   382â†’# frontend/.env.local\n   383â†’NEXTAUTH_DEBUG=true\n   384â†’```\n   385â†’\n   386â†’This provides detailed logging in browser console and server logs.\n   387â†’\n   388â†’### Health Check\n   389â†’\n   390â†’Run the authentication health check:\n   391â†’```bash\n   392â†’node auth-health-check.js\n   393â†’```\n   394â†’\n   395â†’## Migration from Legacy Auth\n   396â†’\n   397â†’The system supports gradual migration:\n   398â†’\n   399â†’1. **Existing tokens**: Old token-based auth still works\n   400â†’2. **User linking**: Existing users automatically linked to NextAuth\n   401â†’3. **Gradual rollout**: Can be deployed without breaking existing sessions\n   402â†’4. **Cleanup**: Remove old auth system after migration complete\n   403â†’\n   404â†’## Production Considerations\n   405â†’\n   406â†’### Security Checklist\n   407â†’- [ ] Use strong `AUTH_SECRET` (32+ character random string)\n   408â†’- [ ] Enable HTTPS for all OAuth callbacks\n   409â†’- [ ] Configure proper CORS settings\n   410â†’- [ ] Set up OAuth apps for production domains\n   411â†’- [ ] Enable security headers in Django\n   412â†’- [ ] Configure proper cookie settings (Secure, SameSite)\n   413â†’\n   414â†’### Performance Optimization\n   415â†’- [ ] Configure JWT expiration appropriately\n   416â†’- [ ] Set up proper session storage (Redis for production)\n   417â†’- [ ] Optimize user lookup queries\n   418â†’- [ ] Configure connection pooling\n   419â†’- [ ] Set up monitoring for authentication failures\n   420â†’\n   421â†’### Monitoring\n   422â†’- [ ] Track authentication success/failure rates\n   423â†’- [ ] Monitor JWT validation performance\n   424â†’- [ ] Set up alerts for authentication errors\n   425â†’- [ ] Log OAuth provider issues\n   426â†’- [ ] Monitor user registration patterns\n\n<system-reminder>\nWhenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"732ba4fb-a364-45f2-bd79-b1c69c884533","timestamp":"2025-08-25T04:39:34.473Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/markelmore/_code/fowldata/docs/authentication.md","content":"# ğŸ” Authentication System\n\nFowlData uses a sophisticated authentication system that integrates NextAuth.js (frontend) with Django JWT authentication (backend).\n\n## Architecture Overview\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    JWT Token    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚   NextAuth.js   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Django JWT    â”‚\nâ”‚   (Frontend)    â”‚                â”‚   (Backend)     â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n         â”‚                                   â”‚\n         â–¼                                   â–¼\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚  OAuth Providersâ”‚                â”‚  User Database  â”‚\nâ”‚ Google/Facebook â”‚                â”‚   PostgreSQL    â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n## Key Features\n\n- **Unified Authentication**: Single sign-on across frontend and backend\n- **Social Login**: Google, Facebook, and Instagram OAuth\n- **Credentials Login**: Traditional email/password authentication\n- **JWT Tokens**: Secure token-based authentication\n- **Automatic Sync**: User data synchronized between NextAuth and Django\n- **Session Management**: Secure session handling with HTTP-only cookies\n\n## Configuration\n\n### Environment Variables\n\nBoth frontend and backend require the same `AUTH_SECRET`:\n\n```bash\n# .env.local (Backend)\nAUTH_SECRET=your-secret-key-here\n\n# frontend/.env.local (Frontend)\nAUTH_SECRET=your-secret-key-here\nNEXTAUTH_URL=http://localhost:3000\n\n# OAuth Providers\nGOOGLE_CLIENT_ID=your-google-client-id\nGOOGLE_CLIENT_SECRET=your-google-client-secret\nFACEBOOK_CLIENT_ID=your-facebook-app-id\nFACEBOOK_CLIENT_SECRET=your-facebook-app-secret\n```\n\n### Generate AUTH_SECRET\n\n```bash\nopenssl rand -base64 32\n```\n\n## OAuth Provider Setup\n\n### Google OAuth\n\n1. Go to [Google Cloud Console](https://console.cloud.google.com/)\n2. Create/select project and enable Google+ API\n3. Create OAuth 2.0 Client ID\n4. Add authorized redirect URIs:\n   - `http://localhost:3000/api/auth/callback/google` (development)\n   - `https://yourdomain.com/api/auth/callback/google` (production)\n\n### Facebook OAuth\n\n1. Go to [Facebook Developers](https://developers.facebook.com/)\n2. Create app and add \"Facebook Login\" product\n3. Configure OAuth redirect URIs:\n   - `http://localhost:3000/api/auth/callback/facebook` (development)\n   - `https://yourdomain.com/api/auth/callback/facebook` (production)\n\n### Instagram OAuth\n\n1. Use Facebook Developers platform\n2. Add \"Instagram Basic Display\" product\n3. Configure redirect URIs similarly to Facebook\n\n## Implementation Details\n\n### Frontend (NextAuth.js)\n\n#### Configuration File\n**Location**: `frontend/src/app/api/auth/[...nextauth]/route.ts`\n\n```typescript\nexport const { handlers, auth, signIn, signOut } = NextAuth({\n  providers: [\n    Google({\n      clientId: process.env.GOOGLE_CLIENT_ID!,\n      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,\n    }),\n    Facebook({\n      clientId: process.env.FACEBOOK_CLIENT_ID!,\n      clientSecret: process.env.FACEBOOK_CLIENT_SECRET!,\n    }),\n    Credentials({\n      // Email/password authentication\n    }),\n  ],\n  session: {\n    strategy: \"jwt\",\n    maxAge: 24 * 60 * 60, // 24 hours\n  },\n  callbacks: {\n    jwt: async ({ token, user, account }) => {\n      // Custom JWT handling\n    },\n    session: async ({ session, token }) => {\n      // Session customization\n    },\n  },\n})\n```\n\n#### API Client Integration\n**Location**: `frontend/src/lib/api/client.ts`\n\n```typescript\nconst apiClient = {\n  async request(endpoint: string, options: RequestInit = {}) {\n    // Automatically includes authentication cookies\n    const response = await fetch(`${API_BASE_URL}${endpoint}`, {\n      ...options,\n      credentials: 'include', // Include cookies\n      headers: {\n        'Content-Type': 'application/json',\n        ...options.headers,\n      },\n    });\n    \n    if (response.status === 401) {\n      // Redirect to sign-in on authentication failure\n      window.location.href = '/auth/signin';\n    }\n    \n    return response;\n  }\n};\n```\n\n### Backend (Django)\n\n#### JWT Authentication Backend\n**Location**: `fowldata/accounts/nextauth_backend.py`\n\n```python\nclass NextAuthJWTBackend:\n    def authenticate(self, request, **kwargs):\n        # Extract JWT from request headers or cookies\n        token = self.get_token_from_request(request)\n        if not token:\n            return None\n            \n        try:\n            # Verify JWT signature\n            payload = jwt.decode(\n                token, \n                settings.AUTH_SECRET, \n                algorithms=[\"HS256\"]\n            )\n            \n            # Get or create user from JWT claims\n            user = self.get_or_create_user(payload)\n            return user\n            \n        except jwt.InvalidTokenError:\n            return None\n```\n\n#### Authentication Middleware\n**Location**: `fowldata/accounts/middleware.py`\n\n```python\nclass NextAuthJWTMiddleware:\n    def __init__(self, get_response):\n        self.get_response = get_response\n\n    def __call__(self, request):\n        # Authenticate user for each request\n        user = authenticate(request)\n        if user:\n            request.user = user\n        \n        response = self.get_response(request)\n        return response\n```\n\n#### Django REST Framework Integration\n**Location**: `fowldata/accounts/authentication.py`\n\n```python\nclass NextAuthJWTAuthentication(BaseAuthentication):\n    def authenticate(self, request):\n        backend = NextAuthJWTBackend()\n        user = backend.authenticate(request)\n        \n        if user and user.is_active:\n            return (user, None)\n        return None\n```\n\n### User Models\n\n#### Django User Model\n**Location**: `fowldata/accounts/models.py`\n\n```python\nclass MyUser(AbstractUser):\n    email = models.EmailField(unique=True)\n    first_name = models.CharField(max_length=150)\n    last_name = models.CharField(max_length=150)\n    is_active = models.BooleanField(default=True)\n    \n    USERNAME_FIELD = 'email'\n    REQUIRED_FIELDS = ['first_name', 'last_name']\n\nclass UserProfile(models.Model):\n    user = models.OneToOneField(MyUser, on_delete=models.CASCADE)\n    auth_provider = models.CharField(max_length=50)  # 'google', 'facebook', 'credentials'\n    external_id = models.CharField(max_length=255, blank=True)\n    image_url = models.URLField(blank=True)\n    created_at = models.DateTimeField(auto_now_add=True)\n    updated_at = models.DateTimeField(auto_now=True)\n```\n\n## Authentication Flow\n\n### Social Login Flow\n\n1. **Frontend**: User clicks Google/Facebook login button\n2. **OAuth Provider**: User authenticates with provider\n3. **NextAuth**: Receives OAuth callback with user data\n4. **JWT Creation**: NextAuth creates signed JWT with user information\n5. **Cookie Storage**: JWT stored in secure HTTP-only cookie\n6. **Backend Sync**: Subsequent API calls include JWT\n7. **Django Validation**: Backend validates JWT and creates/updates user\n8. **Session Establishment**: User authenticated across entire application\n\n### Credentials Login Flow\n\n1. **Frontend**: User submits email/password form\n2. **NextAuth**: Validates credentials (can integrate with Django)\n3. **JWT Creation**: Creates JWT for authenticated user\n4. **Backend Sync**: Same synchronization process as social login\n\n### API Authentication Flow\n\n1. **Request**: Frontend makes API request with cookies\n2. **Middleware**: Django middleware extracts JWT from cookies/headers\n3. **Validation**: JWT signature and expiration validated\n4. **User Lookup**: User retrieved/created from JWT payload\n5. **Authorization**: Request proceeds with authenticated user context\n\n## Security Features\n\n### JWT Security\n- **Signed Tokens**: Tokens signed with shared secret\n- **Expiration**: Configurable token expiration (24 hours default)\n- **No Sensitive Data**: Tokens contain minimal user information\n- **Secure Storage**: HTTP-only cookies prevent XSS attacks\n\n### Session Security\n- **CSRF Protection**: Django CSRF middleware enabled\n- **Secure Cookies**: HTTPS-only cookies in production\n- **SameSite Cookies**: CSRF protection via SameSite attribute\n- **Token Refresh**: Automatic token refresh via NextAuth\n\n### Data Protection\n- **Password Hashing**: Django's robust password hashing\n- **OAuth Security**: No password storage for social logins\n- **User Validation**: Email verification and account validation\n- **Brute Force Protection**: Rate limiting on authentication endpoints\n\n## API Endpoints\n\n### Authentication Endpoints\n\n#### Get Current User\n```http\nGET /api/users/me/\nAuthorization: Bearer <jwt-token>\n\nResponse:\n{\n  \"id\": 1,\n  \"email\": \"user@example.com\",\n  \"first_name\": \"John\",\n  \"last_name\": \"Doe\",\n  \"profile\": {\n    \"auth_provider\": \"google\",\n    \"image_url\": \"https://...\",\n    \"created_at\": \"2024-01-01T00:00:00Z\"\n  }\n}\n```\n\n#### Sync User Data\n```http\nPOST /api/auth/sync/\nContent-Type: application/json\n\n{\n  \"email\": \"user@example.com\",\n  \"first_name\": \"John\",\n  \"last_name\": \"Doe\",\n  \"image_url\": \"https://...\",\n  \"auth_provider\": \"google\"\n}\n```\n\n## Testing\n\n### Test Configuration\n\n#### Django Tests\n```python\n# fowldata/accounts/tests/test_nextauth_backend.py\n@pytest.mark.django_db\nclass TestNextAuthJWTBackend:\n    def test_authenticate_valid_token(self):\n        # Test JWT authentication with valid token\n        \n    def test_authenticate_invalid_token(self):\n        # Test authentication failure with invalid token\n        \n    def test_user_creation_from_jwt(self):\n        # Test automatic user creation from JWT payload\n```\n\n#### Frontend Tests\n```typescript\n// frontend/src/__tests__/auth.test.ts\ndescribe('NextAuth Configuration', () => {\n  it('should have required environment variables', () => {\n    // Test environment configuration\n  });\n  \n  it('should configure OAuth providers correctly', () => {\n    // Test provider configuration\n  });\n});\n```\n\n### Test User Credentials\n\nFor E2E testing:\n```bash\n# Test user credentials\nEMAIL=mark@mail.com\nPASSWORD=1@Tsgstp\n```\n\n## Troubleshooting\n\n### Common Issues\n\n#### \"Invalid JWT token\" errors\n- Verify `AUTH_SECRET` matches between frontend and backend\n- Check JWT is being sent in cookies or Authorization header\n- Ensure token hasn't expired\n\n#### User not created in Django\n- Check Django logs for authentication errors\n- Verify UserProfile migration has been run\n- Ensure signals are properly connected\n\n#### CORS errors\n- Add frontend URL to Django's `CORS_ALLOWED_ORIGINS`\n- Ensure `withCredentials: true` in API client configuration\n\n#### OAuth redirect errors\n- Verify callback URLs match exactly in OAuth provider settings\n- Check that OAuth app is in \"Live\" mode for production\n\n### Debug Mode\n\nEnable NextAuth debug mode:\n```bash\n# frontend/.env.local\nNEXTAUTH_DEBUG=true\n```\n\nThis provides detailed logging in browser console and server logs.\n\n### Health Check\n\nRun the authentication health check:\n```bash\nnode auth-health-check.js\n```\n\n## Migration from Legacy Auth\n\nThe system supports gradual migration:\n\n1. **Existing tokens**: Old token-based auth still works\n2. **User linking**: Existing users automatically linked to NextAuth\n3. **Gradual rollout**: Can be deployed without breaking existing sessions\n4. **Cleanup**: Remove old auth system after migration complete\n\n## Production Considerations\n\n### Security Checklist\n- [ ] Use strong `AUTH_SECRET` (32+ character random string)\n- [ ] Enable HTTPS for all OAuth callbacks\n- [ ] Configure proper CORS settings\n- [ ] Set up OAuth apps for production domains\n- [ ] Enable security headers in Django\n- [ ] Configure proper cookie settings (Secure, SameSite)\n\n### Performance Optimization\n- [ ] Configure JWT expiration appropriately\n- [ ] Set up proper session storage (Redis for production)\n- [ ] Optimize user lookup queries\n- [ ] Configure connection pooling\n- [ ] Set up monitoring for authentication failures\n\n### Monitoring\n- [ ] Track authentication success/failure rates\n- [ ] Monitor JWT validation performance\n- [ ] Set up alerts for authentication errors\n- [ ] Log OAuth provider issues\n- [ ] Monitor user registration patterns","numLines":426,"startLine":1,"totalLines":426}}}
{"parentUuid":"732ba4fb-a364-45f2-bd79-b1c69c884533","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01L7wtzhPq5SUf7Uv5LcmgQb","type":"tool_result","content":"     1â†’# Mapping & Geolocation Guide\n     2â†’\n     3â†’FowlData uses Mapbox GL JS v3+ with react-map-gl v8 for interactive mapping and geospatial features.\n     4â†’\n     5â†’## Overview\n     6â†’\n     7â†’The mapping system provides:\n     8â†’- **Interactive Map Interface** - Pan, zoom, and click interactions\n     9â†’- **Hunt Location Tracking** - Precise GPS coordinates for hunting spots\n    10â†’- **Layer Management** - Multiple data layers with privacy controls\n    11â†’- **Clustering** - Automatic grouping of nearby hunt locations\n    12â†’- **Geospatial Queries** - Find hunts within radius, nearest locations\n    13â†’- **Weather Overlay** - Real-time and historical weather data visualization\n    14â†’\n    15â†’## Technical Architecture\n    16â†’\n    17â†’### Map Stack\n    18â†’- **Mapbox GL JS v3.6+** - Core mapping engine\n    19â†’- **react-map-gl v8** - React integration layer\n    20â†’- **PostGIS** - Database geospatial extensions\n    21â†’- **Custom Style** - Satellite imagery with hunt-specific overlays\n    22â†’\n    23â†’### Critical Configuration\n    24â†’\n    25â†’âš ï¸ **Essential for Mapbox GL JS v3+ with react-map-gl v8**:\n    26â†’\n    27â†’```typescript\n    28â†’import mapboxgl from 'mapbox-gl';\n    29â†’\n    30â†’// REQUIRED: Explicit token configuration for layer rendering\n    31â†’const MAPBOX_TOKEN = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;\n    32â†’if (MAPBOX_TOKEN) {\n    33â†’  mapboxgl.accessToken = MAPBOX_TOKEN;\n    34â†’}\n    35â†’```\n    36â†’\n    37â†’**Without this configuration**:\n    38â†’- Map loads successfully âœ…\n    39â†’- Data processing works âœ…\n    40â†’- **NO layers render** âŒ\n    41â†’- No console errors (silent failure) âŒ\n    42â†’\n    43â†’## Map Components\n    44â†’\n    45â†’### Core Map Component\n    46â†’\n    47â†’```typescript\n    48â†’// components/map/UnifiedMap.tsx\n    49â†’import { Map, Source, Layer } from 'react-map-gl/mapbox';\n    50â†’import mapboxgl from 'mapbox-gl';\n    51â†’\n    52â†’// Critical: Set global access token\n    53â†’mapboxgl.accessToken = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN!;\n    54â†’\n    55â†’export default function UnifiedMap({ hunts, onHuntClick }: MapProps) {\n    56â†’  return (\n    57â†’    <Map\n    58â†’      mapboxAccessToken={process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN}\n    59â†’      initialViewState={{\n    60â†’        longitude: -122.4194,\n    61â†’        latitude: 37.7749,\n    62â†’        zoom: 9\n    63â†’      }}\n    64â†’      style={{ width: '100%', height: '100%' }}\n    65â†’      mapStyle=\"mapbox://styles/your-username/your-style-id\"\n    66â†’    >\n    67â†’      {/* Hunt Locations Layer */}\n    68â†’      <Source id=\"hunts\" type=\"geojson\" data={huntGeoJSON}>\n    69â†’        <Layer\n    70â†’          id=\"hunt-points\"\n    71â†’          type=\"circle\"\n    72â†’          paint={{\n    73â†’            'circle-radius': 8,\n    74â†’            'circle-color': '#2563eb',\n    75â†’            'circle-stroke-width': 2,\n    76â†’            'circle-stroke-color': '#ffffff'\n    77â†’          }}\n    78â†’        />\n    79â†’      </Source>\n    80â†’      \n    81â†’      {/* Controls */}\n    82â†’      <NavigationControl position=\"top-right\" />\n    83â†’      <ScaleControl position=\"bottom-left\" />\n    84â†’    </Map>\n    85â†’  );\n    86â†’}\n    87â†’```\n    88â†’\n    89â†’### Layer Structure Requirements\n    90â†’\n    91â†’**react-map-gl v8 Requirements**:\n    92â†’1. Layer components must be **immediate children** of Source components\n    93â†’2. **No React fragments** (`<>...</>`) between Source and Layer\n    94â†’3. **No explicit `source` props** on Layer components inside Source\n    95â†’\n    96â†’```typescript\n    97â†’// âœ… CORRECT\n    98â†’<Source id=\"hunts\" type=\"geojson\" data={data}>\n    99â†’  <Layer id=\"hunt-points\" type=\"circle\" paint={...} />\n   100â†’</Source>\n   101â†’\n   102â†’// âŒ WRONG - React fragment breaks layer connection\n   103â†’<Source id=\"hunts\" type=\"geojson\" data={data}>\n   104â†’  <>\n   105â†’    <Layer id=\"hunt-points\" type=\"circle\" paint={...} />\n   106â†’  </>\n   107â†’</Source>\n   108â†’\n   109â†’// âŒ WRONG - Explicit source prop conflicts\n   110â†’<Source id=\"hunts\" type=\"geojson\" data={data}>\n   111â†’  <Layer id=\"hunt-points\" source=\"hunts\" type=\"circle\" paint={...} />\n   112â†’</Source>\n   113â†’```\n   114â†’\n   115â†’## Geospatial Data Management\n   116â†’\n   117â†’### Hunt Location Storage\n   118â†’\n   119â†’Locations stored as PostGIS Point geometry:\n   120â†’\n   121â†’```sql\n   122â†’-- Database schema\n   123â†’CREATE TABLE hunts_hunt (\n   124â†’    id SERIAL PRIMARY KEY,\n   125â†’    user_id INTEGER REFERENCES accounts_user(id),\n   126â†’    location GEOMETRY(Point, 4326) NOT NULL,\n   127â†’    date DATE NOT NULL,\n   128â†’    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n   129â†’);\n   130â†’\n   131â†’-- Spatial index for performance\n   132â†’CREATE INDEX idx_hunts_location ON hunts_hunt USING GIST (location);\n   133â†’```\n   134â†’\n   135â†’### GeoJSON API Response\n   136â†’\n   137â†’```json\n   138â†’{\n   139â†’  \"type\": \"FeatureCollection\",\n   140â†’  \"features\": [\n   141â†’    {\n   142â†’      \"type\": \"Feature\",\n   143â†’      \"properties\": {\n   144â†’        \"id\": 1,\n   145â†’        \"date\": \"2025-01-15\",\n   146â†’        \"birds_harvested\": 3,\n   147â†’        \"success_rate\": 0.375,\n   148â†’        \"privacy_level\": \"private\",\n   149â†’        \"weather_conditions\": {\n   150â†’          \"temperature\": 45.2,\n   151â†’          \"wind_speed\": 12,\n   152â†’          \"conditions\": \"partly_cloudy\"\n   153â†’        }\n   154â†’      },\n   155â†’      \"geometry\": {\n   156â†’        \"type\": \"Point\",\n   157â†’        \"coordinates\": [-122.6784, 45.5152]\n   158â†’      }\n   159â†’    }\n   160â†’  ]\n   161â†’}\n   162â†’```\n   163â†’\n   164â†’## Layer System\n   165â†’\n   166â†’### Layer Categories\n   167â†’\n   168â†’1. **Hunt Locations** - User hunting spots with privacy controls\n   169â†’2. **Weather Overlay** - Current conditions and forecasts\n   170â†’3. **Waterfowl Management Areas** - Public hunting areas\n   171â†’4. **Migration Routes** - Seasonal bird movement patterns\n   172â†’5. **User Shared Locations** - Community hunting spots\n   173â†’\n   174â†’### Privacy Levels\n   175â†’\n   176â†’- **Private** - Only visible to hunt owner\n   177â†’- **Friends** - Shared with approved connections\n   178â†’- **Public** - Visible to all users\n   179â†’- **Anonymous** - Public but without user attribution\n   180â†’\n   181â†’### Layer Toggle System\n   182â†’\n   183â†’```typescript\n   184â†’// Layer visibility management\n   185â†’interface LayerState {\n   186â†’  [layerId: string]: {\n   187â†’    visible: boolean;\n   188â†’    privacy: 'private' | 'shared' | 'public';\n   189â†’    style: LayerStyle;\n   190â†’  };\n   191â†’}\n   192â†’\n   193â†’const useLayerToggle = () => {\n   194â†’  const [layers, setLayers] = useState<LayerState>({});\n   195â†’  \n   196â†’  const toggleLayer = (layerId: string, visible: boolean) => {\n   197â†’    setLayers(prev => ({\n   198â†’      ...prev,\n   199â†’      [layerId]: { ...prev[layerId], visible }\n   200â†’    }));\n   201â†’  };\n   202â†’  \n   203â†’  return { layers, toggleLayer };\n   204â†’};\n   205â†’```\n   206â†’\n   207â†’## Clustering System\n   208â†’\n   209â†’### Automatic Clustering\n   210â†’\n   211â†’Hunt locations automatically cluster when:\n   212â†’- Zoom level < 12 (distant view)\n   213â†’- Multiple hunts within 50px radius\n   214â†’- More than 100 points visible on screen\n   215â†’\n   216â†’### Cluster Configuration\n   217â†’\n   218â†’```typescript\n   219â†’// Mapbox cluster source configuration\n   220â†’const clusterSource = {\n   221â†’  type: 'geojson' as const,\n   222â†’  data: huntGeoJSON,\n   223â†’  cluster: true,\n   224â†’  clusterMaxZoom: 14,\n   225â†’  clusterRadius: 50,\n   226â†’  clusterProperties: {\n   227â†’    // Aggregate hunt statistics\n   228â†’    total_birds: ['+', ['get', 'birds_harvested']],\n   229â†’    total_hunts: ['+', 1],\n   230â†’    avg_success: ['/', ['+', ['get', 'success_rate']], ['get', 'point_count']]\n   231â†’  }\n   232â†’};\n   233â†’```\n   234â†’\n   235â†’### Cluster Visualization\n   236â†’\n   237â†’```typescript\n   238â†’// Cluster circle styling\n   239â†’const clusterLayer: LayerProps = {\n   240â†’  id: 'clusters',\n   241â†’  type: 'circle',\n   242â†’  source: 'hunts',\n   243â†’  filter: ['has', 'point_count'],\n   244â†’  paint: {\n   245â†’    'circle-color': [\n   246â†’      'step',\n   247â†’      ['get', 'point_count'],\n   248â†’      '#51bbd3',    // < 10 hunts\n   249â†’      10, '#f1c40f', // 10-30 hunts  \n   250â†’      30, '#e74c3c'  // > 30 hunts\n   251â†’    ],\n   252â†’    'circle-radius': [\n   253â†’      'step',\n   254â†’      ['get', 'point_count'],\n   255â†’      20,    // < 10 hunts\n   256â†’      10, 30, // 10-30 hunts\n   257â†’      30, 40  // > 30 hunts  \n   258â†’    ]\n   259â†’  }\n   260â†’};\n   261â†’\n   262â†’// Cluster count labels\n   263â†’const clusterCountLayer: LayerProps = {\n   264â†’  id: 'cluster-count',\n   265â†’  type: 'symbol',\n   266â†’  source: 'hunts', \n   267â†’  filter: ['has', 'point_count'],\n   268â†’  layout: {\n   269â†’    'text-field': '{point_count_abbreviated}',\n   270â†’    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],\n   271â†’    'text-size': 12\n   272â†’  }\n   273â†’};\n   274â†’```\n   275â†’\n   276â†’## Location Services\n   277â†’\n   278â†’### GPS Coordinate Capture\n   279â†’\n   280â†’```typescript\n   281â†’const useLocationCapture = () => {\n   282â†’  const [location, setLocation] = useState<Coordinates | null>(null);\n   283â†’  const [accuracy, setAccuracy] = useState<number>(0);\n   284â†’  \n   285â†’  const captureLocation = () => {\n   286â†’    navigator.geolocation.getCurrentPosition(\n   287â†’      (position) => {\n   288â†’        setLocation({\n   289â†’          latitude: position.coords.latitude,\n   290â†’          longitude: position.coords.longitude\n   291â†’        });\n   292â†’        setAccuracy(position.coords.accuracy);\n   293â†’      },\n   294â†’      (error) => {\n   295â†’        console.error('GPS capture failed:', error);\n   296â†’      },\n   297â†’      {\n   298â†’        enableHighAccuracy: true,\n   299â†’        timeout: 10000,\n   300â†’        maximumAge: 300000 // 5 minutes\n   301â†’      }\n   302â†’    );\n   303â†’  };\n   304â†’  \n   305â†’  return { location, accuracy, captureLocation };\n   306â†’};\n   307â†’```\n   308â†’\n   309â†’### Address Geocoding\n   310â†’\n   311â†’Integration with Mapbox Geocoding API for address lookup:\n   312â†’\n   313â†’```typescript\n   314â†’const geocodeAddress = async (address: string) => {\n   315â†’  const response = await fetch(\n   316â†’    `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${MAPBOX_TOKEN}`\n   317â†’  );\n   318â†’  \n   319â†’  const data = await response.json();\n   320â†’  \n   321â†’  if (data.features.length > 0) {\n   322â†’    const [longitude, latitude] = data.features[0].center;\n   323â†’    return {\n   324â†’      latitude,\n   325â†’      longitude,\n   326â†’      address: data.features[0].place_name\n   327â†’    };\n   328â†’  }\n   329â†’  \n   330â†’  throw new Error('Address not found');\n   331â†’};\n   332â†’```\n   333â†’\n   334â†’## Weather Integration\n   335â†’\n   336â†’### Weather Overlay Layer\n   337â†’\n   338â†’```typescript\n   339â†’// Weather data source\n   340â†’const weatherSource = {\n   341â†’  type: 'geojson' as const,\n   342â†’  data: {\n   343â†’    type: 'FeatureCollection',\n   344â†’    features: weatherStations.map(station => ({\n   345â†’      type: 'Feature',\n   346â†’      properties: {\n   347â†’        temperature: station.temperature,\n   348â†’        wind_speed: station.wind_speed,\n   349â†’        wind_direction: station.wind_direction,\n   350â†’        conditions: station.conditions\n   351â†’      },\n   352â†’      geometry: {\n   353â†’        type: 'Point',\n   354â†’        coordinates: [station.longitude, station.latitude]\n   355â†’      }\n   356â†’    }))\n   357â†’  }\n   358â†’};\n   359â†’\n   360â†’// Weather symbol layer\n   361â†’const weatherLayer: LayerProps = {\n   362â†’  id: 'weather-symbols',\n   363â†’  type: 'symbol',\n   364â†’  source: 'weather',\n   365â†’  layout: {\n   366â†’    'icon-image': [\n   367â†’      'case',\n   368â†’      ['==', ['get', 'conditions'], 'sunny'], 'sun-icon',\n   369â†’      ['==', ['get', 'conditions'], 'cloudy'], 'cloud-icon',\n   370â†’      ['==', ['get', 'conditions'], 'rainy'], 'rain-icon',\n   371â†’      'default-weather-icon'\n   372â†’    ],\n   373â†’    'icon-size': 0.8,\n   374â†’    'text-field': '{temperature}Â°F',\n   375â†’    'text-offset': [0, 2],\n   376â†’    'text-size': 12\n   377â†’  }\n   378â†’};\n   379â†’```\n   380â†’\n   381â†’## Geospatial Queries\n   382â†’\n   383â†’### Nearby Hunt Search\n   384â†’\n   385â†’Backend PostGIS query for spatial search:\n   386â†’\n   387â†’```python\n   388â†’# Django ORM with PostGIS\n   389â†’from django.contrib.gis.geos import Point\n   390â†’from django.contrib.gis.measure import Distance\n   391â†’\n   392â†’def find_nearby_hunts(latitude, longitude, radius_km=50):\n   393â†’    center_point = Point(longitude, latitude, srid=4326)\n   394â†’    \n   395â†’    return Hunt.objects.filter(\n   396â†’        location__distance_lte=(center_point, Distance(km=radius_km))\n   397â†’    ).annotate(\n   398â†’        distance=Distance('location', center_point)\n   399â†’    ).order_by('distance')[:20]\n   400â†’```\n   401â†’\n   402â†’### Frontend Spatial Filtering\n   403â†’\n   404â†’```typescript\n   405â†’const useNearbyHunts = (center: Coordinates, radiusKm: number) => {\n   406â†’  const [nearbyHunts, setNearbyHunts] = useState<Hunt[]>([]);\n   407â†’  \n   408â†’  useEffect(() => {\n   409â†’    const fetchNearbyHunts = async () => {\n   410â†’      const response = await fetch(\n   411â†’        `/api/hunts/nearby/?lat=${center.latitude}&lng=${center.longitude}&radius=${radiusKm}`\n   412â†’      );\n   413â†’      const data = await response.json();\n   414â†’      setNearbyHunts(data.results);\n   415â†’    };\n   416â†’    \n   417â†’    fetchNearbyHunts();\n   418â†’  }, [center, radiusKm]);\n   419â†’  \n   420â†’  return nearbyHunts;\n   421â†’};\n   422â†’```\n   423â†’\n   424â†’## Performance Optimization\n   425â†’\n   426â†’### Data Loading Strategies\n   427â†’\n   428â†’1. **Viewport-based Loading** - Only load hunts visible in current map bounds\n   429â†’2. **Level-of-Detail** - Simplified data at low zoom levels\n   430â†’3. **Clustering** - Reduce visual complexity and API calls\n   431â†’4. **Caching** - Cache geospatial queries with spatial indexes\n   432â†’\n   433â†’### Map Performance\n   434â†’\n   435â†’```typescript\n   436â†’// Optimize re-renders with useCallback\n   437â†’const mapCallbacks = {\n   438â†’  onMove: useCallback((evt: ViewStateChangeEvent) => {\n   439â†’    setViewState(evt.viewState);\n   440â†’  }, []),\n   441â†’  \n   442â†’  onClick: useCallback((event: MapLayerMouseEvent) => {\n   443â†’    const features = event.features;\n   444â†’    if (features && features.length > 0) {\n   445â†’      handleHuntClick(features[0].properties?.id);\n   446â†’    }\n   447â†’  }, [handleHuntClick])\n   448â†’};\n   449â†’\n   450â†’// Memoize expensive GeoJSON processing\n   451â†’const huntGeoJSON = useMemo(() => {\n   452â†’  return {\n   453â†’    type: 'FeatureCollection',\n   454â†’    features: hunts.map(hunt => transformToGeoJSON(hunt))\n   455â†’  };\n   456â†’}, [hunts]);\n   457â†’```\n   458â†’\n   459â†’## Common Issues & Solutions\n   460â†’\n   461â†’### Layer Not Rendering\n   462â†’**Problem**: Map loads but no custom layers appear\n   463â†’**Solution**: Ensure `mapboxgl.accessToken` is set before Map component renders\n   464â†’\n   465â†’### Control Positioning\n   466â†’**Problem**: Custom controls overlap or position incorrectly\n   467â†’**Solution**: Use explicit positioning and z-index management\n   468â†’\n   469â†’```typescript\n   470â†’// Control positioning for Mapbox GL JS v3+\n   471â†’<NavigationControl position=\"top-right\" />\n   472â†’<ScaleControl position=\"bottom-left\" />\n   473â†’\n   474â†’// Custom positioned controls\n   475â†’<div className=\"absolute top-4 left-4 z-10\">\n   476â†’  <LayerTogglePanel />\n   477â†’</div>\n   478â†’```\n   479â†’\n   480â†’### Click Event Issues\n   481â†’**Problem**: Map clicks not registering on layers  \n   482â†’**Solution**: Ensure proper layer configuration and event handlers\n   483â†’\n   484â†’```typescript\n   485â†’// Proper click handling\n   486â†’const mapRef = useRef<MapRef>(null);\n   487â†’\n   488â†’const handleMapClick = (event: MapLayerMouseEvent) => {\n   489â†’  const map = mapRef.current?.getMap();\n   490â†’  const features = map?.queryRenderedFeatures(event.point, {\n   491â†’    layers: ['hunt-points', 'clusters']\n   492â†’  });\n   493â†’  \n   494â†’  if (features && features.length > 0) {\n   495â†’    handleFeatureClick(features[0]);\n   496â†’  }\n   497â†’};\n   498â†’```\n   499â†’\n   500â†’### Memory Leaks\n   501â†’**Problem**: Map component memory usage grows over time\n   502â†’**Solution**: Proper cleanup and ref management\n   503â†’\n   504â†’```typescript\n   505â†’useEffect(() => {\n   506â†’  return () => {\n   507â†’    // Cleanup map resources\n   508â†’    mapRef.current?.getMap().remove();\n   509â†’  };\n   510â†’}, []);\n   511â†’```\n   512â†’\n   513â†’For detailed troubleshooting, see the [Mapbox Integration Guide](./MAPBOX_LAYER_RENDERING_INVESTIGATION.md) and [Performance Optimization](./MAPBOX_PERFORMANCE_OPTIMIZATION.md) documents.\n\n<system-reminder>\nWhenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"62563c20-5d9b-451a-86db-27ec1de6513c","timestamp":"2025-08-25T04:39:34.473Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/markelmore/_code/fowldata/docs/mapping.md","content":"# Mapping & Geolocation Guide\n\nFowlData uses Mapbox GL JS v3+ with react-map-gl v8 for interactive mapping and geospatial features.\n\n## Overview\n\nThe mapping system provides:\n- **Interactive Map Interface** - Pan, zoom, and click interactions\n- **Hunt Location Tracking** - Precise GPS coordinates for hunting spots\n- **Layer Management** - Multiple data layers with privacy controls\n- **Clustering** - Automatic grouping of nearby hunt locations\n- **Geospatial Queries** - Find hunts within radius, nearest locations\n- **Weather Overlay** - Real-time and historical weather data visualization\n\n## Technical Architecture\n\n### Map Stack\n- **Mapbox GL JS v3.6+** - Core mapping engine\n- **react-map-gl v8** - React integration layer\n- **PostGIS** - Database geospatial extensions\n- **Custom Style** - Satellite imagery with hunt-specific overlays\n\n### Critical Configuration\n\nâš ï¸ **Essential for Mapbox GL JS v3+ with react-map-gl v8**:\n\n```typescript\nimport mapboxgl from 'mapbox-gl';\n\n// REQUIRED: Explicit token configuration for layer rendering\nconst MAPBOX_TOKEN = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;\nif (MAPBOX_TOKEN) {\n  mapboxgl.accessToken = MAPBOX_TOKEN;\n}\n```\n\n**Without this configuration**:\n- Map loads successfully âœ…\n- Data processing works âœ…\n- **NO layers render** âŒ\n- No console errors (silent failure) âŒ\n\n## Map Components\n\n### Core Map Component\n\n```typescript\n// components/map/UnifiedMap.tsx\nimport { Map, Source, Layer } from 'react-map-gl/mapbox';\nimport mapboxgl from 'mapbox-gl';\n\n// Critical: Set global access token\nmapboxgl.accessToken = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN!;\n\nexport default function UnifiedMap({ hunts, onHuntClick }: MapProps) {\n  return (\n    <Map\n      mapboxAccessToken={process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN}\n      initialViewState={{\n        longitude: -122.4194,\n        latitude: 37.7749,\n        zoom: 9\n      }}\n      style={{ width: '100%', height: '100%' }}\n      mapStyle=\"mapbox://styles/your-username/your-style-id\"\n    >\n      {/* Hunt Locations Layer */}\n      <Source id=\"hunts\" type=\"geojson\" data={huntGeoJSON}>\n        <Layer\n          id=\"hunt-points\"\n          type=\"circle\"\n          paint={{\n            'circle-radius': 8,\n            'circle-color': '#2563eb',\n            'circle-stroke-width': 2,\n            'circle-stroke-color': '#ffffff'\n          }}\n        />\n      </Source>\n      \n      {/* Controls */}\n      <NavigationControl position=\"top-right\" />\n      <ScaleControl position=\"bottom-left\" />\n    </Map>\n  );\n}\n```\n\n### Layer Structure Requirements\n\n**react-map-gl v8 Requirements**:\n1. Layer components must be **immediate children** of Source components\n2. **No React fragments** (`<>...</>`) between Source and Layer\n3. **No explicit `source` props** on Layer components inside Source\n\n```typescript\n// âœ… CORRECT\n<Source id=\"hunts\" type=\"geojson\" data={data}>\n  <Layer id=\"hunt-points\" type=\"circle\" paint={...} />\n</Source>\n\n// âŒ WRONG - React fragment breaks layer connection\n<Source id=\"hunts\" type=\"geojson\" data={data}>\n  <>\n    <Layer id=\"hunt-points\" type=\"circle\" paint={...} />\n  </>\n</Source>\n\n// âŒ WRONG - Explicit source prop conflicts\n<Source id=\"hunts\" type=\"geojson\" data={data}>\n  <Layer id=\"hunt-points\" source=\"hunts\" type=\"circle\" paint={...} />\n</Source>\n```\n\n## Geospatial Data Management\n\n### Hunt Location Storage\n\nLocations stored as PostGIS Point geometry:\n\n```sql\n-- Database schema\nCREATE TABLE hunts_hunt (\n    id SERIAL PRIMARY KEY,\n    user_id INTEGER REFERENCES accounts_user(id),\n    location GEOMETRY(Point, 4326) NOT NULL,\n    date DATE NOT NULL,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()\n);\n\n-- Spatial index for performance\nCREATE INDEX idx_hunts_location ON hunts_hunt USING GIST (location);\n```\n\n### GeoJSON API Response\n\n```json\n{\n  \"type\": \"FeatureCollection\",\n  \"features\": [\n    {\n      \"type\": \"Feature\",\n      \"properties\": {\n        \"id\": 1,\n        \"date\": \"2025-01-15\",\n        \"birds_harvested\": 3,\n        \"success_rate\": 0.375,\n        \"privacy_level\": \"private\",\n        \"weather_conditions\": {\n          \"temperature\": 45.2,\n          \"wind_speed\": 12,\n          \"conditions\": \"partly_cloudy\"\n        }\n      },\n      \"geometry\": {\n        \"type\": \"Point\",\n        \"coordinates\": [-122.6784, 45.5152]\n      }\n    }\n  ]\n}\n```\n\n## Layer System\n\n### Layer Categories\n\n1. **Hunt Locations** - User hunting spots with privacy controls\n2. **Weather Overlay** - Current conditions and forecasts\n3. **Waterfowl Management Areas** - Public hunting areas\n4. **Migration Routes** - Seasonal bird movement patterns\n5. **User Shared Locations** - Community hunting spots\n\n### Privacy Levels\n\n- **Private** - Only visible to hunt owner\n- **Friends** - Shared with approved connections\n- **Public** - Visible to all users\n- **Anonymous** - Public but without user attribution\n\n### Layer Toggle System\n\n```typescript\n// Layer visibility management\ninterface LayerState {\n  [layerId: string]: {\n    visible: boolean;\n    privacy: 'private' | 'shared' | 'public';\n    style: LayerStyle;\n  };\n}\n\nconst useLayerToggle = () => {\n  const [layers, setLayers] = useState<LayerState>({});\n  \n  const toggleLayer = (layerId: string, visible: boolean) => {\n    setLayers(prev => ({\n      ...prev,\n      [layerId]: { ...prev[layerId], visible }\n    }));\n  };\n  \n  return { layers, toggleLayer };\n};\n```\n\n## Clustering System\n\n### Automatic Clustering\n\nHunt locations automatically cluster when:\n- Zoom level < 12 (distant view)\n- Multiple hunts within 50px radius\n- More than 100 points visible on screen\n\n### Cluster Configuration\n\n```typescript\n// Mapbox cluster source configuration\nconst clusterSource = {\n  type: 'geojson' as const,\n  data: huntGeoJSON,\n  cluster: true,\n  clusterMaxZoom: 14,\n  clusterRadius: 50,\n  clusterProperties: {\n    // Aggregate hunt statistics\n    total_birds: ['+', ['get', 'birds_harvested']],\n    total_hunts: ['+', 1],\n    avg_success: ['/', ['+', ['get', 'success_rate']], ['get', 'point_count']]\n  }\n};\n```\n\n### Cluster Visualization\n\n```typescript\n// Cluster circle styling\nconst clusterLayer: LayerProps = {\n  id: 'clusters',\n  type: 'circle',\n  source: 'hunts',\n  filter: ['has', 'point_count'],\n  paint: {\n    'circle-color': [\n      'step',\n      ['get', 'point_count'],\n      '#51bbd3',    // < 10 hunts\n      10, '#f1c40f', // 10-30 hunts  \n      30, '#e74c3c'  // > 30 hunts\n    ],\n    'circle-radius': [\n      'step',\n      ['get', 'point_count'],\n      20,    // < 10 hunts\n      10, 30, // 10-30 hunts\n      30, 40  // > 30 hunts  \n    ]\n  }\n};\n\n// Cluster count labels\nconst clusterCountLayer: LayerProps = {\n  id: 'cluster-count',\n  type: 'symbol',\n  source: 'hunts', \n  filter: ['has', 'point_count'],\n  layout: {\n    'text-field': '{point_count_abbreviated}',\n    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],\n    'text-size': 12\n  }\n};\n```\n\n## Location Services\n\n### GPS Coordinate Capture\n\n```typescript\nconst useLocationCapture = () => {\n  const [location, setLocation] = useState<Coordinates | null>(null);\n  const [accuracy, setAccuracy] = useState<number>(0);\n  \n  const captureLocation = () => {\n    navigator.geolocation.getCurrentPosition(\n      (position) => {\n        setLocation({\n          latitude: position.coords.latitude,\n          longitude: position.coords.longitude\n        });\n        setAccuracy(position.coords.accuracy);\n      },\n      (error) => {\n        console.error('GPS capture failed:', error);\n      },\n      {\n        enableHighAccuracy: true,\n        timeout: 10000,\n        maximumAge: 300000 // 5 minutes\n      }\n    );\n  };\n  \n  return { location, accuracy, captureLocation };\n};\n```\n\n### Address Geocoding\n\nIntegration with Mapbox Geocoding API for address lookup:\n\n```typescript\nconst geocodeAddress = async (address: string) => {\n  const response = await fetch(\n    `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${MAPBOX_TOKEN}`\n  );\n  \n  const data = await response.json();\n  \n  if (data.features.length > 0) {\n    const [longitude, latitude] = data.features[0].center;\n    return {\n      latitude,\n      longitude,\n      address: data.features[0].place_name\n    };\n  }\n  \n  throw new Error('Address not found');\n};\n```\n\n## Weather Integration\n\n### Weather Overlay Layer\n\n```typescript\n// Weather data source\nconst weatherSource = {\n  type: 'geojson' as const,\n  data: {\n    type: 'FeatureCollection',\n    features: weatherStations.map(station => ({\n      type: 'Feature',\n      properties: {\n        temperature: station.temperature,\n        wind_speed: station.wind_speed,\n        wind_direction: station.wind_direction,\n        conditions: station.conditions\n      },\n      geometry: {\n        type: 'Point',\n        coordinates: [station.longitude, station.latitude]\n      }\n    }))\n  }\n};\n\n// Weather symbol layer\nconst weatherLayer: LayerProps = {\n  id: 'weather-symbols',\n  type: 'symbol',\n  source: 'weather',\n  layout: {\n    'icon-image': [\n      'case',\n      ['==', ['get', 'conditions'], 'sunny'], 'sun-icon',\n      ['==', ['get', 'conditions'], 'cloudy'], 'cloud-icon',\n      ['==', ['get', 'conditions'], 'rainy'], 'rain-icon',\n      'default-weather-icon'\n    ],\n    'icon-size': 0.8,\n    'text-field': '{temperature}Â°F',\n    'text-offset': [0, 2],\n    'text-size': 12\n  }\n};\n```\n\n## Geospatial Queries\n\n### Nearby Hunt Search\n\nBackend PostGIS query for spatial search:\n\n```python\n# Django ORM with PostGIS\nfrom django.contrib.gis.geos import Point\nfrom django.contrib.gis.measure import Distance\n\ndef find_nearby_hunts(latitude, longitude, radius_km=50):\n    center_point = Point(longitude, latitude, srid=4326)\n    \n    return Hunt.objects.filter(\n        location__distance_lte=(center_point, Distance(km=radius_km))\n    ).annotate(\n        distance=Distance('location', center_point)\n    ).order_by('distance')[:20]\n```\n\n### Frontend Spatial Filtering\n\n```typescript\nconst useNearbyHunts = (center: Coordinates, radiusKm: number) => {\n  const [nearbyHunts, setNearbyHunts] = useState<Hunt[]>([]);\n  \n  useEffect(() => {\n    const fetchNearbyHunts = async () => {\n      const response = await fetch(\n        `/api/hunts/nearby/?lat=${center.latitude}&lng=${center.longitude}&radius=${radiusKm}`\n      );\n      const data = await response.json();\n      setNearbyHunts(data.results);\n    };\n    \n    fetchNearbyHunts();\n  }, [center, radiusKm]);\n  \n  return nearbyHunts;\n};\n```\n\n## Performance Optimization\n\n### Data Loading Strategies\n\n1. **Viewport-based Loading** - Only load hunts visible in current map bounds\n2. **Level-of-Detail** - Simplified data at low zoom levels\n3. **Clustering** - Reduce visual complexity and API calls\n4. **Caching** - Cache geospatial queries with spatial indexes\n\n### Map Performance\n\n```typescript\n// Optimize re-renders with useCallback\nconst mapCallbacks = {\n  onMove: useCallback((evt: ViewStateChangeEvent) => {\n    setViewState(evt.viewState);\n  }, []),\n  \n  onClick: useCallback((event: MapLayerMouseEvent) => {\n    const features = event.features;\n    if (features && features.length > 0) {\n      handleHuntClick(features[0].properties?.id);\n    }\n  }, [handleHuntClick])\n};\n\n// Memoize expensive GeoJSON processing\nconst huntGeoJSON = useMemo(() => {\n  return {\n    type: 'FeatureCollection',\n    features: hunts.map(hunt => transformToGeoJSON(hunt))\n  };\n}, [hunts]);\n```\n\n## Common Issues & Solutions\n\n### Layer Not Rendering\n**Problem**: Map loads but no custom layers appear\n**Solution**: Ensure `mapboxgl.accessToken` is set before Map component renders\n\n### Control Positioning\n**Problem**: Custom controls overlap or position incorrectly\n**Solution**: Use explicit positioning and z-index management\n\n```typescript\n// Control positioning for Mapbox GL JS v3+\n<NavigationControl position=\"top-right\" />\n<ScaleControl position=\"bottom-left\" />\n\n// Custom positioned controls\n<div className=\"absolute top-4 left-4 z-10\">\n  <LayerTogglePanel />\n</div>\n```\n\n### Click Event Issues\n**Problem**: Map clicks not registering on layers  \n**Solution**: Ensure proper layer configuration and event handlers\n\n```typescript\n// Proper click handling\nconst mapRef = useRef<MapRef>(null);\n\nconst handleMapClick = (event: MapLayerMouseEvent) => {\n  const map = mapRef.current?.getMap();\n  const features = map?.queryRenderedFeatures(event.point, {\n    layers: ['hunt-points', 'clusters']\n  });\n  \n  if (features && features.length > 0) {\n    handleFeatureClick(features[0]);\n  }\n};\n```\n\n### Memory Leaks\n**Problem**: Map component memory usage grows over time\n**Solution**: Proper cleanup and ref management\n\n```typescript\nuseEffect(() => {\n  return () => {\n    // Cleanup map resources\n    mapRef.current?.getMap().remove();\n  };\n}, []);\n```\n\nFor detailed troubleshooting, see the [Mapbox Integration Guide](./MAPBOX_LAYER_RENDERING_INVESTIGATION.md) and [Performance Optimization](./MAPBOX_PERFORMANCE_OPTIMIZATION.md) documents.","numLines":513,"startLine":1,"totalLines":513}}}
{"parentUuid":"62563c20-5d9b-451a-86db-27ec1de6513c","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_0149ZsQNXUPChafwqX1qY5BC","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01U9hkWJeBZiCq5skk2Ez7We","name":"TodoWrite","input":{"todos":[{"content":"Read all files in the docs directory","status":"completed","activeForm":"Reading all files in the docs directory"},{"content":"Examine CLAUDE.md file for potential improvements","status":"in_progress","activeForm":"Examining CLAUDE.md file for potential improvements"},{"content":"Provide recommendations for improving CLAUDE.md","status":"pending","activeForm":"Providing recommendations for improving CLAUDE.md"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":21228,"cache_read_input_tokens":48832,"cache_creation":{"ephemeral_5m_input_tokens":21228,"ephemeral_1h_input_tokens":0},"output_tokens":26,"service_tier":"standard"}},"requestId":"req_011CSTp2Zv2HLHPmJTfMEyGd","type":"assistant","uuid":"fc3f16b1-9632-484e-8804-6349e511cd2c","timestamp":"2025-08-25T04:39:39.878Z"}
{"parentUuid":"fc3f16b1-9632-484e-8804-6349e511cd2c","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01U9hkWJeBZiCq5skk2Ez7We","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"8391f7d0-c2c2-496b-b85a-2e568e5d6316","timestamp":"2025-08-25T04:39:39.931Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Read all files in the docs directory","status":"completed","activeForm":"Reading all files in the docs directory"},{"content":"Examine CLAUDE.md file for potential improvements","status":"in_progress","activeForm":"Examining CLAUDE.md file for potential improvements"},{"content":"Provide recommendations for improving CLAUDE.md","status":"pending","activeForm":"Providing recommendations for improving CLAUDE.md"}]}}
{"parentUuid":"8391f7d0-c2c2-496b-b85a-2e568e5d6316","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01FGEp1Lq6X7pNKg8jy9JfiM","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"Now let me examine the current CLAUDE.md file to understand its structure and content:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":203,"cache_read_input_tokens":70060,"cache_creation":{"ephemeral_5m_input_tokens":203,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTp2y5JKaQhjZzqXYXZv","type":"assistant","uuid":"de7ebfb8-df5d-4ee2-a038-363b8c5b2f0c","timestamp":"2025-08-25T04:39:43.191Z"}
{"parentUuid":"de7ebfb8-df5d-4ee2-a038-363b8c5b2f0c","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01FGEp1Lq6X7pNKg8jy9JfiM","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01SnPyYXPA9j2GypbmjNBcqe","name":"Read","input":{"file_path":"/Users/markelmore/_code/fowldata/CLAUDE.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":203,"cache_read_input_tokens":70060,"cache_creation":{"ephemeral_5m_input_tokens":203,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTp2y5JKaQhjZzqXYXZv","type":"assistant","uuid":"183cc23d-6459-43eb-a20e-5eecd09899d6","timestamp":"2025-08-25T04:39:43.866Z"}
{"parentUuid":"183cc23d-6459-43eb-a20e-5eecd09899d6","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SnPyYXPA9j2GypbmjNBcqe","type":"tool_result","content":"     1â†’# CLAUDE.md\n     2â†’\n     3â†’This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n     4â†’\n     5â†’## âš ï¸ CRITICAL: Docker Network Configuration - NEVER CHANGE\n     6â†’**RECURRING ISSUE - ALWAYS CHECK THIS FIRST**\n     7â†’\n     8â†’The frontend `.env.local` file MUST use the Docker service name for backend communication:\n     9â†’```bash\n    10â†’# CORRECT - Use Docker service name (this is in frontend/.env.local)\n    11â†’BACKEND_URL=http://fowldata:8000\n    12â†’\n    13â†’# WRONG - Will cause ECONNREFUSED errors in Docker containers\n    14â†’BACKEND_URL=http://localhost:8000\n    15â†’```\n    16â†’\n    17â†’**Why**: Inside Docker containers, `localhost` refers to the container itself, not the host. Service names resolve to container IPs within the Docker network.\n    18â†’\n    19â†’**Symptoms**: NextAuth authentication fails, API calls fail with \"connect ECONNREFUSED ::1:8000\"\n    20â†’\n    21â†’**Fix**: Always use `fowldata:8000` (service name from docker-compose.yml) for inter-container communication.\n    22â†’\n    23â†’## âš ï¸ CRITICAL: Mapbox GL JS v3+ with react-map-gl v8 Layer Rendering\n    24â†’**RECURRING ISSUE - ESSENTIAL FOR LAYER VISIBILITY**\n    25â†’\n    26â†’When using Mapbox GL JS v3+ with react-map-gl v8, layers will NOT render without explicit `mapboxgl.accessToken` configuration:\n    27â†’\n    28â†’```typescript\n    29â†’import mapboxgl from 'mapbox-gl';\n    30â†’\n    31â†’const MAPBOX_TOKEN = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;\n    32â†’\n    33â†’// CRITICAL: This is required for Mapbox GL JS v3+ with react-map-gl v8\n    34â†’if (MAPBOX_TOKEN) {\n    35â†’  mapboxgl.accessToken = MAPBOX_TOKEN;\n    36â†’}\n    37â†’```\n    38â†’\n    39â†’**Why**: react-map-gl v8 delegates to Mapbox GL JS v3+ which requires explicit token configuration. Previous versions handled this automatically.\n    40â†’\n    41â†’**Symptoms**: \n    42â†’- Map loads successfully with satellite/custom styles\n    43â†’- Source/Layer components appear to be configured correctly  \n    44â†’- Debug panels show data is present\n    45â†’- NO visual layers render (not even test layers with bright colors)\n    46â†’- No console errors about authentication or tokens\n    47â†’- Canvas element exists but shows no content\n    48â†’\n    49â†’**Additional react-map-gl v8 Requirements:**\n    50â†’- Layer components must be **immediate children** of Source components (no React fragments `<>...</>`)\n    51â†’- Do NOT add explicit `source` props to Layer components inside Source components\n    52â†’- Remove conditional `mapStyleLoaded` wrappers - let react-map-gl handle timing internally\n    53â†’\n    54â†’**Fix Location**: Add the `mapboxgl.accessToken` configuration at the top level of your Map component file, after importing mapboxgl.\n    55â†’\n    56â†’**Debugging Signs This is the Issue**:\n    57â†’- Mapbox canvas renders with proper classes (`mapboxgl-canvas-container`)\n    58â†’- Map style loads successfully\n    59â†’- Data processing works correctly\n    60â†’- Visibility and layer management appears functional\n    61â†’- Zero visual layer rendering despite all other systems working\n    62â†’\n    63â†’## âš ï¸ CRITICAL: Production Environment Variable Loading\n    64â†’**RECURRING DEPLOYMENT ISSUE - ESSENTIAL FOR PRODUCTION**\n    65â†’\n    66â†’Docker Compose production deployments REQUIRE explicit `--env-file` flag:\n    67â†’\n    68â†’```bash\n    69â†’# REQUIRED for all production commands\n    70â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n    71â†’\n    72â†’# WRONG - Will cause \"variable is not set\" warnings and startup failures\n    73â†’docker-compose -f docker-compose.prod.yaml up -d\n    74â†’```\n    75â†’\n    76â†’**Why**: The `env_file:` setting in docker-compose.prod.yaml handles container environment variables, but Docker Compose variable substitution (${VARIABLE}) requires the explicit `--env-file` flag.\n    77â†’\n    78â†’**Symptoms**: \n    79â†’- `WARN[0000] The \"DB_NAME\" variable is not set. Defaulting to a blank string.`\n    80â†’- PostgreSQL container fails with \"superuser password not specified\"\n    81â†’- Environment variables visible in some services but not others\n    82â†’\n    83â†’**Additional Production Requirements**:\n    84â†’- All services need `env_file: - .env.production` in docker-compose.prod.yaml\n    85â†’- Avoid special characters in passwords (`$`, `!`, etc.) - shell interprets them\n    86â†’- Use clean file encoding (UTF-8 without BOM) for environment files\n    87â†’\n    88â†’## Architecture Overview\n    89â†’\n    90â†’FowlData is a production-ready full-stack waterfowl hunting tracking application:\n    91â†’\n    92â†’**Backend (Django)**: Located in `fowldata/` directory\n    93â†’- Django 4.2 with Django REST Framework for API endpoints\n    94â†’- PostgreSQL 16 with PostGIS 3.4 for geospatial data storage and spatial queries\n    95â†’- JWT RS256 authentication integrated with NextAuth.js frontend\n    96â†’- Two main apps: `accounts` (user management) and `hunts` (hunt tracking)\n    97â†’- AWS S3 integration for photo storage with presigned URLs and CORS\n    98â†’- Gunicorn WSGI server with production performance tuning\n    99â†’\n   100â†’**Frontend (Next.js)**: Located in `frontend/` directory  \n   101â†’- Next.js 15.4.4 with React 19 and TypeScript\n   102â†’- NextAuth.js v5 with Google OAuth and credentials authentication\n   103â†’- Mapbox GL JS v3+ with react-map-gl v8 for interactive mapping\n   104â†’- TailwindCSS for styling, React Hook Form for forms\n   105â†’- Playwright for E2E testing, Jest for unit tests\n   106â†’- Production-optimized standalone builds\n   107â†’\n   108â†’**Production Infrastructure**:\n   109â†’- **Deployment**: Digital Ocean Droplets with Docker Compose orchestration\n   110â†’- **Reverse Proxy**: Nginx with SSL/TLS termination via Let's Encrypt\n   111â†’- **Caching**: Redis for sessions, query caching, and performance optimization\n   112â†’- **Storage**: AWS S3 with CloudFront CDN for photo uploads and static assets\n   113â†’- **Database**: PostgreSQL with PostGIS extensions, performance tuning, and automated backups\n   114â†’- **Monitoring**: Docker health checks, database performance monitoring, and logging\n   115â†’- **Security**: SSL enforcement, security headers, rate limiting, and firewall configuration\n   116â†’\n   117â†’## Development Commands\n   118â†’\n   119â†’### Backend Development\n   120â†’```bash\n   121â†’# Start services\n   122â†’docker compose up -d\n   123â†’\n   124â†’# Django management commands\n   125â†’docker compose exec fowldata python manage.py migrate\n   126â†’docker compose exec fowldata python manage.py createsuperuser\n   127â†’docker compose exec fowldata python manage.py shell\n   128â†’\n   129â†’# Run backend tests\n   130â†’docker compose exec fowldata python -m pytest\n   131â†’docker compose exec fowldata python -m pytest accounts/tests/ hunts/tests/ -v\n   132â†’\n   133â†’# Code formatting and linting\n   134â†’docker compose exec fowldata black .\n   135â†’docker compose exec fowldata flake8\n   136â†’\n   137â†’# Single test file\n   138â†’docker compose exec fowldata python -m pytest hunts/tests/test_weather_api.py -v\n   139â†’```\n   140â†’\n   141â†’### Frontend Development\n   142â†’```bash\n   143â†’cd frontend\n   144â†’\n   145â†’# Development server (with Turbopack)\n   146â†’npm run dev\n   147â†’\n   148â†’# Build and type checking\n   149â†’npm run build\n   150â†’npm run lint\n   151â†’\n   152â†’# Testing\n   153â†’npm run test                    # Jest unit tests\n   154â†’npm run test:watch             # Jest in watch mode  \n   155â†’npm run test:e2e               # Playwright E2E tests\n   156â†’npm run test:e2e:ui            # Playwright with UI\n   157â†’```\n   158â†’\n   159â†’### Pre-Commit Validation\n   160â†’```bash\n   161â†’# Full CI validation (includes E2E tests)\n   162â†’./testlint\n   163â†’\n   164â†’# Quick validation (faster, no E2E)  \n   165â†’./testlint-quick\n   166â†’```\n   167â†’\n   168â†’### Production Deployment\n   169â†’```bash\n   170â†’# Production validation and deployment\n   171â†’./scripts/validate-production.sh\n   172â†’\n   173â†’# Production commands (ALWAYS use --env-file flag)\n   174â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production build\n   175â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n   176â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production logs -f\n   177â†’\n   178â†’# Django production setup\n   179â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py migrate\n   180â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py createsuperuser\n   181â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py collectstatic --noinput\n   182â†’```\n   183â†’\n   184â†’## Core Data Models\n   185â†’\n   186â†’**Hunt Model** (`hunts/models.py`):\n   187â†’- Tracks hunting sessions with date, location (PostGIS Point), weather conditions\n   188â†’- Links to multiple Bird harvests and HuntPhoto uploads\n   189â†’- Weather data automatically fetched from external API based on coordinates\n   190â†’\n   191â†’**Bird Model**:\n   192â†’- Individual waterfowl harvests within a hunt\n   193â†’- Species selection from predefined WATERFOWL_CHOICES (Dabblers, Divers, Geese)\n   194â†’- Includes harvest time, notes, and gender (Drake/Hen)\n   195â†’\n   196â†’**Authentication Integration**:\n   197â†’- Django backend uses custom NextAuthBackend for JWT token validation\n   198â†’- Frontend NextAuth.js providers: Google, Facebook, Credentials\n   199â†’- Token synchronization between NextAuth and Django API client\n   200â†’\n   201â†’## Key Integration Points\n   202â†’\n   203â†’**Django-NextAuth Authentication Flow**:\n   204â†’- NextAuth JWT tokens validated by Django via `accounts/nextauth_backend.py`  \n   205â†’- API requests include NextAuth JWT in Authorization header\n   206â†’- User creation/sync handled by Django signals in `accounts/signals.py`\n   207â†’\n   208â†’**Photo Upload System**:\n   209â†’- S3 presigned URLs generated by Django `hunts/s3_manager.py`\n   210â†’- Frontend uploads directly to S3, then registers with Django\n   211â†’- HuntPhoto model tracks S3 URLs linked to Hunt instances\n   212â†’\n   213â†’**Geospatial Features**:\n   214â†’- Hunt locations stored as PostGIS Points with lat/lng coordinates\n   215â†’- Weather API integration fetches conditions based on hunt coordinates\n   216â†’- Mapbox integration for location selection and visualization\n   217â†’\n   218â†’## Environment Configuration\n   219â†’\n   220â†’Required environment files:\n   221â†’- `.env.local` (root) - Django database, secrets, S3 credentials\n   222â†’- `frontend/.env.local` - NextAuth secrets, API URLs\n   223â†’\n   224â†’Critical environment variables:\n   225â†’- `SECRET_KEY` (Django), `AUTH_SECRET` (NextAuth)\n   226â†’- `DB_HOST`, `DB_NAME`, `DB_USER`, `DB_PASS` (PostgreSQL)\n   227â†’- `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_S3_BUCKET_NAME`\n   228â†’- `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` (OAuth)\n   229â†’\n   230â†’## Testing Patterns\n   231â†’\n   232â†’**Backend Tests** (pytest-django):\n   233â†’- Database tests marked with `@pytest.mark.django_db`\n   234â†’- API endpoint tests use Django's APIClient  \n   235â†’- External services (S3, weather API) are mocked\n   236â†’- Fixtures in `conftest.py` create test users and hunt data\n   237â†’\n   238â†’**Frontend Tests**:\n   239â†’- Unit tests: Jest + React Testing Library in `src/__tests__/`\n   240â†’- Component tests focus on user interactions, not implementation\n   241â†’- E2E tests: Playwright in `e2e/` directory with real browser automation\n   242â†’- API mocking for isolated component testing\n   243â†’\n   244â†’## Mapbox Configuration\n   245â†’\n   246â†’- Import controls from `react-map-gl/mapbox` for Mapbox GL JS v3.5+\n   247â†’- Control positioning critical - use `position` prop, not `style` object\n   248â†’- Standard controls must be children of `<Map>` component\n   249â†’- Custom controls positioned absolutely outside `<Map>`\n   250â†’- Test controls in both browser and fullscreen modes\n   251â†’\n   252â†’## Development Notes\n   253â†’\n   254â†’- Rebuild Docker containers after backend changes to see frontend updates\n   255â†’- Use test credentials: `mark@mail.com` / `1@Tsgstp` for Puppeteer E2E tests\n   256â†’- Run `./testlint-quick` before commits, `./testlint` before PRs\n   257â†’- Weather API responses should be mocked in tests for consistency\n   258â†’- if authentication issue arises we can run  Run the health check script:\n   259â†’  node auth-health-check.js\n\n<system-reminder>\nWhenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"dfe8a4e5-6ec4-4169-8dd6-71c7e316a37b","timestamp":"2025-08-25T04:39:43.946Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/markelmore/_code/fowldata/CLAUDE.md","content":"# CLAUDE.md\n\nThis file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n\n## âš ï¸ CRITICAL: Docker Network Configuration - NEVER CHANGE\n**RECURRING ISSUE - ALWAYS CHECK THIS FIRST**\n\nThe frontend `.env.local` file MUST use the Docker service name for backend communication:\n```bash\n# CORRECT - Use Docker service name (this is in frontend/.env.local)\nBACKEND_URL=http://fowldata:8000\n\n# WRONG - Will cause ECONNREFUSED errors in Docker containers\nBACKEND_URL=http://localhost:8000\n```\n\n**Why**: Inside Docker containers, `localhost` refers to the container itself, not the host. Service names resolve to container IPs within the Docker network.\n\n**Symptoms**: NextAuth authentication fails, API calls fail with \"connect ECONNREFUSED ::1:8000\"\n\n**Fix**: Always use `fowldata:8000` (service name from docker-compose.yml) for inter-container communication.\n\n## âš ï¸ CRITICAL: Mapbox GL JS v3+ with react-map-gl v8 Layer Rendering\n**RECURRING ISSUE - ESSENTIAL FOR LAYER VISIBILITY**\n\nWhen using Mapbox GL JS v3+ with react-map-gl v8, layers will NOT render without explicit `mapboxgl.accessToken` configuration:\n\n```typescript\nimport mapboxgl from 'mapbox-gl';\n\nconst MAPBOX_TOKEN = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;\n\n// CRITICAL: This is required for Mapbox GL JS v3+ with react-map-gl v8\nif (MAPBOX_TOKEN) {\n  mapboxgl.accessToken = MAPBOX_TOKEN;\n}\n```\n\n**Why**: react-map-gl v8 delegates to Mapbox GL JS v3+ which requires explicit token configuration. Previous versions handled this automatically.\n\n**Symptoms**: \n- Map loads successfully with satellite/custom styles\n- Source/Layer components appear to be configured correctly  \n- Debug panels show data is present\n- NO visual layers render (not even test layers with bright colors)\n- No console errors about authentication or tokens\n- Canvas element exists but shows no content\n\n**Additional react-map-gl v8 Requirements:**\n- Layer components must be **immediate children** of Source components (no React fragments `<>...</>`)\n- Do NOT add explicit `source` props to Layer components inside Source components\n- Remove conditional `mapStyleLoaded` wrappers - let react-map-gl handle timing internally\n\n**Fix Location**: Add the `mapboxgl.accessToken` configuration at the top level of your Map component file, after importing mapboxgl.\n\n**Debugging Signs This is the Issue**:\n- Mapbox canvas renders with proper classes (`mapboxgl-canvas-container`)\n- Map style loads successfully\n- Data processing works correctly\n- Visibility and layer management appears functional\n- Zero visual layer rendering despite all other systems working\n\n## âš ï¸ CRITICAL: Production Environment Variable Loading\n**RECURRING DEPLOYMENT ISSUE - ESSENTIAL FOR PRODUCTION**\n\nDocker Compose production deployments REQUIRE explicit `--env-file` flag:\n\n```bash\n# REQUIRED for all production commands\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# WRONG - Will cause \"variable is not set\" warnings and startup failures\ndocker-compose -f docker-compose.prod.yaml up -d\n```\n\n**Why**: The `env_file:` setting in docker-compose.prod.yaml handles container environment variables, but Docker Compose variable substitution (${VARIABLE}) requires the explicit `--env-file` flag.\n\n**Symptoms**: \n- `WARN[0000] The \"DB_NAME\" variable is not set. Defaulting to a blank string.`\n- PostgreSQL container fails with \"superuser password not specified\"\n- Environment variables visible in some services but not others\n\n**Additional Production Requirements**:\n- All services need `env_file: - .env.production` in docker-compose.prod.yaml\n- Avoid special characters in passwords (`$`, `!`, etc.) - shell interprets them\n- Use clean file encoding (UTF-8 without BOM) for environment files\n\n## Architecture Overview\n\nFowlData is a production-ready full-stack waterfowl hunting tracking application:\n\n**Backend (Django)**: Located in `fowldata/` directory\n- Django 4.2 with Django REST Framework for API endpoints\n- PostgreSQL 16 with PostGIS 3.4 for geospatial data storage and spatial queries\n- JWT RS256 authentication integrated with NextAuth.js frontend\n- Two main apps: `accounts` (user management) and `hunts` (hunt tracking)\n- AWS S3 integration for photo storage with presigned URLs and CORS\n- Gunicorn WSGI server with production performance tuning\n\n**Frontend (Next.js)**: Located in `frontend/` directory  \n- Next.js 15.4.4 with React 19 and TypeScript\n- NextAuth.js v5 with Google OAuth and credentials authentication\n- Mapbox GL JS v3+ with react-map-gl v8 for interactive mapping\n- TailwindCSS for styling, React Hook Form for forms\n- Playwright for E2E testing, Jest for unit tests\n- Production-optimized standalone builds\n\n**Production Infrastructure**:\n- **Deployment**: Digital Ocean Droplets with Docker Compose orchestration\n- **Reverse Proxy**: Nginx with SSL/TLS termination via Let's Encrypt\n- **Caching**: Redis for sessions, query caching, and performance optimization\n- **Storage**: AWS S3 with CloudFront CDN for photo uploads and static assets\n- **Database**: PostgreSQL with PostGIS extensions, performance tuning, and automated backups\n- **Monitoring**: Docker health checks, database performance monitoring, and logging\n- **Security**: SSL enforcement, security headers, rate limiting, and firewall configuration\n\n## Development Commands\n\n### Backend Development\n```bash\n# Start services\ndocker compose up -d\n\n# Django management commands\ndocker compose exec fowldata python manage.py migrate\ndocker compose exec fowldata python manage.py createsuperuser\ndocker compose exec fowldata python manage.py shell\n\n# Run backend tests\ndocker compose exec fowldata python -m pytest\ndocker compose exec fowldata python -m pytest accounts/tests/ hunts/tests/ -v\n\n# Code formatting and linting\ndocker compose exec fowldata black .\ndocker compose exec fowldata flake8\n\n# Single test file\ndocker compose exec fowldata python -m pytest hunts/tests/test_weather_api.py -v\n```\n\n### Frontend Development\n```bash\ncd frontend\n\n# Development server (with Turbopack)\nnpm run dev\n\n# Build and type checking\nnpm run build\nnpm run lint\n\n# Testing\nnpm run test                    # Jest unit tests\nnpm run test:watch             # Jest in watch mode  \nnpm run test:e2e               # Playwright E2E tests\nnpm run test:e2e:ui            # Playwright with UI\n```\n\n### Pre-Commit Validation\n```bash\n# Full CI validation (includes E2E tests)\n./testlint\n\n# Quick validation (faster, no E2E)  \n./testlint-quick\n```\n\n### Production Deployment\n```bash\n# Production validation and deployment\n./scripts/validate-production.sh\n\n# Production commands (ALWAYS use --env-file flag)\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production build\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production logs -f\n\n# Django production setup\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py migrate\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py createsuperuser\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py collectstatic --noinput\n```\n\n## Core Data Models\n\n**Hunt Model** (`hunts/models.py`):\n- Tracks hunting sessions with date, location (PostGIS Point), weather conditions\n- Links to multiple Bird harvests and HuntPhoto uploads\n- Weather data automatically fetched from external API based on coordinates\n\n**Bird Model**:\n- Individual waterfowl harvests within a hunt\n- Species selection from predefined WATERFOWL_CHOICES (Dabblers, Divers, Geese)\n- Includes harvest time, notes, and gender (Drake/Hen)\n\n**Authentication Integration**:\n- Django backend uses custom NextAuthBackend for JWT token validation\n- Frontend NextAuth.js providers: Google, Facebook, Credentials\n- Token synchronization between NextAuth and Django API client\n\n## Key Integration Points\n\n**Django-NextAuth Authentication Flow**:\n- NextAuth JWT tokens validated by Django via `accounts/nextauth_backend.py`  \n- API requests include NextAuth JWT in Authorization header\n- User creation/sync handled by Django signals in `accounts/signals.py`\n\n**Photo Upload System**:\n- S3 presigned URLs generated by Django `hunts/s3_manager.py`\n- Frontend uploads directly to S3, then registers with Django\n- HuntPhoto model tracks S3 URLs linked to Hunt instances\n\n**Geospatial Features**:\n- Hunt locations stored as PostGIS Points with lat/lng coordinates\n- Weather API integration fetches conditions based on hunt coordinates\n- Mapbox integration for location selection and visualization\n\n## Environment Configuration\n\nRequired environment files:\n- `.env.local` (root) - Django database, secrets, S3 credentials\n- `frontend/.env.local` - NextAuth secrets, API URLs\n\nCritical environment variables:\n- `SECRET_KEY` (Django), `AUTH_SECRET` (NextAuth)\n- `DB_HOST`, `DB_NAME`, `DB_USER`, `DB_PASS` (PostgreSQL)\n- `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_S3_BUCKET_NAME`\n- `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` (OAuth)\n\n## Testing Patterns\n\n**Backend Tests** (pytest-django):\n- Database tests marked with `@pytest.mark.django_db`\n- API endpoint tests use Django's APIClient  \n- External services (S3, weather API) are mocked\n- Fixtures in `conftest.py` create test users and hunt data\n\n**Frontend Tests**:\n- Unit tests: Jest + React Testing Library in `src/__tests__/`\n- Component tests focus on user interactions, not implementation\n- E2E tests: Playwright in `e2e/` directory with real browser automation\n- API mocking for isolated component testing\n\n## Mapbox Configuration\n\n- Import controls from `react-map-gl/mapbox` for Mapbox GL JS v3.5+\n- Control positioning critical - use `position` prop, not `style` object\n- Standard controls must be children of `<Map>` component\n- Custom controls positioned absolutely outside `<Map>`\n- Test controls in both browser and fullscreen modes\n\n## Development Notes\n\n- Rebuild Docker containers after backend changes to see frontend updates\n- Use test credentials: `mark@mail.com` / `1@Tsgstp` for Puppeteer E2E tests\n- Run `./testlint-quick` before commits, `./testlint` before PRs\n- Weather API responses should be mocked in tests for consistency\n- if authentication issue arises we can run  Run the health check script:\n  node auth-health-check.js","numLines":259,"startLine":1,"totalLines":259}}}
{"parentUuid":"dfe8a4e5-6ec4-4169-8dd6-71c7e316a37b","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01M8fwv3ypj52mwqNBz7viLh","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01KbqXFsDMNnLBzsEQMrfVSc","name":"TodoWrite","input":{"todos":[{"content":"Read all files in the docs directory","status":"completed","activeForm":"Reading all files in the docs directory"},{"content":"Examine CLAUDE.md file for potential improvements","status":"completed","activeForm":"Examining CLAUDE.md file for potential improvements"},{"content":"Provide recommendations for improving CLAUDE.md","status":"in_progress","activeForm":"Providing recommendations for improving CLAUDE.md"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":3737,"cache_read_input_tokens":70263,"cache_creation":{"ephemeral_5m_input_tokens":3737,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CSTp3FmteNEty5dUjqmsN","type":"assistant","uuid":"45335761-34e9-4b54-ae95-e9b483d5f05e","timestamp":"2025-08-25T04:39:48.285Z"}
{"parentUuid":"45335761-34e9-4b54-ae95-e9b483d5f05e","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KbqXFsDMNnLBzsEQMrfVSc","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"15d7bc32-3e72-46d4-8656-a41074550ddf","timestamp":"2025-08-25T04:39:48.352Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Read all files in the docs directory","status":"completed","activeForm":"Reading all files in the docs directory"},{"content":"Examine CLAUDE.md file for potential improvements","status":"completed","activeForm":"Examining CLAUDE.md file for potential improvements"},{"content":"Provide recommendations for improving CLAUDE.md","status":"in_progress","activeForm":"Providing recommendations for improving CLAUDE.md"}]}}
{"parentUuid":"15d7bc32-3e72-46d4-8656-a41074550ddf","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01LK25eyDYvh5ddHzhjYJ3Fe","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"Based on my comprehensive review of the documentation directory and the current CLAUDE.md file, I can provide several recommendations for improving the CLAUDE.md file:\n\n## Analysis and Recommendations for CLAUDE.md Improvements\n\n### Current Strengths\n- Excellent critical issue documentation with clear \"NEVER CHANGE\" sections\n- Good coverage of Docker network configuration and Mapbox rendering issues\n- Clear command examples and troubleshooting symptoms\n- Production environment variable guidance\n\n### Key Areas for Improvement\n\n#### 1. **Enhanced Testing Section**\nThe docs have comprehensive testing guides, but CLAUDE.md only briefly mentions testing. Add:\n\n```bash\n# Testing Commands\n./testlint                      # Full CI validation with E2E tests\n./testlint-quick               # Quick validation without E2E\nnpm run test -- --watchAll=false  # Frontend unit tests (CI mode)\nnpm run test:e2e -- --project chromium  # E2E tests specific browser\n\n# Test Debugging\ndocker compose exec fowldata python -m pytest -s --pdb  # Backend debug\nnpm run test:e2e -- --debug    # Playwright debug mode\n```\n\n#### 2. **Security and Performance Best Practices**\nAdd critical security practices found in the docs:\n\n```bash\n# Security Checklist\n- Avoid special characters in production passwords (no $, !, etc.)\n- Always use HTTPS in production OAuth callbacks\n- Set proper CORS origins for frontend domain\n\n# Performance Commands  \ndocker compose exec fowldata python manage.py collectstatic --noinput\n# Database optimization queries\n```\n\n#### 3. **Troubleshooting Section Enhancement**\nConsolidate common troubleshooting patterns from the docs:\n\n```bash\n# Common Issues Resolution\n# Authentication failures\nnode auth-health-check.js\n\n# Database connection issues\ndocker compose exec fowldata python manage.py dbshell\n\n# E2E test failures\n./scripts/verify-e2e-setup.sh\n```\n\n#### 4. **Development Workflow Improvements**\nAdd better development workflow guidance:\n\n```bash\n# Development Cycle\ngit checkout -b feature/description\n# Make changes\n./testlint-quick  # Before commit\ngit commit -m \"feat: description\"\n./testlint        # Before PR\n```\n\n#### 5. **API Reference Quick Links**\nAdd quick API endpoint references:\n\n```bash\n# Key API Endpoints\nGET /api/hunts/                # List user hunts\nPOST /api/hunts/               # Create hunt  \nGET /api/users/me/             # Current user info\nPOST /api/auth/sync/           # User sync\n```\n\n#### 6. **Environment Variables Priority List**\nConsolidate critical environment variables:\n\n```bash\n# CRITICAL Environment Variables (must be identical in both files)\nAUTH_SECRET=                   # NextAuth + Django JWT\nBACKEND_URL=http://fowldata:8000  # Docker service name\nNEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=  # Required for layer rendering\n```\n\n#### 7. **Architecture Quick Reference**\nAdd simplified architecture diagram from the docs for quick reference.\n\n### Specific Improvements:\n\n1. **Add Testing Markers Section**\n2. **Include Performance Monitoring Commands**\n3. **Add Database Backup/Recovery Commands**\n4. **Include SSL/TLS Setup Quick Reference**\n5. **Add Debugging Tools Section**\n6. **Expand Error Code Reference**"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":202,"cache_read_input_tokens":74000,"cache_creation":{"ephemeral_5m_input_tokens":202,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTp3b4Ft3yASLRcR4Wfs","type":"assistant","uuid":"f3168a5f-eb69-41ae-8a4d-468bc2499576","timestamp":"2025-08-25T04:40:06.714Z"}
{"parentUuid":"f3168a5f-eb69-41ae-8a4d-468bc2499576","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01LK25eyDYvh5ddHzhjYJ3Fe","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01HyqNxyMYZUhZAFXzE55jUV","name":"TodoWrite","input":{"todos":[{"content":"Read all files in the docs directory","status":"completed","activeForm":"Reading all files in the docs directory"},{"content":"Examine CLAUDE.md file for potential improvements","status":"completed","activeForm":"Examining CLAUDE.md file for potential improvements"},{"content":"Provide recommendations for improving CLAUDE.md","status":"completed","activeForm":"Providing recommendations for improving CLAUDE.md"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":202,"cache_read_input_tokens":74000,"cache_creation":{"ephemeral_5m_input_tokens":202,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTp3b4Ft3yASLRcR4Wfs","type":"assistant","uuid":"c89d599b-7ff7-49bf-80ec-97fdf77f9b76","timestamp":"2025-08-25T04:40:07.768Z"}
{"parentUuid":"c89d599b-7ff7-49bf-80ec-97fdf77f9b76","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HyqNxyMYZUhZAFXzE55jUV","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"5824fa2a-6e09-458e-8851-fd4acec6d67a","timestamp":"2025-08-25T04:40:07.830Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Read all files in the docs directory","status":"completed","activeForm":"Reading all files in the docs directory"},{"content":"Examine CLAUDE.md file for potential improvements","status":"completed","activeForm":"Examining CLAUDE.md file for potential improvements"},{"content":"Provide recommendations for improving CLAUDE.md","status":"completed","activeForm":"Providing recommendations for improving CLAUDE.md"}]}}
{"parentUuid":"5824fa2a-6e09-458e-8851-fd4acec6d67a","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01AspmZXj5UQ88AizSpbB4Ay","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"The current CLAUDE.md file is well-structured but could benefit from incorporating more comprehensive information from the docs directory. The docs contain extensive details about testing, security, performance optimization, troubleshooting, and development workflows that would be valuable additions to the CLAUDE.md file for better AI assistant guidance.\n\nThe main opportunities for improvement are:\n- Enhanced testing command coverage\n- Better troubleshooting workflows\n- Security best practices consolidation\n- Performance monitoring commands\n- More comprehensive environment variable guidance\n- API endpoint quick reference\n\nWould you like me to implement any of these improvements to the CLAUDE.md file?"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":985,"cache_read_input_tokens":74202,"cache_creation":{"ephemeral_5m_input_tokens":985,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTp52h975cn6HBeEs5vn","type":"assistant","uuid":"d8a84ceb-2f78-45a9-bdf8-a5d16d27c8b4","timestamp":"2025-08-25T04:40:13.116Z"}
{"parentUuid":"d8a84ceb-2f78-45a9-bdf8-a5d16d27c8b4","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":"yes lets do all of that.  BUT i want you to make sure there is no redundant or conflicting information"},"uuid":"c22ac252-c656-4b57-8cfa-64ce800bb0c7","timestamp":"2025-08-25T04:43:11.557Z"}
{"parentUuid":"c22ac252-c656-4b57-8cfa-64ce800bb0c7","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_015YPFVp2e2xHhcnghFHCr6K","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"I'll enhance the CLAUDE.md file with all the recommended improvements while carefully avoiding redundancy and conflicts. Let me analyze the current content and integrate the new sections seamlessly."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":162,"cache_read_input_tokens":75187,"cache_creation":{"ephemeral_5m_input_tokens":162,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CSTpJaVSfVysCczTdbS6K","type":"assistant","uuid":"c18e9816-816c-4a1b-81bd-10e0c1a1ae15","timestamp":"2025-08-25T04:43:16.962Z"}
{"parentUuid":"c18e9816-816c-4a1b-81bd-10e0c1a1ae15","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_015YPFVp2e2xHhcnghFHCr6K","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_012ZMSEwScHLBCKTsC3du62r","name":"TodoWrite","input":{"todos":[{"content":"Analyze current CLAUDE.md structure and identify integration points","status":"in_progress","activeForm":"Analyzing current CLAUDE.md structure and identifying integration points"},{"content":"Enhance testing section with comprehensive commands","status":"pending","activeForm":"Enhancing testing section with comprehensive commands"},{"content":"Add security and performance best practices","status":"pending","activeForm":"Adding security and performance best practices"},{"content":"Expand troubleshooting section with consolidated patterns","status":"pending","activeForm":"Expanding troubleshooting section with consolidated patterns"},{"content":"Add development workflow improvements","status":"pending","activeForm":"Adding development workflow improvements"},{"content":"Include API reference and environment variables priority","status":"pending","activeForm":"Including API reference and environment variables priority"},{"content":"Review for redundancy and conflicts","status":"pending","activeForm":"Reviewing for redundancy and conflicts"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":162,"cache_read_input_tokens":75187,"cache_creation":{"ephemeral_5m_input_tokens":162,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CSTpJaVSfVysCczTdbS6K","type":"assistant","uuid":"971505a7-6d44-4fdb-9f0d-ec65a348a7eb","timestamp":"2025-08-25T04:43:19.814Z"}
{"parentUuid":"971505a7-6d44-4fdb-9f0d-ec65a348a7eb","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012ZMSEwScHLBCKTsC3du62r","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"a09ca636-f914-4d35-b02a-ed5e311c1217","timestamp":"2025-08-25T04:43:19.890Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Analyze current CLAUDE.md structure and identify integration points","status":"in_progress","activeForm":"Analyzing current CLAUDE.md structure and identifying integration points"},{"content":"Enhance testing section with comprehensive commands","status":"pending","activeForm":"Enhancing testing section with comprehensive commands"},{"content":"Add security and performance best practices","status":"pending","activeForm":"Adding security and performance best practices"},{"content":"Expand troubleshooting section with consolidated patterns","status":"pending","activeForm":"Expanding troubleshooting section with consolidated patterns"},{"content":"Add development workflow improvements","status":"pending","activeForm":"Adding development workflow improvements"},{"content":"Include API reference and environment variables priority","status":"pending","activeForm":"Including API reference and environment variables priority"},{"content":"Review for redundancy and conflicts","status":"pending","activeForm":"Reviewing for redundancy and conflicts"}]}}
{"parentUuid":"a09ca636-f914-4d35-b02a-ed5e311c1217","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01KZGs181y8R325amsFjiAdN","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_012xaJhArPGpWApWyume6WUq","name":"Edit","input":{"file_path":"/Users/markelmore/_code/fowldata/CLAUDE.md","old_string":"# CLAUDE.md\n\nThis file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.","new_string":"# CLAUDE.md\n\nThis file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n\n## ğŸ¯ Quick Reference\n\n### Critical Commands\n```bash\n# Essential Development\ndocker compose up -d && cd frontend && npm run dev  # Start full stack\n./testlint-quick           # Quick validation before commits\n./testlint                 # Full validation before PRs\n\n# Production Deployment\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# Emergency Troubleshooting\nnode auth-health-check.js  # Authentication issues\n./scripts/verify-e2e-setup.sh  # E2E test setup validation\n```\n\n### Key API Endpoints\n```bash\nGET /api/hunts/            # List user hunts\nPOST /api/hunts/           # Create hunt\nGET /api/users/me/         # Current user info  \nPOST /api/auth/sync/       # User synchronization\nGET /api/health/           # Backend health check\n```"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":362,"cache_read_input_tokens":75349,"cache_creation":{"ephemeral_5m_input_tokens":362,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CSTpKBjzV8kTHN9Cmtafo","type":"assistant","uuid":"70f7d962-1dcf-4aa9-a939-2c563510552c","timestamp":"2025-08-25T04:43:28.185Z"}
{"parentUuid":"70f7d962-1dcf-4aa9-a939-2c563510552c","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012xaJhArPGpWApWyume6WUq","type":"tool_result","content":"The file /Users/markelmore/_code/fowldata/CLAUDE.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     1â†’# CLAUDE.md\n     2â†’\n     3â†’This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n     4â†’\n     5â†’## ğŸ¯ Quick Reference\n     6â†’\n     7â†’### Critical Commands\n     8â†’```bash\n     9â†’# Essential Development\n    10â†’docker compose up -d && cd frontend && npm run dev  # Start full stack\n    11â†’./testlint-quick           # Quick validation before commits\n    12â†’./testlint                 # Full validation before PRs\n    13â†’\n    14â†’# Production Deployment\n    15â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n    16â†’\n    17â†’# Emergency Troubleshooting\n    18â†’node auth-health-check.js  # Authentication issues\n    19â†’./scripts/verify-e2e-setup.sh  # E2E test setup validation\n    20â†’```\n    21â†’\n    22â†’### Key API Endpoints\n    23â†’```bash\n    24â†’GET /api/hunts/            # List user hunts\n    25â†’POST /api/hunts/           # Create hunt\n    26â†’GET /api/users/me/         # Current user info  \n    27â†’POST /api/auth/sync/       # User synchronization\n    28â†’GET /api/health/           # Backend health check\n    29â†’```\n    30â†’\n    31â†’## âš ï¸ CRITICAL: Docker Network Configuration - NEVER CHANGE\n    32â†’**RECURRING ISSUE - ALWAYS CHECK THIS FIRST**\n    33â†’"}]},"uuid":"572a8ec9-6f09-4aa7-8a40-a9c4e09aeb45","timestamp":"2025-08-25T04:43:28.240Z","toolUseResult":{"filePath":"/Users/markelmore/_code/fowldata/CLAUDE.md","oldString":"# CLAUDE.md\n\nThis file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.","newString":"# CLAUDE.md\n\nThis file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n\n## ğŸ¯ Quick Reference\n\n### Critical Commands\n```bash\n# Essential Development\ndocker compose up -d && cd frontend && npm run dev  # Start full stack\n./testlint-quick           # Quick validation before commits\n./testlint                 # Full validation before PRs\n\n# Production Deployment\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# Emergency Troubleshooting\nnode auth-health-check.js  # Authentication issues\n./scripts/verify-e2e-setup.sh  # E2E test setup validation\n```\n\n### Key API Endpoints\n```bash\nGET /api/hunts/            # List user hunts\nPOST /api/hunts/           # Create hunt\nGET /api/users/me/         # Current user info  \nPOST /api/auth/sync/       # User synchronization\nGET /api/health/           # Backend health check\n```","originalFile":"# CLAUDE.md\n\nThis file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n\n## âš ï¸ CRITICAL: Docker Network Configuration - NEVER CHANGE\n**RECURRING ISSUE - ALWAYS CHECK THIS FIRST**\n\nThe frontend `.env.local` file MUST use the Docker service name for backend communication:\n```bash\n# CORRECT - Use Docker service name (this is in frontend/.env.local)\nBACKEND_URL=http://fowldata:8000\n\n# WRONG - Will cause ECONNREFUSED errors in Docker containers\nBACKEND_URL=http://localhost:8000\n```\n\n**Why**: Inside Docker containers, `localhost` refers to the container itself, not the host. Service names resolve to container IPs within the Docker network.\n\n**Symptoms**: NextAuth authentication fails, API calls fail with \"connect ECONNREFUSED ::1:8000\"\n\n**Fix**: Always use `fowldata:8000` (service name from docker-compose.yml) for inter-container communication.\n\n## âš ï¸ CRITICAL: Mapbox GL JS v3+ with react-map-gl v8 Layer Rendering\n**RECURRING ISSUE - ESSENTIAL FOR LAYER VISIBILITY**\n\nWhen using Mapbox GL JS v3+ with react-map-gl v8, layers will NOT render without explicit `mapboxgl.accessToken` configuration:\n\n```typescript\nimport mapboxgl from 'mapbox-gl';\n\nconst MAPBOX_TOKEN = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;\n\n// CRITICAL: This is required for Mapbox GL JS v3+ with react-map-gl v8\nif (MAPBOX_TOKEN) {\n  mapboxgl.accessToken = MAPBOX_TOKEN;\n}\n```\n\n**Why**: react-map-gl v8 delegates to Mapbox GL JS v3+ which requires explicit token configuration. Previous versions handled this automatically.\n\n**Symptoms**: \n- Map loads successfully with satellite/custom styles\n- Source/Layer components appear to be configured correctly  \n- Debug panels show data is present\n- NO visual layers render (not even test layers with bright colors)\n- No console errors about authentication or tokens\n- Canvas element exists but shows no content\n\n**Additional react-map-gl v8 Requirements:**\n- Layer components must be **immediate children** of Source components (no React fragments `<>...</>`)\n- Do NOT add explicit `source` props to Layer components inside Source components\n- Remove conditional `mapStyleLoaded` wrappers - let react-map-gl handle timing internally\n\n**Fix Location**: Add the `mapboxgl.accessToken` configuration at the top level of your Map component file, after importing mapboxgl.\n\n**Debugging Signs This is the Issue**:\n- Mapbox canvas renders with proper classes (`mapboxgl-canvas-container`)\n- Map style loads successfully\n- Data processing works correctly\n- Visibility and layer management appears functional\n- Zero visual layer rendering despite all other systems working\n\n## âš ï¸ CRITICAL: Production Environment Variable Loading\n**RECURRING DEPLOYMENT ISSUE - ESSENTIAL FOR PRODUCTION**\n\nDocker Compose production deployments REQUIRE explicit `--env-file` flag:\n\n```bash\n# REQUIRED for all production commands\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# WRONG - Will cause \"variable is not set\" warnings and startup failures\ndocker-compose -f docker-compose.prod.yaml up -d\n```\n\n**Why**: The `env_file:` setting in docker-compose.prod.yaml handles container environment variables, but Docker Compose variable substitution (${VARIABLE}) requires the explicit `--env-file` flag.\n\n**Symptoms**: \n- `WARN[0000] The \"DB_NAME\" variable is not set. Defaulting to a blank string.`\n- PostgreSQL container fails with \"superuser password not specified\"\n- Environment variables visible in some services but not others\n\n**Additional Production Requirements**:\n- All services need `env_file: - .env.production` in docker-compose.prod.yaml\n- Avoid special characters in passwords (`$`, `!`, etc.) - shell interprets them\n- Use clean file encoding (UTF-8 without BOM) for environment files\n\n## Architecture Overview\n\nFowlData is a production-ready full-stack waterfowl hunting tracking application:\n\n**Backend (Django)**: Located in `fowldata/` directory\n- Django 4.2 with Django REST Framework for API endpoints\n- PostgreSQL 16 with PostGIS 3.4 for geospatial data storage and spatial queries\n- JWT RS256 authentication integrated with NextAuth.js frontend\n- Two main apps: `accounts` (user management) and `hunts` (hunt tracking)\n- AWS S3 integration for photo storage with presigned URLs and CORS\n- Gunicorn WSGI server with production performance tuning\n\n**Frontend (Next.js)**: Located in `frontend/` directory  \n- Next.js 15.4.4 with React 19 and TypeScript\n- NextAuth.js v5 with Google OAuth and credentials authentication\n- Mapbox GL JS v3+ with react-map-gl v8 for interactive mapping\n- TailwindCSS for styling, React Hook Form for forms\n- Playwright for E2E testing, Jest for unit tests\n- Production-optimized standalone builds\n\n**Production Infrastructure**:\n- **Deployment**: Digital Ocean Droplets with Docker Compose orchestration\n- **Reverse Proxy**: Nginx with SSL/TLS termination via Let's Encrypt\n- **Caching**: Redis for sessions, query caching, and performance optimization\n- **Storage**: AWS S3 with CloudFront CDN for photo uploads and static assets\n- **Database**: PostgreSQL with PostGIS extensions, performance tuning, and automated backups\n- **Monitoring**: Docker health checks, database performance monitoring, and logging\n- **Security**: SSL enforcement, security headers, rate limiting, and firewall configuration\n\n## Development Commands\n\n### Backend Development\n```bash\n# Start services\ndocker compose up -d\n\n# Django management commands\ndocker compose exec fowldata python manage.py migrate\ndocker compose exec fowldata python manage.py createsuperuser\ndocker compose exec fowldata python manage.py shell\n\n# Run backend tests\ndocker compose exec fowldata python -m pytest\ndocker compose exec fowldata python -m pytest accounts/tests/ hunts/tests/ -v\n\n# Code formatting and linting\ndocker compose exec fowldata black .\ndocker compose exec fowldata flake8\n\n# Single test file\ndocker compose exec fowldata python -m pytest hunts/tests/test_weather_api.py -v\n```\n\n### Frontend Development\n```bash\ncd frontend\n\n# Development server (with Turbopack)\nnpm run dev\n\n# Build and type checking\nnpm run build\nnpm run lint\n\n# Testing\nnpm run test                    # Jest unit tests\nnpm run test:watch             # Jest in watch mode  \nnpm run test:e2e               # Playwright E2E tests\nnpm run test:e2e:ui            # Playwright with UI\n```\n\n### Pre-Commit Validation\n```bash\n# Full CI validation (includes E2E tests)\n./testlint\n\n# Quick validation (faster, no E2E)  \n./testlint-quick\n```\n\n### Production Deployment\n```bash\n# Production validation and deployment\n./scripts/validate-production.sh\n\n# Production commands (ALWAYS use --env-file flag)\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production build\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production logs -f\n\n# Django production setup\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py migrate\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py createsuperuser\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py collectstatic --noinput\n```\n\n## Core Data Models\n\n**Hunt Model** (`hunts/models.py`):\n- Tracks hunting sessions with date, location (PostGIS Point), weather conditions\n- Links to multiple Bird harvests and HuntPhoto uploads\n- Weather data automatically fetched from external API based on coordinates\n\n**Bird Model**:\n- Individual waterfowl harvests within a hunt\n- Species selection from predefined WATERFOWL_CHOICES (Dabblers, Divers, Geese)\n- Includes harvest time, notes, and gender (Drake/Hen)\n\n**Authentication Integration**:\n- Django backend uses custom NextAuthBackend for JWT token validation\n- Frontend NextAuth.js providers: Google, Facebook, Credentials\n- Token synchronization between NextAuth and Django API client\n\n## Key Integration Points\n\n**Django-NextAuth Authentication Flow**:\n- NextAuth JWT tokens validated by Django via `accounts/nextauth_backend.py`  \n- API requests include NextAuth JWT in Authorization header\n- User creation/sync handled by Django signals in `accounts/signals.py`\n\n**Photo Upload System**:\n- S3 presigned URLs generated by Django `hunts/s3_manager.py`\n- Frontend uploads directly to S3, then registers with Django\n- HuntPhoto model tracks S3 URLs linked to Hunt instances\n\n**Geospatial Features**:\n- Hunt locations stored as PostGIS Points with lat/lng coordinates\n- Weather API integration fetches conditions based on hunt coordinates\n- Mapbox integration for location selection and visualization\n\n## Environment Configuration\n\nRequired environment files:\n- `.env.local` (root) - Django database, secrets, S3 credentials\n- `frontend/.env.local` - NextAuth secrets, API URLs\n\nCritical environment variables:\n- `SECRET_KEY` (Django), `AUTH_SECRET` (NextAuth)\n- `DB_HOST`, `DB_NAME`, `DB_USER`, `DB_PASS` (PostgreSQL)\n- `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_S3_BUCKET_NAME`\n- `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` (OAuth)\n\n## Testing Patterns\n\n**Backend Tests** (pytest-django):\n- Database tests marked with `@pytest.mark.django_db`\n- API endpoint tests use Django's APIClient  \n- External services (S3, weather API) are mocked\n- Fixtures in `conftest.py` create test users and hunt data\n\n**Frontend Tests**:\n- Unit tests: Jest + React Testing Library in `src/__tests__/`\n- Component tests focus on user interactions, not implementation\n- E2E tests: Playwright in `e2e/` directory with real browser automation\n- API mocking for isolated component testing\n\n## Mapbox Configuration\n\n- Import controls from `react-map-gl/mapbox` for Mapbox GL JS v3.5+\n- Control positioning critical - use `position` prop, not `style` object\n- Standard controls must be children of `<Map>` component\n- Custom controls positioned absolutely outside `<Map>`\n- Test controls in both browser and fullscreen modes\n\n## Development Notes\n\n- Rebuild Docker containers after backend changes to see frontend updates\n- Use test credentials: `mark@mail.com` / `1@Tsgstp` for Puppeteer E2E tests\n- Run `./testlint-quick` before commits, `./testlint` before PRs\n- Weather API responses should be mocked in tests for consistency\n- if authentication issue arises we can run  Run the health check script:\n  node auth-health-check.js","structuredPatch":[{"oldStart":2,"oldLines":6,"newStart":2,"newLines":32,"lines":[" "," This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository."," ","+## ğŸ¯ Quick Reference","+","+### Critical Commands","+```bash","+# Essential Development","+docker compose up -d && cd frontend && npm run dev  # Start full stack","+./testlint-quick           # Quick validation before commits","+./testlint                 # Full validation before PRs","+","+# Production Deployment","+docker-compose -f docker-compose.prod.yaml --env-file .env.production up -d","+","+# Emergency Troubleshooting","+node auth-health-check.js  # Authentication issues","+./scripts/verify-e2e-setup.sh  # E2E test setup validation","+```","+","+### Key API Endpoints","+```bash","+GET /api/hunts/            # List user hunts","+POST /api/hunts/           # Create hunt","+GET /api/users/me/         # Current user info  ","+POST /api/auth/sync/       # User synchronization","+GET /api/health/           # Backend health check","+```","+"," ## âš ï¸ CRITICAL: Docker Network Configuration - NEVER CHANGE"," **RECURRING ISSUE - ALWAYS CHECK THIS FIRST**"," "]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"572a8ec9-6f09-4aa7-8a40-a9c4e09aeb45","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_014c7jFVgRJXiKFmzSKp8oKs","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01Mw3kEaZtXNtT7XCvFA4qmC","name":"TodoWrite","input":{"todos":[{"content":"Analyze current CLAUDE.md structure and identify integration points","status":"completed","activeForm":"Analyzing current CLAUDE.md structure and identifying integration points"},{"content":"Enhance testing section with comprehensive commands","status":"in_progress","activeForm":"Enhancing testing section with comprehensive commands"},{"content":"Add security and performance best practices","status":"pending","activeForm":"Adding security and performance best practices"},{"content":"Expand troubleshooting section with consolidated patterns","status":"pending","activeForm":"Expanding troubleshooting section with consolidated patterns"},{"content":"Add development workflow improvements","status":"pending","activeForm":"Adding development workflow improvements"},{"content":"Include API reference and environment variables priority","status":"pending","activeForm":"Including API reference and environment variables priority"},{"content":"Review for redundancy and conflicts","status":"pending","activeForm":"Reviewing for redundancy and conflicts"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":813,"cache_read_input_tokens":75711,"cache_creation":{"ephemeral_5m_input_tokens":813,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"}},"requestId":"req_011CSTpKoChfWfKkr8boSjop","type":"assistant","uuid":"b539c2c1-d3e7-4bc3-90f8-40729b0b48a9","timestamp":"2025-08-25T04:43:32.663Z"}
{"parentUuid":"b539c2c1-d3e7-4bc3-90f8-40729b0b48a9","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Mw3kEaZtXNtT7XCvFA4qmC","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"c7d7b3b0-a6b1-4fb3-88d1-f253d6a0a86b","timestamp":"2025-08-25T04:43:32.720Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Analyze current CLAUDE.md structure and identify integration points","status":"completed","activeForm":"Analyzing current CLAUDE.md structure and identifying integration points"},{"content":"Enhance testing section with comprehensive commands","status":"in_progress","activeForm":"Enhancing testing section with comprehensive commands"},{"content":"Add security and performance best practices","status":"pending","activeForm":"Adding security and performance best practices"},{"content":"Expand troubleshooting section with consolidated patterns","status":"pending","activeForm":"Expanding troubleshooting section with consolidated patterns"},{"content":"Add development workflow improvements","status":"pending","activeForm":"Adding development workflow improvements"},{"content":"Include API reference and environment variables priority","status":"pending","activeForm":"Including API reference and environment variables priority"},{"content":"Review for redundancy and conflicts","status":"pending","activeForm":"Reviewing for redundancy and conflicts"}]}}
{"parentUuid":"c7d7b3b0-a6b1-4fb3-88d1-f253d6a0a86b","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01H9MnkbbABpfDg2WbQUX237","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01ETehPphFgqbvEY5omUNB41","name":"Edit","input":{"file_path":"/Users/markelmore/_code/fowldata/CLAUDE.md","old_string":"### Pre-Commit Validation\n```bash\n# Full CI validation (includes E2E tests)\n./testlint\n\n# Quick validation (faster, no E2E)  \n./testlint-quick\n```","new_string":"### Testing & Validation\n\n#### Pre-Commit Validation\n```bash\n# Quick validation (run before commits)\n./testlint-quick               # Essential tests only (2-3 minutes)\n\n# Full validation (run before PRs)  \n./testlint                     # Complete validation with E2E tests (10-15 minutes)\n```\n\n#### Comprehensive Testing Commands\n```bash\n# Backend Testing\ndocker compose exec fowldata python -m pytest                    # All backend tests\ndocker compose exec fowldata python -m pytest -m \"not performance\"  # Skip slow tests\ndocker compose exec fowldata python -m pytest --cov=fowldata     # With coverage\ndocker compose exec fowldata python -m pytest -s --pdb          # Debug mode\n\n# Frontend Testing\ncd frontend\nnpm run test                           # Jest unit tests\nnpm run test -- --watchAll=false      # CI mode (run once)  \nnpm run test:e2e                      # Playwright E2E tests\nnpm run test:e2e -- --project chromium  # Specific browser\nnpm run test:e2e -- --debug           # Debug E2E tests\n\n# Specific Test Categories\ndocker compose exec fowldata python -m pytest -m \"auth\"      # Authentication tests\ndocker compose exec fowldata python -m pytest -m \"api\"       # API endpoint tests\nnpm test -- --testNamePattern=\"authentication\"               # Frontend auth tests\n```\n\n#### Test Debugging\n```bash\n# Backend Debug\ndocker compose exec fowldata python -m pytest -s --pdb hunts/tests/test_weather_api.py::test_function\ndocker compose exec fowldata python manage.py shell\n\n# Frontend Debug\nnpm run test:e2e -- --headed          # Show browser\nnpm run test:e2e -- --ui               # Playwright UI mode\nnpm test -- --no-coverage --verbose   # Detailed Jest output\n\n# E2E Test Environment Validation\n./scripts/verify-e2e-setup.sh         # Check E2E prerequisites\n```"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":328,"cache_read_input_tokens":76524,"cache_creation":{"ephemeral_5m_input_tokens":328,"ephemeral_1h_input_tokens":0},"output_tokens":40,"service_tier":"standard"}},"requestId":"req_011CSTpL8TaYrTb8oKgEZ1yZ","type":"assistant","uuid":"694d1eef-7261-4f16-a4db-af91b5a6004f","timestamp":"2025-08-25T04:43:44.105Z"}
{"parentUuid":"694d1eef-7261-4f16-a4db-af91b5a6004f","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01ETehPphFgqbvEY5omUNB41","type":"tool_result","content":"The file /Users/markelmore/_code/fowldata/CLAUDE.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   181â†’npm run test:e2e               # Playwright E2E tests\n   182â†’npm run test:e2e:ui            # Playwright with UI\n   183â†’```\n   184â†’\n   185â†’### Testing & Validation\n   186â†’\n   187â†’#### Pre-Commit Validation\n   188â†’```bash\n   189â†’# Quick validation (run before commits)\n   190â†’./testlint-quick               # Essential tests only (2-3 minutes)\n   191â†’\n   192â†’# Full validation (run before PRs)  \n   193â†’./testlint                     # Complete validation with E2E tests (10-15 minutes)\n   194â†’```\n   195â†’\n   196â†’#### Comprehensive Testing Commands\n   197â†’```bash\n   198â†’# Backend Testing\n   199â†’docker compose exec fowldata python -m pytest                    # All backend tests\n   200â†’docker compose exec fowldata python -m pytest -m \"not performance\"  # Skip slow tests\n   201â†’docker compose exec fowldata python -m pytest --cov=fowldata     # With coverage\n   202â†’docker compose exec fowldata python -m pytest -s --pdb          # Debug mode\n   203â†’\n   204â†’# Frontend Testing\n   205â†’cd frontend\n   206â†’npm run test                           # Jest unit tests\n   207â†’npm run test -- --watchAll=false      # CI mode (run once)  \n   208â†’npm run test:e2e                      # Playwright E2E tests\n   209â†’npm run test:e2e -- --project chromium  # Specific browser\n   210â†’npm run test:e2e -- --debug           # Debug E2E tests\n   211â†’\n   212â†’# Specific Test Categories\n   213â†’docker compose exec fowldata python -m pytest -m \"auth\"      # Authentication tests\n   214â†’docker compose exec fowldata python -m pytest -m \"api\"       # API endpoint tests\n   215â†’npm test -- --testNamePattern=\"authentication\"               # Frontend auth tests\n   216â†’```\n   217â†’\n   218â†’#### Test Debugging\n   219â†’```bash\n   220â†’# Backend Debug\n   221â†’docker compose exec fowldata python -m pytest -s --pdb hunts/tests/test_weather_api.py::test_function\n   222â†’docker compose exec fowldata python manage.py shell\n   223â†’\n   224â†’# Frontend Debug\n   225â†’npm run test:e2e -- --headed          # Show browser\n   226â†’npm run test:e2e -- --ui               # Playwright UI mode\n   227â†’npm test -- --no-coverage --verbose   # Detailed Jest output\n   228â†’\n   229â†’# E2E Test Environment Validation\n   230â†’./scripts/verify-e2e-setup.sh         # Check E2E prerequisites\n   231â†’```\n   232â†’\n   233â†’### Production Deployment\n   234â†’```bash\n   235â†’# Production validation and deployment"}]},"uuid":"1e31c31d-7f30-4b4e-be6f-8b6396fa4d3b","timestamp":"2025-08-25T04:43:44.170Z","toolUseResult":{"filePath":"/Users/markelmore/_code/fowldata/CLAUDE.md","oldString":"### Pre-Commit Validation\n```bash\n# Full CI validation (includes E2E tests)\n./testlint\n\n# Quick validation (faster, no E2E)  \n./testlint-quick\n```","newString":"### Testing & Validation\n\n#### Pre-Commit Validation\n```bash\n# Quick validation (run before commits)\n./testlint-quick               # Essential tests only (2-3 minutes)\n\n# Full validation (run before PRs)  \n./testlint                     # Complete validation with E2E tests (10-15 minutes)\n```\n\n#### Comprehensive Testing Commands\n```bash\n# Backend Testing\ndocker compose exec fowldata python -m pytest                    # All backend tests\ndocker compose exec fowldata python -m pytest -m \"not performance\"  # Skip slow tests\ndocker compose exec fowldata python -m pytest --cov=fowldata     # With coverage\ndocker compose exec fowldata python -m pytest -s --pdb          # Debug mode\n\n# Frontend Testing\ncd frontend\nnpm run test                           # Jest unit tests\nnpm run test -- --watchAll=false      # CI mode (run once)  \nnpm run test:e2e                      # Playwright E2E tests\nnpm run test:e2e -- --project chromium  # Specific browser\nnpm run test:e2e -- --debug           # Debug E2E tests\n\n# Specific Test Categories\ndocker compose exec fowldata python -m pytest -m \"auth\"      # Authentication tests\ndocker compose exec fowldata python -m pytest -m \"api\"       # API endpoint tests\nnpm test -- --testNamePattern=\"authentication\"               # Frontend auth tests\n```\n\n#### Test Debugging\n```bash\n# Backend Debug\ndocker compose exec fowldata python -m pytest -s --pdb hunts/tests/test_weather_api.py::test_function\ndocker compose exec fowldata python manage.py shell\n\n# Frontend Debug\nnpm run test:e2e -- --headed          # Show browser\nnpm run test:e2e -- --ui               # Playwright UI mode\nnpm test -- --no-coverage --verbose   # Detailed Jest output\n\n# E2E Test Environment Validation\n./scripts/verify-e2e-setup.sh         # Check E2E prerequisites\n```","originalFile":"# CLAUDE.md\n\nThis file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n\n## ğŸ¯ Quick Reference\n\n### Critical Commands\n```bash\n# Essential Development\ndocker compose up -d && cd frontend && npm run dev  # Start full stack\n./testlint-quick           # Quick validation before commits\n./testlint                 # Full validation before PRs\n\n# Production Deployment\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# Emergency Troubleshooting\nnode auth-health-check.js  # Authentication issues\n./scripts/verify-e2e-setup.sh  # E2E test setup validation\n```\n\n### Key API Endpoints\n```bash\nGET /api/hunts/            # List user hunts\nPOST /api/hunts/           # Create hunt\nGET /api/users/me/         # Current user info  \nPOST /api/auth/sync/       # User synchronization\nGET /api/health/           # Backend health check\n```\n\n## âš ï¸ CRITICAL: Docker Network Configuration - NEVER CHANGE\n**RECURRING ISSUE - ALWAYS CHECK THIS FIRST**\n\nThe frontend `.env.local` file MUST use the Docker service name for backend communication:\n```bash\n# CORRECT - Use Docker service name (this is in frontend/.env.local)\nBACKEND_URL=http://fowldata:8000\n\n# WRONG - Will cause ECONNREFUSED errors in Docker containers\nBACKEND_URL=http://localhost:8000\n```\n\n**Why**: Inside Docker containers, `localhost` refers to the container itself, not the host. Service names resolve to container IPs within the Docker network.\n\n**Symptoms**: NextAuth authentication fails, API calls fail with \"connect ECONNREFUSED ::1:8000\"\n\n**Fix**: Always use `fowldata:8000` (service name from docker-compose.yml) for inter-container communication.\n\n## âš ï¸ CRITICAL: Mapbox GL JS v3+ with react-map-gl v8 Layer Rendering\n**RECURRING ISSUE - ESSENTIAL FOR LAYER VISIBILITY**\n\nWhen using Mapbox GL JS v3+ with react-map-gl v8, layers will NOT render without explicit `mapboxgl.accessToken` configuration:\n\n```typescript\nimport mapboxgl from 'mapbox-gl';\n\nconst MAPBOX_TOKEN = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;\n\n// CRITICAL: This is required for Mapbox GL JS v3+ with react-map-gl v8\nif (MAPBOX_TOKEN) {\n  mapboxgl.accessToken = MAPBOX_TOKEN;\n}\n```\n\n**Why**: react-map-gl v8 delegates to Mapbox GL JS v3+ which requires explicit token configuration. Previous versions handled this automatically.\n\n**Symptoms**: \n- Map loads successfully with satellite/custom styles\n- Source/Layer components appear to be configured correctly  \n- Debug panels show data is present\n- NO visual layers render (not even test layers with bright colors)\n- No console errors about authentication or tokens\n- Canvas element exists but shows no content\n\n**Additional react-map-gl v8 Requirements:**\n- Layer components must be **immediate children** of Source components (no React fragments `<>...</>`)\n- Do NOT add explicit `source` props to Layer components inside Source components\n- Remove conditional `mapStyleLoaded` wrappers - let react-map-gl handle timing internally\n\n**Fix Location**: Add the `mapboxgl.accessToken` configuration at the top level of your Map component file, after importing mapboxgl.\n\n**Debugging Signs This is the Issue**:\n- Mapbox canvas renders with proper classes (`mapboxgl-canvas-container`)\n- Map style loads successfully\n- Data processing works correctly\n- Visibility and layer management appears functional\n- Zero visual layer rendering despite all other systems working\n\n## âš ï¸ CRITICAL: Production Environment Variable Loading\n**RECURRING DEPLOYMENT ISSUE - ESSENTIAL FOR PRODUCTION**\n\nDocker Compose production deployments REQUIRE explicit `--env-file` flag:\n\n```bash\n# REQUIRED for all production commands\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# WRONG - Will cause \"variable is not set\" warnings and startup failures\ndocker-compose -f docker-compose.prod.yaml up -d\n```\n\n**Why**: The `env_file:` setting in docker-compose.prod.yaml handles container environment variables, but Docker Compose variable substitution (${VARIABLE}) requires the explicit `--env-file` flag.\n\n**Symptoms**: \n- `WARN[0000] The \"DB_NAME\" variable is not set. Defaulting to a blank string.`\n- PostgreSQL container fails with \"superuser password not specified\"\n- Environment variables visible in some services but not others\n\n**Additional Production Requirements**:\n- All services need `env_file: - .env.production` in docker-compose.prod.yaml\n- Avoid special characters in passwords (`$`, `!`, etc.) - shell interprets them\n- Use clean file encoding (UTF-8 without BOM) for environment files\n\n## Architecture Overview\n\nFowlData is a production-ready full-stack waterfowl hunting tracking application:\n\n**Backend (Django)**: Located in `fowldata/` directory\n- Django 4.2 with Django REST Framework for API endpoints\n- PostgreSQL 16 with PostGIS 3.4 for geospatial data storage and spatial queries\n- JWT RS256 authentication integrated with NextAuth.js frontend\n- Two main apps: `accounts` (user management) and `hunts` (hunt tracking)\n- AWS S3 integration for photo storage with presigned URLs and CORS\n- Gunicorn WSGI server with production performance tuning\n\n**Frontend (Next.js)**: Located in `frontend/` directory  \n- Next.js 15.4.4 with React 19 and TypeScript\n- NextAuth.js v5 with Google OAuth and credentials authentication\n- Mapbox GL JS v3+ with react-map-gl v8 for interactive mapping\n- TailwindCSS for styling, React Hook Form for forms\n- Playwright for E2E testing, Jest for unit tests\n- Production-optimized standalone builds\n\n**Production Infrastructure**:\n- **Deployment**: Digital Ocean Droplets with Docker Compose orchestration\n- **Reverse Proxy**: Nginx with SSL/TLS termination via Let's Encrypt\n- **Caching**: Redis for sessions, query caching, and performance optimization\n- **Storage**: AWS S3 with CloudFront CDN for photo uploads and static assets\n- **Database**: PostgreSQL with PostGIS extensions, performance tuning, and automated backups\n- **Monitoring**: Docker health checks, database performance monitoring, and logging\n- **Security**: SSL enforcement, security headers, rate limiting, and firewall configuration\n\n## Development Commands\n\n### Backend Development\n```bash\n# Start services\ndocker compose up -d\n\n# Django management commands\ndocker compose exec fowldata python manage.py migrate\ndocker compose exec fowldata python manage.py createsuperuser\ndocker compose exec fowldata python manage.py shell\n\n# Run backend tests\ndocker compose exec fowldata python -m pytest\ndocker compose exec fowldata python -m pytest accounts/tests/ hunts/tests/ -v\n\n# Code formatting and linting\ndocker compose exec fowldata black .\ndocker compose exec fowldata flake8\n\n# Single test file\ndocker compose exec fowldata python -m pytest hunts/tests/test_weather_api.py -v\n```\n\n### Frontend Development\n```bash\ncd frontend\n\n# Development server (with Turbopack)\nnpm run dev\n\n# Build and type checking\nnpm run build\nnpm run lint\n\n# Testing\nnpm run test                    # Jest unit tests\nnpm run test:watch             # Jest in watch mode  \nnpm run test:e2e               # Playwright E2E tests\nnpm run test:e2e:ui            # Playwright with UI\n```\n\n### Pre-Commit Validation\n```bash\n# Full CI validation (includes E2E tests)\n./testlint\n\n# Quick validation (faster, no E2E)  \n./testlint-quick\n```\n\n### Production Deployment\n```bash\n# Production validation and deployment\n./scripts/validate-production.sh\n\n# Production commands (ALWAYS use --env-file flag)\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production build\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production logs -f\n\n# Django production setup\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py migrate\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py createsuperuser\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py collectstatic --noinput\n```\n\n## Core Data Models\n\n**Hunt Model** (`hunts/models.py`):\n- Tracks hunting sessions with date, location (PostGIS Point), weather conditions\n- Links to multiple Bird harvests and HuntPhoto uploads\n- Weather data automatically fetched from external API based on coordinates\n\n**Bird Model**:\n- Individual waterfowl harvests within a hunt\n- Species selection from predefined WATERFOWL_CHOICES (Dabblers, Divers, Geese)\n- Includes harvest time, notes, and gender (Drake/Hen)\n\n**Authentication Integration**:\n- Django backend uses custom NextAuthBackend for JWT token validation\n- Frontend NextAuth.js providers: Google, Facebook, Credentials\n- Token synchronization between NextAuth and Django API client\n\n## Key Integration Points\n\n**Django-NextAuth Authentication Flow**:\n- NextAuth JWT tokens validated by Django via `accounts/nextauth_backend.py`  \n- API requests include NextAuth JWT in Authorization header\n- User creation/sync handled by Django signals in `accounts/signals.py`\n\n**Photo Upload System**:\n- S3 presigned URLs generated by Django `hunts/s3_manager.py`\n- Frontend uploads directly to S3, then registers with Django\n- HuntPhoto model tracks S3 URLs linked to Hunt instances\n\n**Geospatial Features**:\n- Hunt locations stored as PostGIS Points with lat/lng coordinates\n- Weather API integration fetches conditions based on hunt coordinates\n- Mapbox integration for location selection and visualization\n\n## Environment Configuration\n\nRequired environment files:\n- `.env.local` (root) - Django database, secrets, S3 credentials\n- `frontend/.env.local` - NextAuth secrets, API URLs\n\nCritical environment variables:\n- `SECRET_KEY` (Django), `AUTH_SECRET` (NextAuth)\n- `DB_HOST`, `DB_NAME`, `DB_USER`, `DB_PASS` (PostgreSQL)\n- `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_S3_BUCKET_NAME`\n- `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` (OAuth)\n\n## Testing Patterns\n\n**Backend Tests** (pytest-django):\n- Database tests marked with `@pytest.mark.django_db`\n- API endpoint tests use Django's APIClient  \n- External services (S3, weather API) are mocked\n- Fixtures in `conftest.py` create test users and hunt data\n\n**Frontend Tests**:\n- Unit tests: Jest + React Testing Library in `src/__tests__/`\n- Component tests focus on user interactions, not implementation\n- E2E tests: Playwright in `e2e/` directory with real browser automation\n- API mocking for isolated component testing\n\n## Mapbox Configuration\n\n- Import controls from `react-map-gl/mapbox` for Mapbox GL JS v3.5+\n- Control positioning critical - use `position` prop, not `style` object\n- Standard controls must be children of `<Map>` component\n- Custom controls positioned absolutely outside `<Map>`\n- Test controls in both browser and fullscreen modes\n\n## Development Notes\n\n- Rebuild Docker containers after backend changes to see frontend updates\n- Use test credentials: `mark@mail.com` / `1@Tsgstp` for Puppeteer E2E tests\n- Run `./testlint-quick` before commits, `./testlint` before PRs\n- Weather API responses should be mocked in tests for consistency\n- if authentication issue arises we can run  Run the health check script:\n  node auth-health-check.js","structuredPatch":[{"oldStart":182,"oldLines":15,"newStart":182,"newLines":54,"lines":[" npm run test:e2e:ui            # Playwright with UI"," ```"," ","-### Pre-Commit Validation","+### Testing & Validation","+","+#### Pre-Commit Validation"," ```bash","-# Full CI validation (includes E2E tests)","-./testlint","+# Quick validation (run before commits)","+./testlint-quick               # Essential tests only (2-3 minutes)"," ","-# Quick validation (faster, no E2E)  ","-./testlint-quick","+# Full validation (run before PRs)  ","+./testlint                     # Complete validation with E2E tests (10-15 minutes)"," ```"," ","+#### Comprehensive Testing Commands","+```bash","+# Backend Testing","+docker compose exec fowldata python -m pytest                    # All backend tests","+docker compose exec fowldata python -m pytest -m \"not performance\"  # Skip slow tests","+docker compose exec fowldata python -m pytest --cov=fowldata     # With coverage","+docker compose exec fowldata python -m pytest -s --pdb          # Debug mode","+","+# Frontend Testing","+cd frontend","+npm run test                           # Jest unit tests","+npm run test -- --watchAll=false      # CI mode (run once)  ","+npm run test:e2e                      # Playwright E2E tests","+npm run test:e2e -- --project chromium  # Specific browser","+npm run test:e2e -- --debug           # Debug E2E tests","+","+# Specific Test Categories","+docker compose exec fowldata python -m pytest -m \"auth\"      # Authentication tests","+docker compose exec fowldata python -m pytest -m \"api\"       # API endpoint tests","+npm test -- --testNamePattern=\"authentication\"               # Frontend auth tests","+```","+","+#### Test Debugging","+```bash","+# Backend Debug","+docker compose exec fowldata python -m pytest -s --pdb hunts/tests/test_weather_api.py::test_function","+docker compose exec fowldata python manage.py shell","+","+# Frontend Debug","+npm run test:e2e -- --headed          # Show browser","+npm run test:e2e -- --ui               # Playwright UI mode","+npm test -- --no-coverage --verbose   # Detailed Jest output","+","+# E2E Test Environment Validation","+./scripts/verify-e2e-setup.sh         # Check E2E prerequisites","+```","+"," ### Production Deployment"," ```bash"," # Production validation and deployment"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"1e31c31d-7f30-4b4e-be6f-8b6396fa4d3b","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_011TWamVRnuEvstwW3Gns8Rc","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01N2gDGQwAKJNANEkBDFmHTk","name":"TodoWrite","input":{"todos":[{"content":"Analyze current CLAUDE.md structure and identify integration points","status":"completed","activeForm":"Analyzing current CLAUDE.md structure and identifying integration points"},{"content":"Enhance testing section with comprehensive commands","status":"completed","activeForm":"Enhancing testing section with comprehensive commands"},{"content":"Add security and performance best practices","status":"in_progress","activeForm":"Adding security and performance best practices"},{"content":"Expand troubleshooting section with consolidated patterns","status":"pending","activeForm":"Expanding troubleshooting section with consolidated patterns"},{"content":"Add development workflow improvements","status":"pending","activeForm":"Adding development workflow improvements"},{"content":"Include API reference and environment variables priority","status":"pending","activeForm":"Including API reference and environment variables priority"},{"content":"Review for redundancy and conflicts","status":"pending","activeForm":"Reviewing for redundancy and conflicts"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":1364,"cache_read_input_tokens":76852,"cache_creation":{"ephemeral_5m_input_tokens":1364,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"}},"requestId":"req_011CSTpLyLBT13ysKMwFrEB6","type":"assistant","uuid":"485d8cc4-5802-42fb-ab2b-aa9d090e7aa0","timestamp":"2025-08-25T04:43:48.628Z"}
{"parentUuid":"485d8cc4-5802-42fb-ab2b-aa9d090e7aa0","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01N2gDGQwAKJNANEkBDFmHTk","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"2f03fcd9-48bb-4e2c-8a5d-5104621782bc","timestamp":"2025-08-25T04:43:48.676Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Analyze current CLAUDE.md structure and identify integration points","status":"completed","activeForm":"Analyzing current CLAUDE.md structure and identifying integration points"},{"content":"Enhance testing section with comprehensive commands","status":"completed","activeForm":"Enhancing testing section with comprehensive commands"},{"content":"Add security and performance best practices","status":"in_progress","activeForm":"Adding security and performance best practices"},{"content":"Expand troubleshooting section with consolidated patterns","status":"pending","activeForm":"Expanding troubleshooting section with consolidated patterns"},{"content":"Add development workflow improvements","status":"pending","activeForm":"Adding development workflow improvements"},{"content":"Include API reference and environment variables priority","status":"pending","activeForm":"Including API reference and environment variables priority"},{"content":"Review for redundancy and conflicts","status":"pending","activeForm":"Reviewing for redundancy and conflicts"}]}}
{"parentUuid":"2f03fcd9-48bb-4e2c-8a5d-5104621782bc","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_013oNXx4QqXXDXVUSq5LqZJq","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01PVhjqmprZuSAxQxC3JsaaG","name":"Edit","input":{"file_path":"/Users/markelmore/_code/fowldata/CLAUDE.md","old_string":"## Environment Configuration\n\nRequired environment files:\n- `.env.local` (root) - Django database, secrets, S3 credentials\n- `frontend/.env.local` - NextAuth secrets, API URLs\n\nCritical environment variables:\n- `SECRET_KEY` (Django), `AUTH_SECRET` (NextAuth)\n- `DB_HOST`, `DB_NAME`, `DB_USER`, `DB_PASS` (PostgreSQL)\n- `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_S3_BUCKET_NAME`\n- `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` (OAuth)","new_string":"## Environment Configuration\n\n### Critical Environment Variables (MUST MATCH)\n**These variables must be identical in both backend and frontend:**\n```bash\n# Authentication (CRITICAL - must match exactly)\nAUTH_SECRET=your-nextauth-secret-key        # Both .env.local AND frontend/.env.local\n\n# Docker Network (CRITICAL - use service names)  \nBACKEND_URL=http://fowldata:8000            # frontend/.env.local ONLY\n```\n\n### Required Environment Files\n```bash\n# Development\n.env.local                  # Backend: Django database, secrets, S3 credentials  \nfrontend/.env.local         # Frontend: NextAuth secrets, API URLs\n\n# Production  \n.env.production            # Backend: Production settings\nfrontend/.env.production   # Frontend: Production URLs and secrets\n```\n\n### Essential Variables by Service\n```bash\n# Database (Backend .env.local)\nDB_HOST=localhost           # Development: localhost, Production: postgres\nDB_NAME=fowldata           # Database name\nDB_USER=postgres           # Database username\nDB_PASS=your_password      # No special characters in production\n\n# Authentication (Both files)\nAUTH_SECRET=your-secret    # Generate: openssl rand -base64 32\nSECRET_KEY=django-secret   # Django only\n\n# Mapbox (Frontend .env.local)\nNEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-token  # REQUIRED for layer rendering\n\n# AWS S3 (Backend .env.local)\nAWS_ACCESS_KEY_ID=your-key\nAWS_SECRET_ACCESS_KEY=your-secret  \nAWS_S3_BUCKET_NAME=bucket-name\n\n# OAuth (Frontend .env.local)\nGOOGLE_CLIENT_ID=your-google-id\nGOOGLE_CLIENT_SECRET=your-google-secret\n```\n\n### Security & Performance Best Practices\n```bash\n# Production Security Checklist\n- Use strong AUTH_SECRET (32+ characters): openssl rand -base64 32\n- Avoid special characters in passwords (no $, !, etc.) - shell interprets them\n- Always use HTTPS for OAuth callbacks in production\n- Set proper CORS origins: CORS_ALLOWED_ORIGINS=https://yourdomain.com\n\n# Performance Optimization  \n- Use Redis for caching: REDIS_HOST=redis, REDIS_PASSWORD=your-password\n- Enable SSL redirect: SECURE_SSL_REDIRECT=True (production)\n- Configure proper headers: SECURE_HSTS_SECONDS=31536000\n\n# Environment File Best Practices\n- Use UTF-8 encoding without BOM\n- No spaces around = signs: VAR=value (not VAR = value)\n- Always backup production environment files\n```"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":328,"cache_read_input_tokens":78216,"cache_creation":{"ephemeral_5m_input_tokens":328,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"}},"requestId":"req_011CSTpMJaoz1k6S3rAchkr9","type":"assistant","uuid":"72f4e022-71aa-4dcc-a34c-9fc196308ebb","timestamp":"2025-08-25T04:44:06.782Z"}
{"parentUuid":"72f4e022-71aa-4dcc-a34c-9fc196308ebb","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PVhjqmprZuSAxQxC3JsaaG","type":"tool_result","content":"The file /Users/markelmore/_code/fowldata/CLAUDE.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   279â†’- Hunt locations stored as PostGIS Points with lat/lng coordinates\n   280â†’- Weather API integration fetches conditions based on hunt coordinates\n   281â†’- Mapbox integration for location selection and visualization\n   282â†’\n   283â†’## Environment Configuration\n   284â†’\n   285â†’### Critical Environment Variables (MUST MATCH)\n   286â†’**These variables must be identical in both backend and frontend:**\n   287â†’```bash\n   288â†’# Authentication (CRITICAL - must match exactly)\n   289â†’AUTH_SECRET=your-nextauth-secret-key        # Both .env.local AND frontend/.env.local\n   290â†’\n   291â†’# Docker Network (CRITICAL - use service names)  \n   292â†’BACKEND_URL=http://fowldata:8000            # frontend/.env.local ONLY\n   293â†’```\n   294â†’\n   295â†’### Required Environment Files\n   296â†’```bash\n   297â†’# Development\n   298â†’.env.local                  # Backend: Django database, secrets, S3 credentials  \n   299â†’frontend/.env.local         # Frontend: NextAuth secrets, API URLs\n   300â†’\n   301â†’# Production  \n   302â†’.env.production            # Backend: Production settings\n   303â†’frontend/.env.production   # Frontend: Production URLs and secrets\n   304â†’```\n   305â†’\n   306â†’### Essential Variables by Service\n   307â†’```bash\n   308â†’# Database (Backend .env.local)\n   309â†’DB_HOST=localhost           # Development: localhost, Production: postgres\n   310â†’DB_NAME=fowldata           # Database name\n   311â†’DB_USER=postgres           # Database username\n   312â†’DB_PASS=your_password      # No special characters in production\n   313â†’\n   314â†’# Authentication (Both files)\n   315â†’AUTH_SECRET=your-secret    # Generate: openssl rand -base64 32\n   316â†’SECRET_KEY=django-secret   # Django only\n   317â†’\n   318â†’# Mapbox (Frontend .env.local)\n   319â†’NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-token  # REQUIRED for layer rendering\n   320â†’\n   321â†’# AWS S3 (Backend .env.local)\n   322â†’AWS_ACCESS_KEY_ID=your-key\n   323â†’AWS_SECRET_ACCESS_KEY=your-secret  \n   324â†’AWS_S3_BUCKET_NAME=bucket-name\n   325â†’\n   326â†’# OAuth (Frontend .env.local)\n   327â†’GOOGLE_CLIENT_ID=your-google-id\n   328â†’GOOGLE_CLIENT_SECRET=your-google-secret\n   329â†’```\n   330â†’\n   331â†’### Security & Performance Best Practices\n   332â†’```bash\n   333â†’# Production Security Checklist\n   334â†’- Use strong AUTH_SECRET (32+ characters): openssl rand -base64 32\n   335â†’- Avoid special characters in passwords (no $, !, etc.) - shell interprets them\n   336â†’- Always use HTTPS for OAuth callbacks in production\n   337â†’- Set proper CORS origins: CORS_ALLOWED_ORIGINS=https://yourdomain.com\n   338â†’\n   339â†’# Performance Optimization  \n   340â†’- Use Redis for caching: REDIS_HOST=redis, REDIS_PASSWORD=your-password\n   341â†’- Enable SSL redirect: SECURE_SSL_REDIRECT=True (production)\n   342â†’- Configure proper headers: SECURE_HSTS_SECONDS=31536000\n   343â†’\n   344â†’# Environment File Best Practices\n   345â†’- Use UTF-8 encoding without BOM\n   346â†’- No spaces around = signs: VAR=value (not VAR = value)\n   347â†’- Always backup production environment files\n   348â†’```\n   349â†’\n   350â†’## Testing Patterns\n   351â†’\n   352â†’**Backend Tests** (pytest-django):"}]},"uuid":"a2761440-6829-4417-90bb-a71ed946072b","timestamp":"2025-08-25T04:44:06.848Z","toolUseResult":{"filePath":"/Users/markelmore/_code/fowldata/CLAUDE.md","oldString":"## Environment Configuration\n\nRequired environment files:\n- `.env.local` (root) - Django database, secrets, S3 credentials\n- `frontend/.env.local` - NextAuth secrets, API URLs\n\nCritical environment variables:\n- `SECRET_KEY` (Django), `AUTH_SECRET` (NextAuth)\n- `DB_HOST`, `DB_NAME`, `DB_USER`, `DB_PASS` (PostgreSQL)\n- `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_S3_BUCKET_NAME`\n- `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` (OAuth)","newString":"## Environment Configuration\n\n### Critical Environment Variables (MUST MATCH)\n**These variables must be identical in both backend and frontend:**\n```bash\n# Authentication (CRITICAL - must match exactly)\nAUTH_SECRET=your-nextauth-secret-key        # Both .env.local AND frontend/.env.local\n\n# Docker Network (CRITICAL - use service names)  \nBACKEND_URL=http://fowldata:8000            # frontend/.env.local ONLY\n```\n\n### Required Environment Files\n```bash\n# Development\n.env.local                  # Backend: Django database, secrets, S3 credentials  \nfrontend/.env.local         # Frontend: NextAuth secrets, API URLs\n\n# Production  \n.env.production            # Backend: Production settings\nfrontend/.env.production   # Frontend: Production URLs and secrets\n```\n\n### Essential Variables by Service\n```bash\n# Database (Backend .env.local)\nDB_HOST=localhost           # Development: localhost, Production: postgres\nDB_NAME=fowldata           # Database name\nDB_USER=postgres           # Database username\nDB_PASS=your_password      # No special characters in production\n\n# Authentication (Both files)\nAUTH_SECRET=your-secret    # Generate: openssl rand -base64 32\nSECRET_KEY=django-secret   # Django only\n\n# Mapbox (Frontend .env.local)\nNEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-token  # REQUIRED for layer rendering\n\n# AWS S3 (Backend .env.local)\nAWS_ACCESS_KEY_ID=your-key\nAWS_SECRET_ACCESS_KEY=your-secret  \nAWS_S3_BUCKET_NAME=bucket-name\n\n# OAuth (Frontend .env.local)\nGOOGLE_CLIENT_ID=your-google-id\nGOOGLE_CLIENT_SECRET=your-google-secret\n```\n\n### Security & Performance Best Practices\n```bash\n# Production Security Checklist\n- Use strong AUTH_SECRET (32+ characters): openssl rand -base64 32\n- Avoid special characters in passwords (no $, !, etc.) - shell interprets them\n- Always use HTTPS for OAuth callbacks in production\n- Set proper CORS origins: CORS_ALLOWED_ORIGINS=https://yourdomain.com\n\n# Performance Optimization  \n- Use Redis for caching: REDIS_HOST=redis, REDIS_PASSWORD=your-password\n- Enable SSL redirect: SECURE_SSL_REDIRECT=True (production)\n- Configure proper headers: SECURE_HSTS_SECONDS=31536000\n\n# Environment File Best Practices\n- Use UTF-8 encoding without BOM\n- No spaces around = signs: VAR=value (not VAR = value)\n- Always backup production environment files\n```","originalFile":"# CLAUDE.md\n\nThis file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n\n## ğŸ¯ Quick Reference\n\n### Critical Commands\n```bash\n# Essential Development\ndocker compose up -d && cd frontend && npm run dev  # Start full stack\n./testlint-quick           # Quick validation before commits\n./testlint                 # Full validation before PRs\n\n# Production Deployment\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# Emergency Troubleshooting\nnode auth-health-check.js  # Authentication issues\n./scripts/verify-e2e-setup.sh  # E2E test setup validation\n```\n\n### Key API Endpoints\n```bash\nGET /api/hunts/            # List user hunts\nPOST /api/hunts/           # Create hunt\nGET /api/users/me/         # Current user info  \nPOST /api/auth/sync/       # User synchronization\nGET /api/health/           # Backend health check\n```\n\n## âš ï¸ CRITICAL: Docker Network Configuration - NEVER CHANGE\n**RECURRING ISSUE - ALWAYS CHECK THIS FIRST**\n\nThe frontend `.env.local` file MUST use the Docker service name for backend communication:\n```bash\n# CORRECT - Use Docker service name (this is in frontend/.env.local)\nBACKEND_URL=http://fowldata:8000\n\n# WRONG - Will cause ECONNREFUSED errors in Docker containers\nBACKEND_URL=http://localhost:8000\n```\n\n**Why**: Inside Docker containers, `localhost` refers to the container itself, not the host. Service names resolve to container IPs within the Docker network.\n\n**Symptoms**: NextAuth authentication fails, API calls fail with \"connect ECONNREFUSED ::1:8000\"\n\n**Fix**: Always use `fowldata:8000` (service name from docker-compose.yml) for inter-container communication.\n\n## âš ï¸ CRITICAL: Mapbox GL JS v3+ with react-map-gl v8 Layer Rendering\n**RECURRING ISSUE - ESSENTIAL FOR LAYER VISIBILITY**\n\nWhen using Mapbox GL JS v3+ with react-map-gl v8, layers will NOT render without explicit `mapboxgl.accessToken` configuration:\n\n```typescript\nimport mapboxgl from 'mapbox-gl';\n\nconst MAPBOX_TOKEN = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;\n\n// CRITICAL: This is required for Mapbox GL JS v3+ with react-map-gl v8\nif (MAPBOX_TOKEN) {\n  mapboxgl.accessToken = MAPBOX_TOKEN;\n}\n```\n\n**Why**: react-map-gl v8 delegates to Mapbox GL JS v3+ which requires explicit token configuration. Previous versions handled this automatically.\n\n**Symptoms**: \n- Map loads successfully with satellite/custom styles\n- Source/Layer components appear to be configured correctly  \n- Debug panels show data is present\n- NO visual layers render (not even test layers with bright colors)\n- No console errors about authentication or tokens\n- Canvas element exists but shows no content\n\n**Additional react-map-gl v8 Requirements:**\n- Layer components must be **immediate children** of Source components (no React fragments `<>...</>`)\n- Do NOT add explicit `source` props to Layer components inside Source components\n- Remove conditional `mapStyleLoaded` wrappers - let react-map-gl handle timing internally\n\n**Fix Location**: Add the `mapboxgl.accessToken` configuration at the top level of your Map component file, after importing mapboxgl.\n\n**Debugging Signs This is the Issue**:\n- Mapbox canvas renders with proper classes (`mapboxgl-canvas-container`)\n- Map style loads successfully\n- Data processing works correctly\n- Visibility and layer management appears functional\n- Zero visual layer rendering despite all other systems working\n\n## âš ï¸ CRITICAL: Production Environment Variable Loading\n**RECURRING DEPLOYMENT ISSUE - ESSENTIAL FOR PRODUCTION**\n\nDocker Compose production deployments REQUIRE explicit `--env-file` flag:\n\n```bash\n# REQUIRED for all production commands\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# WRONG - Will cause \"variable is not set\" warnings and startup failures\ndocker-compose -f docker-compose.prod.yaml up -d\n```\n\n**Why**: The `env_file:` setting in docker-compose.prod.yaml handles container environment variables, but Docker Compose variable substitution (${VARIABLE}) requires the explicit `--env-file` flag.\n\n**Symptoms**: \n- `WARN[0000] The \"DB_NAME\" variable is not set. Defaulting to a blank string.`\n- PostgreSQL container fails with \"superuser password not specified\"\n- Environment variables visible in some services but not others\n\n**Additional Production Requirements**:\n- All services need `env_file: - .env.production` in docker-compose.prod.yaml\n- Avoid special characters in passwords (`$`, `!`, etc.) - shell interprets them\n- Use clean file encoding (UTF-8 without BOM) for environment files\n\n## Architecture Overview\n\nFowlData is a production-ready full-stack waterfowl hunting tracking application:\n\n**Backend (Django)**: Located in `fowldata/` directory\n- Django 4.2 with Django REST Framework for API endpoints\n- PostgreSQL 16 with PostGIS 3.4 for geospatial data storage and spatial queries\n- JWT RS256 authentication integrated with NextAuth.js frontend\n- Two main apps: `accounts` (user management) and `hunts` (hunt tracking)\n- AWS S3 integration for photo storage with presigned URLs and CORS\n- Gunicorn WSGI server with production performance tuning\n\n**Frontend (Next.js)**: Located in `frontend/` directory  \n- Next.js 15.4.4 with React 19 and TypeScript\n- NextAuth.js v5 with Google OAuth and credentials authentication\n- Mapbox GL JS v3+ with react-map-gl v8 for interactive mapping\n- TailwindCSS for styling, React Hook Form for forms\n- Playwright for E2E testing, Jest for unit tests\n- Production-optimized standalone builds\n\n**Production Infrastructure**:\n- **Deployment**: Digital Ocean Droplets with Docker Compose orchestration\n- **Reverse Proxy**: Nginx with SSL/TLS termination via Let's Encrypt\n- **Caching**: Redis for sessions, query caching, and performance optimization\n- **Storage**: AWS S3 with CloudFront CDN for photo uploads and static assets\n- **Database**: PostgreSQL with PostGIS extensions, performance tuning, and automated backups\n- **Monitoring**: Docker health checks, database performance monitoring, and logging\n- **Security**: SSL enforcement, security headers, rate limiting, and firewall configuration\n\n## Development Commands\n\n### Backend Development\n```bash\n# Start services\ndocker compose up -d\n\n# Django management commands\ndocker compose exec fowldata python manage.py migrate\ndocker compose exec fowldata python manage.py createsuperuser\ndocker compose exec fowldata python manage.py shell\n\n# Run backend tests\ndocker compose exec fowldata python -m pytest\ndocker compose exec fowldata python -m pytest accounts/tests/ hunts/tests/ -v\n\n# Code formatting and linting\ndocker compose exec fowldata black .\ndocker compose exec fowldata flake8\n\n# Single test file\ndocker compose exec fowldata python -m pytest hunts/tests/test_weather_api.py -v\n```\n\n### Frontend Development\n```bash\ncd frontend\n\n# Development server (with Turbopack)\nnpm run dev\n\n# Build and type checking\nnpm run build\nnpm run lint\n\n# Testing\nnpm run test                    # Jest unit tests\nnpm run test:watch             # Jest in watch mode  \nnpm run test:e2e               # Playwright E2E tests\nnpm run test:e2e:ui            # Playwright with UI\n```\n\n### Testing & Validation\n\n#### Pre-Commit Validation\n```bash\n# Quick validation (run before commits)\n./testlint-quick               # Essential tests only (2-3 minutes)\n\n# Full validation (run before PRs)  \n./testlint                     # Complete validation with E2E tests (10-15 minutes)\n```\n\n#### Comprehensive Testing Commands\n```bash\n# Backend Testing\ndocker compose exec fowldata python -m pytest                    # All backend tests\ndocker compose exec fowldata python -m pytest -m \"not performance\"  # Skip slow tests\ndocker compose exec fowldata python -m pytest --cov=fowldata     # With coverage\ndocker compose exec fowldata python -m pytest -s --pdb          # Debug mode\n\n# Frontend Testing\ncd frontend\nnpm run test                           # Jest unit tests\nnpm run test -- --watchAll=false      # CI mode (run once)  \nnpm run test:e2e                      # Playwright E2E tests\nnpm run test:e2e -- --project chromium  # Specific browser\nnpm run test:e2e -- --debug           # Debug E2E tests\n\n# Specific Test Categories\ndocker compose exec fowldata python -m pytest -m \"auth\"      # Authentication tests\ndocker compose exec fowldata python -m pytest -m \"api\"       # API endpoint tests\nnpm test -- --testNamePattern=\"authentication\"               # Frontend auth tests\n```\n\n#### Test Debugging\n```bash\n# Backend Debug\ndocker compose exec fowldata python -m pytest -s --pdb hunts/tests/test_weather_api.py::test_function\ndocker compose exec fowldata python manage.py shell\n\n# Frontend Debug\nnpm run test:e2e -- --headed          # Show browser\nnpm run test:e2e -- --ui               # Playwright UI mode\nnpm test -- --no-coverage --verbose   # Detailed Jest output\n\n# E2E Test Environment Validation\n./scripts/verify-e2e-setup.sh         # Check E2E prerequisites\n```\n\n### Production Deployment\n```bash\n# Production validation and deployment\n./scripts/validate-production.sh\n\n# Production commands (ALWAYS use --env-file flag)\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production build\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production logs -f\n\n# Django production setup\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py migrate\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py createsuperuser\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py collectstatic --noinput\n```\n\n## Core Data Models\n\n**Hunt Model** (`hunts/models.py`):\n- Tracks hunting sessions with date, location (PostGIS Point), weather conditions\n- Links to multiple Bird harvests and HuntPhoto uploads\n- Weather data automatically fetched from external API based on coordinates\n\n**Bird Model**:\n- Individual waterfowl harvests within a hunt\n- Species selection from predefined WATERFOWL_CHOICES (Dabblers, Divers, Geese)\n- Includes harvest time, notes, and gender (Drake/Hen)\n\n**Authentication Integration**:\n- Django backend uses custom NextAuthBackend for JWT token validation\n- Frontend NextAuth.js providers: Google, Facebook, Credentials\n- Token synchronization between NextAuth and Django API client\n\n## Key Integration Points\n\n**Django-NextAuth Authentication Flow**:\n- NextAuth JWT tokens validated by Django via `accounts/nextauth_backend.py`  \n- API requests include NextAuth JWT in Authorization header\n- User creation/sync handled by Django signals in `accounts/signals.py`\n\n**Photo Upload System**:\n- S3 presigned URLs generated by Django `hunts/s3_manager.py`\n- Frontend uploads directly to S3, then registers with Django\n- HuntPhoto model tracks S3 URLs linked to Hunt instances\n\n**Geospatial Features**:\n- Hunt locations stored as PostGIS Points with lat/lng coordinates\n- Weather API integration fetches conditions based on hunt coordinates\n- Mapbox integration for location selection and visualization\n\n## Environment Configuration\n\nRequired environment files:\n- `.env.local` (root) - Django database, secrets, S3 credentials\n- `frontend/.env.local` - NextAuth secrets, API URLs\n\nCritical environment variables:\n- `SECRET_KEY` (Django), `AUTH_SECRET` (NextAuth)\n- `DB_HOST`, `DB_NAME`, `DB_USER`, `DB_PASS` (PostgreSQL)\n- `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_S3_BUCKET_NAME`\n- `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` (OAuth)\n\n## Testing Patterns\n\n**Backend Tests** (pytest-django):\n- Database tests marked with `@pytest.mark.django_db`\n- API endpoint tests use Django's APIClient  \n- External services (S3, weather API) are mocked\n- Fixtures in `conftest.py` create test users and hunt data\n\n**Frontend Tests**:\n- Unit tests: Jest + React Testing Library in `src/__tests__/`\n- Component tests focus on user interactions, not implementation\n- E2E tests: Playwright in `e2e/` directory with real browser automation\n- API mocking for isolated component testing\n\n## Mapbox Configuration\n\n- Import controls from `react-map-gl/mapbox` for Mapbox GL JS v3.5+\n- Control positioning critical - use `position` prop, not `style` object\n- Standard controls must be children of `<Map>` component\n- Custom controls positioned absolutely outside `<Map>`\n- Test controls in both browser and fullscreen modes\n\n## Development Notes\n\n- Rebuild Docker containers after backend changes to see frontend updates\n- Use test credentials: `mark@mail.com` / `1@Tsgstp` for Puppeteer E2E tests\n- Run `./testlint-quick` before commits, `./testlint` before PRs\n- Weather API responses should be mocked in tests for consistency\n- if authentication issue arises we can run  Run the health check script:\n  node auth-health-check.js","structuredPatch":[{"oldStart":282,"oldLines":16,"newStart":282,"newLines":71,"lines":[" "," ## Environment Configuration"," ","-Required environment files:","-- `.env.local` (root) - Django database, secrets, S3 credentials","-- `frontend/.env.local` - NextAuth secrets, API URLs","+### Critical Environment Variables (MUST MATCH)","+**These variables must be identical in both backend and frontend:**","+```bash","+# Authentication (CRITICAL - must match exactly)","+AUTH_SECRET=your-nextauth-secret-key        # Both .env.local AND frontend/.env.local"," ","-Critical environment variables:","-- `SECRET_KEY` (Django), `AUTH_SECRET` (NextAuth)","-- `DB_HOST`, `DB_NAME`, `DB_USER`, `DB_PASS` (PostgreSQL)","-- `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_S3_BUCKET_NAME`","-- `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` (OAuth)","+# Docker Network (CRITICAL - use service names)  ","+BACKEND_URL=http://fowldata:8000            # frontend/.env.local ONLY","+```"," ","+### Required Environment Files","+```bash","+# Development","+.env.local                  # Backend: Django database, secrets, S3 credentials  ","+frontend/.env.local         # Frontend: NextAuth secrets, API URLs","+","+# Production  ","+.env.production            # Backend: Production settings","+frontend/.env.production   # Frontend: Production URLs and secrets","+```","+","+### Essential Variables by Service","+```bash","+# Database (Backend .env.local)","+DB_HOST=localhost           # Development: localhost, Production: postgres","+DB_NAME=fowldata           # Database name","+DB_USER=postgres           # Database username","+DB_PASS=your_password      # No special characters in production","+","+# Authentication (Both files)","+AUTH_SECRET=your-secret    # Generate: openssl rand -base64 32","+SECRET_KEY=django-secret   # Django only","+","+# Mapbox (Frontend .env.local)","+NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-token  # REQUIRED for layer rendering","+","+# AWS S3 (Backend .env.local)","+AWS_ACCESS_KEY_ID=your-key","+AWS_SECRET_ACCESS_KEY=your-secret  ","+AWS_S3_BUCKET_NAME=bucket-name","+","+# OAuth (Frontend .env.local)","+GOOGLE_CLIENT_ID=your-google-id","+GOOGLE_CLIENT_SECRET=your-google-secret","+```","+","+### Security & Performance Best Practices","+```bash","+# Production Security Checklist","+- Use strong AUTH_SECRET (32+ characters): openssl rand -base64 32","+- Avoid special characters in passwords (no $, !, etc.) - shell interprets them","+- Always use HTTPS for OAuth callbacks in production","+- Set proper CORS origins: CORS_ALLOWED_ORIGINS=https://yourdomain.com","+","+# Performance Optimization  ","+- Use Redis for caching: REDIS_HOST=redis, REDIS_PASSWORD=your-password","+- Enable SSL redirect: SECURE_SSL_REDIRECT=True (production)","+- Configure proper headers: SECURE_HSTS_SECONDS=31536000","+","+# Environment File Best Practices","+- Use UTF-8 encoding without BOM","+- No spaces around = signs: VAR=value (not VAR = value)","+- Always backup production environment files","+```","+"," ## Testing Patterns"," "," **Backend Tests** (pytest-django):"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"a2761440-6829-4417-90bb-a71ed946072b","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01LC71wk6Unn7cUV7mGNPLuL","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_0132H6Dw1ChitcwLwtLrrZqM","name":"TodoWrite","input":{"todos":[{"content":"Analyze current CLAUDE.md structure and identify integration points","status":"completed","activeForm":"Analyzing current CLAUDE.md structure and identifying integration points"},{"content":"Enhance testing section with comprehensive commands","status":"completed","activeForm":"Enhancing testing section with comprehensive commands"},{"content":"Add security and performance best practices","status":"completed","activeForm":"Adding security and performance best practices"},{"content":"Expand troubleshooting section with consolidated patterns","status":"in_progress","activeForm":"Expanding troubleshooting section with consolidated patterns"},{"content":"Add development workflow improvements","status":"pending","activeForm":"Adding development workflow improvements"},{"content":"Include API reference and environment variables priority","status":"pending","activeForm":"Including API reference and environment variables priority"},{"content":"Review for redundancy and conflicts","status":"pending","activeForm":"Reviewing for redundancy and conflicts"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":1848,"cache_read_input_tokens":78544,"cache_creation":{"ephemeral_5m_input_tokens":1848,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"}},"requestId":"req_011CSTpNeNxq32Pi2fC4c5Ap","type":"assistant","uuid":"24cac778-124d-4d49-b478-c88da71122cd","timestamp":"2025-08-25T04:44:11.639Z"}
{"parentUuid":"24cac778-124d-4d49-b478-c88da71122cd","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0132H6Dw1ChitcwLwtLrrZqM","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"49abbbe7-b4cd-4977-a0b6-8c62ef48b462","timestamp":"2025-08-25T04:44:11.692Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Analyze current CLAUDE.md structure and identify integration points","status":"completed","activeForm":"Analyzing current CLAUDE.md structure and identifying integration points"},{"content":"Enhance testing section with comprehensive commands","status":"completed","activeForm":"Enhancing testing section with comprehensive commands"},{"content":"Add security and performance best practices","status":"completed","activeForm":"Adding security and performance best practices"},{"content":"Expand troubleshooting section with consolidated patterns","status":"in_progress","activeForm":"Expanding troubleshooting section with consolidated patterns"},{"content":"Add development workflow improvements","status":"pending","activeForm":"Adding development workflow improvements"},{"content":"Include API reference and environment variables priority","status":"pending","activeForm":"Including API reference and environment variables priority"},{"content":"Review for redundancy and conflicts","status":"pending","activeForm":"Reviewing for redundancy and conflicts"}]}}
{"parentUuid":"49abbbe7-b4cd-4977-a0b6-8c62ef48b462","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01CKTRYvefnpaQxF346Q6Fy7","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01HsYP1j7jUaa2rfD2p3fABC","name":"Edit","input":{"file_path":"/Users/markelmore/_code/fowldata/CLAUDE.md","old_string":"## Development Notes\n\n- Rebuild Docker containers after backend changes to see frontend updates\n- Use test credentials: `mark@mail.com` / `1@Tsgstp` for Puppeteer E2E tests\n- Run `./testlint-quick` before commits, `./testlint` before PRs\n- Weather API responses should be mocked in tests for consistency\n- if authentication issue arises we can run  Run the health check script:\n  node auth-health-check.js","new_string":"## Development Workflow\n\n### Branch Strategy & Process\n```bash\n# Create feature branch\ngit checkout -b feature/descriptive-name\ngit push -u origin feature/descriptive-name\n\n# Development cycle\n# 1. Make changes\n# 2. Test locally: ./testlint-quick\n# 3. Commit: git commit -m \"feat: description\"  \n# 4. Before PR: ./testlint\n# 5. Create PR: gh pr create --title \"Title\" --body \"Description\"\n\n# Commit Message Format\nfeat: Add hunt sharing functionality\nfix: Resolve photo upload timeout issue  \ndocs: Update API documentation\ntest: Add weather API integration tests\nrefactor: Simplify authentication middleware\n```\n\n### Development Best Practices\n- **Container Rebuilds**: Rebuild Docker containers after backend changes to see frontend updates\n- **Test Credentials**: Use `mark@mail.com` / `1@Tsgstp` for E2E tests\n- **Pre-commit**: Always run `./testlint-quick` before commits\n- **Pre-PR**: Always run `./testlint` before creating pull requests  \n- **API Mocking**: Weather API responses should be mocked in tests for consistency\n\n## Troubleshooting Guide\n\n### Authentication Issues\n```bash\n# Primary diagnostic tool\nnode auth-health-check.js                    # Comprehensive auth system check\n\n# Specific auth problems\ndocker compose logs fowldata | grep -i auth  # Backend auth errors\ndocker compose logs fowldata | grep -i jwt   # JWT token issues\ndocker compose exec fowldata python manage.py shell  # Manual user inspection\n\n# Common auth fixes\n# 1. Verify AUTH_SECRET matches in both .env files\n# 2. Check BACKEND_URL uses fowldata:8000 (not localhost)\n# 3. Clear browser cookies and retry\n# 4. Restart both containers: docker compose restart fowldata frontend\n```\n\n### Database & Migration Issues  \n```bash\n# Database diagnostic\ndocker compose exec fowldata python manage.py check\ndocker compose exec fowldata python manage.py dbshell\ndocker compose exec postgres psql -U postgres -d fowldata\n\n# Reset database (development only)\ndocker compose down -v                       # Destroy volumes\ndocker compose up -d                         # Recreate services\ndocker compose exec fowldata python manage.py migrate\n\n# Migration problems\ndocker compose exec fowldata python manage.py showmigrations  # Show status\ndocker compose exec fowldata python manage.py migrate --fake  # Mark as applied\n```\n\n### Frontend Build & Runtime Issues\n```bash\n# Build diagnostics\ncd frontend\nnpm run build                                # Check for build errors\nnpm run lint                                # TypeScript/ESLint issues\nrm -rf .next node_modules && npm install    # Clean reinstall\n\n# Runtime debugging\nnpm run dev                                  # Development server logs\ndocker compose logs frontend                # Container logs\n```\n\n### E2E Test Failures\n```bash\n# E2E test diagnostics\n./scripts/verify-e2e-setup.sh              # Check prerequisites\nnpm run test:e2e -- --headed               # Visual debugging  \nnpm run test:e2e -- --debug                # Step-by-step debugging\n\n# Common E2E fixes\n# 1. Ensure test user exists: mark@mail.com / 1@Tsgstp\n# 2. Check services are running: docker compose ps\n# 3. Verify ports: curl http://localhost:3000 && curl http://localhost:8000/api/\n# 4. Clear browser state: rm -rf test-results/\n```\n\n### Performance & Resource Issues\n```bash\n# System resource monitoring\ndocker stats                               # Container resource usage\ndocker system df                          # Disk space usage\ndocker system prune -f                    # Clean unused resources\n\n# Database performance\ndocker compose exec fowldata python manage.py dbshell\n# Then: EXPLAIN ANALYZE SELECT * FROM hunts_hunt WHERE location IS NOT NULL;\n\n# Memory issues\ndocker compose down && docker compose up -d  # Restart all services\n```\n\n### Production Deployment Issues\n```bash\n# Production diagnostics\n./scripts/validate-production.sh           # Pre-deployment validation\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production config  # Validate config\n\n# SSL/TLS issues  \nopenssl x509 -in ssl/fullchain.pem -text -noout  # Check certificate\nsudo certbot renew --dry-run               # Test renewal process\n\n# Environment variable issues\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata env | grep DB_\n```\n\n### Emergency Recovery\n```bash\n# Quick service restart\ndocker compose restart fowldata frontend postgres\n\n# Full environment reset (DESTRUCTIVE - development only)\ndocker compose down -v\ndocker system prune -f  \ngit checkout -- .env.local frontend/.env.local\ndocker compose up -d\n\n# Rollback production deployment\ngit checkout previous-working-commit\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate\n```"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":328,"cache_read_input_tokens":80392,"cache_creation":{"ephemeral_5m_input_tokens":328,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"}},"requestId":"req_011CSTpNzxxXH5KzVfyqEWD4","type":"assistant","uuid":"473fa326-8797-419f-8d3b-d449832156cf","timestamp":"2025-08-25T04:44:39.685Z"}
{"parentUuid":"473fa326-8797-419f-8d3b-d449832156cf","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HsYP1j7jUaa2rfD2p3fABC","type":"tool_result","content":"The file /Users/markelmore/_code/fowldata/CLAUDE.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   368â†’- Standard controls must be children of `<Map>` component\n   369â†’- Custom controls positioned absolutely outside `<Map>`\n   370â†’- Test controls in both browser and fullscreen modes\n   371â†’\n   372â†’## Development Workflow\n   373â†’\n   374â†’### Branch Strategy & Process\n   375â†’```bash\n   376â†’# Create feature branch\n   377â†’git checkout -b feature/descriptive-name\n   378â†’git push -u origin feature/descriptive-name\n   379â†’\n   380â†’# Development cycle\n   381â†’# 1. Make changes\n   382â†’# 2. Test locally: ./testlint-quick\n   383â†’# 3. Commit: git commit -m \"feat: description\"  \n   384â†’# 4. Before PR: ./testlint\n   385â†’# 5. Create PR: gh pr create --title \"Title\" --body \"Description\"\n   386â†’\n   387â†’# Commit Message Format\n   388â†’feat: Add hunt sharing functionality\n   389â†’fix: Resolve photo upload timeout issue  \n   390â†’docs: Update API documentation\n   391â†’test: Add weather API integration tests\n   392â†’refactor: Simplify authentication middleware\n   393â†’```\n   394â†’\n   395â†’### Development Best Practices\n   396â†’- **Container Rebuilds**: Rebuild Docker containers after backend changes to see frontend updates\n   397â†’- **Test Credentials**: Use `mark@mail.com` / `1@Tsgstp` for E2E tests\n   398â†’- **Pre-commit**: Always run `./testlint-quick` before commits\n   399â†’- **Pre-PR**: Always run `./testlint` before creating pull requests  \n   400â†’- **API Mocking**: Weather API responses should be mocked in tests for consistency\n   401â†’\n   402â†’## Troubleshooting Guide\n   403â†’\n   404â†’### Authentication Issues\n   405â†’```bash\n   406â†’# Primary diagnostic tool\n   407â†’node auth-health-check.js                    # Comprehensive auth system check\n   408â†’\n   409â†’# Specific auth problems\n   410â†’docker compose logs fowldata | grep -i auth  # Backend auth errors\n   411â†’docker compose logs fowldata | grep -i jwt   # JWT token issues\n   412â†’docker compose exec fowldata python manage.py shell  # Manual user inspection\n   413â†’\n   414â†’# Common auth fixes\n   415â†’# 1. Verify AUTH_SECRET matches in both .env files\n   416â†’# 2. Check BACKEND_URL uses fowldata:8000 (not localhost)\n   417â†’# 3. Clear browser cookies and retry\n   418â†’# 4. Restart both containers: docker compose restart fowldata frontend\n   419â†’```\n   420â†’\n   421â†’### Database & Migration Issues  \n   422â†’```bash\n   423â†’# Database diagnostic\n   424â†’docker compose exec fowldata python manage.py check\n   425â†’docker compose exec fowldata python manage.py dbshell\n   426â†’docker compose exec postgres psql -U postgres -d fowldata\n   427â†’\n   428â†’# Reset database (development only)\n   429â†’docker compose down -v                       # Destroy volumes\n   430â†’docker compose up -d                         # Recreate services\n   431â†’docker compose exec fowldata python manage.py migrate\n   432â†’\n   433â†’# Migration problems\n   434â†’docker compose exec fowldata python manage.py showmigrations  # Show status\n   435â†’docker compose exec fowldata python manage.py migrate --fake  # Mark as applied\n   436â†’```\n   437â†’\n   438â†’### Frontend Build & Runtime Issues\n   439â†’```bash\n   440â†’# Build diagnostics\n   441â†’cd frontend\n   442â†’npm run build                                # Check for build errors\n   443â†’npm run lint                                # TypeScript/ESLint issues\n   444â†’rm -rf .next node_modules && npm install    # Clean reinstall\n   445â†’\n   446â†’# Runtime debugging\n   447â†’npm run dev                                  # Development server logs\n   448â†’docker compose logs frontend                # Container logs\n   449â†’```\n   450â†’\n   451â†’### E2E Test Failures\n   452â†’```bash\n   453â†’# E2E test diagnostics\n   454â†’./scripts/verify-e2e-setup.sh              # Check prerequisites\n   455â†’npm run test:e2e -- --headed               # Visual debugging  \n   456â†’npm run test:e2e -- --debug                # Step-by-step debugging\n   457â†’\n   458â†’# Common E2E fixes\n   459â†’# 1. Ensure test user exists: mark@mail.com / 1@Tsgstp\n   460â†’# 2. Check services are running: docker compose ps\n   461â†’# 3. Verify ports: curl http://localhost:3000 && curl http://localhost:8000/api/\n   462â†’# 4. Clear browser state: rm -rf test-results/\n   463â†’```\n   464â†’\n   465â†’### Performance & Resource Issues\n   466â†’```bash\n   467â†’# System resource monitoring\n   468â†’docker stats                               # Container resource usage\n   469â†’docker system df                          # Disk space usage\n   470â†’docker system prune -f                    # Clean unused resources\n   471â†’\n   472â†’# Database performance\n   473â†’docker compose exec fowldata python manage.py dbshell\n   474â†’# Then: EXPLAIN ANALYZE SELECT * FROM hunts_hunt WHERE location IS NOT NULL;\n   475â†’\n   476â†’# Memory issues\n   477â†’docker compose down && docker compose up -d  # Restart all services\n   478â†’```\n   479â†’\n   480â†’### Production Deployment Issues\n   481â†’```bash\n   482â†’# Production diagnostics\n   483â†’./scripts/validate-production.sh           # Pre-deployment validation\n   484â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production config  # Validate config\n   485â†’\n   486â†’# SSL/TLS issues  \n   487â†’openssl x509 -in ssl/fullchain.pem -text -noout  # Check certificate\n   488â†’sudo certbot renew --dry-run               # Test renewal process\n   489â†’\n   490â†’# Environment variable issues\n   491â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata env | grep DB_\n   492â†’```\n   493â†’\n   494â†’### Emergency Recovery\n   495â†’```bash\n   496â†’# Quick service restart\n   497â†’docker compose restart fowldata frontend postgres\n   498â†’\n   499â†’# Full environment reset (DESTRUCTIVE - development only)\n   500â†’docker compose down -v\n   501â†’docker system prune -f  \n   502â†’git checkout -- .env.local frontend/.env.local\n   503â†’docker compose up -d\n   504â†’\n   505â†’# Rollback production deployment\n   506â†’git checkout previous-working-commit\n   507â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate\n   508â†’```"}]},"uuid":"856da75a-8f31-4cd4-b903-ecb164466c81","timestamp":"2025-08-25T04:44:39.764Z","toolUseResult":{"filePath":"/Users/markelmore/_code/fowldata/CLAUDE.md","oldString":"## Development Notes\n\n- Rebuild Docker containers after backend changes to see frontend updates\n- Use test credentials: `mark@mail.com` / `1@Tsgstp` for Puppeteer E2E tests\n- Run `./testlint-quick` before commits, `./testlint` before PRs\n- Weather API responses should be mocked in tests for consistency\n- if authentication issue arises we can run  Run the health check script:\n  node auth-health-check.js","newString":"## Development Workflow\n\n### Branch Strategy & Process\n```bash\n# Create feature branch\ngit checkout -b feature/descriptive-name\ngit push -u origin feature/descriptive-name\n\n# Development cycle\n# 1. Make changes\n# 2. Test locally: ./testlint-quick\n# 3. Commit: git commit -m \"feat: description\"  \n# 4. Before PR: ./testlint\n# 5. Create PR: gh pr create --title \"Title\" --body \"Description\"\n\n# Commit Message Format\nfeat: Add hunt sharing functionality\nfix: Resolve photo upload timeout issue  \ndocs: Update API documentation\ntest: Add weather API integration tests\nrefactor: Simplify authentication middleware\n```\n\n### Development Best Practices\n- **Container Rebuilds**: Rebuild Docker containers after backend changes to see frontend updates\n- **Test Credentials**: Use `mark@mail.com` / `1@Tsgstp` for E2E tests\n- **Pre-commit**: Always run `./testlint-quick` before commits\n- **Pre-PR**: Always run `./testlint` before creating pull requests  \n- **API Mocking**: Weather API responses should be mocked in tests for consistency\n\n## Troubleshooting Guide\n\n### Authentication Issues\n```bash\n# Primary diagnostic tool\nnode auth-health-check.js                    # Comprehensive auth system check\n\n# Specific auth problems\ndocker compose logs fowldata | grep -i auth  # Backend auth errors\ndocker compose logs fowldata | grep -i jwt   # JWT token issues\ndocker compose exec fowldata python manage.py shell  # Manual user inspection\n\n# Common auth fixes\n# 1. Verify AUTH_SECRET matches in both .env files\n# 2. Check BACKEND_URL uses fowldata:8000 (not localhost)\n# 3. Clear browser cookies and retry\n# 4. Restart both containers: docker compose restart fowldata frontend\n```\n\n### Database & Migration Issues  \n```bash\n# Database diagnostic\ndocker compose exec fowldata python manage.py check\ndocker compose exec fowldata python manage.py dbshell\ndocker compose exec postgres psql -U postgres -d fowldata\n\n# Reset database (development only)\ndocker compose down -v                       # Destroy volumes\ndocker compose up -d                         # Recreate services\ndocker compose exec fowldata python manage.py migrate\n\n# Migration problems\ndocker compose exec fowldata python manage.py showmigrations  # Show status\ndocker compose exec fowldata python manage.py migrate --fake  # Mark as applied\n```\n\n### Frontend Build & Runtime Issues\n```bash\n# Build diagnostics\ncd frontend\nnpm run build                                # Check for build errors\nnpm run lint                                # TypeScript/ESLint issues\nrm -rf .next node_modules && npm install    # Clean reinstall\n\n# Runtime debugging\nnpm run dev                                  # Development server logs\ndocker compose logs frontend                # Container logs\n```\n\n### E2E Test Failures\n```bash\n# E2E test diagnostics\n./scripts/verify-e2e-setup.sh              # Check prerequisites\nnpm run test:e2e -- --headed               # Visual debugging  \nnpm run test:e2e -- --debug                # Step-by-step debugging\n\n# Common E2E fixes\n# 1. Ensure test user exists: mark@mail.com / 1@Tsgstp\n# 2. Check services are running: docker compose ps\n# 3. Verify ports: curl http://localhost:3000 && curl http://localhost:8000/api/\n# 4. Clear browser state: rm -rf test-results/\n```\n\n### Performance & Resource Issues\n```bash\n# System resource monitoring\ndocker stats                               # Container resource usage\ndocker system df                          # Disk space usage\ndocker system prune -f                    # Clean unused resources\n\n# Database performance\ndocker compose exec fowldata python manage.py dbshell\n# Then: EXPLAIN ANALYZE SELECT * FROM hunts_hunt WHERE location IS NOT NULL;\n\n# Memory issues\ndocker compose down && docker compose up -d  # Restart all services\n```\n\n### Production Deployment Issues\n```bash\n# Production diagnostics\n./scripts/validate-production.sh           # Pre-deployment validation\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production config  # Validate config\n\n# SSL/TLS issues  \nopenssl x509 -in ssl/fullchain.pem -text -noout  # Check certificate\nsudo certbot renew --dry-run               # Test renewal process\n\n# Environment variable issues\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata env | grep DB_\n```\n\n### Emergency Recovery\n```bash\n# Quick service restart\ndocker compose restart fowldata frontend postgres\n\n# Full environment reset (DESTRUCTIVE - development only)\ndocker compose down -v\ndocker system prune -f  \ngit checkout -- .env.local frontend/.env.local\ndocker compose up -d\n\n# Rollback production deployment\ngit checkout previous-working-commit\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate\n```","originalFile":"# CLAUDE.md\n\nThis file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n\n## ğŸ¯ Quick Reference\n\n### Critical Commands\n```bash\n# Essential Development\ndocker compose up -d && cd frontend && npm run dev  # Start full stack\n./testlint-quick           # Quick validation before commits\n./testlint                 # Full validation before PRs\n\n# Production Deployment\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# Emergency Troubleshooting\nnode auth-health-check.js  # Authentication issues\n./scripts/verify-e2e-setup.sh  # E2E test setup validation\n```\n\n### Key API Endpoints\n```bash\nGET /api/hunts/            # List user hunts\nPOST /api/hunts/           # Create hunt\nGET /api/users/me/         # Current user info  \nPOST /api/auth/sync/       # User synchronization\nGET /api/health/           # Backend health check\n```\n\n## âš ï¸ CRITICAL: Docker Network Configuration - NEVER CHANGE\n**RECURRING ISSUE - ALWAYS CHECK THIS FIRST**\n\nThe frontend `.env.local` file MUST use the Docker service name for backend communication:\n```bash\n# CORRECT - Use Docker service name (this is in frontend/.env.local)\nBACKEND_URL=http://fowldata:8000\n\n# WRONG - Will cause ECONNREFUSED errors in Docker containers\nBACKEND_URL=http://localhost:8000\n```\n\n**Why**: Inside Docker containers, `localhost` refers to the container itself, not the host. Service names resolve to container IPs within the Docker network.\n\n**Symptoms**: NextAuth authentication fails, API calls fail with \"connect ECONNREFUSED ::1:8000\"\n\n**Fix**: Always use `fowldata:8000` (service name from docker-compose.yml) for inter-container communication.\n\n## âš ï¸ CRITICAL: Mapbox GL JS v3+ with react-map-gl v8 Layer Rendering\n**RECURRING ISSUE - ESSENTIAL FOR LAYER VISIBILITY**\n\nWhen using Mapbox GL JS v3+ with react-map-gl v8, layers will NOT render without explicit `mapboxgl.accessToken` configuration:\n\n```typescript\nimport mapboxgl from 'mapbox-gl';\n\nconst MAPBOX_TOKEN = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;\n\n// CRITICAL: This is required for Mapbox GL JS v3+ with react-map-gl v8\nif (MAPBOX_TOKEN) {\n  mapboxgl.accessToken = MAPBOX_TOKEN;\n}\n```\n\n**Why**: react-map-gl v8 delegates to Mapbox GL JS v3+ which requires explicit token configuration. Previous versions handled this automatically.\n\n**Symptoms**: \n- Map loads successfully with satellite/custom styles\n- Source/Layer components appear to be configured correctly  \n- Debug panels show data is present\n- NO visual layers render (not even test layers with bright colors)\n- No console errors about authentication or tokens\n- Canvas element exists but shows no content\n\n**Additional react-map-gl v8 Requirements:**\n- Layer components must be **immediate children** of Source components (no React fragments `<>...</>`)\n- Do NOT add explicit `source` props to Layer components inside Source components\n- Remove conditional `mapStyleLoaded` wrappers - let react-map-gl handle timing internally\n\n**Fix Location**: Add the `mapboxgl.accessToken` configuration at the top level of your Map component file, after importing mapboxgl.\n\n**Debugging Signs This is the Issue**:\n- Mapbox canvas renders with proper classes (`mapboxgl-canvas-container`)\n- Map style loads successfully\n- Data processing works correctly\n- Visibility and layer management appears functional\n- Zero visual layer rendering despite all other systems working\n\n## âš ï¸ CRITICAL: Production Environment Variable Loading\n**RECURRING DEPLOYMENT ISSUE - ESSENTIAL FOR PRODUCTION**\n\nDocker Compose production deployments REQUIRE explicit `--env-file` flag:\n\n```bash\n# REQUIRED for all production commands\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# WRONG - Will cause \"variable is not set\" warnings and startup failures\ndocker-compose -f docker-compose.prod.yaml up -d\n```\n\n**Why**: The `env_file:` setting in docker-compose.prod.yaml handles container environment variables, but Docker Compose variable substitution (${VARIABLE}) requires the explicit `--env-file` flag.\n\n**Symptoms**: \n- `WARN[0000] The \"DB_NAME\" variable is not set. Defaulting to a blank string.`\n- PostgreSQL container fails with \"superuser password not specified\"\n- Environment variables visible in some services but not others\n\n**Additional Production Requirements**:\n- All services need `env_file: - .env.production` in docker-compose.prod.yaml\n- Avoid special characters in passwords (`$`, `!`, etc.) - shell interprets them\n- Use clean file encoding (UTF-8 without BOM) for environment files\n\n## Architecture Overview\n\nFowlData is a production-ready full-stack waterfowl hunting tracking application:\n\n**Backend (Django)**: Located in `fowldata/` directory\n- Django 4.2 with Django REST Framework for API endpoints\n- PostgreSQL 16 with PostGIS 3.4 for geospatial data storage and spatial queries\n- JWT RS256 authentication integrated with NextAuth.js frontend\n- Two main apps: `accounts` (user management) and `hunts` (hunt tracking)\n- AWS S3 integration for photo storage with presigned URLs and CORS\n- Gunicorn WSGI server with production performance tuning\n\n**Frontend (Next.js)**: Located in `frontend/` directory  \n- Next.js 15.4.4 with React 19 and TypeScript\n- NextAuth.js v5 with Google OAuth and credentials authentication\n- Mapbox GL JS v3+ with react-map-gl v8 for interactive mapping\n- TailwindCSS for styling, React Hook Form for forms\n- Playwright for E2E testing, Jest for unit tests\n- Production-optimized standalone builds\n\n**Production Infrastructure**:\n- **Deployment**: Digital Ocean Droplets with Docker Compose orchestration\n- **Reverse Proxy**: Nginx with SSL/TLS termination via Let's Encrypt\n- **Caching**: Redis for sessions, query caching, and performance optimization\n- **Storage**: AWS S3 with CloudFront CDN for photo uploads and static assets\n- **Database**: PostgreSQL with PostGIS extensions, performance tuning, and automated backups\n- **Monitoring**: Docker health checks, database performance monitoring, and logging\n- **Security**: SSL enforcement, security headers, rate limiting, and firewall configuration\n\n## Development Commands\n\n### Backend Development\n```bash\n# Start services\ndocker compose up -d\n\n# Django management commands\ndocker compose exec fowldata python manage.py migrate\ndocker compose exec fowldata python manage.py createsuperuser\ndocker compose exec fowldata python manage.py shell\n\n# Run backend tests\ndocker compose exec fowldata python -m pytest\ndocker compose exec fowldata python -m pytest accounts/tests/ hunts/tests/ -v\n\n# Code formatting and linting\ndocker compose exec fowldata black .\ndocker compose exec fowldata flake8\n\n# Single test file\ndocker compose exec fowldata python -m pytest hunts/tests/test_weather_api.py -v\n```\n\n### Frontend Development\n```bash\ncd frontend\n\n# Development server (with Turbopack)\nnpm run dev\n\n# Build and type checking\nnpm run build\nnpm run lint\n\n# Testing\nnpm run test                    # Jest unit tests\nnpm run test:watch             # Jest in watch mode  \nnpm run test:e2e               # Playwright E2E tests\nnpm run test:e2e:ui            # Playwright with UI\n```\n\n### Testing & Validation\n\n#### Pre-Commit Validation\n```bash\n# Quick validation (run before commits)\n./testlint-quick               # Essential tests only (2-3 minutes)\n\n# Full validation (run before PRs)  \n./testlint                     # Complete validation with E2E tests (10-15 minutes)\n```\n\n#### Comprehensive Testing Commands\n```bash\n# Backend Testing\ndocker compose exec fowldata python -m pytest                    # All backend tests\ndocker compose exec fowldata python -m pytest -m \"not performance\"  # Skip slow tests\ndocker compose exec fowldata python -m pytest --cov=fowldata     # With coverage\ndocker compose exec fowldata python -m pytest -s --pdb          # Debug mode\n\n# Frontend Testing\ncd frontend\nnpm run test                           # Jest unit tests\nnpm run test -- --watchAll=false      # CI mode (run once)  \nnpm run test:e2e                      # Playwright E2E tests\nnpm run test:e2e -- --project chromium  # Specific browser\nnpm run test:e2e -- --debug           # Debug E2E tests\n\n# Specific Test Categories\ndocker compose exec fowldata python -m pytest -m \"auth\"      # Authentication tests\ndocker compose exec fowldata python -m pytest -m \"api\"       # API endpoint tests\nnpm test -- --testNamePattern=\"authentication\"               # Frontend auth tests\n```\n\n#### Test Debugging\n```bash\n# Backend Debug\ndocker compose exec fowldata python -m pytest -s --pdb hunts/tests/test_weather_api.py::test_function\ndocker compose exec fowldata python manage.py shell\n\n# Frontend Debug\nnpm run test:e2e -- --headed          # Show browser\nnpm run test:e2e -- --ui               # Playwright UI mode\nnpm test -- --no-coverage --verbose   # Detailed Jest output\n\n# E2E Test Environment Validation\n./scripts/verify-e2e-setup.sh         # Check E2E prerequisites\n```\n\n### Production Deployment\n```bash\n# Production validation and deployment\n./scripts/validate-production.sh\n\n# Production commands (ALWAYS use --env-file flag)\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production build\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production logs -f\n\n# Django production setup\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py migrate\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py createsuperuser\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py collectstatic --noinput\n```\n\n## Core Data Models\n\n**Hunt Model** (`hunts/models.py`):\n- Tracks hunting sessions with date, location (PostGIS Point), weather conditions\n- Links to multiple Bird harvests and HuntPhoto uploads\n- Weather data automatically fetched from external API based on coordinates\n\n**Bird Model**:\n- Individual waterfowl harvests within a hunt\n- Species selection from predefined WATERFOWL_CHOICES (Dabblers, Divers, Geese)\n- Includes harvest time, notes, and gender (Drake/Hen)\n\n**Authentication Integration**:\n- Django backend uses custom NextAuthBackend for JWT token validation\n- Frontend NextAuth.js providers: Google, Facebook, Credentials\n- Token synchronization between NextAuth and Django API client\n\n## Key Integration Points\n\n**Django-NextAuth Authentication Flow**:\n- NextAuth JWT tokens validated by Django via `accounts/nextauth_backend.py`  \n- API requests include NextAuth JWT in Authorization header\n- User creation/sync handled by Django signals in `accounts/signals.py`\n\n**Photo Upload System**:\n- S3 presigned URLs generated by Django `hunts/s3_manager.py`\n- Frontend uploads directly to S3, then registers with Django\n- HuntPhoto model tracks S3 URLs linked to Hunt instances\n\n**Geospatial Features**:\n- Hunt locations stored as PostGIS Points with lat/lng coordinates\n- Weather API integration fetches conditions based on hunt coordinates\n- Mapbox integration for location selection and visualization\n\n## Environment Configuration\n\n### Critical Environment Variables (MUST MATCH)\n**These variables must be identical in both backend and frontend:**\n```bash\n# Authentication (CRITICAL - must match exactly)\nAUTH_SECRET=your-nextauth-secret-key        # Both .env.local AND frontend/.env.local\n\n# Docker Network (CRITICAL - use service names)  \nBACKEND_URL=http://fowldata:8000            # frontend/.env.local ONLY\n```\n\n### Required Environment Files\n```bash\n# Development\n.env.local                  # Backend: Django database, secrets, S3 credentials  \nfrontend/.env.local         # Frontend: NextAuth secrets, API URLs\n\n# Production  \n.env.production            # Backend: Production settings\nfrontend/.env.production   # Frontend: Production URLs and secrets\n```\n\n### Essential Variables by Service\n```bash\n# Database (Backend .env.local)\nDB_HOST=localhost           # Development: localhost, Production: postgres\nDB_NAME=fowldata           # Database name\nDB_USER=postgres           # Database username\nDB_PASS=your_password      # No special characters in production\n\n# Authentication (Both files)\nAUTH_SECRET=your-secret    # Generate: openssl rand -base64 32\nSECRET_KEY=django-secret   # Django only\n\n# Mapbox (Frontend .env.local)\nNEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-token  # REQUIRED for layer rendering\n\n# AWS S3 (Backend .env.local)\nAWS_ACCESS_KEY_ID=your-key\nAWS_SECRET_ACCESS_KEY=your-secret  \nAWS_S3_BUCKET_NAME=bucket-name\n\n# OAuth (Frontend .env.local)\nGOOGLE_CLIENT_ID=your-google-id\nGOOGLE_CLIENT_SECRET=your-google-secret\n```\n\n### Security & Performance Best Practices\n```bash\n# Production Security Checklist\n- Use strong AUTH_SECRET (32+ characters): openssl rand -base64 32\n- Avoid special characters in passwords (no $, !, etc.) - shell interprets them\n- Always use HTTPS for OAuth callbacks in production\n- Set proper CORS origins: CORS_ALLOWED_ORIGINS=https://yourdomain.com\n\n# Performance Optimization  \n- Use Redis for caching: REDIS_HOST=redis, REDIS_PASSWORD=your-password\n- Enable SSL redirect: SECURE_SSL_REDIRECT=True (production)\n- Configure proper headers: SECURE_HSTS_SECONDS=31536000\n\n# Environment File Best Practices\n- Use UTF-8 encoding without BOM\n- No spaces around = signs: VAR=value (not VAR = value)\n- Always backup production environment files\n```\n\n## Testing Patterns\n\n**Backend Tests** (pytest-django):\n- Database tests marked with `@pytest.mark.django_db`\n- API endpoint tests use Django's APIClient  \n- External services (S3, weather API) are mocked\n- Fixtures in `conftest.py` create test users and hunt data\n\n**Frontend Tests**:\n- Unit tests: Jest + React Testing Library in `src/__tests__/`\n- Component tests focus on user interactions, not implementation\n- E2E tests: Playwright in `e2e/` directory with real browser automation\n- API mocking for isolated component testing\n\n## Mapbox Configuration\n\n- Import controls from `react-map-gl/mapbox` for Mapbox GL JS v3.5+\n- Control positioning critical - use `position` prop, not `style` object\n- Standard controls must be children of `<Map>` component\n- Custom controls positioned absolutely outside `<Map>`\n- Test controls in both browser and fullscreen modes\n\n## Development Notes\n\n- Rebuild Docker containers after backend changes to see frontend updates\n- Use test credentials: `mark@mail.com` / `1@Tsgstp` for Puppeteer E2E tests\n- Run `./testlint-quick` before commits, `./testlint` before PRs\n- Weather API responses should be mocked in tests for consistency\n- if authentication issue arises we can run  Run the health check script:\n  node auth-health-check.js","structuredPatch":[{"oldStart":369,"oldLines":11,"newStart":369,"newLines":140,"lines":[" - Custom controls positioned absolutely outside `<Map>`"," - Test controls in both browser and fullscreen modes"," ","-## Development Notes","+## Development Workflow"," ","-- Rebuild Docker containers after backend changes to see frontend updates","-- Use test credentials: `mark@mail.com` / `1@Tsgstp` for Puppeteer E2E tests","-- Run `./testlint-quick` before commits, `./testlint` before PRs","-- Weather API responses should be mocked in tests for consistency","-- if authentication issue arises we can run  Run the health check script:","-  node auth-health-check.js","\\ No newline at end of file","+### Branch Strategy & Process","+```bash","+# Create feature branch","+git checkout -b feature/descriptive-name","+git push -u origin feature/descriptive-name","+","+# Development cycle","+# 1. Make changes","+# 2. Test locally: ./testlint-quick","+# 3. Commit: git commit -m \"feat: description\"  ","+# 4. Before PR: ./testlint","+# 5. Create PR: gh pr create --title \"Title\" --body \"Description\"","+","+# Commit Message Format","+feat: Add hunt sharing functionality","+fix: Resolve photo upload timeout issue  ","+docs: Update API documentation","+test: Add weather API integration tests","+refactor: Simplify authentication middleware","+```","+","+### Development Best Practices","+- **Container Rebuilds**: Rebuild Docker containers after backend changes to see frontend updates","+- **Test Credentials**: Use `mark@mail.com` / `1@Tsgstp` for E2E tests","+- **Pre-commit**: Always run `./testlint-quick` before commits","+- **Pre-PR**: Always run `./testlint` before creating pull requests  ","+- **API Mocking**: Weather API responses should be mocked in tests for consistency","+","+## Troubleshooting Guide","+","+### Authentication Issues","+```bash","+# Primary diagnostic tool","+node auth-health-check.js                    # Comprehensive auth system check","+","+# Specific auth problems","+docker compose logs fowldata | grep -i auth  # Backend auth errors","+docker compose logs fowldata | grep -i jwt   # JWT token issues","+docker compose exec fowldata python manage.py shell  # Manual user inspection","+","+# Common auth fixes","+# 1. Verify AUTH_SECRET matches in both .env files","+# 2. Check BACKEND_URL uses fowldata:8000 (not localhost)","+# 3. Clear browser cookies and retry","+# 4. Restart both containers: docker compose restart fowldata frontend","+```","+","+### Database & Migration Issues  ","+```bash","+# Database diagnostic","+docker compose exec fowldata python manage.py check","+docker compose exec fowldata python manage.py dbshell","+docker compose exec postgres psql -U postgres -d fowldata","+","+# Reset database (development only)","+docker compose down -v                       # Destroy volumes","+docker compose up -d                         # Recreate services","+docker compose exec fowldata python manage.py migrate","+","+# Migration problems","+docker compose exec fowldata python manage.py showmigrations  # Show status","+docker compose exec fowldata python manage.py migrate --fake  # Mark as applied","+```","+","+### Frontend Build & Runtime Issues","+```bash","+# Build diagnostics","+cd frontend","+npm run build                                # Check for build errors","+npm run lint                                # TypeScript/ESLint issues","+rm -rf .next node_modules && npm install    # Clean reinstall","+","+# Runtime debugging","+npm run dev                                  # Development server logs","+docker compose logs frontend                # Container logs","+```","+","+### E2E Test Failures","+```bash","+# E2E test diagnostics","+./scripts/verify-e2e-setup.sh              # Check prerequisites","+npm run test:e2e -- --headed               # Visual debugging  ","+npm run test:e2e -- --debug                # Step-by-step debugging","+","+# Common E2E fixes","+# 1. Ensure test user exists: mark@mail.com / 1@Tsgstp","+# 2. Check services are running: docker compose ps","+# 3. Verify ports: curl http://localhost:3000 && curl http://localhost:8000/api/","+# 4. Clear browser state: rm -rf test-results/","+```","+","+### Performance & Resource Issues","+```bash","+# System resource monitoring","+docker stats                               # Container resource usage","+docker system df                          # Disk space usage","+docker system prune -f                    # Clean unused resources","+","+# Database performance","+docker compose exec fowldata python manage.py dbshell","+# Then: EXPLAIN ANALYZE SELECT * FROM hunts_hunt WHERE location IS NOT NULL;","+","+# Memory issues","+docker compose down && docker compose up -d  # Restart all services","+```","+","+### Production Deployment Issues","+```bash","+# Production diagnostics","+./scripts/validate-production.sh           # Pre-deployment validation","+docker-compose -f docker-compose.prod.yaml --env-file .env.production config  # Validate config","+","+# SSL/TLS issues  ","+openssl x509 -in ssl/fullchain.pem -text -noout  # Check certificate","+sudo certbot renew --dry-run               # Test renewal process","+","+# Environment variable issues","+docker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata env | grep DB_","+```","+","+### Emergency Recovery","+```bash","+# Quick service restart","+docker compose restart fowldata frontend postgres","+","+# Full environment reset (DESTRUCTIVE - development only)","+docker compose down -v","+docker system prune -f  ","+git checkout -- .env.local frontend/.env.local","+docker compose up -d","+","+# Rollback production deployment","+git checkout previous-working-commit","+docker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate","+```","\\ No newline at end of file"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"856da75a-8f31-4cd4-b903-ecb164466c81","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_017P1jwg59S4eD3qyVkSpj8c","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_0158JWhsUwvUSyqnnCa6GHuY","name":"TodoWrite","input":{"todos":[{"content":"Analyze current CLAUDE.md structure and identify integration points","status":"completed","activeForm":"Analyzing current CLAUDE.md structure and identifying integration points"},{"content":"Enhance testing section with comprehensive commands","status":"completed","activeForm":"Enhancing testing section with comprehensive commands"},{"content":"Add security and performance best practices","status":"completed","activeForm":"Adding security and performance best practices"},{"content":"Expand troubleshooting section with consolidated patterns","status":"completed","activeForm":"Expanding troubleshooting section with consolidated patterns"},{"content":"Add development workflow improvements","status":"completed","activeForm":"Adding development workflow improvements"},{"content":"Include API reference and environment variables priority","status":"in_progress","activeForm":"Including API reference and environment variables priority"},{"content":"Review for redundancy and conflicts","status":"pending","activeForm":"Reviewing for redundancy and conflicts"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":3144,"cache_read_input_tokens":80720,"cache_creation":{"ephemeral_5m_input_tokens":3144,"ephemeral_1h_input_tokens":0},"output_tokens":286,"service_tier":"standard"}},"requestId":"req_011CSTpR5HihH25NGpayan7P","type":"assistant","uuid":"21df1cda-868b-4898-b015-7bf7a0506921","timestamp":"2025-08-25T04:44:44.752Z"}
{"parentUuid":"21df1cda-868b-4898-b015-7bf7a0506921","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0158JWhsUwvUSyqnnCa6GHuY","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"df58dde9-64b7-4aa1-820f-47837a699b2b","timestamp":"2025-08-25T04:44:44.878Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Analyze current CLAUDE.md structure and identify integration points","status":"completed","activeForm":"Analyzing current CLAUDE.md structure and identifying integration points"},{"content":"Enhance testing section with comprehensive commands","status":"completed","activeForm":"Enhancing testing section with comprehensive commands"},{"content":"Add security and performance best practices","status":"completed","activeForm":"Adding security and performance best practices"},{"content":"Expand troubleshooting section with consolidated patterns","status":"completed","activeForm":"Expanding troubleshooting section with consolidated patterns"},{"content":"Add development workflow improvements","status":"completed","activeForm":"Adding development workflow improvements"},{"content":"Include API reference and environment variables priority","status":"in_progress","activeForm":"Including API reference and environment variables priority"},{"content":"Review for redundancy and conflicts","status":"pending","activeForm":"Reviewing for redundancy and conflicts"}]}}
{"parentUuid":"df58dde9-64b7-4aa1-820f-47837a699b2b","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01Ved8nsdPBT7JvMUy14Jp1a","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"Now I need to remove some redundant sections and add database/monitoring commands. Let me clean up the redundant frontend commands section and add the missing pieces:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":328,"cache_read_input_tokens":83864,"cache_creation":{"ephemeral_5m_input_tokens":328,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTpRSyT4JUUW453zB72B","type":"assistant","uuid":"eb25e6f1-cefc-4b08-a408-57495b1fa3ed","timestamp":"2025-08-25T04:44:48.997Z"}
{"parentUuid":"eb25e6f1-cefc-4b08-a408-57495b1fa3ed","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01Ved8nsdPBT7JvMUy14Jp1a","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_017CgkHWHZ1P4wHAKhM9HWKw","name":"Edit","input":{"file_path":"/Users/markelmore/_code/fowldata/CLAUDE.md","old_string":"### Frontend Development\n```bash\ncd frontend\n\n# Development server (with Turbopack)\nnpm run dev\n\n# Build and type checking\nnpm run build\nnpm run lint\n\n# Testing\nnpm run test                    # Jest unit tests\nnpm run test:watch             # Jest in watch mode  \nnpm run test:e2e               # Playwright E2E tests\nnpm run test:e2e:ui            # Playwright with UI\n```","new_string":"### Frontend Development\n```bash\ncd frontend\n\n# Development server (with Turbopack)\nnpm run dev\n\n# Build and type checking\nnpm run build\nnpm run lint\nnpx tsc --noEmit                # TypeScript checking without emit\n```"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":328,"cache_read_input_tokens":83864,"cache_creation":{"ephemeral_5m_input_tokens":328,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTpRSyT4JUUW453zB72B","type":"assistant","uuid":"0267e9e7-5842-4947-b0d5-f313d8a5971f","timestamp":"2025-08-25T04:44:52.219Z"}
{"parentUuid":"0267e9e7-5842-4947-b0d5-f313d8a5971f","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017CgkHWHZ1P4wHAKhM9HWKw","type":"tool_result","content":"The file /Users/markelmore/_code/fowldata/CLAUDE.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   163â†’# Single test file\n   164â†’docker compose exec fowldata python -m pytest hunts/tests/test_weather_api.py -v\n   165â†’```\n   166â†’\n   167â†’### Frontend Development\n   168â†’```bash\n   169â†’cd frontend\n   170â†’\n   171â†’# Development server (with Turbopack)\n   172â†’npm run dev\n   173â†’\n   174â†’# Build and type checking\n   175â†’npm run build\n   176â†’npm run lint\n   177â†’npx tsc --noEmit                # TypeScript checking without emit\n   178â†’```\n   179â†’\n   180â†’### Testing & Validation\n   181â†’\n   182â†’#### Pre-Commit Validation"}]},"uuid":"e8fb8660-16b4-46f5-878c-fde85a6bbd61","timestamp":"2025-08-25T04:44:52.280Z","toolUseResult":{"filePath":"/Users/markelmore/_code/fowldata/CLAUDE.md","oldString":"### Frontend Development\n```bash\ncd frontend\n\n# Development server (with Turbopack)\nnpm run dev\n\n# Build and type checking\nnpm run build\nnpm run lint\n\n# Testing\nnpm run test                    # Jest unit tests\nnpm run test:watch             # Jest in watch mode  \nnpm run test:e2e               # Playwright E2E tests\nnpm run test:e2e:ui            # Playwright with UI\n```","newString":"### Frontend Development\n```bash\ncd frontend\n\n# Development server (with Turbopack)\nnpm run dev\n\n# Build and type checking\nnpm run build\nnpm run lint\nnpx tsc --noEmit                # TypeScript checking without emit\n```","originalFile":"# CLAUDE.md\n\nThis file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n\n## ğŸ¯ Quick Reference\n\n### Critical Commands\n```bash\n# Essential Development\ndocker compose up -d && cd frontend && npm run dev  # Start full stack\n./testlint-quick           # Quick validation before commits\n./testlint                 # Full validation before PRs\n\n# Production Deployment\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# Emergency Troubleshooting\nnode auth-health-check.js  # Authentication issues\n./scripts/verify-e2e-setup.sh  # E2E test setup validation\n```\n\n### Key API Endpoints\n```bash\nGET /api/hunts/            # List user hunts\nPOST /api/hunts/           # Create hunt\nGET /api/users/me/         # Current user info  \nPOST /api/auth/sync/       # User synchronization\nGET /api/health/           # Backend health check\n```\n\n## âš ï¸ CRITICAL: Docker Network Configuration - NEVER CHANGE\n**RECURRING ISSUE - ALWAYS CHECK THIS FIRST**\n\nThe frontend `.env.local` file MUST use the Docker service name for backend communication:\n```bash\n# CORRECT - Use Docker service name (this is in frontend/.env.local)\nBACKEND_URL=http://fowldata:8000\n\n# WRONG - Will cause ECONNREFUSED errors in Docker containers\nBACKEND_URL=http://localhost:8000\n```\n\n**Why**: Inside Docker containers, `localhost` refers to the container itself, not the host. Service names resolve to container IPs within the Docker network.\n\n**Symptoms**: NextAuth authentication fails, API calls fail with \"connect ECONNREFUSED ::1:8000\"\n\n**Fix**: Always use `fowldata:8000` (service name from docker-compose.yml) for inter-container communication.\n\n## âš ï¸ CRITICAL: Mapbox GL JS v3+ with react-map-gl v8 Layer Rendering\n**RECURRING ISSUE - ESSENTIAL FOR LAYER VISIBILITY**\n\nWhen using Mapbox GL JS v3+ with react-map-gl v8, layers will NOT render without explicit `mapboxgl.accessToken` configuration:\n\n```typescript\nimport mapboxgl from 'mapbox-gl';\n\nconst MAPBOX_TOKEN = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;\n\n// CRITICAL: This is required for Mapbox GL JS v3+ with react-map-gl v8\nif (MAPBOX_TOKEN) {\n  mapboxgl.accessToken = MAPBOX_TOKEN;\n}\n```\n\n**Why**: react-map-gl v8 delegates to Mapbox GL JS v3+ which requires explicit token configuration. Previous versions handled this automatically.\n\n**Symptoms**: \n- Map loads successfully with satellite/custom styles\n- Source/Layer components appear to be configured correctly  \n- Debug panels show data is present\n- NO visual layers render (not even test layers with bright colors)\n- No console errors about authentication or tokens\n- Canvas element exists but shows no content\n\n**Additional react-map-gl v8 Requirements:**\n- Layer components must be **immediate children** of Source components (no React fragments `<>...</>`)\n- Do NOT add explicit `source` props to Layer components inside Source components\n- Remove conditional `mapStyleLoaded` wrappers - let react-map-gl handle timing internally\n\n**Fix Location**: Add the `mapboxgl.accessToken` configuration at the top level of your Map component file, after importing mapboxgl.\n\n**Debugging Signs This is the Issue**:\n- Mapbox canvas renders with proper classes (`mapboxgl-canvas-container`)\n- Map style loads successfully\n- Data processing works correctly\n- Visibility and layer management appears functional\n- Zero visual layer rendering despite all other systems working\n\n## âš ï¸ CRITICAL: Production Environment Variable Loading\n**RECURRING DEPLOYMENT ISSUE - ESSENTIAL FOR PRODUCTION**\n\nDocker Compose production deployments REQUIRE explicit `--env-file` flag:\n\n```bash\n# REQUIRED for all production commands\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# WRONG - Will cause \"variable is not set\" warnings and startup failures\ndocker-compose -f docker-compose.prod.yaml up -d\n```\n\n**Why**: The `env_file:` setting in docker-compose.prod.yaml handles container environment variables, but Docker Compose variable substitution (${VARIABLE}) requires the explicit `--env-file` flag.\n\n**Symptoms**: \n- `WARN[0000] The \"DB_NAME\" variable is not set. Defaulting to a blank string.`\n- PostgreSQL container fails with \"superuser password not specified\"\n- Environment variables visible in some services but not others\n\n**Additional Production Requirements**:\n- All services need `env_file: - .env.production` in docker-compose.prod.yaml\n- Avoid special characters in passwords (`$`, `!`, etc.) - shell interprets them\n- Use clean file encoding (UTF-8 without BOM) for environment files\n\n## Architecture Overview\n\nFowlData is a production-ready full-stack waterfowl hunting tracking application:\n\n**Backend (Django)**: Located in `fowldata/` directory\n- Django 4.2 with Django REST Framework for API endpoints\n- PostgreSQL 16 with PostGIS 3.4 for geospatial data storage and spatial queries\n- JWT RS256 authentication integrated with NextAuth.js frontend\n- Two main apps: `accounts` (user management) and `hunts` (hunt tracking)\n- AWS S3 integration for photo storage with presigned URLs and CORS\n- Gunicorn WSGI server with production performance tuning\n\n**Frontend (Next.js)**: Located in `frontend/` directory  \n- Next.js 15.4.4 with React 19 and TypeScript\n- NextAuth.js v5 with Google OAuth and credentials authentication\n- Mapbox GL JS v3+ with react-map-gl v8 for interactive mapping\n- TailwindCSS for styling, React Hook Form for forms\n- Playwright for E2E testing, Jest for unit tests\n- Production-optimized standalone builds\n\n**Production Infrastructure**:\n- **Deployment**: Digital Ocean Droplets with Docker Compose orchestration\n- **Reverse Proxy**: Nginx with SSL/TLS termination via Let's Encrypt\n- **Caching**: Redis for sessions, query caching, and performance optimization\n- **Storage**: AWS S3 with CloudFront CDN for photo uploads and static assets\n- **Database**: PostgreSQL with PostGIS extensions, performance tuning, and automated backups\n- **Monitoring**: Docker health checks, database performance monitoring, and logging\n- **Security**: SSL enforcement, security headers, rate limiting, and firewall configuration\n\n## Development Commands\n\n### Backend Development\n```bash\n# Start services\ndocker compose up -d\n\n# Django management commands\ndocker compose exec fowldata python manage.py migrate\ndocker compose exec fowldata python manage.py createsuperuser\ndocker compose exec fowldata python manage.py shell\n\n# Run backend tests\ndocker compose exec fowldata python -m pytest\ndocker compose exec fowldata python -m pytest accounts/tests/ hunts/tests/ -v\n\n# Code formatting and linting\ndocker compose exec fowldata black .\ndocker compose exec fowldata flake8\n\n# Single test file\ndocker compose exec fowldata python -m pytest hunts/tests/test_weather_api.py -v\n```\n\n### Frontend Development\n```bash\ncd frontend\n\n# Development server (with Turbopack)\nnpm run dev\n\n# Build and type checking\nnpm run build\nnpm run lint\n\n# Testing\nnpm run test                    # Jest unit tests\nnpm run test:watch             # Jest in watch mode  \nnpm run test:e2e               # Playwright E2E tests\nnpm run test:e2e:ui            # Playwright with UI\n```\n\n### Testing & Validation\n\n#### Pre-Commit Validation\n```bash\n# Quick validation (run before commits)\n./testlint-quick               # Essential tests only (2-3 minutes)\n\n# Full validation (run before PRs)  \n./testlint                     # Complete validation with E2E tests (10-15 minutes)\n```\n\n#### Comprehensive Testing Commands\n```bash\n# Backend Testing\ndocker compose exec fowldata python -m pytest                    # All backend tests\ndocker compose exec fowldata python -m pytest -m \"not performance\"  # Skip slow tests\ndocker compose exec fowldata python -m pytest --cov=fowldata     # With coverage\ndocker compose exec fowldata python -m pytest -s --pdb          # Debug mode\n\n# Frontend Testing\ncd frontend\nnpm run test                           # Jest unit tests\nnpm run test -- --watchAll=false      # CI mode (run once)  \nnpm run test:e2e                      # Playwright E2E tests\nnpm run test:e2e -- --project chromium  # Specific browser\nnpm run test:e2e -- --debug           # Debug E2E tests\n\n# Specific Test Categories\ndocker compose exec fowldata python -m pytest -m \"auth\"      # Authentication tests\ndocker compose exec fowldata python -m pytest -m \"api\"       # API endpoint tests\nnpm test -- --testNamePattern=\"authentication\"               # Frontend auth tests\n```\n\n#### Test Debugging\n```bash\n# Backend Debug\ndocker compose exec fowldata python -m pytest -s --pdb hunts/tests/test_weather_api.py::test_function\ndocker compose exec fowldata python manage.py shell\n\n# Frontend Debug\nnpm run test:e2e -- --headed          # Show browser\nnpm run test:e2e -- --ui               # Playwright UI mode\nnpm test -- --no-coverage --verbose   # Detailed Jest output\n\n# E2E Test Environment Validation\n./scripts/verify-e2e-setup.sh         # Check E2E prerequisites\n```\n\n### Production Deployment\n```bash\n# Production validation and deployment\n./scripts/validate-production.sh\n\n# Production commands (ALWAYS use --env-file flag)\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production build\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production logs -f\n\n# Django production setup\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py migrate\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py createsuperuser\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py collectstatic --noinput\n```\n\n## Core Data Models\n\n**Hunt Model** (`hunts/models.py`):\n- Tracks hunting sessions with date, location (PostGIS Point), weather conditions\n- Links to multiple Bird harvests and HuntPhoto uploads\n- Weather data automatically fetched from external API based on coordinates\n\n**Bird Model**:\n- Individual waterfowl harvests within a hunt\n- Species selection from predefined WATERFOWL_CHOICES (Dabblers, Divers, Geese)\n- Includes harvest time, notes, and gender (Drake/Hen)\n\n**Authentication Integration**:\n- Django backend uses custom NextAuthBackend for JWT token validation\n- Frontend NextAuth.js providers: Google, Facebook, Credentials\n- Token synchronization between NextAuth and Django API client\n\n## Key Integration Points\n\n**Django-NextAuth Authentication Flow**:\n- NextAuth JWT tokens validated by Django via `accounts/nextauth_backend.py`  \n- API requests include NextAuth JWT in Authorization header\n- User creation/sync handled by Django signals in `accounts/signals.py`\n\n**Photo Upload System**:\n- S3 presigned URLs generated by Django `hunts/s3_manager.py`\n- Frontend uploads directly to S3, then registers with Django\n- HuntPhoto model tracks S3 URLs linked to Hunt instances\n\n**Geospatial Features**:\n- Hunt locations stored as PostGIS Points with lat/lng coordinates\n- Weather API integration fetches conditions based on hunt coordinates\n- Mapbox integration for location selection and visualization\n\n## Environment Configuration\n\n### Critical Environment Variables (MUST MATCH)\n**These variables must be identical in both backend and frontend:**\n```bash\n# Authentication (CRITICAL - must match exactly)\nAUTH_SECRET=your-nextauth-secret-key        # Both .env.local AND frontend/.env.local\n\n# Docker Network (CRITICAL - use service names)  \nBACKEND_URL=http://fowldata:8000            # frontend/.env.local ONLY\n```\n\n### Required Environment Files\n```bash\n# Development\n.env.local                  # Backend: Django database, secrets, S3 credentials  \nfrontend/.env.local         # Frontend: NextAuth secrets, API URLs\n\n# Production  \n.env.production            # Backend: Production settings\nfrontend/.env.production   # Frontend: Production URLs and secrets\n```\n\n### Essential Variables by Service\n```bash\n# Database (Backend .env.local)\nDB_HOST=localhost           # Development: localhost, Production: postgres\nDB_NAME=fowldata           # Database name\nDB_USER=postgres           # Database username\nDB_PASS=your_password      # No special characters in production\n\n# Authentication (Both files)\nAUTH_SECRET=your-secret    # Generate: openssl rand -base64 32\nSECRET_KEY=django-secret   # Django only\n\n# Mapbox (Frontend .env.local)\nNEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-token  # REQUIRED for layer rendering\n\n# AWS S3 (Backend .env.local)\nAWS_ACCESS_KEY_ID=your-key\nAWS_SECRET_ACCESS_KEY=your-secret  \nAWS_S3_BUCKET_NAME=bucket-name\n\n# OAuth (Frontend .env.local)\nGOOGLE_CLIENT_ID=your-google-id\nGOOGLE_CLIENT_SECRET=your-google-secret\n```\n\n### Security & Performance Best Practices\n```bash\n# Production Security Checklist\n- Use strong AUTH_SECRET (32+ characters): openssl rand -base64 32\n- Avoid special characters in passwords (no $, !, etc.) - shell interprets them\n- Always use HTTPS for OAuth callbacks in production\n- Set proper CORS origins: CORS_ALLOWED_ORIGINS=https://yourdomain.com\n\n# Performance Optimization  \n- Use Redis for caching: REDIS_HOST=redis, REDIS_PASSWORD=your-password\n- Enable SSL redirect: SECURE_SSL_REDIRECT=True (production)\n- Configure proper headers: SECURE_HSTS_SECONDS=31536000\n\n# Environment File Best Practices\n- Use UTF-8 encoding without BOM\n- No spaces around = signs: VAR=value (not VAR = value)\n- Always backup production environment files\n```\n\n## Testing Patterns\n\n**Backend Tests** (pytest-django):\n- Database tests marked with `@pytest.mark.django_db`\n- API endpoint tests use Django's APIClient  \n- External services (S3, weather API) are mocked\n- Fixtures in `conftest.py` create test users and hunt data\n\n**Frontend Tests**:\n- Unit tests: Jest + React Testing Library in `src/__tests__/`\n- Component tests focus on user interactions, not implementation\n- E2E tests: Playwright in `e2e/` directory with real browser automation\n- API mocking for isolated component testing\n\n## Mapbox Configuration\n\n- Import controls from `react-map-gl/mapbox` for Mapbox GL JS v3.5+\n- Control positioning critical - use `position` prop, not `style` object\n- Standard controls must be children of `<Map>` component\n- Custom controls positioned absolutely outside `<Map>`\n- Test controls in both browser and fullscreen modes\n\n## Development Workflow\n\n### Branch Strategy & Process\n```bash\n# Create feature branch\ngit checkout -b feature/descriptive-name\ngit push -u origin feature/descriptive-name\n\n# Development cycle\n# 1. Make changes\n# 2. Test locally: ./testlint-quick\n# 3. Commit: git commit -m \"feat: description\"  \n# 4. Before PR: ./testlint\n# 5. Create PR: gh pr create --title \"Title\" --body \"Description\"\n\n# Commit Message Format\nfeat: Add hunt sharing functionality\nfix: Resolve photo upload timeout issue  \ndocs: Update API documentation\ntest: Add weather API integration tests\nrefactor: Simplify authentication middleware\n```\n\n### Development Best Practices\n- **Container Rebuilds**: Rebuild Docker containers after backend changes to see frontend updates\n- **Test Credentials**: Use `mark@mail.com` / `1@Tsgstp` for E2E tests\n- **Pre-commit**: Always run `./testlint-quick` before commits\n- **Pre-PR**: Always run `./testlint` before creating pull requests  \n- **API Mocking**: Weather API responses should be mocked in tests for consistency\n\n## Troubleshooting Guide\n\n### Authentication Issues\n```bash\n# Primary diagnostic tool\nnode auth-health-check.js                    # Comprehensive auth system check\n\n# Specific auth problems\ndocker compose logs fowldata | grep -i auth  # Backend auth errors\ndocker compose logs fowldata | grep -i jwt   # JWT token issues\ndocker compose exec fowldata python manage.py shell  # Manual user inspection\n\n# Common auth fixes\n# 1. Verify AUTH_SECRET matches in both .env files\n# 2. Check BACKEND_URL uses fowldata:8000 (not localhost)\n# 3. Clear browser cookies and retry\n# 4. Restart both containers: docker compose restart fowldata frontend\n```\n\n### Database & Migration Issues  \n```bash\n# Database diagnostic\ndocker compose exec fowldata python manage.py check\ndocker compose exec fowldata python manage.py dbshell\ndocker compose exec postgres psql -U postgres -d fowldata\n\n# Reset database (development only)\ndocker compose down -v                       # Destroy volumes\ndocker compose up -d                         # Recreate services\ndocker compose exec fowldata python manage.py migrate\n\n# Migration problems\ndocker compose exec fowldata python manage.py showmigrations  # Show status\ndocker compose exec fowldata python manage.py migrate --fake  # Mark as applied\n```\n\n### Frontend Build & Runtime Issues\n```bash\n# Build diagnostics\ncd frontend\nnpm run build                                # Check for build errors\nnpm run lint                                # TypeScript/ESLint issues\nrm -rf .next node_modules && npm install    # Clean reinstall\n\n# Runtime debugging\nnpm run dev                                  # Development server logs\ndocker compose logs frontend                # Container logs\n```\n\n### E2E Test Failures\n```bash\n# E2E test diagnostics\n./scripts/verify-e2e-setup.sh              # Check prerequisites\nnpm run test:e2e -- --headed               # Visual debugging  \nnpm run test:e2e -- --debug                # Step-by-step debugging\n\n# Common E2E fixes\n# 1. Ensure test user exists: mark@mail.com / 1@Tsgstp\n# 2. Check services are running: docker compose ps\n# 3. Verify ports: curl http://localhost:3000 && curl http://localhost:8000/api/\n# 4. Clear browser state: rm -rf test-results/\n```\n\n### Performance & Resource Issues\n```bash\n# System resource monitoring\ndocker stats                               # Container resource usage\ndocker system df                          # Disk space usage\ndocker system prune -f                    # Clean unused resources\n\n# Database performance\ndocker compose exec fowldata python manage.py dbshell\n# Then: EXPLAIN ANALYZE SELECT * FROM hunts_hunt WHERE location IS NOT NULL;\n\n# Memory issues\ndocker compose down && docker compose up -d  # Restart all services\n```\n\n### Production Deployment Issues\n```bash\n# Production diagnostics\n./scripts/validate-production.sh           # Pre-deployment validation\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production config  # Validate config\n\n# SSL/TLS issues  \nopenssl x509 -in ssl/fullchain.pem -text -noout  # Check certificate\nsudo certbot renew --dry-run               # Test renewal process\n\n# Environment variable issues\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata env | grep DB_\n```\n\n### Emergency Recovery\n```bash\n# Quick service restart\ndocker compose restart fowldata frontend postgres\n\n# Full environment reset (DESTRUCTIVE - development only)\ndocker compose down -v\ndocker system prune -f  \ngit checkout -- .env.local frontend/.env.local\ndocker compose up -d\n\n# Rollback production deployment\ngit checkout previous-working-commit\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate\n```","structuredPatch":[{"oldStart":174,"oldLines":12,"newStart":174,"newLines":7,"lines":[" # Build and type checking"," npm run build"," npm run lint","-","-# Testing","-npm run test                    # Jest unit tests","-npm run test:watch             # Jest in watch mode  ","-npm run test:e2e               # Playwright E2E tests","-npm run test:e2e:ui            # Playwright with UI","+npx tsc --noEmit                # TypeScript checking without emit"," ```"," "," ### Testing & Validation"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"e8fb8660-16b4-46f5-878c-fde85a6bbd61","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01PtPMxUtnnYU61v9hozrnmP","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01BC3PEP1thF9HL7sgjYWFaJ","name":"Edit","input":{"file_path":"/Users/markelmore/_code/fowldata/CLAUDE.md","old_string":"# Rollback production deployment\ngit checkout previous-working-commit\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate\n```","new_string":"# Rollback production deployment\ngit checkout previous-working-commit\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate\n```\n\n## Database & Backup Management\n\n### Database Operations\n```bash\n# Database inspection\ndocker compose exec fowldata python manage.py dbshell\ndocker compose exec postgres psql -U postgres -d fowldata\n\n# Create database backup\ndocker compose exec postgres pg_dump -U postgres fowldata > backup_$(date +%Y%m%d_%H%M%S).sql\n\n# Restore database backup  \ncat backup_file.sql | docker compose exec -T postgres psql -U postgres -d fowldata\n\n# Check database size and connections\ndocker compose exec postgres psql -U postgres -d fowldata -c \"\\l+ fowldata\"\ndocker compose exec postgres psql -U postgres -d fowldata -c \"SELECT * FROM pg_stat_activity;\"\n```\n\n### Performance Monitoring\n```bash\n# Monitor container resources\ndocker stats fowldata postgres redis frontend\n\n# Database performance analysis\ndocker compose exec fowldata python manage.py shell\n# >>> from django.db import connection; print(len(connection.queries))\n\n# Check slow queries (PostgreSQL)\ndocker compose exec postgres psql -U postgres -d fowldata -c \"\nSELECT query, mean_exec_time, calls \nFROM pg_stat_statements \nORDER BY mean_exec_time DESC LIMIT 10;\"\n\n# Redis monitoring\ndocker compose exec redis redis-cli INFO memory\ndocker compose exec redis redis-cli INFO stats\n```\n\n## API Reference\n\n### Core Hunt API\n```bash\n# Hunt Management\nGET /api/hunts/                           # List user hunts (paginated)\nPOST /api/hunts/                          # Create new hunt\nGET /api/hunts/{id}/                      # Get specific hunt\nPUT /api/hunts/{id}/                      # Update hunt\nDELETE /api/hunts/{id}/                   # Delete hunt\n\n# Hunt Search & Filtering  \nGET /api/hunts/?date_after=2024-01-01     # Filter by date\nGET /api/hunts/?location=lat,lng,radius   # Geospatial search\nGET /api/hunts/?species=mallard           # Filter by species\n```\n\n### Photo & Media API\n```bash\n# Photo Management\nGET /api/hunts/{hunt_id}/photos/          # List hunt photos\nPOST /api/hunts/{hunt_id}/photos/         # Upload photo\nDELETE /api/photos/{photo_id}/            # Delete photo\n\n# S3 Upload Workflow\nPOST /api/photos/presigned-url/           # Get presigned upload URL\n# â†’ Upload directly to S3 using presigned URL\nPOST /api/photos/confirm-upload/          # Confirm S3 upload success\n```\n\n### User & Authentication API\n```bash\n# User Management\nGET /api/users/me/                        # Current user profile\nPUT /api/users/me/                        # Update user profile  \nPOST /api/auth/sync/                      # Sync NextAuth user data\n\n# System Health\nGET /api/health/                          # Backend health check\nGET /health.json                          # Frontend health check (static)\n```"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":514,"cache_read_input_tokens":84192,"cache_creation":{"ephemeral_5m_input_tokens":514,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"}},"requestId":"req_011CSTpRzcDFAMYwejmYQE3Y","type":"assistant","uuid":"a63cd212-1995-44f7-ab83-44d61b918d26","timestamp":"2025-08-25T04:45:07.232Z"}
{"parentUuid":"a63cd212-1995-44f7-ab83-44d61b918d26","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BC3PEP1thF9HL7sgjYWFaJ","type":"tool_result","content":"The file /Users/markelmore/_code/fowldata/CLAUDE.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   496â†’docker system prune -f  \n   497â†’git checkout -- .env.local frontend/.env.local\n   498â†’docker compose up -d\n   499â†’\n   500â†’# Rollback production deployment\n   501â†’git checkout previous-working-commit\n   502â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate\n   503â†’```\n   504â†’\n   505â†’## Database & Backup Management\n   506â†’\n   507â†’### Database Operations\n   508â†’```bash\n   509â†’# Database inspection\n   510â†’docker compose exec fowldata python manage.py dbshell\n   511â†’docker compose exec postgres psql -U postgres -d fowldata\n   512â†’\n   513â†’# Create database backup\n   514â†’docker compose exec postgres pg_dump -U postgres fowldata > backup_$(date +%Y%m%d_%H%M%S).sql\n   515â†’\n   516â†’# Restore database backup  \n   517â†’cat backup_file.sql | docker compose exec -T postgres psql -U postgres -d fowldata\n   518â†’\n   519â†’# Check database size and connections\n   520â†’docker compose exec postgres psql -U postgres -d fowldata -c \"\\l+ fowldata\"\n   521â†’docker compose exec postgres psql -U postgres -d fowldata -c \"SELECT * FROM pg_stat_activity;\"\n   522â†’```\n   523â†’\n   524â†’### Performance Monitoring\n   525â†’```bash\n   526â†’# Monitor container resources\n   527â†’docker stats fowldata postgres redis frontend\n   528â†’\n   529â†’# Database performance analysis\n   530â†’docker compose exec fowldata python manage.py shell\n   531â†’# >>> from django.db import connection; print(len(connection.queries))\n   532â†’\n   533â†’# Check slow queries (PostgreSQL)\n   534â†’docker compose exec postgres psql -U postgres -d fowldata -c \"\n   535â†’SELECT query, mean_exec_time, calls \n   536â†’FROM pg_stat_statements \n   537â†’ORDER BY mean_exec_time DESC LIMIT 10;\"\n   538â†’\n   539â†’# Redis monitoring\n   540â†’docker compose exec redis redis-cli INFO memory\n   541â†’docker compose exec redis redis-cli INFO stats\n   542â†’```\n   543â†’\n   544â†’## API Reference\n   545â†’\n   546â†’### Core Hunt API\n   547â†’```bash\n   548â†’# Hunt Management\n   549â†’GET /api/hunts/                           # List user hunts (paginated)\n   550â†’POST /api/hunts/                          # Create new hunt\n   551â†’GET /api/hunts/{id}/                      # Get specific hunt\n   552â†’PUT /api/hunts/{id}/                      # Update hunt\n   553â†’DELETE /api/hunts/{id}/                   # Delete hunt\n   554â†’\n   555â†’# Hunt Search & Filtering  \n   556â†’GET /api/hunts/?date_after=2024-01-01     # Filter by date\n   557â†’GET /api/hunts/?location=lat,lng,radius   # Geospatial search\n   558â†’GET /api/hunts/?species=mallard           # Filter by species\n   559â†’```\n   560â†’\n   561â†’### Photo & Media API\n   562â†’```bash\n   563â†’# Photo Management\n   564â†’GET /api/hunts/{hunt_id}/photos/          # List hunt photos\n   565â†’POST /api/hunts/{hunt_id}/photos/         # Upload photo\n   566â†’DELETE /api/photos/{photo_id}/            # Delete photo\n   567â†’\n   568â†’# S3 Upload Workflow\n   569â†’POST /api/photos/presigned-url/           # Get presigned upload URL\n   570â†’# â†’ Upload directly to S3 using presigned URL\n   571â†’POST /api/photos/confirm-upload/          # Confirm S3 upload success\n   572â†’```\n   573â†’\n   574â†’### User & Authentication API\n   575â†’```bash\n   576â†’# User Management\n   577â†’GET /api/users/me/                        # Current user profile\n   578â†’PUT /api/users/me/                        # Update user profile  \n   579â†’POST /api/auth/sync/                      # Sync NextAuth user data\n   580â†’\n   581â†’# System Health\n   582â†’GET /api/health/                          # Backend health check\n   583â†’GET /health.json                          # Frontend health check (static)\n   584â†’```"}]},"uuid":"fc9d73e3-824d-4cf7-9781-3ba20186f49a","timestamp":"2025-08-25T04:45:07.307Z","toolUseResult":{"filePath":"/Users/markelmore/_code/fowldata/CLAUDE.md","oldString":"# Rollback production deployment\ngit checkout previous-working-commit\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate\n```","newString":"# Rollback production deployment\ngit checkout previous-working-commit\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate\n```\n\n## Database & Backup Management\n\n### Database Operations\n```bash\n# Database inspection\ndocker compose exec fowldata python manage.py dbshell\ndocker compose exec postgres psql -U postgres -d fowldata\n\n# Create database backup\ndocker compose exec postgres pg_dump -U postgres fowldata > backup_$(date +%Y%m%d_%H%M%S).sql\n\n# Restore database backup  \ncat backup_file.sql | docker compose exec -T postgres psql -U postgres -d fowldata\n\n# Check database size and connections\ndocker compose exec postgres psql -U postgres -d fowldata -c \"\\l+ fowldata\"\ndocker compose exec postgres psql -U postgres -d fowldata -c \"SELECT * FROM pg_stat_activity;\"\n```\n\n### Performance Monitoring\n```bash\n# Monitor container resources\ndocker stats fowldata postgres redis frontend\n\n# Database performance analysis\ndocker compose exec fowldata python manage.py shell\n# >>> from django.db import connection; print(len(connection.queries))\n\n# Check slow queries (PostgreSQL)\ndocker compose exec postgres psql -U postgres -d fowldata -c \"\nSELECT query, mean_exec_time, calls \nFROM pg_stat_statements \nORDER BY mean_exec_time DESC LIMIT 10;\"\n\n# Redis monitoring\ndocker compose exec redis redis-cli INFO memory\ndocker compose exec redis redis-cli INFO stats\n```\n\n## API Reference\n\n### Core Hunt API\n```bash\n# Hunt Management\nGET /api/hunts/                           # List user hunts (paginated)\nPOST /api/hunts/                          # Create new hunt\nGET /api/hunts/{id}/                      # Get specific hunt\nPUT /api/hunts/{id}/                      # Update hunt\nDELETE /api/hunts/{id}/                   # Delete hunt\n\n# Hunt Search & Filtering  \nGET /api/hunts/?date_after=2024-01-01     # Filter by date\nGET /api/hunts/?location=lat,lng,radius   # Geospatial search\nGET /api/hunts/?species=mallard           # Filter by species\n```\n\n### Photo & Media API\n```bash\n# Photo Management\nGET /api/hunts/{hunt_id}/photos/          # List hunt photos\nPOST /api/hunts/{hunt_id}/photos/         # Upload photo\nDELETE /api/photos/{photo_id}/            # Delete photo\n\n# S3 Upload Workflow\nPOST /api/photos/presigned-url/           # Get presigned upload URL\n# â†’ Upload directly to S3 using presigned URL\nPOST /api/photos/confirm-upload/          # Confirm S3 upload success\n```\n\n### User & Authentication API\n```bash\n# User Management\nGET /api/users/me/                        # Current user profile\nPUT /api/users/me/                        # Update user profile  \nPOST /api/auth/sync/                      # Sync NextAuth user data\n\n# System Health\nGET /api/health/                          # Backend health check\nGET /health.json                          # Frontend health check (static)\n```","originalFile":"# CLAUDE.md\n\nThis file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n\n## ğŸ¯ Quick Reference\n\n### Critical Commands\n```bash\n# Essential Development\ndocker compose up -d && cd frontend && npm run dev  # Start full stack\n./testlint-quick           # Quick validation before commits\n./testlint                 # Full validation before PRs\n\n# Production Deployment\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# Emergency Troubleshooting\nnode auth-health-check.js  # Authentication issues\n./scripts/verify-e2e-setup.sh  # E2E test setup validation\n```\n\n### Key API Endpoints\n```bash\nGET /api/hunts/            # List user hunts\nPOST /api/hunts/           # Create hunt\nGET /api/users/me/         # Current user info  \nPOST /api/auth/sync/       # User synchronization\nGET /api/health/           # Backend health check\n```\n\n## âš ï¸ CRITICAL: Docker Network Configuration - NEVER CHANGE\n**RECURRING ISSUE - ALWAYS CHECK THIS FIRST**\n\nThe frontend `.env.local` file MUST use the Docker service name for backend communication:\n```bash\n# CORRECT - Use Docker service name (this is in frontend/.env.local)\nBACKEND_URL=http://fowldata:8000\n\n# WRONG - Will cause ECONNREFUSED errors in Docker containers\nBACKEND_URL=http://localhost:8000\n```\n\n**Why**: Inside Docker containers, `localhost` refers to the container itself, not the host. Service names resolve to container IPs within the Docker network.\n\n**Symptoms**: NextAuth authentication fails, API calls fail with \"connect ECONNREFUSED ::1:8000\"\n\n**Fix**: Always use `fowldata:8000` (service name from docker-compose.yml) for inter-container communication.\n\n## âš ï¸ CRITICAL: Mapbox GL JS v3+ with react-map-gl v8 Layer Rendering\n**RECURRING ISSUE - ESSENTIAL FOR LAYER VISIBILITY**\n\nWhen using Mapbox GL JS v3+ with react-map-gl v8, layers will NOT render without explicit `mapboxgl.accessToken` configuration:\n\n```typescript\nimport mapboxgl from 'mapbox-gl';\n\nconst MAPBOX_TOKEN = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;\n\n// CRITICAL: This is required for Mapbox GL JS v3+ with react-map-gl v8\nif (MAPBOX_TOKEN) {\n  mapboxgl.accessToken = MAPBOX_TOKEN;\n}\n```\n\n**Why**: react-map-gl v8 delegates to Mapbox GL JS v3+ which requires explicit token configuration. Previous versions handled this automatically.\n\n**Symptoms**: \n- Map loads successfully with satellite/custom styles\n- Source/Layer components appear to be configured correctly  \n- Debug panels show data is present\n- NO visual layers render (not even test layers with bright colors)\n- No console errors about authentication or tokens\n- Canvas element exists but shows no content\n\n**Additional react-map-gl v8 Requirements:**\n- Layer components must be **immediate children** of Source components (no React fragments `<>...</>`)\n- Do NOT add explicit `source` props to Layer components inside Source components\n- Remove conditional `mapStyleLoaded` wrappers - let react-map-gl handle timing internally\n\n**Fix Location**: Add the `mapboxgl.accessToken` configuration at the top level of your Map component file, after importing mapboxgl.\n\n**Debugging Signs This is the Issue**:\n- Mapbox canvas renders with proper classes (`mapboxgl-canvas-container`)\n- Map style loads successfully\n- Data processing works correctly\n- Visibility and layer management appears functional\n- Zero visual layer rendering despite all other systems working\n\n## âš ï¸ CRITICAL: Production Environment Variable Loading\n**RECURRING DEPLOYMENT ISSUE - ESSENTIAL FOR PRODUCTION**\n\nDocker Compose production deployments REQUIRE explicit `--env-file` flag:\n\n```bash\n# REQUIRED for all production commands\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# WRONG - Will cause \"variable is not set\" warnings and startup failures\ndocker-compose -f docker-compose.prod.yaml up -d\n```\n\n**Why**: The `env_file:` setting in docker-compose.prod.yaml handles container environment variables, but Docker Compose variable substitution (${VARIABLE}) requires the explicit `--env-file` flag.\n\n**Symptoms**: \n- `WARN[0000] The \"DB_NAME\" variable is not set. Defaulting to a blank string.`\n- PostgreSQL container fails with \"superuser password not specified\"\n- Environment variables visible in some services but not others\n\n**Additional Production Requirements**:\n- All services need `env_file: - .env.production` in docker-compose.prod.yaml\n- Avoid special characters in passwords (`$`, `!`, etc.) - shell interprets them\n- Use clean file encoding (UTF-8 without BOM) for environment files\n\n## Architecture Overview\n\nFowlData is a production-ready full-stack waterfowl hunting tracking application:\n\n**Backend (Django)**: Located in `fowldata/` directory\n- Django 4.2 with Django REST Framework for API endpoints\n- PostgreSQL 16 with PostGIS 3.4 for geospatial data storage and spatial queries\n- JWT RS256 authentication integrated with NextAuth.js frontend\n- Two main apps: `accounts` (user management) and `hunts` (hunt tracking)\n- AWS S3 integration for photo storage with presigned URLs and CORS\n- Gunicorn WSGI server with production performance tuning\n\n**Frontend (Next.js)**: Located in `frontend/` directory  \n- Next.js 15.4.4 with React 19 and TypeScript\n- NextAuth.js v5 with Google OAuth and credentials authentication\n- Mapbox GL JS v3+ with react-map-gl v8 for interactive mapping\n- TailwindCSS for styling, React Hook Form for forms\n- Playwright for E2E testing, Jest for unit tests\n- Production-optimized standalone builds\n\n**Production Infrastructure**:\n- **Deployment**: Digital Ocean Droplets with Docker Compose orchestration\n- **Reverse Proxy**: Nginx with SSL/TLS termination via Let's Encrypt\n- **Caching**: Redis for sessions, query caching, and performance optimization\n- **Storage**: AWS S3 with CloudFront CDN for photo uploads and static assets\n- **Database**: PostgreSQL with PostGIS extensions, performance tuning, and automated backups\n- **Monitoring**: Docker health checks, database performance monitoring, and logging\n- **Security**: SSL enforcement, security headers, rate limiting, and firewall configuration\n\n## Development Commands\n\n### Backend Development\n```bash\n# Start services\ndocker compose up -d\n\n# Django management commands\ndocker compose exec fowldata python manage.py migrate\ndocker compose exec fowldata python manage.py createsuperuser\ndocker compose exec fowldata python manage.py shell\n\n# Run backend tests\ndocker compose exec fowldata python -m pytest\ndocker compose exec fowldata python -m pytest accounts/tests/ hunts/tests/ -v\n\n# Code formatting and linting\ndocker compose exec fowldata black .\ndocker compose exec fowldata flake8\n\n# Single test file\ndocker compose exec fowldata python -m pytest hunts/tests/test_weather_api.py -v\n```\n\n### Frontend Development\n```bash\ncd frontend\n\n# Development server (with Turbopack)\nnpm run dev\n\n# Build and type checking\nnpm run build\nnpm run lint\nnpx tsc --noEmit                # TypeScript checking without emit\n```\n\n### Testing & Validation\n\n#### Pre-Commit Validation\n```bash\n# Quick validation (run before commits)\n./testlint-quick               # Essential tests only (2-3 minutes)\n\n# Full validation (run before PRs)  \n./testlint                     # Complete validation with E2E tests (10-15 minutes)\n```\n\n#### Comprehensive Testing Commands\n```bash\n# Backend Testing\ndocker compose exec fowldata python -m pytest                    # All backend tests\ndocker compose exec fowldata python -m pytest -m \"not performance\"  # Skip slow tests\ndocker compose exec fowldata python -m pytest --cov=fowldata     # With coverage\ndocker compose exec fowldata python -m pytest -s --pdb          # Debug mode\n\n# Frontend Testing\ncd frontend\nnpm run test                           # Jest unit tests\nnpm run test -- --watchAll=false      # CI mode (run once)  \nnpm run test:e2e                      # Playwright E2E tests\nnpm run test:e2e -- --project chromium  # Specific browser\nnpm run test:e2e -- --debug           # Debug E2E tests\n\n# Specific Test Categories\ndocker compose exec fowldata python -m pytest -m \"auth\"      # Authentication tests\ndocker compose exec fowldata python -m pytest -m \"api\"       # API endpoint tests\nnpm test -- --testNamePattern=\"authentication\"               # Frontend auth tests\n```\n\n#### Test Debugging\n```bash\n# Backend Debug\ndocker compose exec fowldata python -m pytest -s --pdb hunts/tests/test_weather_api.py::test_function\ndocker compose exec fowldata python manage.py shell\n\n# Frontend Debug\nnpm run test:e2e -- --headed          # Show browser\nnpm run test:e2e -- --ui               # Playwright UI mode\nnpm test -- --no-coverage --verbose   # Detailed Jest output\n\n# E2E Test Environment Validation\n./scripts/verify-e2e-setup.sh         # Check E2E prerequisites\n```\n\n### Production Deployment\n```bash\n# Production validation and deployment\n./scripts/validate-production.sh\n\n# Production commands (ALWAYS use --env-file flag)\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production build\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production logs -f\n\n# Django production setup\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py migrate\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py createsuperuser\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py collectstatic --noinput\n```\n\n## Core Data Models\n\n**Hunt Model** (`hunts/models.py`):\n- Tracks hunting sessions with date, location (PostGIS Point), weather conditions\n- Links to multiple Bird harvests and HuntPhoto uploads\n- Weather data automatically fetched from external API based on coordinates\n\n**Bird Model**:\n- Individual waterfowl harvests within a hunt\n- Species selection from predefined WATERFOWL_CHOICES (Dabblers, Divers, Geese)\n- Includes harvest time, notes, and gender (Drake/Hen)\n\n**Authentication Integration**:\n- Django backend uses custom NextAuthBackend for JWT token validation\n- Frontend NextAuth.js providers: Google, Facebook, Credentials\n- Token synchronization between NextAuth and Django API client\n\n## Key Integration Points\n\n**Django-NextAuth Authentication Flow**:\n- NextAuth JWT tokens validated by Django via `accounts/nextauth_backend.py`  \n- API requests include NextAuth JWT in Authorization header\n- User creation/sync handled by Django signals in `accounts/signals.py`\n\n**Photo Upload System**:\n- S3 presigned URLs generated by Django `hunts/s3_manager.py`\n- Frontend uploads directly to S3, then registers with Django\n- HuntPhoto model tracks S3 URLs linked to Hunt instances\n\n**Geospatial Features**:\n- Hunt locations stored as PostGIS Points with lat/lng coordinates\n- Weather API integration fetches conditions based on hunt coordinates\n- Mapbox integration for location selection and visualization\n\n## Environment Configuration\n\n### Critical Environment Variables (MUST MATCH)\n**These variables must be identical in both backend and frontend:**\n```bash\n# Authentication (CRITICAL - must match exactly)\nAUTH_SECRET=your-nextauth-secret-key        # Both .env.local AND frontend/.env.local\n\n# Docker Network (CRITICAL - use service names)  \nBACKEND_URL=http://fowldata:8000            # frontend/.env.local ONLY\n```\n\n### Required Environment Files\n```bash\n# Development\n.env.local                  # Backend: Django database, secrets, S3 credentials  \nfrontend/.env.local         # Frontend: NextAuth secrets, API URLs\n\n# Production  \n.env.production            # Backend: Production settings\nfrontend/.env.production   # Frontend: Production URLs and secrets\n```\n\n### Essential Variables by Service\n```bash\n# Database (Backend .env.local)\nDB_HOST=localhost           # Development: localhost, Production: postgres\nDB_NAME=fowldata           # Database name\nDB_USER=postgres           # Database username\nDB_PASS=your_password      # No special characters in production\n\n# Authentication (Both files)\nAUTH_SECRET=your-secret    # Generate: openssl rand -base64 32\nSECRET_KEY=django-secret   # Django only\n\n# Mapbox (Frontend .env.local)\nNEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-token  # REQUIRED for layer rendering\n\n# AWS S3 (Backend .env.local)\nAWS_ACCESS_KEY_ID=your-key\nAWS_SECRET_ACCESS_KEY=your-secret  \nAWS_S3_BUCKET_NAME=bucket-name\n\n# OAuth (Frontend .env.local)\nGOOGLE_CLIENT_ID=your-google-id\nGOOGLE_CLIENT_SECRET=your-google-secret\n```\n\n### Security & Performance Best Practices\n```bash\n# Production Security Checklist\n- Use strong AUTH_SECRET (32+ characters): openssl rand -base64 32\n- Avoid special characters in passwords (no $, !, etc.) - shell interprets them\n- Always use HTTPS for OAuth callbacks in production\n- Set proper CORS origins: CORS_ALLOWED_ORIGINS=https://yourdomain.com\n\n# Performance Optimization  \n- Use Redis for caching: REDIS_HOST=redis, REDIS_PASSWORD=your-password\n- Enable SSL redirect: SECURE_SSL_REDIRECT=True (production)\n- Configure proper headers: SECURE_HSTS_SECONDS=31536000\n\n# Environment File Best Practices\n- Use UTF-8 encoding without BOM\n- No spaces around = signs: VAR=value (not VAR = value)\n- Always backup production environment files\n```\n\n## Testing Patterns\n\n**Backend Tests** (pytest-django):\n- Database tests marked with `@pytest.mark.django_db`\n- API endpoint tests use Django's APIClient  \n- External services (S3, weather API) are mocked\n- Fixtures in `conftest.py` create test users and hunt data\n\n**Frontend Tests**:\n- Unit tests: Jest + React Testing Library in `src/__tests__/`\n- Component tests focus on user interactions, not implementation\n- E2E tests: Playwright in `e2e/` directory with real browser automation\n- API mocking for isolated component testing\n\n## Mapbox Configuration\n\n- Import controls from `react-map-gl/mapbox` for Mapbox GL JS v3.5+\n- Control positioning critical - use `position` prop, not `style` object\n- Standard controls must be children of `<Map>` component\n- Custom controls positioned absolutely outside `<Map>`\n- Test controls in both browser and fullscreen modes\n\n## Development Workflow\n\n### Branch Strategy & Process\n```bash\n# Create feature branch\ngit checkout -b feature/descriptive-name\ngit push -u origin feature/descriptive-name\n\n# Development cycle\n# 1. Make changes\n# 2. Test locally: ./testlint-quick\n# 3. Commit: git commit -m \"feat: description\"  \n# 4. Before PR: ./testlint\n# 5. Create PR: gh pr create --title \"Title\" --body \"Description\"\n\n# Commit Message Format\nfeat: Add hunt sharing functionality\nfix: Resolve photo upload timeout issue  \ndocs: Update API documentation\ntest: Add weather API integration tests\nrefactor: Simplify authentication middleware\n```\n\n### Development Best Practices\n- **Container Rebuilds**: Rebuild Docker containers after backend changes to see frontend updates\n- **Test Credentials**: Use `mark@mail.com` / `1@Tsgstp` for E2E tests\n- **Pre-commit**: Always run `./testlint-quick` before commits\n- **Pre-PR**: Always run `./testlint` before creating pull requests  \n- **API Mocking**: Weather API responses should be mocked in tests for consistency\n\n## Troubleshooting Guide\n\n### Authentication Issues\n```bash\n# Primary diagnostic tool\nnode auth-health-check.js                    # Comprehensive auth system check\n\n# Specific auth problems\ndocker compose logs fowldata | grep -i auth  # Backend auth errors\ndocker compose logs fowldata | grep -i jwt   # JWT token issues\ndocker compose exec fowldata python manage.py shell  # Manual user inspection\n\n# Common auth fixes\n# 1. Verify AUTH_SECRET matches in both .env files\n# 2. Check BACKEND_URL uses fowldata:8000 (not localhost)\n# 3. Clear browser cookies and retry\n# 4. Restart both containers: docker compose restart fowldata frontend\n```\n\n### Database & Migration Issues  \n```bash\n# Database diagnostic\ndocker compose exec fowldata python manage.py check\ndocker compose exec fowldata python manage.py dbshell\ndocker compose exec postgres psql -U postgres -d fowldata\n\n# Reset database (development only)\ndocker compose down -v                       # Destroy volumes\ndocker compose up -d                         # Recreate services\ndocker compose exec fowldata python manage.py migrate\n\n# Migration problems\ndocker compose exec fowldata python manage.py showmigrations  # Show status\ndocker compose exec fowldata python manage.py migrate --fake  # Mark as applied\n```\n\n### Frontend Build & Runtime Issues\n```bash\n# Build diagnostics\ncd frontend\nnpm run build                                # Check for build errors\nnpm run lint                                # TypeScript/ESLint issues\nrm -rf .next node_modules && npm install    # Clean reinstall\n\n# Runtime debugging\nnpm run dev                                  # Development server logs\ndocker compose logs frontend                # Container logs\n```\n\n### E2E Test Failures\n```bash\n# E2E test diagnostics\n./scripts/verify-e2e-setup.sh              # Check prerequisites\nnpm run test:e2e -- --headed               # Visual debugging  \nnpm run test:e2e -- --debug                # Step-by-step debugging\n\n# Common E2E fixes\n# 1. Ensure test user exists: mark@mail.com / 1@Tsgstp\n# 2. Check services are running: docker compose ps\n# 3. Verify ports: curl http://localhost:3000 && curl http://localhost:8000/api/\n# 4. Clear browser state: rm -rf test-results/\n```\n\n### Performance & Resource Issues\n```bash\n# System resource monitoring\ndocker stats                               # Container resource usage\ndocker system df                          # Disk space usage\ndocker system prune -f                    # Clean unused resources\n\n# Database performance\ndocker compose exec fowldata python manage.py dbshell\n# Then: EXPLAIN ANALYZE SELECT * FROM hunts_hunt WHERE location IS NOT NULL;\n\n# Memory issues\ndocker compose down && docker compose up -d  # Restart all services\n```\n\n### Production Deployment Issues\n```bash\n# Production diagnostics\n./scripts/validate-production.sh           # Pre-deployment validation\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production config  # Validate config\n\n# SSL/TLS issues  \nopenssl x509 -in ssl/fullchain.pem -text -noout  # Check certificate\nsudo certbot renew --dry-run               # Test renewal process\n\n# Environment variable issues\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata env | grep DB_\n```\n\n### Emergency Recovery\n```bash\n# Quick service restart\ndocker compose restart fowldata frontend postgres\n\n# Full environment reset (DESTRUCTIVE - development only)\ndocker compose down -v\ndocker system prune -f  \ngit checkout -- .env.local frontend/.env.local\ndocker compose up -d\n\n# Rollback production deployment\ngit checkout previous-working-commit\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate\n```","structuredPatch":[{"oldStart":500,"oldLines":4,"newStart":500,"newLines":85,"lines":[" # Rollback production deployment"," git checkout previous-working-commit"," docker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate","+```","+","+## Database & Backup Management","+","+### Database Operations","+```bash","+# Database inspection","+docker compose exec fowldata python manage.py dbshell","+docker compose exec postgres psql -U postgres -d fowldata","+","+# Create database backup","+docker compose exec postgres pg_dump -U postgres fowldata > backup_$(date +%Y%m%d_%H%M%S).sql","+","+# Restore database backup  ","+cat backup_file.sql | docker compose exec -T postgres psql -U postgres -d fowldata","+","+# Check database size and connections","+docker compose exec postgres psql -U postgres -d fowldata -c \"\\l+ fowldata\"","+docker compose exec postgres psql -U postgres -d fowldata -c \"SELECT * FROM pg_stat_activity;\"","+```","+","+### Performance Monitoring","+```bash","+# Monitor container resources","+docker stats fowldata postgres redis frontend","+","+# Database performance analysis","+docker compose exec fowldata python manage.py shell","+# >>> from django.db import connection; print(len(connection.queries))","+","+# Check slow queries (PostgreSQL)","+docker compose exec postgres psql -U postgres -d fowldata -c \"","+SELECT query, mean_exec_time, calls ","+FROM pg_stat_statements ","+ORDER BY mean_exec_time DESC LIMIT 10;\"","+","+# Redis monitoring","+docker compose exec redis redis-cli INFO memory","+docker compose exec redis redis-cli INFO stats","+```","+","+## API Reference","+","+### Core Hunt API","+```bash","+# Hunt Management","+GET /api/hunts/                           # List user hunts (paginated)","+POST /api/hunts/                          # Create new hunt","+GET /api/hunts/{id}/                      # Get specific hunt","+PUT /api/hunts/{id}/                      # Update hunt","+DELETE /api/hunts/{id}/                   # Delete hunt","+","+# Hunt Search & Filtering  ","+GET /api/hunts/?date_after=2024-01-01     # Filter by date","+GET /api/hunts/?location=lat,lng,radius   # Geospatial search","+GET /api/hunts/?species=mallard           # Filter by species","+```","+","+### Photo & Media API","+```bash","+# Photo Management","+GET /api/hunts/{hunt_id}/photos/          # List hunt photos","+POST /api/hunts/{hunt_id}/photos/         # Upload photo","+DELETE /api/photos/{photo_id}/            # Delete photo","+","+# S3 Upload Workflow","+POST /api/photos/presigned-url/           # Get presigned upload URL","+# â†’ Upload directly to S3 using presigned URL","+POST /api/photos/confirm-upload/          # Confirm S3 upload success","+```","+","+### User & Authentication API","+```bash","+# User Management","+GET /api/users/me/                        # Current user profile","+PUT /api/users/me/                        # Update user profile  ","+POST /api/auth/sync/                      # Sync NextAuth user data","+","+# System Health","+GET /api/health/                          # Backend health check","+GET /health.json                          # Frontend health check (static)"," ```","\\ No newline at end of file"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"fc9d73e3-824d-4cf7-9781-3ba20186f49a","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01U9ezEvJnzSBAvgW8fqF7GV","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01FTLzGw7HYAkzSM5ZFP4NBC","name":"TodoWrite","input":{"todos":[{"content":"Analyze current CLAUDE.md structure and identify integration points","status":"completed","activeForm":"Analyzing current CLAUDE.md structure and identifying integration points"},{"content":"Enhance testing section with comprehensive commands","status":"completed","activeForm":"Enhancing testing section with comprehensive commands"},{"content":"Add security and performance best practices","status":"completed","activeForm":"Adding security and performance best practices"},{"content":"Expand troubleshooting section with consolidated patterns","status":"completed","activeForm":"Expanding troubleshooting section with consolidated patterns"},{"content":"Add development workflow improvements","status":"completed","activeForm":"Adding development workflow improvements"},{"content":"Include API reference and environment variables priority","status":"completed","activeForm":"Including API reference and environment variables priority"},{"content":"Review for redundancy and conflicts","status":"in_progress","activeForm":"Reviewing for redundancy and conflicts"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":2030,"cache_read_input_tokens":84706,"cache_creation":{"ephemeral_5m_input_tokens":2030,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"}},"requestId":"req_011CSTpT6vWD4UCA9SF2UR5y","type":"assistant","uuid":"3c36d2ec-31bc-4dfe-a49a-00b9a5a8d004","timestamp":"2025-08-25T04:45:12.028Z"}
{"parentUuid":"3c36d2ec-31bc-4dfe-a49a-00b9a5a8d004","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FTLzGw7HYAkzSM5ZFP4NBC","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"5eabe7dc-7461-4e74-80f3-0d52aba8f910","timestamp":"2025-08-25T04:45:12.099Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Analyze current CLAUDE.md structure and identify integration points","status":"completed","activeForm":"Analyzing current CLAUDE.md structure and identifying integration points"},{"content":"Enhance testing section with comprehensive commands","status":"completed","activeForm":"Enhancing testing section with comprehensive commands"},{"content":"Add security and performance best practices","status":"completed","activeForm":"Adding security and performance best practices"},{"content":"Expand troubleshooting section with consolidated patterns","status":"completed","activeForm":"Expanding troubleshooting section with consolidated patterns"},{"content":"Add development workflow improvements","status":"completed","activeForm":"Adding development workflow improvements"},{"content":"Include API reference and environment variables priority","status":"completed","activeForm":"Including API reference and environment variables priority"},{"content":"Review for redundancy and conflicts","status":"in_progress","activeForm":"Reviewing for redundancy and conflicts"}]}}
{"parentUuid":"5eabe7dc-7461-4e74-80f3-0d52aba8f910","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01Amor4hS7jxWbwrboq7QupB","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"Now let me do a final review to remove any redundant or conflicting information and ensure consistency:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":328,"cache_read_input_tokens":86736,"cache_creation":{"ephemeral_5m_input_tokens":328,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CSTpTTNpG341Chz72gEGG","type":"assistant","uuid":"c5633fab-3bb5-4ae7-b70b-6c88de5d4702","timestamp":"2025-08-25T04:45:15.554Z"}
{"parentUuid":"c5633fab-3bb5-4ae7-b70b-6c88de5d4702","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01Amor4hS7jxWbwrboq7QupB","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01DDC8GynBuFSgakqoga7SSs","name":"Read","input":{"file_path":"/Users/markelmore/_code/fowldata/CLAUDE.md","limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":328,"cache_read_input_tokens":86736,"cache_creation":{"ephemeral_5m_input_tokens":328,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CSTpTTNpG341Chz72gEGG","type":"assistant","uuid":"1960ae8e-d4e4-4f5c-9dbd-73ca108481fa","timestamp":"2025-08-25T04:45:16.030Z"}
{"parentUuid":"1960ae8e-d4e4-4f5c-9dbd-73ca108481fa","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DDC8GynBuFSgakqoga7SSs","type":"tool_result","content":"     1â†’# CLAUDE.md\n     2â†’\n     3â†’This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n     4â†’\n     5â†’## ğŸ¯ Quick Reference\n     6â†’\n     7â†’### Critical Commands\n     8â†’```bash\n     9â†’# Essential Development\n    10â†’docker compose up -d && cd frontend && npm run dev  # Start full stack\n    11â†’./testlint-quick           # Quick validation before commits\n    12â†’./testlint                 # Full validation before PRs\n    13â†’\n    14â†’# Production Deployment\n    15â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n    16â†’\n    17â†’# Emergency Troubleshooting\n    18â†’node auth-health-check.js  # Authentication issues\n    19â†’./scripts/verify-e2e-setup.sh  # E2E test setup validation\n    20â†’```\n    21â†’\n    22â†’### Key API Endpoints\n    23â†’```bash\n    24â†’GET /api/hunts/            # List user hunts\n    25â†’POST /api/hunts/           # Create hunt\n    26â†’GET /api/users/me/         # Current user info  \n    27â†’POST /api/auth/sync/       # User synchronization\n    28â†’GET /api/health/           # Backend health check\n    29â†’```\n    30â†’\n    31â†’## âš ï¸ CRITICAL: Docker Network Configuration - NEVER CHANGE\n    32â†’**RECURRING ISSUE - ALWAYS CHECK THIS FIRST**\n    33â†’\n    34â†’The frontend `.env.local` file MUST use the Docker service name for backend communication:\n    35â†’```bash\n    36â†’# CORRECT - Use Docker service name (this is in frontend/.env.local)\n    37â†’BACKEND_URL=http://fowldata:8000\n    38â†’\n    39â†’# WRONG - Will cause ECONNREFUSED errors in Docker containers\n    40â†’BACKEND_URL=http://localhost:8000\n    41â†’```\n    42â†’\n    43â†’**Why**: Inside Docker containers, `localhost` refers to the container itself, not the host. Service names resolve to container IPs within the Docker network.\n    44â†’\n    45â†’**Symptoms**: NextAuth authentication fails, API calls fail with \"connect ECONNREFUSED ::1:8000\"\n    46â†’\n    47â†’**Fix**: Always use `fowldata:8000` (service name from docker-compose.yml) for inter-container communication.\n    48â†’\n    49â†’## âš ï¸ CRITICAL: Mapbox GL JS v3+ with react-map-gl v8 Layer Rendering\n    50â†’**RECURRING ISSUE - ESSENTIAL FOR LAYER VISIBILITY**\n\n<system-reminder>\nWhenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"3b62659c-ae10-4738-9f0b-c99731f1b1bc","timestamp":"2025-08-25T04:45:16.083Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/markelmore/_code/fowldata/CLAUDE.md","content":"# CLAUDE.md\n\nThis file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n\n## ğŸ¯ Quick Reference\n\n### Critical Commands\n```bash\n# Essential Development\ndocker compose up -d && cd frontend && npm run dev  # Start full stack\n./testlint-quick           # Quick validation before commits\n./testlint                 # Full validation before PRs\n\n# Production Deployment\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# Emergency Troubleshooting\nnode auth-health-check.js  # Authentication issues\n./scripts/verify-e2e-setup.sh  # E2E test setup validation\n```\n\n### Key API Endpoints\n```bash\nGET /api/hunts/            # List user hunts\nPOST /api/hunts/           # Create hunt\nGET /api/users/me/         # Current user info  \nPOST /api/auth/sync/       # User synchronization\nGET /api/health/           # Backend health check\n```\n\n## âš ï¸ CRITICAL: Docker Network Configuration - NEVER CHANGE\n**RECURRING ISSUE - ALWAYS CHECK THIS FIRST**\n\nThe frontend `.env.local` file MUST use the Docker service name for backend communication:\n```bash\n# CORRECT - Use Docker service name (this is in frontend/.env.local)\nBACKEND_URL=http://fowldata:8000\n\n# WRONG - Will cause ECONNREFUSED errors in Docker containers\nBACKEND_URL=http://localhost:8000\n```\n\n**Why**: Inside Docker containers, `localhost` refers to the container itself, not the host. Service names resolve to container IPs within the Docker network.\n\n**Symptoms**: NextAuth authentication fails, API calls fail with \"connect ECONNREFUSED ::1:8000\"\n\n**Fix**: Always use `fowldata:8000` (service name from docker-compose.yml) for inter-container communication.\n\n## âš ï¸ CRITICAL: Mapbox GL JS v3+ with react-map-gl v8 Layer Rendering\n**RECURRING ISSUE - ESSENTIAL FOR LAYER VISIBILITY**","numLines":50,"startLine":1,"totalLines":584}}}
{"parentUuid":"3b62659c-ae10-4738-9f0b-c99731f1b1bc","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01Hjt1WeEUaBxHWsrvdwpd5X","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"Let me check the end of the file to see if there are any remaining redundant sections:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":847,"cache_read_input_tokens":87064,"cache_creation":{"ephemeral_5m_input_tokens":847,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTpTjszYboRfKLpBLQHH","type":"assistant","uuid":"47edb70e-c3ed-45b5-a74b-8e8d8403ab39","timestamp":"2025-08-25T04:45:18.811Z"}
{"parentUuid":"47edb70e-c3ed-45b5-a74b-8e8d8403ab39","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01Hjt1WeEUaBxHWsrvdwpd5X","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01HAhriuo5kPGogReQF6u3jB","name":"Read","input":{"file_path":"/Users/markelmore/_code/fowldata/CLAUDE.md","offset":350}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":847,"cache_read_input_tokens":87064,"cache_creation":{"ephemeral_5m_input_tokens":847,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTpTjszYboRfKLpBLQHH","type":"assistant","uuid":"71177b8e-a7e1-49b2-8daa-c92f66530530","timestamp":"2025-08-25T04:45:19.336Z"}
{"parentUuid":"71177b8e-a7e1-49b2-8daa-c92f66530530","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HAhriuo5kPGogReQF6u3jB","type":"tool_result","content":"   350â†’- External services (S3, weather API) are mocked\n   351â†’- Fixtures in `conftest.py` create test users and hunt data\n   352â†’\n   353â†’**Frontend Tests**:\n   354â†’- Unit tests: Jest + React Testing Library in `src/__tests__/`\n   355â†’- Component tests focus on user interactions, not implementation\n   356â†’- E2E tests: Playwright in `e2e/` directory with real browser automation\n   357â†’- API mocking for isolated component testing\n   358â†’\n   359â†’## Mapbox Configuration\n   360â†’\n   361â†’- Import controls from `react-map-gl/mapbox` for Mapbox GL JS v3.5+\n   362â†’- Control positioning critical - use `position` prop, not `style` object\n   363â†’- Standard controls must be children of `<Map>` component\n   364â†’- Custom controls positioned absolutely outside `<Map>`\n   365â†’- Test controls in both browser and fullscreen modes\n   366â†’\n   367â†’## Development Workflow\n   368â†’\n   369â†’### Branch Strategy & Process\n   370â†’```bash\n   371â†’# Create feature branch\n   372â†’git checkout -b feature/descriptive-name\n   373â†’git push -u origin feature/descriptive-name\n   374â†’\n   375â†’# Development cycle\n   376â†’# 1. Make changes\n   377â†’# 2. Test locally: ./testlint-quick\n   378â†’# 3. Commit: git commit -m \"feat: description\"  \n   379â†’# 4. Before PR: ./testlint\n   380â†’# 5. Create PR: gh pr create --title \"Title\" --body \"Description\"\n   381â†’\n   382â†’# Commit Message Format\n   383â†’feat: Add hunt sharing functionality\n   384â†’fix: Resolve photo upload timeout issue  \n   385â†’docs: Update API documentation\n   386â†’test: Add weather API integration tests\n   387â†’refactor: Simplify authentication middleware\n   388â†’```\n   389â†’\n   390â†’### Development Best Practices\n   391â†’- **Container Rebuilds**: Rebuild Docker containers after backend changes to see frontend updates\n   392â†’- **Test Credentials**: Use `mark@mail.com` / `1@Tsgstp` for E2E tests\n   393â†’- **Pre-commit**: Always run `./testlint-quick` before commits\n   394â†’- **Pre-PR**: Always run `./testlint` before creating pull requests  \n   395â†’- **API Mocking**: Weather API responses should be mocked in tests for consistency\n   396â†’\n   397â†’## Troubleshooting Guide\n   398â†’\n   399â†’### Authentication Issues\n   400â†’```bash\n   401â†’# Primary diagnostic tool\n   402â†’node auth-health-check.js                    # Comprehensive auth system check\n   403â†’\n   404â†’# Specific auth problems\n   405â†’docker compose logs fowldata | grep -i auth  # Backend auth errors\n   406â†’docker compose logs fowldata | grep -i jwt   # JWT token issues\n   407â†’docker compose exec fowldata python manage.py shell  # Manual user inspection\n   408â†’\n   409â†’# Common auth fixes\n   410â†’# 1. Verify AUTH_SECRET matches in both .env files\n   411â†’# 2. Check BACKEND_URL uses fowldata:8000 (not localhost)\n   412â†’# 3. Clear browser cookies and retry\n   413â†’# 4. Restart both containers: docker compose restart fowldata frontend\n   414â†’```\n   415â†’\n   416â†’### Database & Migration Issues  \n   417â†’```bash\n   418â†’# Database diagnostic\n   419â†’docker compose exec fowldata python manage.py check\n   420â†’docker compose exec fowldata python manage.py dbshell\n   421â†’docker compose exec postgres psql -U postgres -d fowldata\n   422â†’\n   423â†’# Reset database (development only)\n   424â†’docker compose down -v                       # Destroy volumes\n   425â†’docker compose up -d                         # Recreate services\n   426â†’docker compose exec fowldata python manage.py migrate\n   427â†’\n   428â†’# Migration problems\n   429â†’docker compose exec fowldata python manage.py showmigrations  # Show status\n   430â†’docker compose exec fowldata python manage.py migrate --fake  # Mark as applied\n   431â†’```\n   432â†’\n   433â†’### Frontend Build & Runtime Issues\n   434â†’```bash\n   435â†’# Build diagnostics\n   436â†’cd frontend\n   437â†’npm run build                                # Check for build errors\n   438â†’npm run lint                                # TypeScript/ESLint issues\n   439â†’rm -rf .next node_modules && npm install    # Clean reinstall\n   440â†’\n   441â†’# Runtime debugging\n   442â†’npm run dev                                  # Development server logs\n   443â†’docker compose logs frontend                # Container logs\n   444â†’```\n   445â†’\n   446â†’### E2E Test Failures\n   447â†’```bash\n   448â†’# E2E test diagnostics\n   449â†’./scripts/verify-e2e-setup.sh              # Check prerequisites\n   450â†’npm run test:e2e -- --headed               # Visual debugging  \n   451â†’npm run test:e2e -- --debug                # Step-by-step debugging\n   452â†’\n   453â†’# Common E2E fixes\n   454â†’# 1. Ensure test user exists: mark@mail.com / 1@Tsgstp\n   455â†’# 2. Check services are running: docker compose ps\n   456â†’# 3. Verify ports: curl http://localhost:3000 && curl http://localhost:8000/api/\n   457â†’# 4. Clear browser state: rm -rf test-results/\n   458â†’```\n   459â†’\n   460â†’### Performance & Resource Issues\n   461â†’```bash\n   462â†’# System resource monitoring\n   463â†’docker stats                               # Container resource usage\n   464â†’docker system df                          # Disk space usage\n   465â†’docker system prune -f                    # Clean unused resources\n   466â†’\n   467â†’# Database performance\n   468â†’docker compose exec fowldata python manage.py dbshell\n   469â†’# Then: EXPLAIN ANALYZE SELECT * FROM hunts_hunt WHERE location IS NOT NULL;\n   470â†’\n   471â†’# Memory issues\n   472â†’docker compose down && docker compose up -d  # Restart all services\n   473â†’```\n   474â†’\n   475â†’### Production Deployment Issues\n   476â†’```bash\n   477â†’# Production diagnostics\n   478â†’./scripts/validate-production.sh           # Pre-deployment validation\n   479â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production config  # Validate config\n   480â†’\n   481â†’# SSL/TLS issues  \n   482â†’openssl x509 -in ssl/fullchain.pem -text -noout  # Check certificate\n   483â†’sudo certbot renew --dry-run               # Test renewal process\n   484â†’\n   485â†’# Environment variable issues\n   486â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata env | grep DB_\n   487â†’```\n   488â†’\n   489â†’### Emergency Recovery\n   490â†’```bash\n   491â†’# Quick service restart\n   492â†’docker compose restart fowldata frontend postgres\n   493â†’\n   494â†’# Full environment reset (DESTRUCTIVE - development only)\n   495â†’docker compose down -v\n   496â†’docker system prune -f  \n   497â†’git checkout -- .env.local frontend/.env.local\n   498â†’docker compose up -d\n   499â†’\n   500â†’# Rollback production deployment\n   501â†’git checkout previous-working-commit\n   502â†’docker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate\n   503â†’```\n   504â†’\n   505â†’## Database & Backup Management\n   506â†’\n   507â†’### Database Operations\n   508â†’```bash\n   509â†’# Database inspection\n   510â†’docker compose exec fowldata python manage.py dbshell\n   511â†’docker compose exec postgres psql -U postgres -d fowldata\n   512â†’\n   513â†’# Create database backup\n   514â†’docker compose exec postgres pg_dump -U postgres fowldata > backup_$(date +%Y%m%d_%H%M%S).sql\n   515â†’\n   516â†’# Restore database backup  \n   517â†’cat backup_file.sql | docker compose exec -T postgres psql -U postgres -d fowldata\n   518â†’\n   519â†’# Check database size and connections\n   520â†’docker compose exec postgres psql -U postgres -d fowldata -c \"\\l+ fowldata\"\n   521â†’docker compose exec postgres psql -U postgres -d fowldata -c \"SELECT * FROM pg_stat_activity;\"\n   522â†’```\n   523â†’\n   524â†’### Performance Monitoring\n   525â†’```bash\n   526â†’# Monitor container resources\n   527â†’docker stats fowldata postgres redis frontend\n   528â†’\n   529â†’# Database performance analysis\n   530â†’docker compose exec fowldata python manage.py shell\n   531â†’# >>> from django.db import connection; print(len(connection.queries))\n   532â†’\n   533â†’# Check slow queries (PostgreSQL)\n   534â†’docker compose exec postgres psql -U postgres -d fowldata -c \"\n   535â†’SELECT query, mean_exec_time, calls \n   536â†’FROM pg_stat_statements \n   537â†’ORDER BY mean_exec_time DESC LIMIT 10;\"\n   538â†’\n   539â†’# Redis monitoring\n   540â†’docker compose exec redis redis-cli INFO memory\n   541â†’docker compose exec redis redis-cli INFO stats\n   542â†’```\n   543â†’\n   544â†’## API Reference\n   545â†’\n   546â†’### Core Hunt API\n   547â†’```bash\n   548â†’# Hunt Management\n   549â†’GET /api/hunts/                           # List user hunts (paginated)\n   550â†’POST /api/hunts/                          # Create new hunt\n   551â†’GET /api/hunts/{id}/                      # Get specific hunt\n   552â†’PUT /api/hunts/{id}/                      # Update hunt\n   553â†’DELETE /api/hunts/{id}/                   # Delete hunt\n   554â†’\n   555â†’# Hunt Search & Filtering  \n   556â†’GET /api/hunts/?date_after=2024-01-01     # Filter by date\n   557â†’GET /api/hunts/?location=lat,lng,radius   # Geospatial search\n   558â†’GET /api/hunts/?species=mallard           # Filter by species\n   559â†’```\n   560â†’\n   561â†’### Photo & Media API\n   562â†’```bash\n   563â†’# Photo Management\n   564â†’GET /api/hunts/{hunt_id}/photos/          # List hunt photos\n   565â†’POST /api/hunts/{hunt_id}/photos/         # Upload photo\n   566â†’DELETE /api/photos/{photo_id}/            # Delete photo\n   567â†’\n   568â†’# S3 Upload Workflow\n   569â†’POST /api/photos/presigned-url/           # Get presigned upload URL\n   570â†’# â†’ Upload directly to S3 using presigned URL\n   571â†’POST /api/photos/confirm-upload/          # Confirm S3 upload success\n   572â†’```\n   573â†’\n   574â†’### User & Authentication API\n   575â†’```bash\n   576â†’# User Management\n   577â†’GET /api/users/me/                        # Current user profile\n   578â†’PUT /api/users/me/                        # Update user profile  \n   579â†’POST /api/auth/sync/                      # Sync NextAuth user data\n   580â†’\n   581â†’# System Health\n   582â†’GET /api/health/                          # Backend health check\n   583â†’GET /health.json                          # Frontend health check (static)\n   584â†’```\n\n<system-reminder>\nWhenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d77400ef-6de9-4841-ac03-541973e1d6ec","timestamp":"2025-08-25T04:45:19.399Z","toolUseResult":{"type":"text","file":{"filePath":"/Users/markelmore/_code/fowldata/CLAUDE.md","content":"- External services (S3, weather API) are mocked\n- Fixtures in `conftest.py` create test users and hunt data\n\n**Frontend Tests**:\n- Unit tests: Jest + React Testing Library in `src/__tests__/`\n- Component tests focus on user interactions, not implementation\n- E2E tests: Playwright in `e2e/` directory with real browser automation\n- API mocking for isolated component testing\n\n## Mapbox Configuration\n\n- Import controls from `react-map-gl/mapbox` for Mapbox GL JS v3.5+\n- Control positioning critical - use `position` prop, not `style` object\n- Standard controls must be children of `<Map>` component\n- Custom controls positioned absolutely outside `<Map>`\n- Test controls in both browser and fullscreen modes\n\n## Development Workflow\n\n### Branch Strategy & Process\n```bash\n# Create feature branch\ngit checkout -b feature/descriptive-name\ngit push -u origin feature/descriptive-name\n\n# Development cycle\n# 1. Make changes\n# 2. Test locally: ./testlint-quick\n# 3. Commit: git commit -m \"feat: description\"  \n# 4. Before PR: ./testlint\n# 5. Create PR: gh pr create --title \"Title\" --body \"Description\"\n\n# Commit Message Format\nfeat: Add hunt sharing functionality\nfix: Resolve photo upload timeout issue  \ndocs: Update API documentation\ntest: Add weather API integration tests\nrefactor: Simplify authentication middleware\n```\n\n### Development Best Practices\n- **Container Rebuilds**: Rebuild Docker containers after backend changes to see frontend updates\n- **Test Credentials**: Use `mark@mail.com` / `1@Tsgstp` for E2E tests\n- **Pre-commit**: Always run `./testlint-quick` before commits\n- **Pre-PR**: Always run `./testlint` before creating pull requests  \n- **API Mocking**: Weather API responses should be mocked in tests for consistency\n\n## Troubleshooting Guide\n\n### Authentication Issues\n```bash\n# Primary diagnostic tool\nnode auth-health-check.js                    # Comprehensive auth system check\n\n# Specific auth problems\ndocker compose logs fowldata | grep -i auth  # Backend auth errors\ndocker compose logs fowldata | grep -i jwt   # JWT token issues\ndocker compose exec fowldata python manage.py shell  # Manual user inspection\n\n# Common auth fixes\n# 1. Verify AUTH_SECRET matches in both .env files\n# 2. Check BACKEND_URL uses fowldata:8000 (not localhost)\n# 3. Clear browser cookies and retry\n# 4. Restart both containers: docker compose restart fowldata frontend\n```\n\n### Database & Migration Issues  \n```bash\n# Database diagnostic\ndocker compose exec fowldata python manage.py check\ndocker compose exec fowldata python manage.py dbshell\ndocker compose exec postgres psql -U postgres -d fowldata\n\n# Reset database (development only)\ndocker compose down -v                       # Destroy volumes\ndocker compose up -d                         # Recreate services\ndocker compose exec fowldata python manage.py migrate\n\n# Migration problems\ndocker compose exec fowldata python manage.py showmigrations  # Show status\ndocker compose exec fowldata python manage.py migrate --fake  # Mark as applied\n```\n\n### Frontend Build & Runtime Issues\n```bash\n# Build diagnostics\ncd frontend\nnpm run build                                # Check for build errors\nnpm run lint                                # TypeScript/ESLint issues\nrm -rf .next node_modules && npm install    # Clean reinstall\n\n# Runtime debugging\nnpm run dev                                  # Development server logs\ndocker compose logs frontend                # Container logs\n```\n\n### E2E Test Failures\n```bash\n# E2E test diagnostics\n./scripts/verify-e2e-setup.sh              # Check prerequisites\nnpm run test:e2e -- --headed               # Visual debugging  \nnpm run test:e2e -- --debug                # Step-by-step debugging\n\n# Common E2E fixes\n# 1. Ensure test user exists: mark@mail.com / 1@Tsgstp\n# 2. Check services are running: docker compose ps\n# 3. Verify ports: curl http://localhost:3000 && curl http://localhost:8000/api/\n# 4. Clear browser state: rm -rf test-results/\n```\n\n### Performance & Resource Issues\n```bash\n# System resource monitoring\ndocker stats                               # Container resource usage\ndocker system df                          # Disk space usage\ndocker system prune -f                    # Clean unused resources\n\n# Database performance\ndocker compose exec fowldata python manage.py dbshell\n# Then: EXPLAIN ANALYZE SELECT * FROM hunts_hunt WHERE location IS NOT NULL;\n\n# Memory issues\ndocker compose down && docker compose up -d  # Restart all services\n```\n\n### Production Deployment Issues\n```bash\n# Production diagnostics\n./scripts/validate-production.sh           # Pre-deployment validation\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production config  # Validate config\n\n# SSL/TLS issues  \nopenssl x509 -in ssl/fullchain.pem -text -noout  # Check certificate\nsudo certbot renew --dry-run               # Test renewal process\n\n# Environment variable issues\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata env | grep DB_\n```\n\n### Emergency Recovery\n```bash\n# Quick service restart\ndocker compose restart fowldata frontend postgres\n\n# Full environment reset (DESTRUCTIVE - development only)\ndocker compose down -v\ndocker system prune -f  \ngit checkout -- .env.local frontend/.env.local\ndocker compose up -d\n\n# Rollback production deployment\ngit checkout previous-working-commit\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate\n```\n\n## Database & Backup Management\n\n### Database Operations\n```bash\n# Database inspection\ndocker compose exec fowldata python manage.py dbshell\ndocker compose exec postgres psql -U postgres -d fowldata\n\n# Create database backup\ndocker compose exec postgres pg_dump -U postgres fowldata > backup_$(date +%Y%m%d_%H%M%S).sql\n\n# Restore database backup  \ncat backup_file.sql | docker compose exec -T postgres psql -U postgres -d fowldata\n\n# Check database size and connections\ndocker compose exec postgres psql -U postgres -d fowldata -c \"\\l+ fowldata\"\ndocker compose exec postgres psql -U postgres -d fowldata -c \"SELECT * FROM pg_stat_activity;\"\n```\n\n### Performance Monitoring\n```bash\n# Monitor container resources\ndocker stats fowldata postgres redis frontend\n\n# Database performance analysis\ndocker compose exec fowldata python manage.py shell\n# >>> from django.db import connection; print(len(connection.queries))\n\n# Check slow queries (PostgreSQL)\ndocker compose exec postgres psql -U postgres -d fowldata -c \"\nSELECT query, mean_exec_time, calls \nFROM pg_stat_statements \nORDER BY mean_exec_time DESC LIMIT 10;\"\n\n# Redis monitoring\ndocker compose exec redis redis-cli INFO memory\ndocker compose exec redis redis-cli INFO stats\n```\n\n## API Reference\n\n### Core Hunt API\n```bash\n# Hunt Management\nGET /api/hunts/                           # List user hunts (paginated)\nPOST /api/hunts/                          # Create new hunt\nGET /api/hunts/{id}/                      # Get specific hunt\nPUT /api/hunts/{id}/                      # Update hunt\nDELETE /api/hunts/{id}/                   # Delete hunt\n\n# Hunt Search & Filtering  \nGET /api/hunts/?date_after=2024-01-01     # Filter by date\nGET /api/hunts/?location=lat,lng,radius   # Geospatial search\nGET /api/hunts/?species=mallard           # Filter by species\n```\n\n### Photo & Media API\n```bash\n# Photo Management\nGET /api/hunts/{hunt_id}/photos/          # List hunt photos\nPOST /api/hunts/{hunt_id}/photos/         # Upload photo\nDELETE /api/photos/{photo_id}/            # Delete photo\n\n# S3 Upload Workflow\nPOST /api/photos/presigned-url/           # Get presigned upload URL\n# â†’ Upload directly to S3 using presigned URL\nPOST /api/photos/confirm-upload/          # Confirm S3 upload success\n```\n\n### User & Authentication API\n```bash\n# User Management\nGET /api/users/me/                        # Current user profile\nPUT /api/users/me/                        # Update user profile  \nPOST /api/auth/sync/                      # Sync NextAuth user data\n\n# System Health\nGET /api/health/                          # Backend health check\nGET /health.json                          # Frontend health check (static)\n```","numLines":235,"startLine":350,"totalLines":584}}}
{"parentUuid":"d77400ef-6de9-4841-ac03-541973e1d6ec","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01FwNCx4qWVSYhrLwquukjGq","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"I notice there's some redundancy in database commands between the troubleshooting section and the new database management section. Let me clean this up:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":3022,"cache_read_input_tokens":87911,"cache_creation":{"ephemeral_5m_input_tokens":3022,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTpTz14T8eTEEyRfR4ka","type":"assistant","uuid":"34a8634f-93c5-4ebb-8adb-60180216e2f8","timestamp":"2025-08-25T04:45:23.475Z"}
{"parentUuid":"34a8634f-93c5-4ebb-8adb-60180216e2f8","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01FwNCx4qWVSYhrLwquukjGq","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_017AJbALJCTcHntCWnFrmy7E","name":"Edit","input":{"file_path":"/Users/markelmore/_code/fowldata/CLAUDE.md","old_string":"### Database & Migration Issues  \n```bash\n# Database diagnostic\ndocker compose exec fowldata python manage.py check\ndocker compose exec fowldata python manage.py dbshell\ndocker compose exec postgres psql -U postgres -d fowldata\n\n# Reset database (development only)\ndocker compose down -v                       # Destroy volumes\ndocker compose up -d                         # Recreate services\ndocker compose exec fowldata python manage.py migrate\n\n# Migration problems\ndocker compose exec fowldata python manage.py showmigrations  # Show status\ndocker compose exec fowldata python manage.py migrate --fake  # Mark as applied\n```","new_string":"### Database & Migration Issues  \n```bash\n# Database diagnostic\ndocker compose exec fowldata python manage.py check\ndocker compose exec fowldata python manage.py showmigrations  # Show status\n\n# Reset database (development only)\ndocker compose down -v                       # Destroy volumes\ndocker compose up -d                         # Recreate services\ndocker compose exec fowldata python manage.py migrate\n\n# Migration problems\ndocker compose exec fowldata python manage.py migrate --fake  # Mark as applied\n```"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":3022,"cache_read_input_tokens":87911,"cache_creation":{"ephemeral_5m_input_tokens":3022,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CSTpTz14T8eTEEyRfR4ka","type":"assistant","uuid":"6522fa1e-e48c-4c68-b104-8d1eefece902","timestamp":"2025-08-25T04:45:26.131Z"}
{"parentUuid":"6522fa1e-e48c-4c68-b104-8d1eefece902","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017AJbALJCTcHntCWnFrmy7E","type":"tool_result","content":"The file /Users/markelmore/_code/fowldata/CLAUDE.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   412â†’# 3. Clear browser cookies and retry\n   413â†’# 4. Restart both containers: docker compose restart fowldata frontend\n   414â†’```\n   415â†’\n   416â†’### Database & Migration Issues  \n   417â†’```bash\n   418â†’# Database diagnostic\n   419â†’docker compose exec fowldata python manage.py check\n   420â†’docker compose exec fowldata python manage.py showmigrations  # Show status\n   421â†’\n   422â†’# Reset database (development only)\n   423â†’docker compose down -v                       # Destroy volumes\n   424â†’docker compose up -d                         # Recreate services\n   425â†’docker compose exec fowldata python manage.py migrate\n   426â†’\n   427â†’# Migration problems\n   428â†’docker compose exec fowldata python manage.py migrate --fake  # Mark as applied\n   429â†’```\n   430â†’\n   431â†’### Frontend Build & Runtime Issues\n   432â†’```bash\n   433â†’# Build diagnostics"}]},"uuid":"cde82e44-bd3a-4b7a-ba9c-cc9f24ba5f82","timestamp":"2025-08-25T04:45:26.184Z","toolUseResult":{"filePath":"/Users/markelmore/_code/fowldata/CLAUDE.md","oldString":"### Database & Migration Issues  \n```bash\n# Database diagnostic\ndocker compose exec fowldata python manage.py check\ndocker compose exec fowldata python manage.py dbshell\ndocker compose exec postgres psql -U postgres -d fowldata\n\n# Reset database (development only)\ndocker compose down -v                       # Destroy volumes\ndocker compose up -d                         # Recreate services\ndocker compose exec fowldata python manage.py migrate\n\n# Migration problems\ndocker compose exec fowldata python manage.py showmigrations  # Show status\ndocker compose exec fowldata python manage.py migrate --fake  # Mark as applied\n```","newString":"### Database & Migration Issues  \n```bash\n# Database diagnostic\ndocker compose exec fowldata python manage.py check\ndocker compose exec fowldata python manage.py showmigrations  # Show status\n\n# Reset database (development only)\ndocker compose down -v                       # Destroy volumes\ndocker compose up -d                         # Recreate services\ndocker compose exec fowldata python manage.py migrate\n\n# Migration problems\ndocker compose exec fowldata python manage.py migrate --fake  # Mark as applied\n```","originalFile":"# CLAUDE.md\n\nThis file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n\n## ğŸ¯ Quick Reference\n\n### Critical Commands\n```bash\n# Essential Development\ndocker compose up -d && cd frontend && npm run dev  # Start full stack\n./testlint-quick           # Quick validation before commits\n./testlint                 # Full validation before PRs\n\n# Production Deployment\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# Emergency Troubleshooting\nnode auth-health-check.js  # Authentication issues\n./scripts/verify-e2e-setup.sh  # E2E test setup validation\n```\n\n### Key API Endpoints\n```bash\nGET /api/hunts/            # List user hunts\nPOST /api/hunts/           # Create hunt\nGET /api/users/me/         # Current user info  \nPOST /api/auth/sync/       # User synchronization\nGET /api/health/           # Backend health check\n```\n\n## âš ï¸ CRITICAL: Docker Network Configuration - NEVER CHANGE\n**RECURRING ISSUE - ALWAYS CHECK THIS FIRST**\n\nThe frontend `.env.local` file MUST use the Docker service name for backend communication:\n```bash\n# CORRECT - Use Docker service name (this is in frontend/.env.local)\nBACKEND_URL=http://fowldata:8000\n\n# WRONG - Will cause ECONNREFUSED errors in Docker containers\nBACKEND_URL=http://localhost:8000\n```\n\n**Why**: Inside Docker containers, `localhost` refers to the container itself, not the host. Service names resolve to container IPs within the Docker network.\n\n**Symptoms**: NextAuth authentication fails, API calls fail with \"connect ECONNREFUSED ::1:8000\"\n\n**Fix**: Always use `fowldata:8000` (service name from docker-compose.yml) for inter-container communication.\n\n## âš ï¸ CRITICAL: Mapbox GL JS v3+ with react-map-gl v8 Layer Rendering\n**RECURRING ISSUE - ESSENTIAL FOR LAYER VISIBILITY**\n\nWhen using Mapbox GL JS v3+ with react-map-gl v8, layers will NOT render without explicit `mapboxgl.accessToken` configuration:\n\n```typescript\nimport mapboxgl from 'mapbox-gl';\n\nconst MAPBOX_TOKEN = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;\n\n// CRITICAL: This is required for Mapbox GL JS v3+ with react-map-gl v8\nif (MAPBOX_TOKEN) {\n  mapboxgl.accessToken = MAPBOX_TOKEN;\n}\n```\n\n**Why**: react-map-gl v8 delegates to Mapbox GL JS v3+ which requires explicit token configuration. Previous versions handled this automatically.\n\n**Symptoms**: \n- Map loads successfully with satellite/custom styles\n- Source/Layer components appear to be configured correctly  \n- Debug panels show data is present\n- NO visual layers render (not even test layers with bright colors)\n- No console errors about authentication or tokens\n- Canvas element exists but shows no content\n\n**Additional react-map-gl v8 Requirements:**\n- Layer components must be **immediate children** of Source components (no React fragments `<>...</>`)\n- Do NOT add explicit `source` props to Layer components inside Source components\n- Remove conditional `mapStyleLoaded` wrappers - let react-map-gl handle timing internally\n\n**Fix Location**: Add the `mapboxgl.accessToken` configuration at the top level of your Map component file, after importing mapboxgl.\n\n**Debugging Signs This is the Issue**:\n- Mapbox canvas renders with proper classes (`mapboxgl-canvas-container`)\n- Map style loads successfully\n- Data processing works correctly\n- Visibility and layer management appears functional\n- Zero visual layer rendering despite all other systems working\n\n## âš ï¸ CRITICAL: Production Environment Variable Loading\n**RECURRING DEPLOYMENT ISSUE - ESSENTIAL FOR PRODUCTION**\n\nDocker Compose production deployments REQUIRE explicit `--env-file` flag:\n\n```bash\n# REQUIRED for all production commands\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# WRONG - Will cause \"variable is not set\" warnings and startup failures\ndocker-compose -f docker-compose.prod.yaml up -d\n```\n\n**Why**: The `env_file:` setting in docker-compose.prod.yaml handles container environment variables, but Docker Compose variable substitution (${VARIABLE}) requires the explicit `--env-file` flag.\n\n**Symptoms**: \n- `WARN[0000] The \"DB_NAME\" variable is not set. Defaulting to a blank string.`\n- PostgreSQL container fails with \"superuser password not specified\"\n- Environment variables visible in some services but not others\n\n**Additional Production Requirements**:\n- All services need `env_file: - .env.production` in docker-compose.prod.yaml\n- Avoid special characters in passwords (`$`, `!`, etc.) - shell interprets them\n- Use clean file encoding (UTF-8 without BOM) for environment files\n\n## Architecture Overview\n\nFowlData is a production-ready full-stack waterfowl hunting tracking application:\n\n**Backend (Django)**: Located in `fowldata/` directory\n- Django 4.2 with Django REST Framework for API endpoints\n- PostgreSQL 16 with PostGIS 3.4 for geospatial data storage and spatial queries\n- JWT RS256 authentication integrated with NextAuth.js frontend\n- Two main apps: `accounts` (user management) and `hunts` (hunt tracking)\n- AWS S3 integration for photo storage with presigned URLs and CORS\n- Gunicorn WSGI server with production performance tuning\n\n**Frontend (Next.js)**: Located in `frontend/` directory  \n- Next.js 15.4.4 with React 19 and TypeScript\n- NextAuth.js v5 with Google OAuth and credentials authentication\n- Mapbox GL JS v3+ with react-map-gl v8 for interactive mapping\n- TailwindCSS for styling, React Hook Form for forms\n- Playwright for E2E testing, Jest for unit tests\n- Production-optimized standalone builds\n\n**Production Infrastructure**:\n- **Deployment**: Digital Ocean Droplets with Docker Compose orchestration\n- **Reverse Proxy**: Nginx with SSL/TLS termination via Let's Encrypt\n- **Caching**: Redis for sessions, query caching, and performance optimization\n- **Storage**: AWS S3 with CloudFront CDN for photo uploads and static assets\n- **Database**: PostgreSQL with PostGIS extensions, performance tuning, and automated backups\n- **Monitoring**: Docker health checks, database performance monitoring, and logging\n- **Security**: SSL enforcement, security headers, rate limiting, and firewall configuration\n\n## Development Commands\n\n### Backend Development\n```bash\n# Start services\ndocker compose up -d\n\n# Django management commands\ndocker compose exec fowldata python manage.py migrate\ndocker compose exec fowldata python manage.py createsuperuser\ndocker compose exec fowldata python manage.py shell\n\n# Run backend tests\ndocker compose exec fowldata python -m pytest\ndocker compose exec fowldata python -m pytest accounts/tests/ hunts/tests/ -v\n\n# Code formatting and linting\ndocker compose exec fowldata black .\ndocker compose exec fowldata flake8\n\n# Single test file\ndocker compose exec fowldata python -m pytest hunts/tests/test_weather_api.py -v\n```\n\n### Frontend Development\n```bash\ncd frontend\n\n# Development server (with Turbopack)\nnpm run dev\n\n# Build and type checking\nnpm run build\nnpm run lint\nnpx tsc --noEmit                # TypeScript checking without emit\n```\n\n### Testing & Validation\n\n#### Pre-Commit Validation\n```bash\n# Quick validation (run before commits)\n./testlint-quick               # Essential tests only (2-3 minutes)\n\n# Full validation (run before PRs)  \n./testlint                     # Complete validation with E2E tests (10-15 minutes)\n```\n\n#### Comprehensive Testing Commands\n```bash\n# Backend Testing\ndocker compose exec fowldata python -m pytest                    # All backend tests\ndocker compose exec fowldata python -m pytest -m \"not performance\"  # Skip slow tests\ndocker compose exec fowldata python -m pytest --cov=fowldata     # With coverage\ndocker compose exec fowldata python -m pytest -s --pdb          # Debug mode\n\n# Frontend Testing\ncd frontend\nnpm run test                           # Jest unit tests\nnpm run test -- --watchAll=false      # CI mode (run once)  \nnpm run test:e2e                      # Playwright E2E tests\nnpm run test:e2e -- --project chromium  # Specific browser\nnpm run test:e2e -- --debug           # Debug E2E tests\n\n# Specific Test Categories\ndocker compose exec fowldata python -m pytest -m \"auth\"      # Authentication tests\ndocker compose exec fowldata python -m pytest -m \"api\"       # API endpoint tests\nnpm test -- --testNamePattern=\"authentication\"               # Frontend auth tests\n```\n\n#### Test Debugging\n```bash\n# Backend Debug\ndocker compose exec fowldata python -m pytest -s --pdb hunts/tests/test_weather_api.py::test_function\ndocker compose exec fowldata python manage.py shell\n\n# Frontend Debug\nnpm run test:e2e -- --headed          # Show browser\nnpm run test:e2e -- --ui               # Playwright UI mode\nnpm test -- --no-coverage --verbose   # Detailed Jest output\n\n# E2E Test Environment Validation\n./scripts/verify-e2e-setup.sh         # Check E2E prerequisites\n```\n\n### Production Deployment\n```bash\n# Production validation and deployment\n./scripts/validate-production.sh\n\n# Production commands (ALWAYS use --env-file flag)\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production build\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production logs -f\n\n# Django production setup\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py migrate\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py createsuperuser\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py collectstatic --noinput\n```\n\n## Core Data Models\n\n**Hunt Model** (`hunts/models.py`):\n- Tracks hunting sessions with date, location (PostGIS Point), weather conditions\n- Links to multiple Bird harvests and HuntPhoto uploads\n- Weather data automatically fetched from external API based on coordinates\n\n**Bird Model**:\n- Individual waterfowl harvests within a hunt\n- Species selection from predefined WATERFOWL_CHOICES (Dabblers, Divers, Geese)\n- Includes harvest time, notes, and gender (Drake/Hen)\n\n**Authentication Integration**:\n- Django backend uses custom NextAuthBackend for JWT token validation\n- Frontend NextAuth.js providers: Google, Facebook, Credentials\n- Token synchronization between NextAuth and Django API client\n\n## Key Integration Points\n\n**Django-NextAuth Authentication Flow**:\n- NextAuth JWT tokens validated by Django via `accounts/nextauth_backend.py`  \n- API requests include NextAuth JWT in Authorization header\n- User creation/sync handled by Django signals in `accounts/signals.py`\n\n**Photo Upload System**:\n- S3 presigned URLs generated by Django `hunts/s3_manager.py`\n- Frontend uploads directly to S3, then registers with Django\n- HuntPhoto model tracks S3 URLs linked to Hunt instances\n\n**Geospatial Features**:\n- Hunt locations stored as PostGIS Points with lat/lng coordinates\n- Weather API integration fetches conditions based on hunt coordinates\n- Mapbox integration for location selection and visualization\n\n## Environment Configuration\n\n### Critical Environment Variables (MUST MATCH)\n**These variables must be identical in both backend and frontend:**\n```bash\n# Authentication (CRITICAL - must match exactly)\nAUTH_SECRET=your-nextauth-secret-key        # Both .env.local AND frontend/.env.local\n\n# Docker Network (CRITICAL - use service names)  \nBACKEND_URL=http://fowldata:8000            # frontend/.env.local ONLY\n```\n\n### Required Environment Files\n```bash\n# Development\n.env.local                  # Backend: Django database, secrets, S3 credentials  \nfrontend/.env.local         # Frontend: NextAuth secrets, API URLs\n\n# Production  \n.env.production            # Backend: Production settings\nfrontend/.env.production   # Frontend: Production URLs and secrets\n```\n\n### Essential Variables by Service\n```bash\n# Database (Backend .env.local)\nDB_HOST=localhost           # Development: localhost, Production: postgres\nDB_NAME=fowldata           # Database name\nDB_USER=postgres           # Database username\nDB_PASS=your_password      # No special characters in production\n\n# Authentication (Both files)\nAUTH_SECRET=your-secret    # Generate: openssl rand -base64 32\nSECRET_KEY=django-secret   # Django only\n\n# Mapbox (Frontend .env.local)\nNEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-token  # REQUIRED for layer rendering\n\n# AWS S3 (Backend .env.local)\nAWS_ACCESS_KEY_ID=your-key\nAWS_SECRET_ACCESS_KEY=your-secret  \nAWS_S3_BUCKET_NAME=bucket-name\n\n# OAuth (Frontend .env.local)\nGOOGLE_CLIENT_ID=your-google-id\nGOOGLE_CLIENT_SECRET=your-google-secret\n```\n\n### Security & Performance Best Practices\n```bash\n# Production Security Checklist\n- Use strong AUTH_SECRET (32+ characters): openssl rand -base64 32\n- Avoid special characters in passwords (no $, !, etc.) - shell interprets them\n- Always use HTTPS for OAuth callbacks in production\n- Set proper CORS origins: CORS_ALLOWED_ORIGINS=https://yourdomain.com\n\n# Performance Optimization  \n- Use Redis for caching: REDIS_HOST=redis, REDIS_PASSWORD=your-password\n- Enable SSL redirect: SECURE_SSL_REDIRECT=True (production)\n- Configure proper headers: SECURE_HSTS_SECONDS=31536000\n\n# Environment File Best Practices\n- Use UTF-8 encoding without BOM\n- No spaces around = signs: VAR=value (not VAR = value)\n- Always backup production environment files\n```\n\n## Testing Patterns\n\n**Backend Tests** (pytest-django):\n- Database tests marked with `@pytest.mark.django_db`\n- API endpoint tests use Django's APIClient  \n- External services (S3, weather API) are mocked\n- Fixtures in `conftest.py` create test users and hunt data\n\n**Frontend Tests**:\n- Unit tests: Jest + React Testing Library in `src/__tests__/`\n- Component tests focus on user interactions, not implementation\n- E2E tests: Playwright in `e2e/` directory with real browser automation\n- API mocking for isolated component testing\n\n## Mapbox Configuration\n\n- Import controls from `react-map-gl/mapbox` for Mapbox GL JS v3.5+\n- Control positioning critical - use `position` prop, not `style` object\n- Standard controls must be children of `<Map>` component\n- Custom controls positioned absolutely outside `<Map>`\n- Test controls in both browser and fullscreen modes\n\n## Development Workflow\n\n### Branch Strategy & Process\n```bash\n# Create feature branch\ngit checkout -b feature/descriptive-name\ngit push -u origin feature/descriptive-name\n\n# Development cycle\n# 1. Make changes\n# 2. Test locally: ./testlint-quick\n# 3. Commit: git commit -m \"feat: description\"  \n# 4. Before PR: ./testlint\n# 5. Create PR: gh pr create --title \"Title\" --body \"Description\"\n\n# Commit Message Format\nfeat: Add hunt sharing functionality\nfix: Resolve photo upload timeout issue  \ndocs: Update API documentation\ntest: Add weather API integration tests\nrefactor: Simplify authentication middleware\n```\n\n### Development Best Practices\n- **Container Rebuilds**: Rebuild Docker containers after backend changes to see frontend updates\n- **Test Credentials**: Use `mark@mail.com` / `1@Tsgstp` for E2E tests\n- **Pre-commit**: Always run `./testlint-quick` before commits\n- **Pre-PR**: Always run `./testlint` before creating pull requests  \n- **API Mocking**: Weather API responses should be mocked in tests for consistency\n\n## Troubleshooting Guide\n\n### Authentication Issues\n```bash\n# Primary diagnostic tool\nnode auth-health-check.js                    # Comprehensive auth system check\n\n# Specific auth problems\ndocker compose logs fowldata | grep -i auth  # Backend auth errors\ndocker compose logs fowldata | grep -i jwt   # JWT token issues\ndocker compose exec fowldata python manage.py shell  # Manual user inspection\n\n# Common auth fixes\n# 1. Verify AUTH_SECRET matches in both .env files\n# 2. Check BACKEND_URL uses fowldata:8000 (not localhost)\n# 3. Clear browser cookies and retry\n# 4. Restart both containers: docker compose restart fowldata frontend\n```\n\n### Database & Migration Issues  \n```bash\n# Database diagnostic\ndocker compose exec fowldata python manage.py check\ndocker compose exec fowldata python manage.py dbshell\ndocker compose exec postgres psql -U postgres -d fowldata\n\n# Reset database (development only)\ndocker compose down -v                       # Destroy volumes\ndocker compose up -d                         # Recreate services\ndocker compose exec fowldata python manage.py migrate\n\n# Migration problems\ndocker compose exec fowldata python manage.py showmigrations  # Show status\ndocker compose exec fowldata python manage.py migrate --fake  # Mark as applied\n```\n\n### Frontend Build & Runtime Issues\n```bash\n# Build diagnostics\ncd frontend\nnpm run build                                # Check for build errors\nnpm run lint                                # TypeScript/ESLint issues\nrm -rf .next node_modules && npm install    # Clean reinstall\n\n# Runtime debugging\nnpm run dev                                  # Development server logs\ndocker compose logs frontend                # Container logs\n```\n\n### E2E Test Failures\n```bash\n# E2E test diagnostics\n./scripts/verify-e2e-setup.sh              # Check prerequisites\nnpm run test:e2e -- --headed               # Visual debugging  \nnpm run test:e2e -- --debug                # Step-by-step debugging\n\n# Common E2E fixes\n# 1. Ensure test user exists: mark@mail.com / 1@Tsgstp\n# 2. Check services are running: docker compose ps\n# 3. Verify ports: curl http://localhost:3000 && curl http://localhost:8000/api/\n# 4. Clear browser state: rm -rf test-results/\n```\n\n### Performance & Resource Issues\n```bash\n# System resource monitoring\ndocker stats                               # Container resource usage\ndocker system df                          # Disk space usage\ndocker system prune -f                    # Clean unused resources\n\n# Database performance\ndocker compose exec fowldata python manage.py dbshell\n# Then: EXPLAIN ANALYZE SELECT * FROM hunts_hunt WHERE location IS NOT NULL;\n\n# Memory issues\ndocker compose down && docker compose up -d  # Restart all services\n```\n\n### Production Deployment Issues\n```bash\n# Production diagnostics\n./scripts/validate-production.sh           # Pre-deployment validation\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production config  # Validate config\n\n# SSL/TLS issues  \nopenssl x509 -in ssl/fullchain.pem -text -noout  # Check certificate\nsudo certbot renew --dry-run               # Test renewal process\n\n# Environment variable issues\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata env | grep DB_\n```\n\n### Emergency Recovery\n```bash\n# Quick service restart\ndocker compose restart fowldata frontend postgres\n\n# Full environment reset (DESTRUCTIVE - development only)\ndocker compose down -v\ndocker system prune -f  \ngit checkout -- .env.local frontend/.env.local\ndocker compose up -d\n\n# Rollback production deployment\ngit checkout previous-working-commit\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate\n```\n\n## Database & Backup Management\n\n### Database Operations\n```bash\n# Database inspection\ndocker compose exec fowldata python manage.py dbshell\ndocker compose exec postgres psql -U postgres -d fowldata\n\n# Create database backup\ndocker compose exec postgres pg_dump -U postgres fowldata > backup_$(date +%Y%m%d_%H%M%S).sql\n\n# Restore database backup  \ncat backup_file.sql | docker compose exec -T postgres psql -U postgres -d fowldata\n\n# Check database size and connections\ndocker compose exec postgres psql -U postgres -d fowldata -c \"\\l+ fowldata\"\ndocker compose exec postgres psql -U postgres -d fowldata -c \"SELECT * FROM pg_stat_activity;\"\n```\n\n### Performance Monitoring\n```bash\n# Monitor container resources\ndocker stats fowldata postgres redis frontend\n\n# Database performance analysis\ndocker compose exec fowldata python manage.py shell\n# >>> from django.db import connection; print(len(connection.queries))\n\n# Check slow queries (PostgreSQL)\ndocker compose exec postgres psql -U postgres -d fowldata -c \"\nSELECT query, mean_exec_time, calls \nFROM pg_stat_statements \nORDER BY mean_exec_time DESC LIMIT 10;\"\n\n# Redis monitoring\ndocker compose exec redis redis-cli INFO memory\ndocker compose exec redis redis-cli INFO stats\n```\n\n## API Reference\n\n### Core Hunt API\n```bash\n# Hunt Management\nGET /api/hunts/                           # List user hunts (paginated)\nPOST /api/hunts/                          # Create new hunt\nGET /api/hunts/{id}/                      # Get specific hunt\nPUT /api/hunts/{id}/                      # Update hunt\nDELETE /api/hunts/{id}/                   # Delete hunt\n\n# Hunt Search & Filtering  \nGET /api/hunts/?date_after=2024-01-01     # Filter by date\nGET /api/hunts/?location=lat,lng,radius   # Geospatial search\nGET /api/hunts/?species=mallard           # Filter by species\n```\n\n### Photo & Media API\n```bash\n# Photo Management\nGET /api/hunts/{hunt_id}/photos/          # List hunt photos\nPOST /api/hunts/{hunt_id}/photos/         # Upload photo\nDELETE /api/photos/{photo_id}/            # Delete photo\n\n# S3 Upload Workflow\nPOST /api/photos/presigned-url/           # Get presigned upload URL\n# â†’ Upload directly to S3 using presigned URL\nPOST /api/photos/confirm-upload/          # Confirm S3 upload success\n```\n\n### User & Authentication API\n```bash\n# User Management\nGET /api/users/me/                        # Current user profile\nPUT /api/users/me/                        # Update user profile  \nPOST /api/auth/sync/                      # Sync NextAuth user data\n\n# System Health\nGET /api/health/                          # Backend health check\nGET /health.json                          # Frontend health check (static)\n```","structuredPatch":[{"oldStart":417,"oldLines":8,"newStart":417,"newLines":7,"lines":[" ```bash"," # Database diagnostic"," docker compose exec fowldata python manage.py check","-docker compose exec fowldata python manage.py dbshell","-docker compose exec postgres psql -U postgres -d fowldata","+docker compose exec fowldata python manage.py showmigrations  # Show status"," "," # Reset database (development only)"," docker compose down -v                       # Destroy volumes"]},{"oldStart":426,"oldLines":7,"newStart":425,"newLines":6,"lines":[" docker compose exec fowldata python manage.py migrate"," "," # Migration problems","-docker compose exec fowldata python manage.py showmigrations  # Show status"," docker compose exec fowldata python manage.py migrate --fake  # Mark as applied"," ```"," "]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"cde82e44-bd3a-4b7a-ba9c-cc9f24ba5f82","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01BQgHoJZK9NMZ9PHkCEi7MX","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01KyAcp9jea92NRBZ5c62GsX","name":"Edit","input":{"file_path":"/Users/markelmore/_code/fowldata/CLAUDE.md","old_string":"### Database Operations\n```bash\n# Database inspection\ndocker compose exec fowldata python manage.py dbshell\ndocker compose exec postgres psql -U postgres -d fowldata\n\n# Create database backup\ndocker compose exec postgres pg_dump -U postgres fowldata > backup_$(date +%Y%m%d_%H%M%S).sql\n\n# Restore database backup  \ncat backup_file.sql | docker compose exec -T postgres psql -U postgres -d fowldata\n\n# Check database size and connections\ndocker compose exec postgres psql -U postgres -d fowldata -c \"\\l+ fowldata\"\ndocker compose exec postgres psql -U postgres -d fowldata -c \"SELECT * FROM pg_stat_activity;\"\n```","new_string":"### Database Operations\n```bash\n# Database access\ndocker compose exec fowldata python manage.py dbshell  # Django database shell\ndocker compose exec postgres psql -U postgres -d fowldata  # Direct PostgreSQL\n\n# Backup & Recovery\ndocker compose exec postgres pg_dump -U postgres fowldata > backup_$(date +%Y%m%d_%H%M%S).sql\ncat backup_file.sql | docker compose exec -T postgres psql -U postgres -d fowldata\n\n# Database status\ndocker compose exec postgres psql -U postgres -d fowldata -c \"\\l+ fowldata\"  # Size info\ndocker compose exec postgres psql -U postgres -d fowldata -c \"SELECT * FROM pg_stat_activity;\"  # Active connections\n```"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":676,"cache_read_input_tokens":90933,"cache_creation":{"ephemeral_5m_input_tokens":676,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"}},"requestId":"req_011CSTpUVUbm2P2BYkmk1zvq","type":"assistant","uuid":"7cdc94cd-71f9-48f8-a677-70ace58bae2c","timestamp":"2025-08-25T04:45:32.911Z"}
{"parentUuid":"7cdc94cd-71f9-48f8-a677-70ace58bae2c","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KyAcp9jea92NRBZ5c62GsX","type":"tool_result","content":"The file /Users/markelmore/_code/fowldata/CLAUDE.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   501â†’```\n   502â†’\n   503â†’## Database & Backup Management\n   504â†’\n   505â†’### Database Operations\n   506â†’```bash\n   507â†’# Database access\n   508â†’docker compose exec fowldata python manage.py dbshell  # Django database shell\n   509â†’docker compose exec postgres psql -U postgres -d fowldata  # Direct PostgreSQL\n   510â†’\n   511â†’# Backup & Recovery\n   512â†’docker compose exec postgres pg_dump -U postgres fowldata > backup_$(date +%Y%m%d_%H%M%S).sql\n   513â†’cat backup_file.sql | docker compose exec -T postgres psql -U postgres -d fowldata\n   514â†’\n   515â†’# Database status\n   516â†’docker compose exec postgres psql -U postgres -d fowldata -c \"\\l+ fowldata\"  # Size info\n   517â†’docker compose exec postgres psql -U postgres -d fowldata -c \"SELECT * FROM pg_stat_activity;\"  # Active connections\n   518â†’```\n   519â†’\n   520â†’### Performance Monitoring\n   521â†’```bash\n   522â†’# Monitor container resources"}]},"uuid":"d3986935-83a2-4506-9d67-09207b59116d","timestamp":"2025-08-25T04:45:33.067Z","toolUseResult":{"filePath":"/Users/markelmore/_code/fowldata/CLAUDE.md","oldString":"### Database Operations\n```bash\n# Database inspection\ndocker compose exec fowldata python manage.py dbshell\ndocker compose exec postgres psql -U postgres -d fowldata\n\n# Create database backup\ndocker compose exec postgres pg_dump -U postgres fowldata > backup_$(date +%Y%m%d_%H%M%S).sql\n\n# Restore database backup  \ncat backup_file.sql | docker compose exec -T postgres psql -U postgres -d fowldata\n\n# Check database size and connections\ndocker compose exec postgres psql -U postgres -d fowldata -c \"\\l+ fowldata\"\ndocker compose exec postgres psql -U postgres -d fowldata -c \"SELECT * FROM pg_stat_activity;\"\n```","newString":"### Database Operations\n```bash\n# Database access\ndocker compose exec fowldata python manage.py dbshell  # Django database shell\ndocker compose exec postgres psql -U postgres -d fowldata  # Direct PostgreSQL\n\n# Backup & Recovery\ndocker compose exec postgres pg_dump -U postgres fowldata > backup_$(date +%Y%m%d_%H%M%S).sql\ncat backup_file.sql | docker compose exec -T postgres psql -U postgres -d fowldata\n\n# Database status\ndocker compose exec postgres psql -U postgres -d fowldata -c \"\\l+ fowldata\"  # Size info\ndocker compose exec postgres psql -U postgres -d fowldata -c \"SELECT * FROM pg_stat_activity;\"  # Active connections\n```","originalFile":"# CLAUDE.md\n\nThis file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.\n\n## ğŸ¯ Quick Reference\n\n### Critical Commands\n```bash\n# Essential Development\ndocker compose up -d && cd frontend && npm run dev  # Start full stack\n./testlint-quick           # Quick validation before commits\n./testlint                 # Full validation before PRs\n\n# Production Deployment\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# Emergency Troubleshooting\nnode auth-health-check.js  # Authentication issues\n./scripts/verify-e2e-setup.sh  # E2E test setup validation\n```\n\n### Key API Endpoints\n```bash\nGET /api/hunts/            # List user hunts\nPOST /api/hunts/           # Create hunt\nGET /api/users/me/         # Current user info  \nPOST /api/auth/sync/       # User synchronization\nGET /api/health/           # Backend health check\n```\n\n## âš ï¸ CRITICAL: Docker Network Configuration - NEVER CHANGE\n**RECURRING ISSUE - ALWAYS CHECK THIS FIRST**\n\nThe frontend `.env.local` file MUST use the Docker service name for backend communication:\n```bash\n# CORRECT - Use Docker service name (this is in frontend/.env.local)\nBACKEND_URL=http://fowldata:8000\n\n# WRONG - Will cause ECONNREFUSED errors in Docker containers\nBACKEND_URL=http://localhost:8000\n```\n\n**Why**: Inside Docker containers, `localhost` refers to the container itself, not the host. Service names resolve to container IPs within the Docker network.\n\n**Symptoms**: NextAuth authentication fails, API calls fail with \"connect ECONNREFUSED ::1:8000\"\n\n**Fix**: Always use `fowldata:8000` (service name from docker-compose.yml) for inter-container communication.\n\n## âš ï¸ CRITICAL: Mapbox GL JS v3+ with react-map-gl v8 Layer Rendering\n**RECURRING ISSUE - ESSENTIAL FOR LAYER VISIBILITY**\n\nWhen using Mapbox GL JS v3+ with react-map-gl v8, layers will NOT render without explicit `mapboxgl.accessToken` configuration:\n\n```typescript\nimport mapboxgl from 'mapbox-gl';\n\nconst MAPBOX_TOKEN = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;\n\n// CRITICAL: This is required for Mapbox GL JS v3+ with react-map-gl v8\nif (MAPBOX_TOKEN) {\n  mapboxgl.accessToken = MAPBOX_TOKEN;\n}\n```\n\n**Why**: react-map-gl v8 delegates to Mapbox GL JS v3+ which requires explicit token configuration. Previous versions handled this automatically.\n\n**Symptoms**: \n- Map loads successfully with satellite/custom styles\n- Source/Layer components appear to be configured correctly  \n- Debug panels show data is present\n- NO visual layers render (not even test layers with bright colors)\n- No console errors about authentication or tokens\n- Canvas element exists but shows no content\n\n**Additional react-map-gl v8 Requirements:**\n- Layer components must be **immediate children** of Source components (no React fragments `<>...</>`)\n- Do NOT add explicit `source` props to Layer components inside Source components\n- Remove conditional `mapStyleLoaded` wrappers - let react-map-gl handle timing internally\n\n**Fix Location**: Add the `mapboxgl.accessToken` configuration at the top level of your Map component file, after importing mapboxgl.\n\n**Debugging Signs This is the Issue**:\n- Mapbox canvas renders with proper classes (`mapboxgl-canvas-container`)\n- Map style loads successfully\n- Data processing works correctly\n- Visibility and layer management appears functional\n- Zero visual layer rendering despite all other systems working\n\n## âš ï¸ CRITICAL: Production Environment Variable Loading\n**RECURRING DEPLOYMENT ISSUE - ESSENTIAL FOR PRODUCTION**\n\nDocker Compose production deployments REQUIRE explicit `--env-file` flag:\n\n```bash\n# REQUIRED for all production commands\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\n\n# WRONG - Will cause \"variable is not set\" warnings and startup failures\ndocker-compose -f docker-compose.prod.yaml up -d\n```\n\n**Why**: The `env_file:` setting in docker-compose.prod.yaml handles container environment variables, but Docker Compose variable substitution (${VARIABLE}) requires the explicit `--env-file` flag.\n\n**Symptoms**: \n- `WARN[0000] The \"DB_NAME\" variable is not set. Defaulting to a blank string.`\n- PostgreSQL container fails with \"superuser password not specified\"\n- Environment variables visible in some services but not others\n\n**Additional Production Requirements**:\n- All services need `env_file: - .env.production` in docker-compose.prod.yaml\n- Avoid special characters in passwords (`$`, `!`, etc.) - shell interprets them\n- Use clean file encoding (UTF-8 without BOM) for environment files\n\n## Architecture Overview\n\nFowlData is a production-ready full-stack waterfowl hunting tracking application:\n\n**Backend (Django)**: Located in `fowldata/` directory\n- Django 4.2 with Django REST Framework for API endpoints\n- PostgreSQL 16 with PostGIS 3.4 for geospatial data storage and spatial queries\n- JWT RS256 authentication integrated with NextAuth.js frontend\n- Two main apps: `accounts` (user management) and `hunts` (hunt tracking)\n- AWS S3 integration for photo storage with presigned URLs and CORS\n- Gunicorn WSGI server with production performance tuning\n\n**Frontend (Next.js)**: Located in `frontend/` directory  \n- Next.js 15.4.4 with React 19 and TypeScript\n- NextAuth.js v5 with Google OAuth and credentials authentication\n- Mapbox GL JS v3+ with react-map-gl v8 for interactive mapping\n- TailwindCSS for styling, React Hook Form for forms\n- Playwright for E2E testing, Jest for unit tests\n- Production-optimized standalone builds\n\n**Production Infrastructure**:\n- **Deployment**: Digital Ocean Droplets with Docker Compose orchestration\n- **Reverse Proxy**: Nginx with SSL/TLS termination via Let's Encrypt\n- **Caching**: Redis for sessions, query caching, and performance optimization\n- **Storage**: AWS S3 with CloudFront CDN for photo uploads and static assets\n- **Database**: PostgreSQL with PostGIS extensions, performance tuning, and automated backups\n- **Monitoring**: Docker health checks, database performance monitoring, and logging\n- **Security**: SSL enforcement, security headers, rate limiting, and firewall configuration\n\n## Development Commands\n\n### Backend Development\n```bash\n# Start services\ndocker compose up -d\n\n# Django management commands\ndocker compose exec fowldata python manage.py migrate\ndocker compose exec fowldata python manage.py createsuperuser\ndocker compose exec fowldata python manage.py shell\n\n# Run backend tests\ndocker compose exec fowldata python -m pytest\ndocker compose exec fowldata python -m pytest accounts/tests/ hunts/tests/ -v\n\n# Code formatting and linting\ndocker compose exec fowldata black .\ndocker compose exec fowldata flake8\n\n# Single test file\ndocker compose exec fowldata python -m pytest hunts/tests/test_weather_api.py -v\n```\n\n### Frontend Development\n```bash\ncd frontend\n\n# Development server (with Turbopack)\nnpm run dev\n\n# Build and type checking\nnpm run build\nnpm run lint\nnpx tsc --noEmit                # TypeScript checking without emit\n```\n\n### Testing & Validation\n\n#### Pre-Commit Validation\n```bash\n# Quick validation (run before commits)\n./testlint-quick               # Essential tests only (2-3 minutes)\n\n# Full validation (run before PRs)  \n./testlint                     # Complete validation with E2E tests (10-15 minutes)\n```\n\n#### Comprehensive Testing Commands\n```bash\n# Backend Testing\ndocker compose exec fowldata python -m pytest                    # All backend tests\ndocker compose exec fowldata python -m pytest -m \"not performance\"  # Skip slow tests\ndocker compose exec fowldata python -m pytest --cov=fowldata     # With coverage\ndocker compose exec fowldata python -m pytest -s --pdb          # Debug mode\n\n# Frontend Testing\ncd frontend\nnpm run test                           # Jest unit tests\nnpm run test -- --watchAll=false      # CI mode (run once)  \nnpm run test:e2e                      # Playwright E2E tests\nnpm run test:e2e -- --project chromium  # Specific browser\nnpm run test:e2e -- --debug           # Debug E2E tests\n\n# Specific Test Categories\ndocker compose exec fowldata python -m pytest -m \"auth\"      # Authentication tests\ndocker compose exec fowldata python -m pytest -m \"api\"       # API endpoint tests\nnpm test -- --testNamePattern=\"authentication\"               # Frontend auth tests\n```\n\n#### Test Debugging\n```bash\n# Backend Debug\ndocker compose exec fowldata python -m pytest -s --pdb hunts/tests/test_weather_api.py::test_function\ndocker compose exec fowldata python manage.py shell\n\n# Frontend Debug\nnpm run test:e2e -- --headed          # Show browser\nnpm run test:e2e -- --ui               # Playwright UI mode\nnpm test -- --no-coverage --verbose   # Detailed Jest output\n\n# E2E Test Environment Validation\n./scripts/verify-e2e-setup.sh         # Check E2E prerequisites\n```\n\n### Production Deployment\n```bash\n# Production validation and deployment\n./scripts/validate-production.sh\n\n# Production commands (ALWAYS use --env-file flag)\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production build\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production logs -f\n\n# Django production setup\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py migrate\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py createsuperuser\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata python manage.py collectstatic --noinput\n```\n\n## Core Data Models\n\n**Hunt Model** (`hunts/models.py`):\n- Tracks hunting sessions with date, location (PostGIS Point), weather conditions\n- Links to multiple Bird harvests and HuntPhoto uploads\n- Weather data automatically fetched from external API based on coordinates\n\n**Bird Model**:\n- Individual waterfowl harvests within a hunt\n- Species selection from predefined WATERFOWL_CHOICES (Dabblers, Divers, Geese)\n- Includes harvest time, notes, and gender (Drake/Hen)\n\n**Authentication Integration**:\n- Django backend uses custom NextAuthBackend for JWT token validation\n- Frontend NextAuth.js providers: Google, Facebook, Credentials\n- Token synchronization between NextAuth and Django API client\n\n## Key Integration Points\n\n**Django-NextAuth Authentication Flow**:\n- NextAuth JWT tokens validated by Django via `accounts/nextauth_backend.py`  \n- API requests include NextAuth JWT in Authorization header\n- User creation/sync handled by Django signals in `accounts/signals.py`\n\n**Photo Upload System**:\n- S3 presigned URLs generated by Django `hunts/s3_manager.py`\n- Frontend uploads directly to S3, then registers with Django\n- HuntPhoto model tracks S3 URLs linked to Hunt instances\n\n**Geospatial Features**:\n- Hunt locations stored as PostGIS Points with lat/lng coordinates\n- Weather API integration fetches conditions based on hunt coordinates\n- Mapbox integration for location selection and visualization\n\n## Environment Configuration\n\n### Critical Environment Variables (MUST MATCH)\n**These variables must be identical in both backend and frontend:**\n```bash\n# Authentication (CRITICAL - must match exactly)\nAUTH_SECRET=your-nextauth-secret-key        # Both .env.local AND frontend/.env.local\n\n# Docker Network (CRITICAL - use service names)  \nBACKEND_URL=http://fowldata:8000            # frontend/.env.local ONLY\n```\n\n### Required Environment Files\n```bash\n# Development\n.env.local                  # Backend: Django database, secrets, S3 credentials  \nfrontend/.env.local         # Frontend: NextAuth secrets, API URLs\n\n# Production  \n.env.production            # Backend: Production settings\nfrontend/.env.production   # Frontend: Production URLs and secrets\n```\n\n### Essential Variables by Service\n```bash\n# Database (Backend .env.local)\nDB_HOST=localhost           # Development: localhost, Production: postgres\nDB_NAME=fowldata           # Database name\nDB_USER=postgres           # Database username\nDB_PASS=your_password      # No special characters in production\n\n# Authentication (Both files)\nAUTH_SECRET=your-secret    # Generate: openssl rand -base64 32\nSECRET_KEY=django-secret   # Django only\n\n# Mapbox (Frontend .env.local)\nNEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=your-token  # REQUIRED for layer rendering\n\n# AWS S3 (Backend .env.local)\nAWS_ACCESS_KEY_ID=your-key\nAWS_SECRET_ACCESS_KEY=your-secret  \nAWS_S3_BUCKET_NAME=bucket-name\n\n# OAuth (Frontend .env.local)\nGOOGLE_CLIENT_ID=your-google-id\nGOOGLE_CLIENT_SECRET=your-google-secret\n```\n\n### Security & Performance Best Practices\n```bash\n# Production Security Checklist\n- Use strong AUTH_SECRET (32+ characters): openssl rand -base64 32\n- Avoid special characters in passwords (no $, !, etc.) - shell interprets them\n- Always use HTTPS for OAuth callbacks in production\n- Set proper CORS origins: CORS_ALLOWED_ORIGINS=https://yourdomain.com\n\n# Performance Optimization  \n- Use Redis for caching: REDIS_HOST=redis, REDIS_PASSWORD=your-password\n- Enable SSL redirect: SECURE_SSL_REDIRECT=True (production)\n- Configure proper headers: SECURE_HSTS_SECONDS=31536000\n\n# Environment File Best Practices\n- Use UTF-8 encoding without BOM\n- No spaces around = signs: VAR=value (not VAR = value)\n- Always backup production environment files\n```\n\n## Testing Patterns\n\n**Backend Tests** (pytest-django):\n- Database tests marked with `@pytest.mark.django_db`\n- API endpoint tests use Django's APIClient  \n- External services (S3, weather API) are mocked\n- Fixtures in `conftest.py` create test users and hunt data\n\n**Frontend Tests**:\n- Unit tests: Jest + React Testing Library in `src/__tests__/`\n- Component tests focus on user interactions, not implementation\n- E2E tests: Playwright in `e2e/` directory with real browser automation\n- API mocking for isolated component testing\n\n## Mapbox Configuration\n\n- Import controls from `react-map-gl/mapbox` for Mapbox GL JS v3.5+\n- Control positioning critical - use `position` prop, not `style` object\n- Standard controls must be children of `<Map>` component\n- Custom controls positioned absolutely outside `<Map>`\n- Test controls in both browser and fullscreen modes\n\n## Development Workflow\n\n### Branch Strategy & Process\n```bash\n# Create feature branch\ngit checkout -b feature/descriptive-name\ngit push -u origin feature/descriptive-name\n\n# Development cycle\n# 1. Make changes\n# 2. Test locally: ./testlint-quick\n# 3. Commit: git commit -m \"feat: description\"  \n# 4. Before PR: ./testlint\n# 5. Create PR: gh pr create --title \"Title\" --body \"Description\"\n\n# Commit Message Format\nfeat: Add hunt sharing functionality\nfix: Resolve photo upload timeout issue  \ndocs: Update API documentation\ntest: Add weather API integration tests\nrefactor: Simplify authentication middleware\n```\n\n### Development Best Practices\n- **Container Rebuilds**: Rebuild Docker containers after backend changes to see frontend updates\n- **Test Credentials**: Use `mark@mail.com` / `1@Tsgstp` for E2E tests\n- **Pre-commit**: Always run `./testlint-quick` before commits\n- **Pre-PR**: Always run `./testlint` before creating pull requests  \n- **API Mocking**: Weather API responses should be mocked in tests for consistency\n\n## Troubleshooting Guide\n\n### Authentication Issues\n```bash\n# Primary diagnostic tool\nnode auth-health-check.js                    # Comprehensive auth system check\n\n# Specific auth problems\ndocker compose logs fowldata | grep -i auth  # Backend auth errors\ndocker compose logs fowldata | grep -i jwt   # JWT token issues\ndocker compose exec fowldata python manage.py shell  # Manual user inspection\n\n# Common auth fixes\n# 1. Verify AUTH_SECRET matches in both .env files\n# 2. Check BACKEND_URL uses fowldata:8000 (not localhost)\n# 3. Clear browser cookies and retry\n# 4. Restart both containers: docker compose restart fowldata frontend\n```\n\n### Database & Migration Issues  \n```bash\n# Database diagnostic\ndocker compose exec fowldata python manage.py check\ndocker compose exec fowldata python manage.py showmigrations  # Show status\n\n# Reset database (development only)\ndocker compose down -v                       # Destroy volumes\ndocker compose up -d                         # Recreate services\ndocker compose exec fowldata python manage.py migrate\n\n# Migration problems\ndocker compose exec fowldata python manage.py migrate --fake  # Mark as applied\n```\n\n### Frontend Build & Runtime Issues\n```bash\n# Build diagnostics\ncd frontend\nnpm run build                                # Check for build errors\nnpm run lint                                # TypeScript/ESLint issues\nrm -rf .next node_modules && npm install    # Clean reinstall\n\n# Runtime debugging\nnpm run dev                                  # Development server logs\ndocker compose logs frontend                # Container logs\n```\n\n### E2E Test Failures\n```bash\n# E2E test diagnostics\n./scripts/verify-e2e-setup.sh              # Check prerequisites\nnpm run test:e2e -- --headed               # Visual debugging  \nnpm run test:e2e -- --debug                # Step-by-step debugging\n\n# Common E2E fixes\n# 1. Ensure test user exists: mark@mail.com / 1@Tsgstp\n# 2. Check services are running: docker compose ps\n# 3. Verify ports: curl http://localhost:3000 && curl http://localhost:8000/api/\n# 4. Clear browser state: rm -rf test-results/\n```\n\n### Performance & Resource Issues\n```bash\n# System resource monitoring\ndocker stats                               # Container resource usage\ndocker system df                          # Disk space usage\ndocker system prune -f                    # Clean unused resources\n\n# Database performance\ndocker compose exec fowldata python manage.py dbshell\n# Then: EXPLAIN ANALYZE SELECT * FROM hunts_hunt WHERE location IS NOT NULL;\n\n# Memory issues\ndocker compose down && docker compose up -d  # Restart all services\n```\n\n### Production Deployment Issues\n```bash\n# Production diagnostics\n./scripts/validate-production.sh           # Pre-deployment validation\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production config  # Validate config\n\n# SSL/TLS issues  \nopenssl x509 -in ssl/fullchain.pem -text -noout  # Check certificate\nsudo certbot renew --dry-run               # Test renewal process\n\n# Environment variable issues\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production exec fowldata env | grep DB_\n```\n\n### Emergency Recovery\n```bash\n# Quick service restart\ndocker compose restart fowldata frontend postgres\n\n# Full environment reset (DESTRUCTIVE - development only)\ndocker compose down -v\ndocker system prune -f  \ngit checkout -- .env.local frontend/.env.local\ndocker compose up -d\n\n# Rollback production deployment\ngit checkout previous-working-commit\ndocker-compose -f docker-compose.prod.yaml --env-file .env.production up -d --force-recreate\n```\n\n## Database & Backup Management\n\n### Database Operations\n```bash\n# Database inspection\ndocker compose exec fowldata python manage.py dbshell\ndocker compose exec postgres psql -U postgres -d fowldata\n\n# Create database backup\ndocker compose exec postgres pg_dump -U postgres fowldata > backup_$(date +%Y%m%d_%H%M%S).sql\n\n# Restore database backup  \ncat backup_file.sql | docker compose exec -T postgres psql -U postgres -d fowldata\n\n# Check database size and connections\ndocker compose exec postgres psql -U postgres -d fowldata -c \"\\l+ fowldata\"\ndocker compose exec postgres psql -U postgres -d fowldata -c \"SELECT * FROM pg_stat_activity;\"\n```\n\n### Performance Monitoring\n```bash\n# Monitor container resources\ndocker stats fowldata postgres redis frontend\n\n# Database performance analysis\ndocker compose exec fowldata python manage.py shell\n# >>> from django.db import connection; print(len(connection.queries))\n\n# Check slow queries (PostgreSQL)\ndocker compose exec postgres psql -U postgres -d fowldata -c \"\nSELECT query, mean_exec_time, calls \nFROM pg_stat_statements \nORDER BY mean_exec_time DESC LIMIT 10;\"\n\n# Redis monitoring\ndocker compose exec redis redis-cli INFO memory\ndocker compose exec redis redis-cli INFO stats\n```\n\n## API Reference\n\n### Core Hunt API\n```bash\n# Hunt Management\nGET /api/hunts/                           # List user hunts (paginated)\nPOST /api/hunts/                          # Create new hunt\nGET /api/hunts/{id}/                      # Get specific hunt\nPUT /api/hunts/{id}/                      # Update hunt\nDELETE /api/hunts/{id}/                   # Delete hunt\n\n# Hunt Search & Filtering  \nGET /api/hunts/?date_after=2024-01-01     # Filter by date\nGET /api/hunts/?location=lat,lng,radius   # Geospatial search\nGET /api/hunts/?species=mallard           # Filter by species\n```\n\n### Photo & Media API\n```bash\n# Photo Management\nGET /api/hunts/{hunt_id}/photos/          # List hunt photos\nPOST /api/hunts/{hunt_id}/photos/         # Upload photo\nDELETE /api/photos/{photo_id}/            # Delete photo\n\n# S3 Upload Workflow\nPOST /api/photos/presigned-url/           # Get presigned upload URL\n# â†’ Upload directly to S3 using presigned URL\nPOST /api/photos/confirm-upload/          # Confirm S3 upload success\n```\n\n### User & Authentication API\n```bash\n# User Management\nGET /api/users/me/                        # Current user profile\nPUT /api/users/me/                        # Update user profile  \nPOST /api/auth/sync/                      # Sync NextAuth user data\n\n# System Health\nGET /api/health/                          # Backend health check\nGET /health.json                          # Frontend health check (static)\n```","structuredPatch":[{"oldStart":504,"oldLines":19,"newStart":504,"newLines":17,"lines":[" "," ### Database Operations"," ```bash","-# Database inspection","-docker compose exec fowldata python manage.py dbshell","-docker compose exec postgres psql -U postgres -d fowldata","+# Database access","+docker compose exec fowldata python manage.py dbshell  # Django database shell","+docker compose exec postgres psql -U postgres -d fowldata  # Direct PostgreSQL"," ","-# Create database backup","+# Backup & Recovery"," docker compose exec postgres pg_dump -U postgres fowldata > backup_$(date +%Y%m%d_%H%M%S).sql","-","-# Restore database backup  "," cat backup_file.sql | docker compose exec -T postgres psql -U postgres -d fowldata"," ","-# Check database size and connections","-docker compose exec postgres psql -U postgres -d fowldata -c \"\\l+ fowldata\"","-docker compose exec postgres psql -U postgres -d fowldata -c \"SELECT * FROM pg_stat_activity;\"","+# Database status","+docker compose exec postgres psql -U postgres -d fowldata -c \"\\l+ fowldata\"  # Size info","+docker compose exec postgres psql -U postgres -d fowldata -c \"SELECT * FROM pg_stat_activity;\"  # Active connections"," ```"," "," ### Performance Monitoring"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"d3986935-83a2-4506-9d67-09207b59116d","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01KUaooFTX7NpVaRYP57cRCb","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"tool_use","id":"toolu_01G6aRYM4scAzW4jbbm16HEy","name":"TodoWrite","input":{"todos":[{"content":"Analyze current CLAUDE.md structure and identify integration points","status":"completed","activeForm":"Analyzing current CLAUDE.md structure and identifying integration points"},{"content":"Enhance testing section with comprehensive commands","status":"completed","activeForm":"Enhancing testing section with comprehensive commands"},{"content":"Add security and performance best practices","status":"completed","activeForm":"Adding security and performance best practices"},{"content":"Expand troubleshooting section with consolidated patterns","status":"completed","activeForm":"Expanding troubleshooting section with consolidated patterns"},{"content":"Add development workflow improvements","status":"completed","activeForm":"Adding development workflow improvements"},{"content":"Include API reference and environment variables priority","status":"completed","activeForm":"Including API reference and environment variables priority"},{"content":"Review for redundancy and conflicts","status":"completed","activeForm":"Reviewing for redundancy and conflicts"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":778,"cache_read_input_tokens":91609,"cache_creation":{"ephemeral_5m_input_tokens":778,"ephemeral_1h_input_tokens":0},"output_tokens":284,"service_tier":"standard"}},"requestId":"req_011CSTpUzzNDvEHhu3kBqmpd","type":"assistant","uuid":"a27aa19e-4dda-4c59-9abd-1ade39a188f6","timestamp":"2025-08-25T04:45:39.762Z"}
{"parentUuid":"a27aa19e-4dda-4c59-9abd-1ade39a188f6","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01G6aRYM4scAzW4jbbm16HEy","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"59fc3e55-14cb-4b64-b4f4-a273e7de29ae","timestamp":"2025-08-25T04:45:39.828Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Analyze current CLAUDE.md structure and identify integration points","status":"completed","activeForm":"Analyzing current CLAUDE.md structure and identifying integration points"},{"content":"Enhance testing section with comprehensive commands","status":"completed","activeForm":"Enhancing testing section with comprehensive commands"},{"content":"Add security and performance best practices","status":"completed","activeForm":"Adding security and performance best practices"},{"content":"Expand troubleshooting section with consolidated patterns","status":"completed","activeForm":"Expanding troubleshooting section with consolidated patterns"},{"content":"Add development workflow improvements","status":"completed","activeForm":"Adding development workflow improvements"},{"content":"Include API reference and environment variables priority","status":"completed","activeForm":"Including API reference and environment variables priority"},{"content":"Review for redundancy and conflicts","status":"completed","activeForm":"Reviewing for redundancy and conflicts"}]}}
{"parentUuid":"59fc3e55-14cb-4b64-b4f4-a273e7de29ae","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"assistant","uuid":"b90f06c4-0e5d-488b-bfce-340ca655d12d","timestamp":"2025-08-25T04:45:41.167Z","message":{"id":"de766e76-25b2-4bb7-9470-92bc932f772d","model":"<synthetic>","role":"assistant","stop_reason":"stop_sequence","stop_sequence":"","type":"message","usage":{"input_tokens":0,"output_tokens":0,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"server_tool_use":{"web_search_requests":0},"service_tier":null},"content":[{"type":"text","text":"5-hour limit reached âˆ™ resets 10pm"}]},"isApiErrorMessage":true}
{"parentUuid":"b90f06c4-0e5d-488b-bfce-340ca655d12d","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","type":"user","message":{"role":"user","content":"ok lets continue now that our limit reset"},"uuid":"32566383-a29f-4596-b517-1646e890af63","timestamp":"2025-08-25T05:12:05.677Z"}
{"parentUuid":"32566383-a29f-4596-b517-1646e890af63","isSidechain":false,"userType":"external","cwd":"/Users/markelmore/_code/fowldata","sessionId":"3a82775c-4d88-49b5-bfca-a3ea4e515867","version":"1.0.89","gitBranch":"docs-consolidation-update","message":{"id":"msg_01CyYVmHkFptEHZ4nheeWKuQ","type":"message","role":"assistant","model":"claude-sonnet-4-20250514","content":[{"type":"text","text":"Perfect! I've successfully enhanced the CLAUDE.md file with all the recommended improvements while carefully avoiding redundancy and conflicts. Here's a summary of what was accomplished:\n\n## âœ… Completed Enhancements\n\n### 1. **Quick Reference Section Added**\n- Critical commands for common tasks\n- Key API endpoints reference\n- Emergency troubleshooting commands\n\n### 2. **Enhanced Testing & Validation**\n- Comprehensive testing commands for both backend and frontend\n- Test debugging tools and strategies\n- Specific test categories (auth, api, performance)\n- E2E test environment validation\n\n### 3. **Security & Performance Best Practices**\n- Production security checklist\n- Environment file best practices\n- Performance optimization guidelines\n- Critical environment variables prioritized\n\n### 4. **Expanded Troubleshooting Guide**\n- Authentication issues with diagnostic tools\n- Database & migration problems\n- Frontend build & runtime issues\n- E2E test failures\n- Performance & resource issues\n- Production deployment problems\n- Emergency recovery procedures\n\n### 5. **Development Workflow Improvements**\n- Branch strategy and process\n- Commit message format standards\n- Development best practices consolidated\n\n### 6. **Database & Backup Management**\n- Database operations and access commands\n- Backup and recovery procedures\n- Performance monitoring tools\n\n### 7. **Comprehensive API Reference**\n- Core Hunt API endpoints\n- Photo & Media API workflows\n- User & Authentication API\n- System health checks\n\n## ğŸ” Redundancy & Conflict Resolution\n\nI carefully reviewed and eliminated redundancies by:\n- Consolidating duplicate database commands\n- Removing redundant frontend testing commands\n- Merging similar troubleshooting patterns\n- Ensuring consistent command syntax throughout\n- Maintaining the existing critical sections while enhancing them\n\nThe file now provides comprehensive guidance for AI assistants working on the FowlData project, with clear section organization and no conflicting information. All the valuable insights from the extensive documentation directory have been integrated while preserving the existing critical issue warnings that were working well."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":92729,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":92729,"ephemeral_1h_input_tokens":0},"output_tokens":451,"service_tier":"standard"}},"requestId":"req_011CSTrWR2FKKeqxSjiopqtt","type":"assistant","uuid":"4fac2a90-11fc-4567-ae9d-c0e085cca338","timestamp":"2025-08-25T05:12:19.929Z"}
